<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
</head>
<body>
    <!--<canvas id="canvas" width="512" height="512"></canvas>-->
    <span><img src="./Assets/Textures/pond/Pond_NRM.png" width="128" height="128"><div style="text-align: center;width: 128px;color: white">sdsd</div></span>
    <script type="module">
        import Matrix44 from "../src/Core/Math3d/Matrix44.js";

        let array = [250, 500, 15, 1000];
        array.sort((a, b)=>{return b - a;});
        console.log('array:\n',array);
        // import MaterialDefBuild from "../src/Core/Material/MaterialDefBuild.js";
        //
        // let matDefBuild = new MaterialDefBuild();
        // matDefBuild.build("#version 2\n" +
        //     "Def Template{\n" +
        //     "    Params{\n" +
        //     "        // 材质参数\n" +
        //     "        sampler2D colorMap;\n" +
        //     "    }\n" +
        //     "    Vars data1{\n" +
        //     "        vec2 wUv0;\n" +
        //     "    }\n" +
        //     "    Vars data2{\n" +
        //     "        vec2 wUv0;\n" +
        //     "    }\n" +
        //     "    // 一组库函数\n" +
        //     "    Functions myCode{\n" +
        //     "        void function1(){\n" +
        //     "            Context.OutPosition = vec4(Context.InPosition, 1.0f);\n" +
        //     "            data1.wUv0 = Context.InUv0;\n" +
        //     "        }\n" +
        //     "        void function2(){\n" +
        //     "            function1();\n" +
        //     "            Context.OutColor = vec4(1.0f);\n" +
        //     "        }\n" +
        //     "        void function3(){\n" +
        //     "            function2();\n" +
        //     "            Context.OutColor = vec4(data1.wUv0, 0.0f, 1.0f);\n" +
        //     "        }\n" +
        //     "        vec4 getColorMap(){\n" +
        //     "            return texture(Params.colorMap, data1.wUv0);\n" +
        //     "        }\n" +
        //     "        void function4(){\n" +
        //     "            // 只能使用一组Vars,不能同时使用两组不同的Vars\n" +
        //     "            Context.OutColor = getColorMap();\n" +
        //     "        }\n" +
        //     "    }\n" +
        //     "    SubTechnology Test{\n" +
        //     "        Vs_Shader:myCode.function1;\n" +
        //     "        Fs_Shader:myCode.function2;\n" +
        //     "    }\n" +
        //     "    SubTechnology Test2{\n" +
        //     "        Vs_Shader:myCode.function1;\n" +
        //     "        Fs_Shader:myCode.function3;\n" +
        //     "    }\n" +
        //     "    Technology{\n" +
        //     "        Sub_Pass{\n" +
        //     "            Pass Test{\n" +
        //     "            }\n" +
        //     "        }\n" +
        //     "    }\n" +
        //     "    Technology 2{\n" +
        //     "        Sub_Pass{\n" +
        //     "            Pass Test2{\n" +
        //     "            }\n" +
        //     "        }\n" +
        //     "    }\n" +
        //     "}\n");
        // let arr = ['color','get','test'];
        // var newArr = arr.sort(function(a,b){return a.localeCompare(b)});
        // console.log("newArr:" + newArr);
        // arr = ['test','color','get'];
        // var newArr = arr.sort(function(a,b){return a.localeCompare(b)});
        // console.log("newArr:" + newArr);
        //
        // let s1 = /color/;
        // let s2 = /colorMap/;
        // let t0 = 'color';
        // let t1 = 'colorMap';
        // console.log("s1匹配t0:" + t0.match(s1));
        // console.log("s2匹配t0:" + t0.match(s2));
        // console.log("s1匹配t1:" + (t1.match(s1) == t1));
        // console.log("s2匹配t1:" + (t1.match(s2) == t1));

        // import Tools from "../src/Core/Util/Tools.js";
        //
        // let src = "test Params.colorMap * Params.diffuseMap;";
        // let p1 = /Params.color/;
        // let p2 = /Params.colorMap/;
        // let p3 = /Params.diffuseMap/;
        //
        // let i = Tools.find2(src, p1);
        // console.log("i:" + i);
        // i = Tools.find2(src, p2);
        // console.log("i:" + i);
        // i = Tools.find2(src, p3);
        // console.log("i:" + i);
        // let arr = [];
        // arr[1] = 2;
        // arr[0] = 3;
        // console.log('arr:',arr);
        // let arr2 = [];
        // arr2[0] = [5, 'ttt'];
        // arr2[1] = [2, 'ggg'];
        // arr2.sort((a, b)=>{return a[0] - b[0];});
        // console.log("arr2:",arr2);
        //
        // let s = 'vec4 albedo = texture(Params.baseColorMap, wUv0) * Params.baseColor;';
        // let i0 = Tools.find2(s, /Params.baseColor/);
        // console.log('i0 = ' , s.search(/Params.baseColor/g));
        // let i1 = Tools.find2(s, /Params.baseColorMap/);
        //
        //
        // let ii = /Params.baseColor[\s+-;.,\*\\]{1,}/;
        // let ii2 = /Params.baseColor/;
        // console.log('结果:' + s.search(ii));
        import Scene from "../src/Core/Scene/Scene.js";
        import Vector3 from "../src/Core/Math3d/Vector3.js";
        import ProbeTools from "../src/Core/Util/ProbeTools.js";
        import Camera from "../src/Core/Scene/Camera.js";
        import Shadow from "../src/Core/Shadow/Shadow.js";

        // console.log('0.5 ^ 2.2 = ' + Math.pow(0.534, 2.2));
        // let texelVect = new Vector3();
        // let weight = ProbeTools.getSAAV(120, 125, 128, 3, texelVect, ProbeTools._S_FIX_SEAMS_METHOD.Wrap);
        // console.log('weight:' + weight + ";texelVect:" + texelVect.toString());
        // let shDir = [];
        // ProbeTools.evalShBasis(texelVect, shDir);
        // console.log('shDir:' , shDir);
        // let cfg = {value:false};
        // console.log('value:' + (cfg.value || 1));

        // let scene = new Scene({cavnas:document.getElementById('canvas')});
        // let shadowCam = new Camera(scene, {id:'shadowCam', parallelProjection:true});
        // console.log('projectMatrix:' + shadowCam.getProjectMatrix().toString());
        //
        //
        //
        // shadowCam.setFar(1000.0);
        // shadowCam.setEye(new Vector3(0, 0, 0));
        // let e = shadowCam.getEye();
        // shadowCam.lookAt(e, e.add(new Vector3(-1, -1, -1), new Vector3()), shadowCam.getUp());
        // console.log('v:' + shadowCam.getViewMatrix().toString());
        // // 强制更新
        // shadowCam._updateFrustum();
        // shadowCam.forceUpdateProjection();
        // let pv = shadowCam.getProjectViewMatrix(true);
        // console.log('pv:' + pv.toString());
        //
        //
        //
        // // 测试calculateLightConeScope
        // console.log('测试calculateLightConeScope...');
        // let points = [];
        // for(let i = 0;i < 8;i++){
        //     points[i] = new Vector3();
        // }
        // let cam = new Camera(scene, {id:'cam'});
        // cam.setEye(new Vector3(0, 0, 0));
        // cam.lookAt(new Vector3(0, 0, 0), new Vector3(0, 0, -1), new Vector3(0, 1, 0));
        // console.log('w:' + cam.getWidth() + ',h:' + cam.getHeight());
        //
        // Shadow.calculateLightConeScope(cam, 0.1, 1000.0, 1.0, points);
        // console.log('points:');
        // for(let i = 0;i < 8;i++){
        //     console.log(i + ":" + points[i].toString());
        // }
        //
        // // 测试calculateSplits
        // let splits = new Array(5);
        // Shadow.calculateSplits(splits, 0.1, 1000.0, 0.65);
        // for(let i = 0;i < 5;i++){
        //     console.log(i + ':' + splits[i]);
        // }
        //
        // async function test() {
        //     return new Promise(resolve => {
        //         setTimeout(()=>{
        //             resolve('ttt');
        //         }, 5000);
        //     });
        // }
        // console.time('test');
        // let result = await test();
        // console.timeEnd('test');
        // console.log('result:' + result);
        const canvasWidth = 640;
        const canvasHeight = 480;
        const pD = 180.0;
        const pDN = 1.0 / pD;
        const fieldOfViewRadians = 45.0 * pDN * Math.PI;
        const near = 0.1;
        const far = 1000.0;
        const mouseX = 50;
        const mouseY = 45;
        const aspect = canvasWidth / canvasHeight;
        const top = Math.tan(fieldOfViewRadians * 0.5) * near;
        const bottom = -top;
        const left = aspect * bottom;
        const right = aspect * top;
        const width = Math.abs(right - left);
        const height = Math.abs(top - bottom);

        // compute the portion of the near plane covers the 1 pixel
        // under the mouse.
        const pixelX = mouseX * 1;
        const pixelY = canvasHeight - mouseY * 1 - 1;

        const subLeft = left + pixelX * width / canvasWidth;
        const subBottom = bottom + pixelY * height / canvasHeight;
        const subWidth = width / canvasWidth;
        const subHeight = height / canvasHeight;
        let m = new Matrix44();
        m.fromFrustum(subLeft,
            subLeft + subWidth,
            subBottom + subHeight,
            subBottom,
            near,
            far,
            false
        );
        console.log('aspect:'+aspect);
        console.log('top:'+top);
        console.log('bottom:'+bottom);
        console.log('left:'+left);
        console.log('right:'+right);
        console.log('width:'+width);
        console.log('height:'+height);
        console.log('pixelX:'+pixelX);
        console.log('pixelY:'+pixelY);
        console.log('subLeft:'+subLeft);
        console.log('subBottom:'+subBottom);
        console.log('subWidth:'+subWidth);
        console.log('subHeight:'+subHeight);
        console.log('m:'+m.toString());

    </script>
    <!--<script>-->
        <!--function findSrc(str, reg){-->
            <!--let res = reg.exec(str);-->
            <!--if(res){-->
                <!--// 截取这个字符串-->
            <!--}-->
        <!--}-->
        <!--function repSrc(str, pattern, tagPattern, tag){-->
            <!--if(str.search(pattern) != -1){-->
                <!--return str.replace(tagPattern, tag);-->
            <!--}-->
            <!--return str;-->
        <!--}-->
        <!--var pattern = /Test.Test/, tagPattern = /Test.Test/g,-->
            <!--str = 'Test.Test = a * Test.Test;';-->
        <!--console.log("b:",repSrc(str, pattern, tagPattern, "gTg"));-->
    <!--</script>-->
</body>
</html>
