!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Try3d=t():e.Try3d=t()}(self,(function(){return(()=>{"use strict";var __webpack_modules__={4755:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r;(r=n(3846))&&r.__esModule;function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_PathName=t,this._m_Keyframes=[],this._m_ActionTrack=null}var t,n,r;return t=e,(n=[{key:"getLength",value:function(){var e=-Number.MAX_VALUE;return this._m_Keyframes.forEach((function(t){e=Math.max(e,t.getTime())})),e==-Number.MAX_VALUE?0:e}},{key:"addKeyframe",value:function(e){this._m_Keyframes.push(e)}},{key:"getPathName",value:function(){return this._m_PathName}},{key:"setActionTrack",value:function(e){this._m_ActionTrack=e}},{key:"update",value:function(e){for(var t=0,n=null,r=this._m_Keyframes.length;t<r&&this._m_Keyframes[t].getTime()<e;)t++;if(0==t)n=this._m_Keyframes[t],this._m_ActionTrack.setValue(n.getValue());else if(t==r)t-=1,n=this._m_Keyframes[t],this._m_ActionTrack.setValue(n.getValue());else{var i=this._m_Keyframes[t-1],o=this._m_Keyframes[t],a=1/(o.getTime()-i.getTime());n=i.interpolation(i.getValue(),o.getValue(),(e-i.getTime())*a),this._m_ActionTrack.setValue(n)}}}])&&i(t.prototype,n),r&&i(t,r),e}();t.default=o},479:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(3846))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Name=t,this._m_Time=0,this._m_TimeLength=0,this._m_Mode=e.S_LOOP,this._m_TimeMode=1,this._m_Processor=null,this._m_TrackMixer=null,this._m_State=e.S_STOP}var t,n,r;return t=e,(n=[{key:"setAnimationMode",value:function(e){}},{key:"_setProcessor",value:function(e){this._m_Processor=e}},{key:"getName",value:function(){return this._m_Name}},{key:"getAnimationLength",value:function(){return this._m_TimeLength}},{key:"setTrackMixer",value:function(e){var t=this;this._m_TrackMixer=e,this._m_Time=0,this._m_TimeLength=-Number.MAX_VALUE,e.getClips().forEach((function(e){t._m_TimeLength=Math.max(e.getLength(),t._m_TimeLength)})),this._m_TimeLength==-Number.MAX_VALUE&&(this._m_TimeLength=0),i.default.log("[["+this.getName()+"]]动画时长:"+this._m_TimeLength+"s")}},{key:"play",value:function(){this._m_State!=e.S_PLAY&&(this._m_Processor._activeAnimationAction(this),this._m_State=e.S_PLAY)}},{key:"pause",value:function(){this._m_State!=e.S_PAUSE&&(this._m_State==e.S_PLAY&&this._m_Processor._disableAnimationAction(this),this._m_State=e.S_PAUSE)}},{key:"stop",value:function(){this._m_State!=e.S_STOP&&(this._m_State==e.S_PLAY&&this._m_Processor._disableAnimationAction(this),this._m_State=e.S_STOP,this._m_Time=0)}},{key:"update",value:function(t){if(this._m_Time>=this._m_TimeLength){if(this._m_Mode==e.S_DONT_LOOP)return void(this._m_TimeMode=1);this._m_Mode==e.S_LOOP&&(this._m_Time=0,this._m_TimeMode=1),this._m_Mode==e.S_BACK_AND_FORTH&&(this._m_Time=this._m_TimeLength,this._m_TimeMode=-1)}this._m_Time+=t*this._m_TimeMode,this._m_TrackMixer.update(this._m_Time)}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=_,a(_,"S_LOOP",1),a(_,"S_DONT_LOOP",2),a(_,"S_BACK_AND_FORTH",3),a(_,"S_PLAY",1),a(_,"S_PAUSE",2),a(_,"S_STOP",4)},1648:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=o(n(9650));o(n(3846));function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _(e,t){return _=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_(e,t)}function s(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=l(e);if(t){var i=l(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return u(this,n)}}function u(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}var f=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_(e,t)}(o,e);var t,n,r,i=s(o);function o(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(n=i.call(this,e,t))._m_AnimationActions=[],n._m_AnimationActionMaps={},n._m_ActiveAnimationActions=[];var r=-1;return n._m_Scene.on("update",(function(e){if((r=n._m_ActiveAnimationActions.length)>0)for(var t=0;t<r;t++)n._m_ActiveAnimationActions[t].update(e)})),n}return t=o,(n=[{key:"getType",value:function(){return"AnimationProcessor"}},{key:"_activeAnimationAction",value:function(e){this._m_ActiveAnimationActions.push(e)}},{key:"_disableAnimationAction",value:function(e){var t=this._m_ActiveAnimationActions.indexOf(e);t>-1&&this._m_ActiveAnimationActions.splice(t,1)}},{key:"addAnimationAction",value:function(e){this._m_AnimationActionMaps[e.getName()]||(this._m_AnimationActionMaps[e.getName()]=e,this._m_AnimationActions.push(e),e._setProcessor(this))}},{key:"getAnimationAction",value:function(e){return this._m_AnimationActionMaps[e]}},{key:"getAnimationActionAtIndex",value:function(e){return e>=this._m_AnimationActions.length?null:this._m_AnimationActions[e]}},{key:"getAnimationActions",value:function(){return this._m_AnimationActions}}])&&a(t.prototype,n),r&&a(t,r),o}(i.default);t.default=f},9586:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return a="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},a(e,t,n||e)}function _(e,t){return _=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_(e,t)}function s(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=l(e);if(t){var i=l(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return u(this,n)}}function u(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var f=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_(e,t)}(u,e);var t,n,r,i=s(u);function u(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(n=i.call(this,e,t))._m_Bind=null,n}return t=u,(n=[{key:"getType",value:function(){return"Bone"}},{key:"bind",value:function(e){this._m_Bind=e}},{key:"getBind",value:function(){return this._m_Bind}},{key:"_updateLocalMatrix",value:function(){a(l(u.prototype),"_updateLocalMatrix",this).call(this),this._m_Bind&&this._m_Bind.actived()}}])&&o(t.prototype,n),r&&o(t,r),u}(((i=n(2949))&&i.__esModule?i:{default:i}).default);t.default=f},6458:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Time=t,this._m_Value=null,this._m_InterpolationMode=e.S_INTERPOLATION_MODE[e.S_LINEAR],this.interpolation=null}var t,r,i;return t=e,(r=[{key:"getTime",value:function(){return this._m_Time}},{key:"getValue",value:function(){return this._m_Value}},{key:"setInterpolationMode",value:function(t){this._m_InterpolationMode=e.S_INTERPOLATION_MODE[t]}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=i,r(i,"S_INTERPOLATION_MODE",{LINEAR:0}),r(i,"S_LINEAR","LINEAR")},7868:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n(6454)),i=o(n(8081));function o(e){return e&&e.__esModule?e:{default:e}}var a,_,s,u=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};t.default=u,a=u,_="S_KEY_FRAME",s={scale:r.default,rotation:i.default,translation:r.default},_ in a?Object.defineProperty(a,_,{value:s,enumerable:!0,configurable:!0,writable:!0}):a[_]=s},8081:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(6458)),o=a(n(453));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},s(e,t,n||e)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(f,e);var t,n,r,a=l(f);function f(e,t,n,r,i){var _;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(_=a.call(this,e))._m_Value=new o.default(t,n,r,i),_}return t=f,(n=[{key:"setInterpolationMode",value:function(e){s(c(f.prototype),"setInterpolationMode",this).call(this,e),e==i.default.S_LINEAR&&(this.interpolation=o.default.slerp)}}])&&_(t.prototype,n),r&&_(t,r),f}(i.default);t.default=m},6454:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(6458)),o=a(n(5604));a(n(3846));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},s(e,t,n||e)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(f,e);var t,n,r,a=l(f);function f(e,t,n,r){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(i=a.call(this,e))._m_Value=new o.default(t,n,r),i}return t=f,(n=[{key:"setInterpolationMode",value:function(e){s(c(f.prototype),"setInterpolationMode",this).call(this,e),e==i.default.S_LINEAR&&(this.interpolation=o.default.inter)}}])&&_(t.prototype,n),r&&_(t,r),f}(i.default);t.default=m},2414:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(6458)),o=a(n(7141));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},s(e,t,n||e)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(f,e);var t,n,r,a=l(f);function f(e,t,n,r,i){var _;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(_=a.call(this,e))._m_Value=new o.default(t,n,r,i),_}return t=f,(n=[{key:"setInterpolationMode",value:function(e){s(c(f.prototype),"setInterpolationMode",this).call(this,e),e==i.default.S_LINEAR&&(this.interpolation=o.default.inter)}}])&&_(t.prototype,n),r&&_(t,r),f}(i.default);t.default=m},1245:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(3846))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(t,n){switch(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Node=t,this._m_Node||i.default.warn("node为null:"),this.setValue=null,this.getValue=null,n){case"rotation":this.setValue=function(e){t.setLocalRotation(e)},this.getValue=function(){return t.getLocalRotation()};break;case"translation":this.setValue=function(e){t.setLocalTranslation(e)},this.getValue=function(){return t.getLocalTranslation()};break;case"scale":this.setValue=function(e){t.setLocalScale(e)},this.getValue=function(){return t.getLocalScale()}}}var t,n,r;return t=e,r=[{key:"bind",value:function(t,n){return new e(t,n)}},{key:"createTrack",value:function(t,n){t.setActionTrack(e.bind(n,t.getPathName()))}}],(n=null)&&o(t.prototype,n),r&&o(t,r),e}();t.default=a},7938:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Clips=[]}var t,r,i;return t=e,(r=[{key:"addClip",value:function(e){this._m_Clips.push(e)}},{key:"getClip",value:function(e){return this._m_Clips[e]}},{key:"getClips",value:function(){return this._m_Clips}},{key:"update",value:function(e){this._m_Clips.forEach((function(t){t.update(e)}))}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},8649:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n(2320)),i=o(n(3846));o(n(453)),o(n(431)),o(n(5397));function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_OwnerSkeleton=null,this._m_Bone=null,this._m_Refs={},this._m_Id=t,this._m_Num=n,this._m_RelMat4=new r.default,this._m_JointMat4=new r.default,this._m_IsActive=!1}var t,n,o;return t=e,(n=[{key:"actived",value:function(){this._m_IsActive||(this._m_IsActive=!0,this._m_OwnerSkeleton.addActiveJoint(this))}},{key:"disable",value:function(){this._m_IsActive=!1}},{key:"addRef",value:function(e,t){this._m_Refs[e]?this._m_Refs[e]!=t&&i.default.warn("ref不等于最新ref:"+t):this._m_Refs[e]=t}},{key:"init",value:function(e,t){this.update(e,t)}},{key:"getId",value:function(){return this._m_Id}},{key:"getNum",value:function(){return this._m_Num}},{key:"setOwnerSkeleton",value:function(e){this._m_OwnerSkeleton=e}},{key:"link",value:function(e){e!=this._m_Bone&&e&&(this._m_Bone=e,this._m_Bone.bind(this))}},{key:"setJointSpace",value:function(e){this._m_RelMat4.setArray(e)}},{key:"getJointMat4",value:function(){return this._m_JointMat4}},{key:"update",value:function(e,t){this._m_Bone?(r.default.multiplyMM(this._m_JointMat4,0,this._m_Bone.getWorldMatrix(),0,this._m_RelMat4,0),e.uniformMatrix4fv(this._m_Refs[t],!1,this._m_JointMat4.getBufferData())):i.default.log("joint_"+this.getNum()+";id:"+this.getId()+"未关联Bone!")}}])&&a(t.prototype,n),o&&a(t,o),e}();t.default=_},1608:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n(9784)),i=o(n(3846));function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Name=t,this._m_Joints=[],this._m_ActiveJoints=[],this._m_IsReady=!1,this._m_Finished=!0,this._m_OwnerShaders={}}var t,n,o;return t=e,(n=[{key:"init",value:function(e,t){this._m_IsReady||(this._m_IsReady=!0,this._m_Joints.forEach((function(n){n.setRef(t.m_LastSubShader.getRef(e,r.default.S_JOINTS_SRC+"["+n.getNum()+"]")),n.init(e)})))}},{key:"isReady",value:function(){return this._m_IsReady}},{key:"owner",value:function(e,t){return this._m_OwnerShaders[t.m_LastSubShader.getSId()]||(this._m_Joints.forEach((function(n){n.addRef(t.m_LastSubShader.getSId(),t.m_LastSubShader.getRef(e,r.default.S_JOINTS_SRC+"["+n.getNum()+"]")),n.init(e,t.m_LastSubShader.getSId())})),this._m_OwnerShaders[t.m_LastSubShader.getSId()]=!0,i.default.log("持有!")),!0}},{key:"isFinished",value:function(){return this._m_Finished}},{key:"finished",value:function(){this._m_Finished=!0}},{key:"getActiveJoints",value:function(){return this._m_ActiveJoints}},{key:"addActiveJoint",value:function(e){this._m_ActiveJoints.push(e)}},{key:"setJoints",value:function(e){var t=this;this._m_Joints.length=0,e.forEach((function(e){t._m_Joints.push(e),e.setOwnerSkeleton(t)}))}},{key:"getJoints",value:function(){return this._m_Joints}},{key:"addJointAtIndex",value:function(e,t){this._m_Joints[e]=t,t.setOwnerSkeleton(this)}},{key:"addJoint",value:function(e){this._m_Joints.push(e),e.setOwnerSkeleton(this)}},{key:"updateJoints",value:function(e,t){this._m_ActiveJoints.length>0&&(this._m_ActiveJoints.forEach((function(n){n.update(e,t.m_LastSubShader.getSId()),n.disable()})),this._m_ActiveJoints.length=0)}}])&&a(t.prototype,n),o&&a(t,o),e}();t.default=_},6858:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=u(n(4720)),o=u(n(9784)),a=u(n(2320)),_=u(n(2475)),s=u(n(3846));function u(e){return e&&e.__esModule?e:{default:e}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function c(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=h(e);if(t){var i=h(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return m(this,n)}}function m(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(u,e);var t,n,r,i=c(u);function u(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(n=i.call(this,e,t))._m_Skeleton=null,n}return t=u,(n=[{key:"setSkeleton",value:function(e){this._m_Skeleton=e}},{key:"draw",value:function(e){var t=this._m_Scene.getCanvas().getGLContext();if(this._m_Skeleton){if(!this._m_Skeleton.isFinished())return;this._m_Skeleton.owner(t,e)||s.default.log("错误持有!"),this._m_Skeleton.updateJoints(t,e)}var n=e.m_LastSubShader.getContextVars(),r=null,i=null;for(var u in n)switch(u){case o.default.S_MODEL_MATRIX_SRC:t[n[u].fun](n[u].loc,!1,this.getWorldMatrix().getBufferData());break;case o.default.S_MV_SRC:r=e.getCalcContext(o.default.S_VIEW_MATRIX_SRC),a.default.multiplyMM(_.default.S_TEMP_MAT4,0,r,0,this.getWorldMatrix(),0),n[u].fun(n[u].loc,!1,_.default.S_TEMP_MAT4.getBufferData());break;case o.default.S_MVP_SRC:r=e.getCalcContext(o.default.S_VIEW_MATRIX_SRC),i=e.getCalcContext(o.default.S_PROJECT_MATRIX_SRC),a.default.multiplyMM(_.default.S_TEMP_MAT4,0,r,0,this.getWorldMatrix(),0),a.default.multiplyMM(_.default.S_TEMP_MAT4_1,0,i,0,r,0),t[n[u].fun](n[u].loc,!1,_.default.S_TEMP_MAT4_1.getBufferData())}this._m_Mesh.draw(t)}}])&&l(t.prototype,n),r&&l(t,r),u}(i.default);t.default=d},9650:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n(8636)),i=o(n(66));function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n=n||{},this._mEvents=new i.default,this._m_NeedUpdate=!1,this._m_Id=n.id||r.default.nextId(),this._m_Components=[],this._m_ComponentIDs={},this._m_Scene=null,this._m_Owner=t,this._m_OwnerAttachComponents=[],this._m_OwnerAttachComponentIDs={},"Scene"==this.getType()?this._m_Scene=this:this._m_Scene=t._m_Scene,this._m_Scene.addComponentInScene(this),this._m_Owner&&this._m_Owner.attachComponent(this)}var t,n,o;return t=e,(n=[{key:"getType",value:function(){return null}},{key:"on",value:function(e,t,n){this._mEvents.register(e,t,n)}},{key:"off",value:function(e,t,n){this._mEvents.unregister(e,t,n)}},{key:"fire",value:function(e,t,n){this._mEvents.trigger(e,t,n)}},{key:"getId",value:function(){return this._m_Id}},{key:"attachComponent",value:function(t){t instanceof e?this._m_OwnerAttachComponentIDs[t.getId()]||(this._m_OwnerAttachComponentIDs[t.getId()]=t,this._m_OwnerAttachComponents.push(t)):console.error("component必须是一个组件!!")}},{key:"getComponent",value:function(e){return this._m_OwnerAttachComponentIDs[e]?this._m_OwnerAttachComponentIDs[e]:null}},{key:"getComponentAtIndex",value:function(e){return e>=this._m_OwnerAttachComponents.length?null:this._m_OwnerAttachComponents[e]}},{key:"getComponentAtType",value:function(e){for(var t=this._m_OwnerAttachComponents.length,n=0;n<t;n++)if(this._m_OwnerAttachComponents[n].getType()==e)return this._m_OwnerAttachComponents[n];return null}},{key:"getComponentAtTypes",value:function(e){for(var t=this._m_OwnerAttachComponents.length,n=null,r=0;r<t;r++)this._m_OwnerAttachComponents[r].getType()==e&&(n||(n=[]),n.push(this._m_OwnerAttachComponents[r]));return n}},{key:"getComponents",value:function(){return this._m_OwnerAttachComponents}},{key:"detachComponent",value:function(t){if(t instanceof e&&this._m_OwnerAttachComponentIDs[t.getId()]){this._m_OwnerAttachComponentIDs[t.getId()]=null;var n=this._m_OwnerAttachComponents.indexOf(t);n>-1&&this._m_OwnerAttachComponents.splice(n,1)}}},{key:"_doUpdate",value:function(e){this._m_NeedUpdate=!1,e?this._update&&this._update():this._m_Scene.scheduleTask(this._update,this)}},{key:"_update",value:function(){}}])&&a(t.prototype,n),o&&a(t,o),e}();t.default=_},5109:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(9650)),o=a(n(3846));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(a,e);var t,n,r,i=u(a);function a(e,t){var n;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),n=i.call(this,e,t),t.version=t.version||"webgl2",n._m_Canvas=t.canvas,n._m_Canvas){if(n._m_GL=n._m_Canvas.getContext(t.version,{antialias:!!t.antialias||!0,depth:!0,powerPreference:!!t.powerPreference||"high-performance",alpha:!!t.alpha||!1}),n._m_GL){if(n._m_GL.getExtension("OES_texture_float_linear"),"webgl2"==t.version)n._m_GL.getExtension("EXT_color_buffer_float");else if(n._m_GL.getExtension("OES_texture_float"),n._m_GL.getExtension("OES_texture_half_float"),n._m_GL.getExtension("OES_texture_half_float_linear"),t.mobile&&n._m_GL.getExtension("WEBGL_color_buffer_float"),!n._m_GL.getExtension("WEBGL_depth_texture"))return console.log("Extension Depth texture is not working"),alert(":( Sorry, Your browser doesn't support depth texture extension. Please browse to webglreport.com to see more information."),l(n);var r=n._m_GL.getExtension("EXT_texture_filter_anisotropic");if(r||console.log("不支持各向异性拓展!"),r){var _=n._m_GL.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT);console.log("maxAnisotropy:"+_)}n._init()}else o.default.error("浏览器不支持"+t.version+"!");n._sizeCanvas(n._m_Canvas.parentNode,n._m_Canvas)}return n}return t=a,(n=[{key:"_sizeCanvas",value:function(e,t){var n=this,r=function(){e?(t.width=e.clientWidth,t.height=e.clientHeight):(t.width=document.documentElement.clientWidth,t.height=document.documentElement.clientHeight),o.default.debug("改变大小:"+t.width+","+t.height),n.fire("resize",[t.width,t.height])};window.onresize=r,r()}},{key:"getCanvasElement",value:function(){return this._m_Canvas}},{key:"_init",value:function(){var e=this._m_GL;e.clearColor(.3,.3,.3,1),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.disable(e.BLEND),e.cullFace(e.BACK),e.depthFunc(e.LEQUAL)}},{key:"setClearColor",value:function(e,t,n,r){this._m_GL.clearColor(e,t,n,r)}},{key:"getWidth",value:function(){return this._m_Canvas.width}},{key:"getHeight",value:function(){return this._m_Canvas.height}},{key:"getGLContext",value:function(){return this._m_GL}}])&&_(t.prototype,n),r&&_(t,r),a}(i.default);t.default=c},7120:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(9650)),o=_(n(5397)),a=_(n(7280));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var i=d(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(e){f(n,e);var t=m(n);function n(e,r){var i;s(this,n),i=t.call(this,e,r);var _=function(e){f(n,e);var t=m(n);function n(e,r){return s(this,n),t.call(this,e,r)}return l(n,[{key:"getType",value:function(){return"FramePicture"}},{key:"isFramePicture",value:function(){return!0}}]),n}(a.default);return i._m_Enable=!0,i._m_FramePicture=new _(e,{id:o.default.nextId()}),i._m_PreFrames=null,i._m_PostFilters=null,i}return l(n,[{key:"getMaterial",value:function(){return this._m_FramePicture.getMaterial()}},{key:"finish",value:function(){this._init()}},{key:"_init",value:function(){this._m_FramePicture.getMaterial().getCurrentTechnology().getSubPasss(n.S_PRE_FRAME_FILTER)&&(this._m_PreFrames={},this._m_PreFrames[this._m_FramePicture.getMaterial().getId()]=[],this._m_PreFrames[this._m_FramePicture.getMaterial().getId()].push(this._m_FramePicture)),this._m_FramePicture.getMaterial().getCurrentTechnology().getSubPasss(n.S_POST_FILTER)&&(this._m_PostFilters={},this._m_PostFilters[this._m_FramePicture.getMaterial().getId()]=[],this._m_PostFilters[this._m_FramePicture.getMaterial().getId()].push(this._m_FramePicture))}},{key:"preFrame",value:function(e){this._m_PreFrames}},{key:"postFilter",value:function(){if(this._m_PostFilters){var e=this._m_Scene.getCanvas().getGLContext();this._m_Scene.getRender().draw(e,n.S_POST_FILTER,this._m_PostFilters)}}},{key:"isEnable",value:function(){return this._m_Enable}},{key:"enable",value:function(){this._m_Enable=!0}},{key:"disable",value:function(){this._m_Enable=!1}}],[{key:"newFilterFromMaterial",value:function(e,t){var r=new n(e,{id:o.default.nextId()});return r._m_FramePicture.setMaterial(t),r.finish(),r}}]),n}(i.default);t.default=g,p(g,"S_PRE_FRAME_FILTER","PreFrame"),p(g,"S_POST_FILTER","PostFilter")},8636:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=0,i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i,o;return t=e,o=[{key:"nextId",value:function(){return r--}}],(i=null)&&n(t.prototype,i),o&&n(t,o),e}();t.default=i},6984:(e,t)=>{function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};t.default=r,n(r,"CHASECAM_DOWN","ChaseCamDown"),n(r,"CHASECAM_UP","ChaseCamUp"),n(r,"CHASECAM_ZOOMIN","ChaseCamZoomIn"),n(r,"CHASECAM_ZOOMOUT","ChaseCamZoomOut"),n(r,"CHASECAM_MOVELEFT","ChaseCamMoveLeft"),n(r,"CHASECAM_MOVERIGHT","ChaseCamMoveRight"),n(r,"CHASECAM_TOGGLEROTATE","ChaseCamToggleRotate"),n(r,"CAMERA_MOVELEFT","CameraMoveLeft"),n(r,"CAMERA_MOVERIGHT","CameraMoveRight"),n(r,"CAMERA_MOVEFRONT","CameraMoveFront"),n(r,"CAMERA_MOVEBACK","CameraMoveBack"),n(r,"FLYCAM_LEFT","FLYCAM_Left"),n(r,"FLYCAM_RIGHT","FLYCAM_Right"),n(r,"FLYCAM_UP","FLYCAM_Up"),n(r,"FLYCAM_DOWN","FLYCAM_Down"),n(r,"FLYCAM_STRAFELEFT","FLYCAM_StrafeLeft"),n(r,"FLYCAM_STRAFERIGHT","FLYCAM_StrafeRight"),n(r,"FLYCAM_FORWARD","FLYCAM_Forward"),n(r,"FLYCAM_BACKWARD","FLYCAM_Backward"),n(r,"FLYCAM_ZOOMIN","FLYCAM_ZoomIn"),n(r,"FLYCAM_ZOOMOUT","FLYCAM_ZoomOut"),n(r,"FLYCAM_ROTATEDRAG","FLYCAM_RotateDrag"),n(r,"FLYCAM_RISE","FLYCAM_Rise"),n(r,"FLYCAM_LOWER","FLYCAM_Lower"),n(r,"FLYCAM_INVERTY","FLYCAM_InvertY")},8878:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=f(n(9650)),o=f(n(5604)),a=f(n(431)),_=f(n(1550)),s=f(n(2320)),u=f(n(4165)),l=f(n(2475));function f(e){return e&&e.__esModule?e:{default:e}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=p(e);if(t){var i=p(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return d(this,n)}}function d(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(f,e);var t,n,r,i=h(f);function f(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(n=i.call(this,e,t))._m_LastExTime=0,n._m_Camera=null,n._m_CameraList=function(e,t,r){n.refresh()},n.setCamera(t.camera||n._m_Scene.getMainCamera()),n._m_Position=new o.default,t.position=t.position||n._m_Camera.getEye(),t.position&&n._m_Position.setTo(t.position),n._m_Front=new o.default(0,0,-1),t.front=t.front||n._m_Camera.getAt().subRetNew(t.position).normal(),t.front&&n._m_Front.setTo(t.front),n._m_Up=new o.default,n._m_Right=new o.default,n._m_WorldUp=new o.default(0,1,0),t.up&&n._m_WorldUp.setTo(t.up),n._m_Yaw=t.yaw||f.YAW,n._m_Pitch=t.pitch||f.PITCH,n._m_MovementSpeed=t.movementSpeed||f.SPEED,n._m_MouseSensitivity=t.mouseSensitivity||f.SENSITIVITY,n._m_Zoom=t.zoom||f.ZOOM,n._m_ViewMatrix=new s.default,n._m_ViewMatrix.identity(),n.synYawPitch(),n.updateCameraVectors(),n._updateViewMatrix();var r=u.default.getInput(n._m_Scene,{id:n._m_Scene.getId()});return n._m_Scene.on("update",(function(e){n._m_LastExTime=e;var t=!1;r.getMouseButtonDown(u.default.S_MOUSE_BUTTON0)&&(n.processMouseMovement(r.getAmountX(),r.getAmountY(),!0),n.updateCameraVectors(),t=!0);var i=null;r.getKeyDown(u.default.S_KEY_W)?i=f.FORWARD:r.getKeyDown(u.default.S_KEY_S)&&(i=f.BACKWARD),r.getKeyDown(u.default.S_KEY_A)?i=f.LEFT:r.getKeyDown(u.default.S_KEY_D)&&(i=f.RIGHT),null!=i&&(t=!0,n.processKeyboard(i,n._m_LastExTime)),t&&n._doUpdate(!0)})),r.on("mousewheel",(function(e){e&&(n.processMouseScroll(e),n._m_Camera.scroll(n._m_Zoom))})),n}return t=f,(n=[{key:"setMovementSpeed",value:function(e){this._m_MovementSpeed=e}},{key:"setMouseSensitivity",value:function(e){this._m_MouseSensitivity=e}},{key:"refresh",value:function(){this._m_Position.setTo(this._m_Camera.getEye()),this._m_Front.setTo(this._m_Camera.getAt().subRetNew(this._m_Position).normal()),this.synYawPitch()}},{key:"setCamera",value:function(e){null!=e&&this._m_Camera!=e&&(this._m_Camera&&this._m_Camera.off(_.default.S_CAMERA_UPDATE_EVENT,this._m_CameraList),this._m_Camera=e,this._m_Camera.on(_.default.S_CAMERA_UPDATE_EVENT,this._m_CameraList))}},{key:"synYawPitch",value:function(){this._m_Pitch=a.default.toAngle(Math.asin(this._m_Front._m_Y));var e=Math.cos(a.default.toRadians(this._m_Pitch)),t=this._m_Front._m_Z/e;t>=1?t=1:t<=-1&&(t=-1),this._m_Yaw=a.default.toAngle(Math.asin(t)),Math.cos(a.default.toRadians(this._m_Yaw))*e*this._m_Front._m_X<0&&(this._m_Yaw=180-this._m_Yaw)}},{key:"processKeyboard",value:function(e,t){var n=this._m_MovementSpeed*t;e==f.FORWARD?(this._m_Front.multLength(n,l.default.S_TEMP_VEC3),this._m_Position.add(l.default.S_TEMP_VEC3)):e==f.BACKWARD?(this._m_Front.multLength(-1*n,l.default.S_TEMP_VEC3),this._m_Position.add(l.default.S_TEMP_VEC3)):e==f.LEFT?(this._m_Right.multLength(-1*n,l.default.S_TEMP_VEC3),this._m_Position.add(l.default.S_TEMP_VEC3)):e==f.RIGHT&&(this._m_Right.multLength(n,l.default.S_TEMP_VEC3),this._m_Position.add(l.default.S_TEMP_VEC3))}},{key:"processMouseMovement",value:function(e,t,n){n=null==n||null==n||n,e*=this._m_MouseSensitivity,t*=this._m_MouseSensitivity,this._m_Yaw+=e,this._m_Pitch+=t,n&&(this._m_Pitch>89?this._m_Pitch=89:this._m_Pitch<-89&&(this._m_Pitch=-89))}},{key:"processMouseScroll",value:function(e){this._m_Zoom-=e,this._m_Zoom<1&&(this._m_Zoom=1),this._m_Zoom>45&&(this._m_Zoom=45)}},{key:"_updateViewMatrix",value:function(){this._m_Position.add(this._m_Front,l.default.S_TEMP_VEC3),this._m_ViewMatrix.lookAt(this._m_Position,l.default.S_TEMP_VEC3,this._m_Up)}},{key:"getViewMatrix",value:function(){return this._m_ViewMatrix}},{key:"getViewMatrixArray",value:function(){return this.getViewMatrix().m}},{key:"updateCameraVectors",value:function(){l.default.S_TEMP_VEC3._m_X=Math.cos(a.default.toRadians(this._m_Yaw))*Math.cos(a.default.toRadians(this._m_Pitch)),l.default.S_TEMP_VEC3._m_Y=Math.sin(a.default.toRadians(this._m_Pitch)),l.default.S_TEMP_VEC3._m_Z=Math.sin(a.default.toRadians(this._m_Yaw))*Math.cos(a.default.toRadians(this._m_Pitch)),this._m_Front.setTo(l.default.S_TEMP_VEC3),this._m_Front.normal(),this._m_Front.cross(this._m_WorldUp,this._m_Right),this._m_Right.normal(),this._m_Right.cross(this._m_Front,this._m_Up),this._m_Up.normal()}},{key:"_update",value:function(){this._updateViewMatrix(),this._m_Camera.lookAt(this._m_Position,this._m_Position.add(this._m_Front,l.default.S_TEMP_VEC3),this._m_Up)}}])&&c(t.prototype,n),r&&c(t,r),f}(i.default);t.default=S,g(S,"FORWARD",1),g(S,"BACKWARD",S.FORWARD<<1),g(S,"LEFT",S.BACKWARD<<1),g(S,"RIGHT",S.LEFT<<1),g(S,"YAW",-90),g(S,"PITCH",0),g(S,"SPEED",10.5),g(S,"SENSITIVITY",.1),g(S,"ZOOM",45)},4165:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var f=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s);var r=(n=i.call(this,e,t))._m_Scene.getCanvas().getCanvasElement();n._keys={},n._mouseButtons={},n._mouseCoords=null,n._wheelDelta=0,n._amountX=0,n._amountY=0,n._mouseStartDownCoords=null,r.oncontextmenu=function(){return!1},r.onkeydown=function(e){n._keys[s.S_KEYS[e.key]]=!0,n.fire("keydown",[s.S_KEYS[e.key]])},r.onkeyup=function(e){n._keys[s.S_KEYS[e.key]]=!1,n.fire("keyup",[s.S_KEYS[e.key]])},r.onkeypress=function(e){n.fire("keypress",[s.S_KEYS[e.key]])};var o=!1;r.onmousedown=function(e){o=!0,n._wheelDelta=0,n._amountX=0,n._amountY=0,n._mouseCoords=n._getClickCoordsWithinElement(e),n._mouseStartDownCoords=n._mouseCoords;var t=null;switch(e.which||e.button+1){case 1:n._mouseButtons[s.S_MOUSE_BUTTON0]=!0,t=s.S_MOUSE_BUTTON0_DOWN;break;case 2:n._mouseButtons[s.S_MOUSE_BUTTON1]=!0,t=s.S_MOUSE_BUTTON1_DOWN;break;case 3:n._mouseButtons[s.S_MOUSE_BUTTON2]=!0,t=s.S_MOUSE_BUTTON2_DOWN}n.fire("mousedown",[t])},r.onmouseup=function(e){o=!1,n._wheelDelta=0,n._amountX=0,n._amountY=0,n._mouseCoords=n._getClickCoordsWithinElement(e),n._mouseStartDownCoords=n._mouseCoords;var t=null;switch(e.which||e.button+1){case 1:n._mouseButtons[s.S_MOUSE_BUTTON0]=!1,t=s.S_MOUSE_BUTTON0_UP;break;case 2:n._mouseButtons[s.S_MOUSE_BUTTON1]=!1,t=s.S_MOUSE_BUTTON1_UP;break;case 3:n._mouseButtons[s.S_MOUSE_BUTTON2]=!1,t=s.S_MOUSE_BUTTON2_UP}n.fire("mouseup",[t])};var a=!1;return r.onmouseenter=function(e){n._wheelDelta=0,n._amountX=0,n._amountY=0,a=!0,n._mouseCoords=n._getClickCoordsWithinElement(e)},r.onmouseout=function(e){n._wheelDelta=0,n._amountX=0,n._amountY=0,a=!1,n._mouseCoords=n._getClickCoordsWithinElement(e)},r.onmousemove=function(e){a&&(n._wheelDelta=0,n._mouseCoords=n._getClickCoordsWithinElement(e),o&&(n._amountX=n._mouseCoords[0]-n._mouseStartDownCoords[0],n._amountY=n._mouseCoords[1]-n._mouseStartDownCoords[1],n._mouseStartDownCoords[0]=n._mouseCoords[0],n._mouseStartDownCoords[1]=n._mouseCoords[1]),n.fire("mousemove",[n._mouseCoords]))},r.onmousewheel=function(e){n._amountX=0,n._amountY=0,n._mouseCoords=n._getClickCoordsWithinElement(e),e.wheelDelta?(n._wheelDelta=e.wheelDelta/120,window.opera&&(n._wheelDelta=-n._wheelDelta)):e.detail&&(n._wheelDelta=-e.detail/3),n.fire("mousewheel",[n._wheelDelta])},n}return t=s,r=[{key:"getInput",value:function(e,t){if(s.S_INPUTS[t.id])return s.S_INPUTS[t.id];var n=new s(e,t);return s.S_INPUTS[t.id]=n,n}}],(n=[{key:"getMouseButtonDown",value:function(e){return this._mouseButtons[e]}},{key:"getKeyDown",value:function(e){return this._keys[e]}},{key:"getKeyUp",value:function(e){return!this._keys[e]}},{key:"getAmountX",value:function(){return this._amountX}},{key:"getAmountY",value:function(){return-this._amountY}},{key:"getMouseCoords",value:function(){return this._mouseCoords}},{key:"getWheelDelta",value:function(){return this._wheelDelta}},{key:"_getClickCoordsWithinElement",value:function(e){var t=[0,0];if(e){for(var n=e.target,r=0,i=0;n.offsetParent;)r+=n.offsetLeft,i+=n.offsetTop,n=n.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-i}else e=window.event,t.x=e.x,t.y=e.y;return t}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(9650))&&i.__esModule?i:{default:i}).default);t.default=f,l(f,"s_Inputs",{}),l(f,"S_KEY_0",0),l(f,"S_KEY_1",1),l(f,"S_KEY_2",2),l(f,"S_KEY_3",3),l(f,"S_KEY_4",4),l(f,"S_KEY_5",5),l(f,"S_KEY_6",6),l(f,"S_KEY_7",7),l(f,"S_KEY_8",8),l(f,"S_KEY_9",9),l(f,"S_KEY_A",10),l(f,"S_KEY_B",11),l(f,"S_KEY_C",12),l(f,"S_KEY_D",13),l(f,"S_KEY_E",14),l(f,"S_KEY_F",15),l(f,"S_KEY_G",16),l(f,"S_KEY_H",17),l(f,"S_KEY_I",18),l(f,"S_KEY_J",19),l(f,"S_KEY_K",20),l(f,"S_KEY_L",21),l(f,"S_KEY_M",22),l(f,"S_KEY_N",23),l(f,"S_KEY_O",24),l(f,"S_KEY_P",25),l(f,"S_KEY_Q",26),l(f,"S_KEY_R",27),l(f,"S_KEY_S",28),l(f,"S_KEY_T",29),l(f,"S_KEY_U",30),l(f,"S_KEY_V",31),l(f,"S_KEY_W",32),l(f,"S_KEY_X",33),l(f,"S_KEY_Y",34),l(f,"S_KEY_Z",35),l(f,"S_KEYS",{0:f.S_KEY_0,1:f.S_KEY_1,2:f.S_KEY_2,3:f.S_KEY_3,4:f.S_KEY_4,5:f.S_KEY_5,6:f.S_KEY_6,7:f.S_KEY_7,8:f.S_KEY_8,9:f.S_KEY_9,a:f.S_KEY_A,b:f.S_KEY_B,c:f.S_KEY_C,d:f.S_KEY_D,e:f.S_KEY_E,f:f.S_KEY_F,g:f.S_KEY_G,h:f.S_KEY_H,i:f.S_KEY_I,j:f.S_KEY_J,k:f.S_KEY_K,l:f.S_KEY_L,m:f.S_KEY_M,n:f.S_KEY_N,o:f.S_KEY_O,p:f.S_KEY_P,q:f.S_KEY_Q,r:f.S_KEY_R,s:f.S_KEY_S,t:f.S_KEY_T,u:f.S_KEY_U,v:f.S_KEY_V,w:f.S_KEY_W,x:f.S_KEY_X,y:f.S_KEY_Y,z:f.S_KEY_Z}),l(f,"S_MOUSE_BUTTON0_DOWN",36),l(f,"S_MOUSE_BUTTON1_DOWN",37),l(f,"S_MOUSE_BUTTON2_DOWN",38),l(f,"S_MOUSE_BUTTON0_UP",39),l(f,"S_MOUSE_BUTTON1_UP",40),l(f,"S_MOUSE_BUTTON2_UP",41),l(f,"S_MOUSE_BUTTON0",42),l(f,"S_MOUSE_BUTTON1",43),l(f,"S_MOUSE_BUTTON2",44),l(f,"S_INPUTS",{})},2028:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=u(n(5604)),o=u(n(431)),a=u(n(9650)),_=u(n(4165)),s=u(n(6984));function u(e){return e&&e.__esModule?e:{default:e}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function c(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var i=d(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return m(this,n)}}function m(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(u,e);var t,n,r,a=c(u);function u(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),p(h(n=a.call(this,e,t)),"_m_Enabled",!0),p(h(n),"_m_Rotating",!0),p(h(n),"_m_VRotating",!0),p(h(n),"_m_CanRotate",!0),p(h(n),"_m_Rotation",0),p(h(n),"_m_VRotation",Math.PI/6),p(h(n),"_m_PreviousTargetRotation",0),p(h(n),"_m_TargetRotation",n._m_Rotation),p(h(n),"_m_TargetVRotation",n._m_VRotation),p(h(n),"_m_RotationSpeed",.3),p(h(n),"_m_ZoomSensitivity",2),p(h(n),"_m_ZoomSpeed",1),p(h(n),"_m_VeryCloseRotation",!0),p(h(n),"_m_MaxVerticalRotation",Math.PI/2),p(h(n),"_m_MinVerticalRotation",-Math.PI/2),p(h(n),"_m_Distance",1),p(h(n),"_m_TargetDistance",n._m_Distance),p(h(n),"_m_MinDistance",1),p(h(n),"_m_MaxDistance",10),p(h(n),"_m_Chasing",!0),p(h(n),"_m_Zooming",!0),p(h(n),"_m_Zoomin",!1),p(h(n),"_m_TrailingRotationInertia",.05),p(h(n),"_m_DistanceLerpFactor",0),p(h(n),"_m_TrailingLerpFactor",0),p(h(n),"_m_TrailingSensitivity",5),p(h(n),"_m_RotationSensitivity",5),p(h(n),"_m_TrailingEnabled",!0),p(h(n),"_m_SmoothMotion",!0),p(h(n),"_m_TargetLocation",new i.default),p(h(n),"_m_TargetDir",new i.default),p(h(n),"_m_OffsetDistance",.002),p(h(n),"_m_Target",new i.default),p(h(n),"_m_LookAtOffset",new i.default),p(h(n),"_m_PrevPos",new i.default),p(h(n),"temp",new i.default),p(h(n),"temp2",new i.default),p(h(n),"_m_Pos",new i.default),p(h(n),"_m_InitialUpVec",(new i.default).setTo(i.default.S_UNIT_AXIS_Y)),p(h(n),"_m_Cam",void 0),p(h(n),"_m_ChasingSensitivity",5),p(h(n),"_m_Input",void 0),p(h(n),"_m_TargetMoves",!1),n._m_Cam=t.camera||n._m_Scene.getMainCamera(),n._m_Input=_.default.getInput(n._m_Scene,{id:n._m_Scene.getId()});var r=0;return n._m_Scene.on("update",(function(e){r=e,n.updateCamera(e)})),n._m_Input.on("mousewheel",(function(e){e&&n.analog(e>0?s.default.CHASECAM_ZOOMIN:s.default.CHASECAM_ZOOMOUT,(e>0?e:-e)*n._m_ZoomSpeed,r)})),n}return t=u,(n=[{key:"setRotationSpeed",value:function(e){this._m_RotationSpeed=e}},{key:"getRotationSpeed",value:function(){return this._m_RotationSpeed}},{key:"setZoomSpeed",value:function(e){this._m_ZoomSpeed=e}},{key:"getZoomSpeed",value:function(){return this._m_ZoomSpeed}},{key:"setTargetDistance",value:function(e){this._m_TargetDistance=e}},{key:"getDistance",value:function(){return this._m_Distance}},{key:"lookScene",value:function(e){if(e){var t=e.getBoundingVolume(),n=2*t.getXHalf(),r=2*t.getYHalf(),o=2*t.getZHalf(),a=5*Math.sqrt(Math.pow(n,2)+Math.pow(r,2)+Math.pow(o,2)),_=a/5e3,s=a-_,u=2*Math.max(n,r,o);this.setTargetDistance(.5*(u-_)+_),this.setMaxDistance(u),this.setMinDistance(_),this.setZoomSpeed(.2*s);var l=new i.default;t.getCenter(l),this.setTarget(l)}}},{key:"setTarget",value:function(e){this._m_Target.setTo(e)}},{key:"syncNavDir",value:function(e,t){this._m_TargetDir.setToInXYZ(e[0],e[1],e[2]),this._m_TargetDir.normal(),this._m_TargetVRotation=Math.asin(this._m_TargetDir.y);var n=Math.cos(this._m_TargetVRotation),r=this._m_TargetDir.z/n;r>=1?r=1:r<=-1&&(r=-1),this._m_TargetRotation=Math.asin(r),Math.cos(this._m_TargetRotation)*n*this._m_TargetDir.x<0&&(this._m_TargetRotation=Math.PI+-this._m_TargetRotation),this._m_Rotating=!0,this._m_VRotating=!0,t&&(this._m_Zooming=!0,this.setTargetDistance(this._m_MaxDistance))}},{key:"rotate",value:function(e,t){var n=this._m_RotationSpeed;this._m_RotationSpeed=Math.PI/100,this._rotate1(e),this._rotate2(t),this._m_RotationSpeed=n}},{key:"_rotate1",value:function(e){this._m_CanRotate&&this._m_Enabled&&(this._m_Rotating=!0,this._m_TargetRotation+=e*this._m_RotationSpeed)}},{key:"_rotate2",value:function(e){if(this._m_CanRotate&&this._m_Enabled){this._m_VRotating=!0;var t=this._m_TargetVRotation;this._m_TargetVRotation+=e*this._m_RotationSpeed,this._m_TargetVRotation>this._m_MaxVerticalRotation&&(this._m_TargetVRotation=t),this._m_VeryCloseRotation?this._m_TargetVRotation<this._m_MinVerticalRotation&&this._m_TargetDistance>this._m_MinDistance+1?this._m_TargetVRotation=this._m_MinVerticalRotation:this._m_TargetVRotation<90*-o.default.S_DEG_TO_RAD&&(this._m_TargetVRotation=t):this._m_TargetVRotation<this._m_MinVerticalRotation&&(this._m_TargetVRotation=t)}}},{key:"setMinVerticalRotation",value:function(e){this._m_MinVerticalRotation=e}},{key:"setMaxVerticalRotation",value:function(e){this._m_MaxVerticalRotation=e}},{key:"_zoomCamera",value:function(e){this._m_Enabled&&(this._m_Zooming=!0,this._m_TargetDistance+=e*this._m_ZoomSensitivity,this._m_TargetDistance>this._m_MaxDistance&&(this._m_TargetDistance=this._m_MaxDistance),this._m_TargetDistance<this._m_MinDistance&&(this._m_TargetDistance=this._m_MinDistance),this._m_VeryCloseRotation&&this._m_TargetVRotation<this._m_MinVerticalRotation&&this._m_TargetDistance>this._m_MinDistance+1&&(this._m_TargetVRotation=this._m_MinVerticalRotation))}},{key:"_checkInput",value:function(e){if(this._m_Input.getMouseButtonDown(_.default.S_MOUSE_BUTTON0)){var t=this._m_Input.getAmountX(),n=this._m_Input.getAmountY();0!=t&&this.analog(t>0?s.default.CHASECAM_MOVERIGHT:s.default.CHASECAM_MOVELEFT,t>0?t:-t,e),0!=n&&this.analog(n>0?s.default.CHASECAM_DOWN:s.default.CHASECAM_UP,n>0?n:-n,e)}}},{key:"updateCamera",value:function(e){this._m_Enabled&&(this._checkInput(e),this._updateCamera(e))}},{key:"_updateCamera",value:function(e){if(this._m_Enabled){if(this._m_TargetLocation.setTo(this._m_Target).add(this._m_LookAtOffset),this._m_SmoothMotion){this._m_TargetDir.setTo(this._m_TargetLocation).sub(this._m_PrevPos);var t=this._m_TargetDir.length();if(this._m_OffsetDistance<t?(this._m_Chasing=!0,this._m_TrailingEnabled&&(this._m_Trailing=!0),this._m_TargetMoves=!0):(this._m_TargetMoves&&!this._m_CanRotate&&(this._m_TargetRotation-this._m_Rotation>this._m_TrailingRotationInertia?this._m_TargetRotation=this._m_Rotation+this._m_TrailingRotationInertia:this._m_TargetRotation-this._m_Rotation<-this._m_TrailingRotationInertia&&(this._m_TargetRotation=this._m_Rotation-this._m_TrailingRotationInertia)),this._m_TargetMoves=!1),this._m_CanRotate&&(this._m_TrailingLerpFactor=0,this._m_Trailing=!1),this._m_TrailingEnabled&&this._m_Trailing){if(this._m_TargetMoves){var n=this._m_TargetDir.negate().normal(),r=i.default.S_UNIT_AXIS_X;n.y=0,this._m_TargetDir.z>0?this._m_TargetRotation=o.default.S_TWO_PI-Math.acos(n.dot(r)):this._m_TargetRotation=Math.acos(n.dot(r)),(this._m_TargetRotation-this._m_Rotation>Math.PI||this._m_TargetRotation-this._m_Rotation<-Math.PI)&&(this._m_TargetRotation-=o.default.S_TWO_PI),this._m_TargetRotation!=this._m_PreviousTargetRotation&&Math.abs(this._m_TargetRotation-this._m_PreviousTargetRotation)>Math.PI/8&&(this._m_TrailingLerpFactor=0),this._m_PreviousTargetRotation=this._m_TargetRotation}this._m_TrailingLerpFactor=Math.min(this._m_TrailingLerpFactor+e*e*this._m_TrailingSensitivity,1),this._m_Rotation=o.default.interpolateLinear(this._m_TrailingLerpFactor,this._m_Rotation,this._m_TargetRotation),this._m_TargetRotation+.01>=this._m_Rotation&&this._m_TargetRotation-.01<=this._m_Rotation&&(this._m_Trailing=!1,this._m_TrailingLerpFactor=0)}this._m_Chasing&&(this.temp2.setTo(this._m_Cam.getEye()),this._m_Distance=this.temp.setTo(this._m_TargetLocation).sub(this.temp2).length(),this._m_DistanceLerpFactor=Math.min(this._m_DistanceLerpFactor+e*e*this._m_ChasingSensitivity*.05,1),this._m_Distance=o.default.interpolateLinear(this._m_DistanceLerpFactor,this._m_Distance,this._m_TargetDistance),this._m_TargetDistance+.01>=this._m_Distance&&this._m_TargetDistance-.01<=this._m_Distance&&(this._m_DistanceLerpFactor=0,this._m_Chasing=!1)),this._m_Zooming&&(this._m_DistanceLerpFactor=Math.min(this._m_DistanceLerpFactor+e*e*this._m_ZoomSensitivity,1),this._m_Distance=o.default.interpolateLinear(this._m_DistanceLerpFactor,this._m_Distance,this._m_TargetDistance),this._m_TargetDistance+.1>=this._m_Distance&&this._m_TargetDistance-.1<=this._m_Distance&&(this._m_Zooming=!1,this._m_DistanceLerpFactor=0)),this._m_Rotating&&(this._m_RotationLerpFactor=Math.min(this._m_RotationLerpFactor+e*e*this._m_RotationSensitivity,1),this._m_Rotation=o.default.interpolateLinear(this._m_RotationLerpFactor,this._m_Rotation,this._m_TargetRotation),this._m_TargetRotation+.01>=this._m_Rotation&&this._m_TargetRotation-.01<=this._m_Rotation&&(this._m_Rotating=!1,this._m_RotationLerpFactor=0)),this._m_VRotating&&(this._m_VRotationLerpFactor=Math.min(this._m_VRotationLerpFactor+e*e*this._m_RotationSensitivity,1),this._m_VRotation=o.default.interpolateLinear(this._m_VRotationLerpFactor,this._m_VRotation,this._m_TargetVRotation),this._m_TargetVRotation+.01>=this._m_VRotation&&this._m_TargetVRotation-.01<=this._m_VRotation&&(this._m_VRotating=!1,this._m_VRotationLerpFactor=0)),this.computePosition(),this._m_Pos.add(this._m_LookAtOffset)}else this._m_VRotation=this._m_TargetVRotation,this._m_Rotation=this._m_TargetRotation,this._m_Distance=this._m_TargetDistance,this.computePosition(),this._m_Pos.add(this._m_LookAtOffset);this._m_PrevPos.setTo(this._m_TargetLocation),this._m_Cam.lookAt(this._m_Pos,this._m_TargetLocation,this._m_InitialUpVec)}}},{key:"computePosition",value:function(){var e=this._m_Distance*Math.sin(Math.PI/2-this._m_VRotation);this._m_Pos.setToInXYZ(e*Math.cos(this._m_Rotation),this._m_Distance*Math.sin(this._m_VRotation),e*Math.sin(this._m_Rotation)),this._m_Pos.add(this._m_Target)}},{key:"analog",value:function(e,t,n){e==s.default.CHASECAM_MOVELEFT?this._rotate1(-t*n):e==s.default.CHASECAM_MOVERIGHT?this._rotate1(t*n):e==s.default.CHASECAM_UP?this._rotate2(t*n):e==s.default.CHASECAM_DOWN?this._rotate2(-t*n):e==s.default.CHASECAM_ZOOMIN?(this._zoomCamera(-t*n),0==this._m_Zoomin&&(this._m_DistanceLerpFactor=0),this._m_Zoomin=!0):e==s.default.CHASECAM_ZOOMOUT&&(this._zoomCamera(+t*n),1==this._m_Zoomin&&(this._m_DistanceLerpFactor=0),this._m_Zoomin=!1)}},{key:"isEnabled",value:function(){return this._m_Enabled}},{key:"setEnabled",value:function(e){this._m_Enabled=e,this._m_CanRotate=e}},{key:"getMaxDistance",value:function(){return this._m_MaxDistance}},{key:"setMaxDistance",value:function(e){this._m_MaxDistance=e,e<this._m_Distance&&this._zoomCamera(e-this._m_Distance)}},{key:"getMinDistance",value:function(){return this._m_MinDistance}},{key:"setMinDistance",value:function(e){this._m_MinDistance=e,e>this._m_Distance&&this._zoomCamera(this._m_Distance-e)}}])&&l(t.prototype,n),r&&l(t,r),u}(a.default);t.default=g},7539:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=s(n(513)),o=s(n(5604)),a=s(n(6177)),_=s(n(3846));function s(e){return e&&e.__esModule?e:{default:e}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=m(e);if(t){var i=m(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return c(this,n)}}function c(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(s,e);var t,n,r,i=f(s);function s(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(n=i.call(this,e,t))._m_Direction=new o.default,n}return t=s,(n=[{key:"getType",value:function(){return"DirectionalLight"}},{key:"getTypeId",value:function(){return 0}},{key:"_genShadow",value:function(){this._m_ShadowCfg.id=this._m_Id+"_shadow",this._m_ShadowCfg.nbSplits=this._m_ShadowCfg.nbSplits||2,this._m_Shadow=new a.default(this._m_Scene,this._m_ShadowCfg)}},{key:"setShadowSplitNum",value:function(e){(e<1||e>4)&&_.default.error("错误的分区数目:"+e),this._m_ShadowCfg.nbSplits=e||2}},{key:"setShadowSplitType",value:function(e){this._m_ShadowCfg.shadowSplitType=e}},{key:"setDirection",value:function(e){this._m_Direction.setTo(e)}},{key:"getDirection",value:function(){return this._m_Direction}},{key:"setDirectionXYZ",value:function(e,t,n){this._m_Direction.setToInXYZ(e,t,n),this._m_Direction.normal()}},{key:"getBoundingVolume",value:function(){return null}}])&&u(t.prototype,n),r&&u(t,r),s}(i.default);t.default=d,h(d,"S_SHADER_SPLIT_TYPE_HALF_TRANSITION",1),h(d,"S_SHADER_SPLIT_TYPE_FIXED",2)},2815:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(6967)),o=_(n(1846)),a=_(n(1446));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(_,e);var t,n,r,i=l(_);function _(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_),(n=i.call(this,e,t))._m_ShCoeffs=null,n._m_ShCoeffsBufferData=null,n._m_PrefilterEnvMap=null,n._m_PrefilterMipmap=0,n._m_Bounding=new o.default,n}return t=_,(n=[{key:"getType",value:function(){return"GIProbe"}},{key:"getTypeId",value:function(){return 4}},{key:"setPrefilterMipmap",value:function(e){this._m_PrefilterMipmap=e}},{key:"getPrefilterMipmap",value:function(){return this._m_PrefilterMipmap}},{key:"setRadius",value:function(e){this._m_Bounding.setRaiuds(e)}},{key:"getRadius",value:function(){return this._m_Bounding.getRadius()}},{key:"setShCoeffs",value:function(e){this._m_ShCoeffs=e,this._m_ShCoeffsBufferData=new a.default(27);for(var t=this._m_ShCoeffsBufferData.getArray(),n=0,r=0;n<e.length;n++)t[r++]=e[n]._m_X,t[r++]=e[n]._m_Y,t[r++]=e[n]._m_Z}},{key:"getShCoeffs",value:function(){return this._m_ShCoeffs}},{key:"getShCoeffsBufferData",value:function(){return this._m_ShCoeffsBufferData}},{key:"setPrefilterEnvMap",value:function(e){this._m_PrefilterEnvMap=e}},{key:"getPrefilterEnvMap",value:function(){return this._m_PrefilterEnvMap}}])&&s(t.prototype,n),r&&s(t,r),_}(i.default);t.default=m},513:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(2949)),o=a(n(7141));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(a,e);var t,n,r,i=u(a);function a(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),(n=i.call(this,e,t))._m_Color=new o.default,n._m_Enable=!0,n._m_Scene.enableLight(f(n)),n._m_ProShadow=!1,n._m_ResetProShadow=n._m_ProShadow,n._m_Shadow=null,n._m_ShadowCfg={shadowMapSize:512,backfaceShadows:!1,debug:!1},n._m_Mark=0,n._init(),n}return t=a,(n=[{key:"getType",value:function(){return"Light"}},{key:"getTypeId",value:function(){return-1}},{key:"_init",value:function(){this._m_Mark|=a.S_VISIBLE_LIGHT,this._m_Mark|=a.S_DYNAMIC}},{key:"enable",value:function(){this._m_Enable||(this._m_Enable=!0,this._m_Scene.enableLight(this),this._m_ResetProShadow&&(this._m_ResetProShadow=!1,this.proShadow(!0)))}},{key:"getShadow",value:function(){return this._m_Shadow}},{key:"setShadowMapSize",value:function(e){this._m_ShadowCfg.shadowMapSize=e}},{key:"debugShadowMap",value:function(){this._m_ShadowCfg.debug=!0}},{key:"proShadow",value:function(e){this._m_ProShadow=e,this._m_ProShadow&&!this._m_Shadow&&(this._genShadow(),this._m_Shadow&&this._m_Shadow.setLight(this)),this._m_Shadow&&this._m_Shadow.enable(e)}},{key:"isProShadow",value:function(){return this._m_ProShadow}},{key:"_genShadow",value:function(){}},{key:"disable",value:function(){this._m_Enable&&(this._m_Enable=!1,this._m_Scene.disableLight(this),this._m_ProShadow&&(this._m_ResetProShadow=this._m_ProShadow,this.proShadow(!1)))}},{key:"isEnable",value:function(){return this._m_Enable}},{key:"setColor",value:function(e){this._m_Color.setTo(e)}},{key:"getColor",value:function(){return this._m_Color}},{key:"setColorRGBA",value:function(e,t,n,r){this._m_Color.setToInXYZW(e,t,n,r)}},{key:"updateBounding",value:function(){this._updateBounding()}}])&&_(t.prototype,n),r&&_(t,r),a}(i.default);t.default=h,m(h,"S_VISIBLE_LIGHT",1),m(h,"S_STATIC_LIGHT",2),m(h,"S_DYNAMIC",3)},6807:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=s(n(513)),o=s(n(5604)),a=s(n(1846)),_=s(n(4867));function s(e){return e&&e.__esModule?e:{default:e}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=m(e);if(t){var i=m(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return c(this,n)}}function c(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(s,e);var t,n,r,i=f(s);function s(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(n=i.call(this,e,t))._m_Position=new o.default,n._m_Radius=-1,n._m_StepClip=.2,n._m_InvRadius=1/n._m_Radius,n._m_InvRadius2=1/(n._m_Radius-n._m_StepClip),n}return t=s,(n=[{key:"getType",value:function(){return"PointLight"}},{key:"getTypeId",value:function(){return 1}},{key:"_genShadow",value:function(){this._m_ShadowCfg.id=this._m_Id+"_shadow",this._m_Shadow=new _.default(this._m_Scene,this._m_ShadowCfg)}},{key:"setStepClip",value:function(e){e<0&&(e=1),this._m_StepClip=e,this._m_InvRadius2=1/(this._m_Radius-this._m_StepClip)}},{key:"getStepClip",value:function(){return this._m_StepClip}},{key:"setPosition",value:function(e){this._m_Position.setTo(e),this._updateBounding()}},{key:"getPosition",value:function(){return this._m_Position}},{key:"setPositionXYZ",value:function(e,t,n){this._m_Position.setToInXYZ(e,t,n),this._updateBounding()}},{key:"setRadius",value:function(e){this._m_Radius=e,this._m_InvRadius=1/e,this._updateBounding()}},{key:"getRadius",value:function(){return this._m_Radius}},{key:"getInRadius",value:function(){return this._m_InvRadius}},{key:"getInRadius2",value:function(){return this._m_InvRadius2}},{key:"getBoundingVolume",value:function(){return this._m_UpdateBoundingVolume&&(this._m_BoudingVolume||(this._m_BoudingVolume=new a.default),this._m_BoudingVolume.setCenter(this._m_Position),this._m_BoudingVolume.setRaiuds(this._m_Radius),this._m_UpdateBoundingVolume=!1),this._m_BoudingVolume}}])&&u(t.prototype,n),r&&u(t,r),s}(i.default);t.default=h},6967:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(513)),o=a(n(5604));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(a,e);var t,n,r,i=u(a);function a(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),(n=i.call(this,e,t))._m_Position=new o.default,n}return t=a,(n=[{key:"getType",value:function(){return"Probe"}},{key:"getTypeId",value:function(){return 100}},{key:"setPositionFromXYZ",value:function(e,t,n){this._m_Position.setToInXYZ(e,t,n)}},{key:"getPosition",value:function(){return this._m_Position}}])&&_(t.prototype,n),r&&_(t,r),a}(i.default);t.default=c},3330:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e,t){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),i.call(this,e,t)}return t=s,(n=[{key:"getType",value:function(){return"RefProbe"}},{key:"getTypeId",value:function(){return 5}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(6967))&&i.__esModule?i:{default:i}).default);t.default=l},9098:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=l(n(513)),o=l(n(5604)),a=l(n(431)),_=l(n(1846)),s=l(n(2475)),u=l(n(948));function l(e){return e&&e.__esModule?e:{default:e}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var i=d(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(l,e);var t,n,r,i=m(l);function l(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),(n=i.call(this,e,t))._m_Direction=new o.default,n._m_Position=new o.default,n._m_InnerAngle=a.default.toRadians(30),n._m_InnerCorner=Math.cos(n._m_InnerAngle),n._m_OuterAngle=a.default.toRadians(45),n._m_OuterCorner=Math.cos(n._m_OuterAngle),n._m_SpotRange=100,n._m_StepClip=4,n._m_InvSpotRange=1/n._m_SpotRange,n._m_InnerMinusOuter=n._m_InnerCorner-n._m_OuterCorner,n._m_PackedAngleCos=0,n.computeAngleParameters(),n}return t=l,(n=[{key:"getType",value:function(){return"SpotLight"}},{key:"getTypeId",value:function(){return 2}},{key:"_genShadow",value:function(){this._m_ShadowCfg.id=this._m_Id+"_shadow",this._m_Shadow=new u.default(this._m_Scene,this._m_ShadowCfg)}},{key:"setStepClip",value:function(e){e<0&&(e=1),this._m_StepClip=e}},{key:"getStepClip",value:function(){return this._m_StepClip}},{key:"getPackedAngleCos",value:function(){return this._m_PackedAngleCos}},{key:"computeAngleParameters",value:function(){this._m_PackedAngleCos=Math.floor(1e3*this._m_InnerCorner),this._m_PackedAngleCos==Math.floor(1e3*this._m_OuterCorner)&&(this._m_OuterCorner-=.001),this._m_PackedAngleCos+=1*this._m_OuterCorner}},{key:"getInnerMinusOuter",value:function(){return this._m_InnerMinusOuter}},{key:"setSpotRange",value:function(e){e<=0?(this._m_SpotRange=0,this._m_InvSpotRange=0):(this._m_SpotRange=e,this._m_InvSpotRange=1/this._m_SpotRange)}},{key:"getSpotRange",value:function(){return this._m_SpotRange}},{key:"getInvSpotRange",value:function(){return this._m_InvSpotRange}},{key:"setInnerAngle",value:function(e){this._m_InnerAngle=e,this._m_InnerCorner=Math.cos(this._m_InnerAngle),this._m_InnerMinusOuter=this._m_InnerCorner-this._m_OuterCorner,this.computeAngleParameters()}},{key:"getInnerAngle",value:function(){return this._m_InnerAngle}},{key:"setOuterAngle",value:function(e){this._m_OuterAngle=e,this._m_OuterCorner=Math.cos(this._m_OuterAngle),this._m_InnerMinusOuter=this._m_InnerCorner-this._m_OuterCorner,this.computeAngleParameters()}},{key:"getOuterAngle",value:function(){return this._m_OuterAngle}},{key:"setPosition",value:function(e){this._m_Position.setTo(e)}},{key:"setPositionXYZ",value:function(e,t,n){this._m_Position.setToInXYZ(e,t,n)}},{key:"getPosition",value:function(){return this._m_Position}},{key:"setDirection",value:function(e){this._m_Direction.setTo(e),this._m_Direction.normal()}},{key:"setDirectionXYZ",value:function(e,t,n){this._m_Direction.setToInXYZ(e,t,n).normal()}},{key:"getDirection",value:function(){return this._m_Direction}},{key:"getBoundingVolume",value:function(){if(0==this._m_SpotRange)return null;if(this._m_UpdateBoundingVolume){this._m_BoudingVolume||(this._m_BoudingVolume=new _.default);var e=.5*this._m_SpotRange,t=s.default.S_TEMP_VEC3_2;this._m_Direction.multLength(.5*this._m_SpotRange,t).add(this._m_Position);var n=this._m_SpotRange*Math.tan(this._m_OuterCorner);this._m_BoudingVolume.setCenter(t),this._m_BoudingVolume.setRaiuds(Math.max(e,n)),this._m_UpdateBoundingVolume=!1}return this._m_BoudingVolume}}])&&f(t.prototype,n),r&&f(t,r),l}(i.default);t.default=p},4008:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=l(n(9650)),o=l(n(2603)),a=l(n(2768)),_=l(n(9784)),s=l(n(3846)),u=l(n(7341));function l(e){return e&&e.__esModule?e:{default:e}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var i=d(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(l,e);var t,n,r,i=m(l);function l(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),(n=i.call(this,e,t))._m_Params={},n._m_ParamValues={},n._m_CanDefineParams={},n._m_AleadyDefinedParams={},n._m_ChangeParams=[],n._init(),n._m_CurrentSubShader=null,n._m_RenderTechnologys={},n._m_CurrentTechnology=null,t.materialDef?function(){var e=n._m_Scene.getCanvas().getGLContext(),r=t.materialDef,i=r.getParams();for(var _ in i)n._m_ParamValues[i[_].getName()]=null,n._m_Params[i[_].getName()]=!0,n._m_CanDefineParams[i[_].getName()]=!0;var s=r.getSubShaderDefs(),u={};for(var l in s)n._initGlobals(r,s[l]),u[s[l].getName()]=new o.default(e,t.frameContext||n._m_Scene.getRender().getFrameContext(),s[l]);var f=r.getTechnologyDefs(),c=null,m=null;for(var h in f){c=f[h],n._m_RenderTechnologys[c.getName()]=new a.default(c.getName()),m=c.getSubPass();var d=function(e){m[e].forEach((function(t){t.getPass().forEach((function(t){n._m_RenderTechnologys[c.getName()].addSubPass(e,u[t.pass.getName()],t.renderState)}))}))};for(var p in m)d(p)}n.selectTechnology(n._m_Scene.getRender().getPriorityTechnology())}():console.log("找不到materialDef..."),n}return t=l,(n=[{key:"getType",value:function(){return"Material"}},{key:"_newAtc",value:function(e,t,n,r,i){"color"==n?t.addTexture(e,r,e.RGBA,0,e.RGBA,e.UNSIGNED_BYTE,e.COLOR_ATTACHMENT0+Number(i),!0):"depth24_stencil8"==n&&t.addBuffer(e,r,e.DEPTH24_STENCIL8,e.DEPTH_STENCIL_ATTACHMENT)}},{key:"_initGlobals",value:function(e){var t=this._m_Scene.getRender().getFrameContext(),n=e.getGlobals(),r=this._m_Scene.getCanvas().getGLContext(),i=this._m_Scene.getCanvas().getWidth(),o=this._m_Scene.getCanvas().getHeight();for(var a in n)if(!t.getFrameBuffer(a)){var _=n[a],l=new u.default(r,a,i,o);if(t.addFrameBuffer(a,l),_){for(var f in _)_[f][0].type,_[f].length>1?this._newAtc(r,l,_[f][1].type,_[f][1].name,_[f][1].loc):_[f].length>0?this._newAtc(r,l,_[f][0].type,_[f][0].name):s.default.log("错误的atc!");l.finish(r,this._m_Scene,!0)}s.default.log("create global "+a)}}},{key:"getRenderTechnology",value:function(e){return this._m_RenderTechnologys.get(e)}},{key:"addTechnology",value:function(e,t){this._m_RenderTechnologys[e]=t}},{key:"selectTechnology",value:function(e){var t=this;if(null==this._m_CurrentTechnology||this._m_RenderTechnologys[e]!=this._m_CurrentTechnology){var n=this._m_CurrentTechnology,r=null!=this._m_CurrentTechnology;if(this._m_CurrentTechnology=this._m_RenderTechnologys[e],null==this._m_CurrentTechnology&&(this._m_CurrentTechnology=null!=n?n:this._m_RenderTechnologys[""]),r){var i=function(e){for(var n in t._m_CurrentTechnology.getSubPassList())t._m_CurrentTechnology.getSubPasss(n).getSubShaders().forEach((function(t){t.subShader.addDefine(e)}))};for(var o in this._m_AleadyDefinedParams)i(o)}}}},{key:"getCurrentTechnology",value:function(){return this._m_CurrentTechnology}},{key:"preload",value:function(){var e=this,t=this.getCurrentTechnology().getSubPassList();t&&function(){var n=e._m_Scene.getCanvas().getGLContext(),r=e._m_Scene.getRender().getFrameContext();for(var i in t)t[i].getSubShaders().forEach((function(e){e.subShader.needCompile()&&e.subShader._compile(n,r)}))}()}},{key:"_selectSubShader",value:function(e){var t=this,n=!1;this._m_CurrentSubShader=e;var r=this._m_Scene.getCanvas().getGLContext(),i=this._m_Scene.getRender().getFrameContext();if(this._m_CurrentSubShader.needCompile()&&this._m_CurrentSubShader._compile(r,i),i.m_LastSubShaderId!=e.getDefId()&&(e.use(r),i.m_LastSubShaderId=e.getDefId(),i.m_LastMaterial=this,i.m_SM++,n=!0),i.m_LastSubShader!=e)for(var o in i.m_LastSubShader=e,i.m_SS++,this._m_ParamValues)this._m_ParamValues[o]&&this._m_CurrentSubShader.uploadParam(r,o,this._m_ParamValues[o]);return this._m_ChangeParams.length>0&&(this._m_ChangeParams.forEach((function(e){t._m_ParamValues[e.paramName]&&t._m_ParamValues[e.paramName].compare(e.value)||(t._m_CurrentSubShader.uploadParam(r,e.paramName,e.value),t._m_ParamValues[e.paramName]=e.value)})),this._m_ChangeParams.length=0),n}},{key:"_init",value:function(){}},{key:"setParam",value:function(e,t){var n=this;if(this._m_Params[e]){var r=!1;if(this._m_AleadyDefinedParams[e]||(r=!0,this._m_AleadyDefinedParams[e]=!0),r){var i=function(e){for(var t in n._m_CurrentTechnology.getSubPassList())n._m_CurrentTechnology.getSubPasss(t).getSubShaders().forEach((function(t){t.subShader.addDefine(e)}))};for(var o in this._m_AleadyDefinedParams)i(o)}var a=!0;if(this._m_ChangeParams.length>0)for(var _=0;_<this._m_ChangeParams.length;_++)if(this._m_ChangeParams[_].paramName==e){this._m_ChangeParams[_].value=t,a=!1;break}t.owner(this,e),a&&this._m_ChangeParams.push({paramName:e,value:t})}}},{key:"clearParams",value:function(e,t){if(this._m_Params[e]){var n=!1;if(this._m_AleadyDefinedParams[e]&&(n=!0,delete this._m_AleadyDefinedParams[e]),n)for(var r in this._m_CurrentTechnology.getSubPassList())this._m_CurrentTechnology.getSubPasss(r).getSubShaders().forEach((function(t){t.subShader.clearDefine(e)}));this._m_ParamValues[e].unowner(this)}}},{key:"addDefine",value:function(e,t){var n=this,r=!1;if(this._m_AleadyDefinedParams[e]||(r=!0,this._m_AleadyDefinedParams[e]=!0),r){var i=function(r){for(var i in n._m_CurrentTechnology.getSubPassList())n._m_CurrentTechnology.getSubPasss(i).getSubShaders().forEach((function(n){n.subShader.addDefine(r,e==r&&null!=_.default.Context_Data[e],t)}))};for(var o in this._m_AleadyDefinedParams)i(o)}}},{key:"clearDefine",value:function(e,t){var n=this,r=!1;if(this._m_AleadyDefinedParams[e]&&(r=!0,this._m_AleadyDefinedParams[e]=!1),r){var i=function(r){for(var i in n._m_CurrentTechnology.getSubPassList())n._m_CurrentTechnology.getSubPasss(i).getSubShaders().forEach((function(n){e==r&&n.subShader.clearDefine(r,e==r&&null!=_.default.Context_Data[e],t)}))};for(var o in this._m_AleadyDefinedParams)i(o)}}}])&&f(t.prototype,n),r&&f(t,r),l}(i.default);t.default=p},8113:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Component=_interopRequireDefault(__webpack_require__(9650)),_AssetLoader=_interopRequireDefault(__webpack_require__(1193)),_ShaderSource=_interopRequireDefault(__webpack_require__(9784)),_Tools=_interopRequireDefault(__webpack_require__(5397)),_SubShaderDef=_interopRequireDefault(__webpack_require__(4974)),_TechnologyDef=_interopRequireDefault(__webpack_require__(8173)),_Render=_interopRequireDefault(__webpack_require__(3061)),_Log=_interopRequireDefault(__webpack_require__(3846));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var Block=function(){function e(t,n,r,i,o){_classCallCheck(this,e),this.m_Type=t,this.m_Id=n,this.m_Data=r,this.m_Start=i,this.m_End=o,this.m_SubBlock=[]}return _createClass(e,[{key:"getName",value:function(){return this.m_Id}},{key:"getType",value:function(){return this.m_Type}},{key:"addSubBlock",value:function(e){this.m_SubBlock.push(e)}},{key:"getSubBlock",value:function(){return this.m_SubBlock}},{key:"setStart",value:function(e){this.m_Start=e}},{key:"getStart",value:function(){return this.m_Start}},{key:"setEnd",value:function(e){this.m_End=e}},{key:"getEnd",value:function(){return this.m_End}},{key:"getData",value:function(){return this.m_Data}},{key:"toString",value:function(){return"type:"+this.m_Type+"\nid:"+this.m_Id+"\ndata:\n"+this.m_Data+"\n"}}]),e}(),Param=function(){function Param(){_classCallCheck(this,Param),this.m_Name=null,this.m_Type=null,this.m_DefaultValue=null,this.m_Pattern=null,this.m_Pattern2=null,this.m_TagPattern=null,this.m_DefType=null}return _createClass(Param,[{key:"creator",value:function creator(){this.m_Pattern=eval("/Params."+this.m_Name+"/"),this.m_Pattern2=eval("/Params."+this.m_Name+"[\\s+-;.,\\*\\\\]{1,}/"),this.m_TagPattern=eval("/Params."+this.m_Name+"/g"),this.m_DefType=""+this.m_Name}},{key:"getDefType",value:function(){return this.m_DefType}},{key:"getPattern",value:function(){return this.m_Pattern}},{key:"getPattern2",value:function(){return this.m_Pattern2}},{key:"getTagPattern",value:function(){return this.m_TagPattern}},{key:"setName",value:function(e){this.m_Name=e}},{key:"getName",value:function(){return this.m_Name}},{key:"setType",value:function(e){this.m_Type=e}},{key:"getType",value:function(){return this.m_Type}},{key:"setDefaultValue",value:function(e){this.m_DefaultValue=e}},{key:"getDefaultVaule",value:function(){return this.m_DefaultValue}}]),Param}(),SubTechnology=null,SubPassDef=function(){function e(t){_classCallCheck(this,e),this.m_RenderPath=t,this.m_Pass=[],this._m_FromMaterialDef=null}return _createClass(e,[{key:"addPass",value:function(e,t){this.m_Pass.push({pass:e,renderState:t})}},{key:"getPass",value:function(){return this.m_Pass}},{key:"setFromMaterialDef",value:function(e){this._m_FromMaterialDef=e}},{key:"getFromMaterialDef",value:function(){return this._m_FromMaterialDef}}]),e}(),MaterialDef=function(){function MaterialDef(e){_classCallCheck(this,MaterialDef),this._m_Name=e,this._m_Globals={},this._m_Params={},this._m_SubShaderDefs={},this._m_TechnologyDefs={},this._m_FBs={}}return _createClass(MaterialDef,[{key:"addSubShaderDef",value:function(e,t){this._m_SubShaderDefs[e]=t,t.setFromMaterialDef(this)}},{key:"getSubShaderDef",value:function(e){return this._m_SubShaderDefs[e]}},{key:"getSubShaderDefs",value:function(){return this._m_SubShaderDefs}},{key:"addTechnologyDef",value:function(e,t){this._m_TechnologyDefs[e]=t,t.setFromMaterialDef(this)}},{key:"getTechnologyDef",value:function(e){return this._m_TechnologyDefs[e]}},{key:"getTechnologyDefs",value:function(){return this._m_TechnologyDefs}},{key:"addParam",value:function(e){this._m_Params[e.getName()]=e}},{key:"getParams",value:function(){return this._m_Params}},{key:"getGlobalInner",value:function(e){return e.indexOf("color")>-1?"color":e.indexOf("depth24_stencil8")>-1?"depth24_stencil8":e.indexOf("depth")>-1?"depth":e.indexOf("stencil")>-1?"stencil":void 0}},{key:"addGlobal",value:function addGlobal(name,type,dataType,varName){this._m_Globals[name]||(this._m_Globals[name]={});var pName=varName;varName="_"+name+varName,this._m_Globals[name][varName]=[];var innerType=this.getGlobalInner(type),t=type.indexOf("color");if(t>-1){this._m_Globals[name][varName].push({type:innerType,dataType:"uniform sampler2D",refName:name,name:varName,pattern:eval("/Globals"+name+".In"+pName+"/"),pattern2:eval("/Globals"+name+".In"+pName+"[\\s+-;.,\\*\\\\]{1,}/"),tagPattern:eval("/Globals"+name+".In"+pName+"/g")});var loc=type.substring(t+5,type.length);_Log.default.log("loc:"+loc),this._m_Globals[name][varName].push({type:innerType,dataType,loc,refName:name,name:varName,pattern:eval("/Globals"+name+".Out"+pName+"/"),pattern2:eval("/Globals"+name+".Out"+pName+"[\\s+-;.,\\*\\\\]{1,}/"),tagPattern:eval("/Globals"+name+".Out"+pName+"/g")})}else this._m_Globals[name][varName].push({type:innerType,dataType,refName:name,name:varName,pattern:eval("/Globals"+name+".In"+pName+"/"),pattern2:eval("/Globals"+name+".In"+pName+"[\\s+-;.,\\*\\\\]{1,}/"),tagPattern:eval("/Globals"+name+".In"+pName+"/g")})}},{key:"getGlobals",value:function(){return this._m_Globals}},{key:"setName",value:function(e){this._m_Name=e}},{key:"getName",value:function(){return this._m_Name}}],[{key:"load",value:function(e){return MaterialDef.parse(_AssetLoader.default.loadMaterialSourceDef(e))}},{key:"trim",value:function(e){return e.replace(/(^\s*)|(\s*$)/g,"")}},{key:"parseGlobals",value:function(e,t){for(var n=t.getName(),r=t.getData(),i=null,o=t.getStart()+1;o<t.getEnd();o++)i=r[o],i=(i=_Tools.default.trim(i)).substring(0,i.length-1).split(" "),e.addGlobal(n,i[0],i[1],i[2])}},{key:"parseParams",value:function(e,t){for(var n=t.getData(),r=null,i=null,o=t.getStart()+1;o<t.getEnd();o++)r=n[o],(r=_Tools.default.trim(r)).startsWith("//")||(r=r.substring(0,r.length-1).split(" "),(i=new Param).setName(r[1]),i.setType(r[0]),i.creator(),r.length>2&&i.setDefaultValue(r[3]),e.addParam(i))}},{key:"parseSubTechnology",value:function(e,t){t.data}},{key:"parseShader",value:function(e,t){t.getSubBlock().forEach((function(t){MaterialDef.parseBlockDef(e,t)}))}},{key:"parseShaderVars",value:function(e,t){for(var n=t.getData(),r=null,i=t.getStart()+1;i<t.getEnd();i++)r=n[i],(r=_Tools.default.trim(r)).startsWith("//")||(r=(r=r.substring(0,r.length-1)).split(" "),e.addVar(r[0],r[1]))}},{key:"parseAdvanced",value:function(e,t){for(var n=t.getData(),r=null,i=t.getStart()+1;i<t.getEnd();i++)r=n[i],(r=_Tools.default.trim(r)).startsWith("//")||(r=(r=r.substring(0,r.length-1)).split(" "))[0].startsWith("RenderProgram")&&e.setRenderProgramType(r[1])}},{key:"parseVsShader",value:function(e,t){for(var n=t.getData(),r=null,i="",o=[],a=[],_=e.getVarTable(),s=e.getFromMaterialDef().getParams(),u=null,l=!1,f=[],c={},m={},h={},d=function(t){if((r=_Tools.default.trim(n[t])).startsWith("//"))return"continue";var d=null,p=-1,g=-1,S=null;if(_.forEach((function(e){-1!=(p=_Tools.default.find2(r,e.pattern))&&(null!=(g=_Tools.default.find2(r,e.pattern2))&&g!=p&&(p=g),S||(S={}),null!=S[p]?S[p].name.length<e.name.length&&(S[p]=e):S[p]=e)})),S)for(var v in S)d=S[v],h[d.name]||(h[d.name]=!0,a.push(d));for(var y in d=null,p=-1,g=-1,S=null,s)u=s[y],-1!=(p=_Tools.default.find2(r,u.getPattern()))&&(null!=(g=_Tools.default.find2(r,u.getPattern2()))&&g!=p&&(p=g),S||(S={}),null!=S[p]?S[p].getName().length<u.getName().length&&(S[p]=u):S[p]=u);if(S)for(var C in S)d=S[C],c[d.getName()]||(f.push(d),c[d.getName()]=!0),r=_Tools.default.repSrc(r,d.getPattern(),d.getTagPattern(),d.getName()),l=!0;var T=null;for(var b in S=null,_ShaderSource.default.Context_Data)if(null!=(T=_ShaderSource.default.Context_Data[b]).pattern&&(-1!=(p=_Tools.default.find2(r,T.pattern))&&(null!=(g=_Tools.default.find2(r,T.pattern2))&&g!=p&&(p=g),S||(S={}),null!=S[p]?S[p].src.length<T.src.length&&(S[p]=T):S[p]=T),S))for(var P in S)T=S[P],m[T.src]||(T.isFlagVariable?e.addContextDefine(_ShaderSource.default.VERTEX_SHADER,T.src):(m[T.src]=!0,o.push(T))),r=_Tools.default.repSrc(r,T.pattern,T.tagPattern,T.tag);i+=_Tools.default.trim(r)+"\n"},p=t.getStart()+1;p<t.getEnd();p++)d(p);if(l){e.addUseParams(_ShaderSource.default.VERTEX_SHADER,f);var g="\n";for(var S in f)g+="uniform "+(u=f[S]).getType()+" "+u.getName()+";\n";i=g+i}if(a.length>0){var v="\n";a.forEach((function(e){v+="out "+e.type+" "+e.name+";\n"})),i=v+i}if(o.length>0){var y={},C=[];e.addUseContexts(o);var T="\n";for(var b in o.forEach((function(e){null!=e.loc||null!=e.loc?T+="layout (location="+e.loc+") in "+e.type+" "+e.src+";\n":e.def?(y[e.def]||C.push(e.def),y[e.def]=e.def):e.utype?(T+=e.utype+" "+e.src,e.modifier&&(T+=e.modifier),T+=";\n"):e.type&&(T+=e.type+" "+e.src+";\n")})),e.addUseBlocks(C),y)T+=_ShaderSource.default.BLOCKS[b].blockDef;i=T+i}i="#version 300 es\n"+i,e.addShaderSource(_ShaderSource.default.VERTEX_SHADER,i)}},{key:"parseVsShaderFun",value:function(e,t){}},{key:"parseVsShaderMain",value:function(e,t){for(var n=t.getData(),r=null,i="void main(){\n",o=[],a=[],_=e.getVarTable(),s=e.getFromMaterialDef().getParams(),u=null,l=!1,f=[],c={},m={},h={},d=t.getStart()+1;d<t.getEnd();d++)if(!(r=_Tools.default.trim(n[d])).startsWith("//")){for(var p in _.forEach((function(e){_Tools.default.find(r,e.pattern)&&(h[e.name]||(h[e.name]=!0,a.push(e)))})),s)u=s[p],_Tools.default.find(r,u.getPattern())&&(c[u.getName()]||(f.push(u),c[u.getName()]=!0),r=_Tools.default.repSrc(r,u.getPattern(),u.getTagPattern(),u.getName()),l=!0);var g=null;for(var S in _ShaderSource.default.Context_Data)g=_ShaderSource.default.Context_Data[S],_Tools.default.find(r,g.pattern)&&(m[g.src]||(m[g.src]=!0,o.push(g)),r=_Tools.default.repSrc(r,g.pattern,g.tagPattern,g.tag));i+=_Tools.default.trim(r)+"\n"}if(i+="}\n",l){e.addUseParams(f);var v="\n";for(var y in f)v+="uniform "+(u=f[y]).getType()+" "+u.getName()+";\n";i=v+i}if(a.length>0){var C="\n";a.forEach((function(e){C+="out "+e.type+" "+e.name+";\n"})),i=C+i}if(o.length>0){var T={},b=[];e.addUseContexts(o);var P="\n";for(var E in o.forEach((function(e){null!=e.loc||null!=e.loc?P+="layout (location="+e.loc+") in "+e.type+" "+e.src+";\n":e.def?(T[e.def]||b.push(e.def),T[e.def]=e.def):e.utype?(P+=e.utype+" "+e.src,e.modifier&&(P+=e.modifier),P+=";\n"):e.type&&(P+=e.type+" "+e.src+";\n")})),e.addUseBlocks(b),T)P+=_ShaderSource.default.BLOCKS[E].blockDef;i=P+i}return i="#version 300 es\n"+i}},{key:"parseFsShader",value:function(e,t){for(var n=t.getData(),r=null,i="",o=[],a=[],_=e.getVarTable(),s=e.getFromMaterialDef().getGlobals(),u=null,l=e.getFromMaterialDef().getParams(),f=null,c=!1,m=[],h=!1,d={},p={},g={},S={},v=[],y=null,C=function(t){if((r=_Tools.default.trim(n[t])).startsWith("//"))return"continue";var y=null,C=-1,T=-1,b=null;if(_.forEach((function(e){-1!=(C=_Tools.default.find2(r,e.pattern))&&(null!=(T=_Tools.default.find2(r,e.pattern2))&&T!=C&&(C=T),b||(b={}),null!=b[C]?b[C].name.length<e.name.length&&(b[C]=e):b[C]=e)})),b)for(var P in b)y=b[P],g[y.name]||(g[y.name]=!0,a.push(y));y=null,C=-1,T=-1,b=null;var E=null;for(var D in s)for(var R in u=s[D])for(var w=0;w<u[R].length;w++)E=u[R][w],-1!=(C=_Tools.default.find2(r,E.pattern))&&(null!=(T=_Tools.default.find2(r,E.pattern2))&&T!=C&&(C=T),b||(b={}),null!=b[C]?b[C].name.length<f.name.length&&(b[C]=E):b[C]=E);if(b)for(var M in b)y=b[M],S[y.name]||(v.push(y),S[y.name]=!0),r=_Tools.default.repSrc(r,y.pattern,y.tagPattern,y.name),h=!0;for(var A in y=null,C=-1,T=-1,b=null,l)f=l[A],-1!=(C=_Tools.default.find2(r,f.getPattern()))&&(null!=(T=_Tools.default.find2(r,f.getPattern2()))&&T!=C&&(C=T),b||(b={}),null!=b[C]?b[C].getName().length<f.getName().length&&(b[C]=f):b[C]=f);if(b)for(var L in b)y=b[L],d[y.getName()]||(m.push(y),d[y.getName()]=!0),r=_Tools.default.repSrc(r,y.getPattern(),y.getTagPattern(),y.getName()),c=!0;var I=null;for(var x in b=null,_ShaderSource.default.Context_Data)if(null!=(I=_ShaderSource.default.Context_Data[x]).pattern&&(-1!=(C=_Tools.default.find2(r,I.pattern))&&(null!=(T=_Tools.default.find2(r,I.pattern2))&&T!=C&&(C=T),b||(b={}),null!=b[C]?b[C].src.length<I.src.length&&(b[C]=I):b[C]=I),b))for(var O in b)I=b[O],p[I.src]||(I.isFlagVariable?e.addContextDefine(_ShaderSource.default.FRAGMENT_SHADER,I.src):(p[I.src]=!0,o.push(I))),r=_Tools.default.repSrc(r,I.pattern,I.tagPattern,I.tag);i+=_Tools.default.trim(r)+"\n"},T=t.getStart()+1;T<t.getEnd();T++)C(T);if(c){e.addUseParams(_ShaderSource.default.FRAGMENT_SHADER,m);var b="\n";for(var P in m)b+="uniform "+(f=m[P]).getType()+" "+f.getName()+";\n";i=b+i}if(h){e.addUseGlobals(v);var E="\n",D=null;for(var R in v)null!=(D=v[R]).loc||null!=D.loc?E+="layout (location="+D.loc+") out "+D.dataType+" "+D.name+";\n":E+=D.dataType+" "+D.name+";\n";i=E+i}if(a.length>0){var w="\n";a.forEach((function(e){w+="in "+e.type+" "+e.name+";\n"})),i=w+i}if(o.length>0){var M={},A=[];e.addUseContexts(o);var L="\n";for(var I in o.forEach((function(e){null!=e.loc||null!=e.loc?(y=_ShaderSource.default.Context_RenderDataRefFBs[e.src],L+="layout (location="+e.loc+") out "+e.type+" "+e.src+";\n"):e.def?(M[e.def]||A.push(e.def),M[e.def]=e.def):e.utype?(L+=e.utype+" "+e.src,e.modifier&&(L+=e.modifier),L+=";\n"):e.type&&(L+=e.type+" "+e.src+";\n")})),e.addUseBlocks(A),M)L+=_ShaderSource.default.BLOCKS[I].blockDef;i=L+i}i="#version 300 es\nprecision mediump float;\n"+i,e.addShaderSource(_ShaderSource.default.FRAGMENT_SHADER,i),e.setFBId(y)}},{key:"parseFsShaderFun",value:function(e,t){}},{key:"parseFsShaderMain",value:function(e,t){for(var n=t.getData(),r=null,i="void main(){\n",o=[],a=[],_=e.getVarTable(),s=e.getFromMaterialDef().getParams(),u=null,l=!1,f=[],c={},m={},h={},d=null,p=t.getStart()+1;p<t.getEnd();p++)if(!(r=_Tools.default.trim(n[p])).startsWith("//")){for(var g in _.forEach((function(e){_Tools.default.find(r,e.pattern)&&(h[e.name]||(h[e.name]=!0,a.push(e)))})),s)u=s[g],_Tools.default.find(r,u.getPattern())&&(c[u.getName()]||(f.push(u),c[u.getName()]=!0),r=_Tools.default.repSrc(r,u.getPattern(),u.getTagPattern(),u.getName()),l=!0);var S=null;for(var v in _ShaderSource.default.Context_Data)S=_ShaderSource.default.Context_Data[v],_Tools.default.find(r,S.pattern)&&(m[S.src]||(m[S.src]=!0,o.push(S)),r=_Tools.default.repSrc(r,S.pattern,S.tagPattern,S.tag));i+=_Tools.default.trim(r)+"\n"}if(i+="}\n",l){e.addUseParams(f);var y="\n";for(var C in f)y+="uniform "+(u=f[C]).getType()+" "+u.getName()+";\n";i=y+i}if(a.length>0){var T="\n";a.forEach((function(e){T+="in "+e.type+" "+e.name+";\n"})),i=T+i}if(o.length>0){e.addUseContexts(o);var b="\n";o.forEach((function(e){null!=e.loc||null!=e.loc?(d=_ShaderSource.default.Context_RenderDataRefFBs[e.src],b+="layout (location="+e.loc+") out "+e.type+" "+e.src+";\n"):e.utype?b+=e.utype+" "+e.src+";\n":e.type&&(b+=e.type+" "+e.src+";\n")})),i=b+i}return i="#version 300 es\nprecision mediump float;\n"+i,e.setFBId(d),i}},{key:"parseSubPass",value:function(e,t){var n=t.getName();null!=n&&""!=n||(n=_Render.default.FORWARD);for(var r=t.getData(),i=null,o=t.getStart()+1;o<t.getEnd();o++)i=r[o],(i=_Tools.default.trim(i)).startsWith("//")||(i=i.substring(0,i.length-1),e.addSubPass(n,e.getFromMaterialDef().getSubShaderDef(i)))}},{key:"parsePass",value:function(e,t){for(var n=t.getData(),r=null,i={},o=t.getStart()+1;o<t.getEnd();o++)if(r=n[o],!(r=_Tools.default.trim(r)).startsWith("//")&&0!=r.length)if((r=(r=r.substring(0,r.length-1)).split(" ")).length>2){for(var a=[],_=1;_<r.length;_++)a.push(r[_]);i[""+r[0]]=a}else i[""+r[0]]=""+r[1];e.addPass(e.getFromMaterialDef().getSubShaderDef(t.getName()),i)}},{key:"parseBlockDef",value:function(e,t){if(t){switch(t.getType()){case"Def":e.setName(t.getName());break;case"Globals":MaterialDef.parseGlobals(e,t);break;case"Params":MaterialDef.parseParams(e,t);break;case"SubTechnology":var n=new _SubShaderDef.default(t.getName());e.addSubShaderDef(n.getName(),n),e=n;break;case"Vs_Shader":return void MaterialDef.parseVsShader(e,t);case"Fs_Shader":return void MaterialDef.parseFsShader(e,t);case"Vars":MaterialDef.parseShaderVars(e,t);break;case"Advanced":MaterialDef.parseAdvanced(e,t);break;case"Vs_Shader_Main":case"Fs_Shader_Main":break;case"Technology":var r=new _TechnologyDef.default(t.getName());e.addTechnologyDef(t.getName(),r),e=r;break;case"Sub_Pass":var i=t.getName();null!=i&&""!=i||(i=_Render.default.FORWARD);var o=new SubPassDef(i);e.addSubPass(i,o),e=o;break;case"Pass":MaterialDef.parsePass(e,t)}t.getSubBlock().forEach((function(t){MaterialDef.parseBlockDef(e,t)}))}}},{key:"getBlockDef",value:function(e,t,n){for(var r=1,i=null,o=n+1;o<t.length;o++)if(!(i=MaterialDef.trim(t[o])).startsWith("//")){if(i.endsWith("{")){r++;var a=i.substring(0,i.indexOf("{")).split(" "),_=a[0];"void"==_&&(_=e.getType()+"_Main");var s="";a.length>1&&(s=a[a.length-1]);var u=new Block(_,s,t,o);2==r&&e.addSubBlock(u),this.getBlockDef(u,t,o)}else i.endsWith("}")&&r--;if(0==r){e.setEnd(o);break}}}},{key:"parse",value:function(e){if(e){e=e.split("\n");for(var t=0;t<e.length;t++){var n=MaterialDef.trim(e[t]);if(!n.startsWith("//")&&n.endsWith("{")){var r=n.substring(0,n.indexOf("{")).split(" "),i=r[0];if("void"!=i){var o="";r.length>1&&(o=r[r.length-1]);var a=new Block(i,o,e,t);MaterialDef.getBlockDef(a,e,t);var _=new MaterialDef(a.getName());return MaterialDef.parseBlockDef(_,a),_}}}}return null}}]),MaterialDef}();exports.default=MaterialDef},5449:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_RenderPath=t,this._m_SubShaders=[],this._m_SubShaderMaps={},this._m_FBId=null,this._m_PassId=0}var t,r,i;return t=e,(r=[{key:"setFBId",value:function(e){this._m_FBId=e}},{key:"getFBId",value:function(){return this._m_FBId}},{key:"getRenderPath",value:function(){return this._m_RenderPath}},{key:"addSubShader",value:function(e){this._m_SubShaders.push(e),this._m_SubShaderMaps[e.subShader.getName()]=e,this._m_SubShaderMaps[this._m_PassId++]=e}},{key:"getSubShaders",value:function(){return this._m_SubShaders}},{key:"getSubShaderMaps",value:function(){return this._m_SubShaderMaps}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},2603:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=_(n(9784)),i=_(n(9836)),o=_(n(5397)),a=_(n(3846));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Def=r,this._m_ObjId=o.default.nextId(),this._m_DefId=r.getDefId(),this._m_Name=r.getName(),this._m_MatParams={},this._m_CanDefineParams={},this._m_AleadyDefinedParams={},this._m_Params={},this._m_ParamValues={},this._m_Defines=null,this._m_KeyDefs=null,this._m_NeedLoadShaderCaches=!1,this._m_ContextVars={},this._m_RenderDatas={},this._m_FBId=r.getFBId(),this._m_RefRenderDataFBs=null,this._m_RenderProgramType=r.getRenderProgramType(),this._loadParams(),this._newShaderProgram(t,n)}var t,n,_;return t=e,(n=[{key:"getSId",value:function(){return this._m_DefId}},{key:"_loadParams",value:function(){var e=this,t=this._m_Def.getUseParams();t&&t.length>0&&t.forEach((function(t){e._m_CanDefineParams[t.getName()]="#define "+t.getDefType()+" "+t.getDefType(),e._m_Params[t.getName()]=!0}))}},{key:"uploadParam",value:function(e,t,n){if(this._m_MatParams[t]){if(this._m_ParamValues[t]&&this._m_ParamValues[t].compare(n))return;n._upload(e,this._m_MatParams[t].loc,null),this._m_ParamValues[t]=n}}},{key:"needCompile",value:function(){return this._m_NeedLoadShaderCaches||null!=this._m_Defines||this._m_ShaderProgram.needCompile()}},{key:"_compile",value:function(e,t){this._m_Defines&&this._newShaderProgram(e,t),this._m_ShaderProgram.needCompile()&&(this._m_ShaderProgram._compile(e),this._m_RenderDatas={},a.default.log("编译!")),this._loadShaderCaches(e,t)}},{key:"_loadShaderCaches",value:function(e,t){var n=this;this._m_MatParams=[],this._m_NeedLoadShaderCaches=!1,this.use(e);var i=this._m_Def.getUseParams(),o=this._m_Def.getUseGlobals(),a=this._m_Def.getUseContexts(),_=0;if(i&&i.length>0&&i.forEach((function(t){var r=e.getUniformLocation(n._m_ShaderProgram.getProgram(),t.getName());if(r){var i=null;switch(t.getType()){case"vec4":i="uniform4f";break;case"sampler2D":case"samplerCube":e.uniform1i(r,_),i=null,r=_++}n._m_MatParams[t.getName()]={type:t.getType(),loc:r,fun:i}}})),o&&o.length>0){var s=null,u=null;o.forEach((function(t){null==t.loc||null==t.loc?n._m_RenderDatas[t.name]||(s=e.getUniformLocation(n._m_ShaderProgram.getProgram(),t.name),e.uniform1i(s,_),u=null,s=_++,n._m_RenderDatas[t.name]={type:t.type,loc:s,fun:u,refId:t.refName,dataId:t.name}):n._m_FBId=t.refName}))}a&&a.length>0&&a.forEach((function(i){if(null==i.loc||null==i.loc){var o=e.getUniformLocation(n._m_ShaderProgram.getProgram(),i.src);if(o){var a=null;switch(i.type){case"mat4":a="uniformMatrix4fv";break;case"samplerCube":case"sampler2D":e.uniform1i(o,_),a=null,o=_++,"renderData"==i.flag&&(n._m_RenderDatas[i.src]={type:i.type,loc:o,fun:a,refId:r.default.Context_RenderDataRefFBs[i.src],dataId:i.src})}n._m_ContextVars[i.src]={type:i.type,loc:o,fun:a},n._m_MatParams[i.src]={type:i.type,loc:o,fun:a}}t.addContext(i.src)}}));var l=this._m_Def.getUseBlocks();l&&l.length>0&&l.forEach((function(t){e.uniformBlockBinding(n._m_ShaderProgram.getProgram(),e.getUniformBlockIndex(n._m_ShaderProgram.getProgram(),t),r.default.BLOCKS[t].blockIndex)})),t.m_LastSubShader&&t.m_LastSubShader.use(e)}},{key:"getRenderProgramType",value:function(){return this._m_RenderProgramType}},{key:"getName",value:function(){return this._m_Name}},{key:"getDefId",value:function(){return this._m_DefId}},{key:"setFBId",value:function(e){this._m_FBId=e}},{key:"getFBId",value:function(){return this._m_FBId}},{key:"use",value:function(e){this._m_ShaderProgram.use(e)}},{key:"getContextVars",value:function(){return this._m_ContextVars}},{key:"getRenderDatas",value:function(){return this._m_RenderDatas}},{key:"getRefRenderDataFBs",value:function(){return this._m_RefRenderDataFBs}},{key:"clearDefine",value:function(e,t,n){var i=!1;if(this._m_AleadyDefinedParams[e]&&(this._m_CanDefineParams[e]||t)&&(i=!0,delete this._m_AleadyDefinedParams[e]),i){for(var o in this._m_Defines=null,this._m_KeyDefs=null,this._m_AleadyDefinedParams){this._m_Defines||(this._m_Defines={});var a=this._m_Def.getShaderParams(),_=this._m_Def.getShaderContextDefines();a[r.default.VERTEX_SHADER]&&a[r.default.VERTEX_SHADER][o]||_[r.default.VERTEX_SHADER]&&_[r.default.VERTEX_SHADER][o]?(this._m_Defines[r.default.VERTEX_SHADER]||(this._m_Defines[r.default.VERTEX_SHADER]=""),t&&o==e||null!=r.default.Context_Data[o]?this._m_Defines[r.default.VERTEX_SHADER]+=r.default.Context_Data[o]+"\n":this._m_Defines[r.default.VERTEX_SHADER]+=this._m_CanDefineParams[o]+"\n",this._m_KeyDefs||(this._m_KeyDefs=""),this._m_KeyDefs+=o+","):(a[r.default.FRAGMENT_SHADER]&&a[r.default.FRAGMENT_SHADER][o]||_[r.default.FRAGMENT_SHADER]&&_[r.default.FRAGMENT_SHADER][o])&&(this._m_Defines[r.default.FRAGMENT_SHADER]||(this._m_Defines[r.default.FRAGMENT_SHADER]=""),t&&o==e||null!=r.default.Context_Data[o]?this._m_Defines[r.default.FRAGMENT_SHADER]+=r.default.Context_Data[o]+"\n":this._m_Defines[r.default.FRAGMENT_SHADER]+=this._m_CanDefineParams[o]+"\n",this._m_KeyDefs||(this._m_KeyDefs=""),this._m_KeyDefs+=o+",")}if(this._m_Defines||(this._m_Defines={},this._m_KeyDefs=","),null!=this._m_Defines&&n){var s=this._m_ShaderProgram._m_Holds;for(var u in s)s[u]!=this&&s[u]&&(s[u]._m_KeyDefs=this._m_KeyDefs,s[u]._m_Defines=this._m_Defines)}}}},{key:"addDefine",value:function(e,t,n){var i=!1;if(this._m_AleadyDefinedParams[e]||(this._m_CanDefineParams[e]||t)&&(i=!0,this._m_AleadyDefinedParams[e]=!0),i){for(var o in this._m_Defines=null,this._m_KeyDefs=null,this._m_AleadyDefinedParams){this._m_Defines||(this._m_Defines={});var a=this._m_Def.getShaderParams(),_=this._m_Def.getShaderContextDefines();a[r.default.VERTEX_SHADER]&&a[r.default.VERTEX_SHADER][o]||_[r.default.VERTEX_SHADER]&&_[r.default.VERTEX_SHADER][o]?(this._m_Defines[r.default.VERTEX_SHADER]||(this._m_Defines[r.default.VERTEX_SHADER]=""),t&&o==e||null!=r.default.Context_Data[o]?this._m_Defines[r.default.VERTEX_SHADER]+=r.default.Context_Data[o]+"\n":this._m_Defines[r.default.VERTEX_SHADER]+=this._m_CanDefineParams[o]+"\n",this._m_KeyDefs||(this._m_KeyDefs=""),this._m_KeyDefs+=o+","):(a[r.default.FRAGMENT_SHADER]&&a[r.default.FRAGMENT_SHADER][o]||_[r.default.FRAGMENT_SHADER]&&_[r.default.FRAGMENT_SHADER][o])&&(this._m_Defines[r.default.FRAGMENT_SHADER]||(this._m_Defines[r.default.FRAGMENT_SHADER]=""),t&&o==e||null!=r.default.Context_Data[o]?this._m_Defines[r.default.FRAGMENT_SHADER]+=r.default.Context_Data[o]+"\n":this._m_Defines[r.default.FRAGMENT_SHADER]+=this._m_CanDefineParams[o]+"\n",this._m_KeyDefs||(this._m_KeyDefs=""),this._m_KeyDefs+=o+",")}if(null!=this._m_Defines&&n){var s=this._m_ShaderProgram._m_Holds;for(var u in s)s[u]!=this&&s[u]&&(s[u]._m_KeyDefs=this._m_KeyDefs,s[u]._m_Defines=this._m_Defines)}}}},{key:"_newShaderProgram",value:function(e,t){if(this._m_Defines){var n=this._m_KeyDefs;n&&n.length>0&&(n=n.substr(0,n.length-1),this._m_DefId=this._m_Def.computeSignatureDefId(n))}t.m_Shaders[this._m_DefId]?(this._m_ShaderProgram&&(this._m_ShaderProgram.deleteHold(this),this._m_ShaderProgram.canDestroy()&&this._m_ShaderProgram.destroy(e,t)),this._m_ShaderProgram=t.m_Shaders[this._m_DefId],this._m_ShaderProgram.addHold(this),this._m_Defines=null):(this._m_ShaderProgram&&(this._m_ShaderProgram.deleteHold(this),this._m_ShaderProgram.canDestroy()&&this._m_ShaderProgram.destroy(e,t)),this._m_ShaderProgram=new i.default(e,this._m_DefId,this._m_Def.getShaderSource(),this._m_Defines,!0),t.m_Shaders[this._m_DefId]=this._m_ShaderProgram,this._m_ShaderProgram.addHold(this),this._m_Defines=null),this._m_NeedLoadShaderCaches=!0}},{key:"getRef",value:function(e,t){return e.getUniformLocation(this._m_ShaderProgram.getProgram(),t)}}])&&s(t.prototype,n),_&&s(t,_),e}();t.default=u},4974:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ShaderSource=_interopRequireDefault(__webpack_require__(9784)),_Tools=_interopRequireDefault(__webpack_require__(5397));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var SubShaderDef=function(){function SubShaderDef(e){_classCallCheck(this,SubShaderDef),this._m_Name=e,this._m_DefId=null,this._m_Signature=null,this._m_ShaderSource=new _ShaderSource.default,this._m_FromMaterialDef=null,this._m_Var_Table=[],this._m_UseContexts=[],this._m_UseParams=[],this._m_UseGlobals=[],this._m_ShaderParams={},this._m_ShaderContextDefines={},this._m_UseBlocks=[],this._m_FBId=null,this._m_RefFBs=null,this._m_RenderProgramType=null}return _createClass(SubShaderDef,[{key:"setRenderProgramType",value:function(e){this._m_RenderProgramType=e}},{key:"getRenderProgramType",value:function(){return this._m_RenderProgramType}},{key:"setFBId",value:function(e){this._m_FBId=e}},{key:"getFBId",value:function(){return this._m_FBId}},{key:"computeSignatureDefId",value:function(e){if(e){var t=e.split(",").sort((function(e,t){return e.localeCompare(t)}));return e="",t.forEach((function(t){e+=t+","})),e=e.substr(0,e.length-1),_Tools.default.uniqueId(this._m_Signature+e)}return this._m_DefId=_Tools.default.uniqueId(this._m_Signature),this._m_DefId}},{key:"getDefId",value:function(){return this._m_DefId}},{key:"addUseContexts",value:function(e){var t=this;e.forEach((function(e){t._m_UseContexts.push(e)}))}},{key:"getUseContexts",value:function(){return this._m_UseContexts}},{key:"addUseGlobals",value:function(e){var t=this;e.forEach((function(e){t._m_UseGlobals.push(e)}))}},{key:"getUseGlobals",value:function(){return this._m_UseGlobals}},{key:"addUseParams",value:function(e,t){var n=this;t.forEach((function(t){n._m_UseParams.push(t),e==_ShaderSource.default.VERTEX_SHADER?(n._m_ShaderParams[_ShaderSource.default.VERTEX_SHADER]||(n._m_ShaderParams[_ShaderSource.default.VERTEX_SHADER]={}),n._m_ShaderParams[_ShaderSource.default.VERTEX_SHADER][t.getName()]=!0):e==_ShaderSource.default.FRAGMENT_SHADER&&(n._m_ShaderParams[_ShaderSource.default.FRAGMENT_SHADER]||(n._m_ShaderParams[_ShaderSource.default.FRAGMENT_SHADER]={}),n._m_ShaderParams[_ShaderSource.default.FRAGMENT_SHADER][t.getName()]=!0)}))}},{key:"addContextDefine",value:function(e,t){this._m_ShaderContextDefines[e]||(this._m_ShaderContextDefines[e]={}),this._m_ShaderContextDefines[e][t]=!0}},{key:"getShaderParams",value:function(){return this._m_ShaderParams}},{key:"getShaderContextDefines",value:function(){return this._m_ShaderContextDefines}},{key:"getUseParams",value:function(){return this._m_UseParams}},{key:"addUseBlocks",value:function(e){var t=this;e.forEach((function(e){t._m_UseBlocks.push(e)}))}},{key:"getUseBlocks",value:function(){return this._m_UseBlocks}},{key:"setFromMaterialDef",value:function(e){this._m_FromMaterialDef=e,this._m_Signature=e.getName()+this.getName(),this.computeSignatureDefId()}},{key:"getFromMaterialDef",value:function(){return this._m_FromMaterialDef}},{key:"getName",value:function(){return this._m_Name}},{key:"addVar",value:function addVar(type,name){this._m_Var_Table.push({type,name,pattern:eval("/"+name+"/"),pattern2:eval("/"+name+"[\\s+-;.,\\*\\\\]{1,}/")})}},{key:"getVarTable",value:function(){return this._m_Var_Table}},{key:"addShaderSource",value:function(e,t){this._m_ShaderSource.set(e,t)}},{key:"getShaderSource",value:function(){return this._m_ShaderSource}}]),SubShaderDef}();exports.default=SubShaderDef},7057:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(9784))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_ShaderSource=null,this._m_ShaderSource=new i.default,this._m_ShaderSource.set(i.default.VERTEX_SHADER,t.getVsSrc()),this._m_ShaderSource.set(i.default.FRAGMENT_SHADER,t.getFsSrc())}var t,n,r;return t=e,(n=[{key:"getShaderSource",value:function(){return this._m_ShaderSource}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=a},2768:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n(8435)),i=o(n(5449));function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Name=t,this._m_SubPasss={}}var t,n,o;return t=e,(n=[{key:"setName",value:function(e){this._m_Name=e}},{key:"addSubPass",value:function(e,t,n){this._m_SubPasss[e]||(this._m_SubPasss[e]=new i.default(e));var o=null;if(n)for(var a in n)o||(o=new r.default),o.setFlag(a,n[a]);this._m_SubPasss[e].addSubShader({subShader:t,renderState:o})}},{key:"getSubPasss",value:function(e){return this._m_SubPasss[e]}},{key:"getSubPassList",value:function(){return this._m_SubPasss}}])&&a(t.prototype,n),o&&a(t,o),e}();t.default=_},8173:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.m_Name=t,this.m_SubPass={},this._m_FromMaterialDef=null}var t,r,i;return t=e,(r=[{key:"getName",value:function(){return this.m_Name}},{key:"setFromMaterialDef",value:function(e){this._m_FromMaterialDef=e}},{key:"getFromMaterialDef",value:function(){return this._m_FromMaterialDef}},{key:"addSubPass",value:function(e,t){this.m_SubPass[e]||(this.m_SubPass[e]=[]),this.m_SubPass[e].push(t),t.setFromMaterialDef(this._m_FromMaterialDef)}},{key:"getSubPass",value:function(){return this.m_SubPass}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},3801:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=s(n(1322)),o=s(n(7088)),a=s(n(5604)),_=s(n(2320));function s(e){return e&&e.__esModule?e:{default:e}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=m(e);if(t){var i=m(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return c(this,n)}}function c(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(c,e);var t,n,r,s=f(c);function c(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),(t=s.call(this,e))._m_XHalf=0,t._m_YHalf=0,t._m_ZHalf=0,t}return t=c,(n=[{key:"setHalfInXYZ",value:function(e,t,n){this._m_XHalf=e,this._m_YHalf=t,this._m_ZHalf=n}},{key:"setHalf",value:function(e){this._m_XHalf=e._m_X,this._m_YHalf=e._m_Y,this._m_ZHalf=e._m_Z}},{key:"setXHalf",value:function(e){this._m_XHalf=e}},{key:"getXHalf",value:function(){return this._m_XHalf}},{key:"setYHalf",value:function(e){this._m_YHalf=e}},{key:"getYHalf",value:function(){return this._m_YHalf}},{key:"setZHalf",value:function(e){this._m_ZHalf=e}},{key:"getZHalf",value:function(){return this._m_ZHalf}},{key:"getType",value:function(){return i.default.S_TYPE_AABB}},{key:"fromPositions",value:function(e){for(var t=Number.MAX_VALUE,n=Number.MAX_VALUE,r=Number.MAX_VALUE,i=-Number.MAX_VALUE,o=-Number.MAX_VALUE,a=-Number.MAX_VALUE,_=0;_<e.length;_+=3)t=Math.min(e[_],t),n=Math.min(e[_+1],n),r=Math.min(e[_+2],r),i=Math.max(e[_],i),o=Math.max(e[_+1],o),a=Math.max(e[_+2],a);this._m_Center.setToInXYZ(t+i,n+o,r+a),this._m_Center.multLength(.5),this._m_XHalf=Math.abs(i-this._m_Center._m_X),this._m_YHalf=Math.abs(o-this._m_Center._m_Y),this._m_ZHalf=Math.abs(a-this._m_Center._m_Z)}},{key:"fromMinMax",value:function(e,t){this._m_Center.setTo(t),this._m_Center.add(e),this._m_Center.multLength(.5),this._m_XHalf=Math.abs(t._m_X-this._m_Center._m_X),this._m_YHalf=Math.abs(t._m_Y-this._m_Center._m_Y),this._m_ZHalf=Math.abs(t._m_Z-this._m_Center._m_Z)}},{key:"whichSide",value:function(e){var t=e.distance(this._m_Center),n=e.getNormal(),r=Math.abs(this._m_XHalf*n._m_X)+Math.abs(this._m_YHalf*n._m_Y)+Math.abs(this._m_ZHalf*n._m_Z);return t>r?o.default.S_SIDE_POSITIVE:t<-r?o.default.S_SIDE_NEGATIVE:o.default.S_SIDE_NONE}},{key:"_mergeFromCenterAndHalf",value:function(e,t,n,r){if(this._m_XHalf==Number.POSITIVE_INFINITY||t==Number.POSITIVE_INFINITY)this._m_Center._m_X=0,this._m_XHalf=Number.POSITIVE_INFINITY;else{var i=this._m_Center._m_X-this._m_XHalf;i>e._m_X-t&&(i=e._m_X-t);var o=this._m_Center._m_X+this._m_XHalf;o<e._m_X+t&&(o=e._m_X+t),this._m_Center._m_X=(i+o)/2,this._m_XHalf=o-this._m_Center._m_X}if(this._m_YHalf==Number.POSITIVE_INFINITY||t==Number.POSITIVE_INFINITY)this._m_Center._m_Y=0,this._m_YHalf=Number.POSITIVE_INFINITY;else{var a=this._m_Center._m_Y-this._m_YHalf;a>e._m_Y-n&&(a=e._m_Y-n);var _=this._m_Center._m_Y+this._m_YHalf;_<e._m_Y+n&&(_=e._m_Y+n),this._m_Center._m_Y=(a+_)/2,this._m_YHalf=_-this._m_Center._m_Y}if(this._m_ZHalf==Number.POSITIVE_INFINITY||t==Number.POSITIVE_INFINITY)this._m_Center._m_Z=0,this._m_ZHalf=Number.POSITIVE_INFINITY;else{var s=this._m_Center._m_Z-this._m_ZHalf;s>e._m_Z-r&&(s=e._m_Z-r);var u=this._m_Center._m_Z+this._m_ZHalf;u<e._m_Z+r&&(u=e._m_Z+r),this._m_Center._m_Z=(s+u)/2,this._m_ZHalf=u-this._m_Center._m_Z}return this}},{key:"merge",value:function(e){if(!e)return this;switch(e.getType()){case i.default.S_TYPE_AABB:return this._mergeFromCenterAndHalf(e._m_Center,e._m_XHalf,e._m_YHalf,e._m_ZHalf);case i.default.S_TYPE_SPHERE:}}},{key:"setTo",value:function(e){e.getType()==i.default.S_TYPE_AABB&&(this._m_Center.setTo(e._m_Center),this._m_XHalf=e._m_XHalf,this._m_YHalf=e._m_YHalf,this._m_ZHalf=e._m_ZHalf)}},{key:"transform",value:function(e,t,n,r){r=r||c.S_TEMP_AABB,this._m_Center.mult(e,r._m_Center),t.multVec3(r._m_Center),r._m_Center.add(n),c.S_TEMP_VEC3.setToInXYZ(this._m_XHalf*Math.abs(e._m_X),this._m_YHalf*Math.abs(e._m_Y),this._m_ZHalf*Math.abs(e._m_Z)),_.default.fromQuaternion(t,c.S_TEMP_MAT4),c.S_TEMP_MAT4.absLocal(),_.default.multiplyMV3In3x3(c.S_TEMP_VEC32,c.S_TEMP_VEC3,c.S_TEMP_MAT4),r._m_XHalf=Math.abs(c.S_TEMP_VEC32._m_X),r._m_YHalf=Math.abs(c.S_TEMP_VEC32._m_Y),r._m_ZHalf=Math.abs(c.S_TEMP_VEC32._m_Z)}},{key:"transformFromMat44",value:function(e,t){t=t||c.S_TEMP_AABB;var n=_.default.multiplyMV3(t._m_Center,this._m_Center,e);t._m_Center.multLength(1/n);var r=c.S_TEMP_MAT4;r.set(e),r.keepRotation(),r.absLocal(),c.S_TEMP_VEC3.setToInXYZ(this._m_XHalf,this._m_YHalf,this._m_ZHalf),_.default.multiplyMV3In3x3(c.S_TEMP_VEC32,c.S_TEMP_VEC3,r),t.setHalfInXYZ(Math.abs(c.S_TEMP_VEC32._m_X),Math.abs(c.S_TEMP_VEC32._m_Y),Math.abs(c.S_TEMP_VEC32._m_Z))}},{key:"getMin",value:function(e){return(e=e||new a.default).setTo(this._m_Center),e.subInXYZ(this._m_XHalf,this._m_YHalf,this._m_ZHalf),e}},{key:"getMax",value:function(e){return(e=e||new a.default).setTo(this._m_Center),e.addInXYZ(this._m_XHalf,this._m_YHalf,this._m_ZHalf),e}},{key:"contains",value:function(e){switch(e.getType()){case i.default.S_TYPE_AABB:var t=this.getMin(c.S_TEMP_VEC3),n=this.getMax(c.S_TEMP_VEC32),r=e.getMin(c.S_TEMP_VEC33),o=e.getMax(c.S_TEMP_VEC34);return!(r._m_X>n._m_X||r._m_Y>n._m_Y||r._m_Z>n._m_Z||o._m_X<t._m_X||o._m_Y<t._m_Y||o._m_Z<t._m_Z);case i.default.S_TYPE_SPHERE:return!1}return!1}}])&&u(t.prototype,n),r&&u(t,r),c}(i.default);t.default=d,h(d,"S_TEMP_VEC3",new a.default),h(d,"S_TEMP_VEC32",new a.default),h(d,"S_TEMP_VEC33",new a.default),h(d,"S_TEMP_VEC34",new a.default),h(d,"S_TEMP_MAT4",new _.default),h(d,"S_TEMP_AABB",new d)},1846:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(1322)),o=a(n(7088));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var c,m,h,d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(l,e);var t,n,r,a=u(l);function l(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),(t=a.call(this,e))._m_Radius=0,t}return t=l,(n=[{key:"setRaiuds",value:function(e){this._m_Radius=e}},{key:"getRadius",value:function(){return this._m_Radius}},{key:"getType",value:function(){return i.default.S_TYPE_SPHERE}},{key:"whichSide",value:function(e){var t=e.distance(this._m_Center);return t>this._m_Radius?o.default.S_SIDE_POSITIVE:t<-this._m_Radius?o.default.S_SIDE_NEGATIVE:o.default.S_SIDE_NONE}}])&&_(t.prototype,n),r&&_(t,r),l}(i.default);t.default=d,h=1.00001,(m="_S_RADIUS_EPSILON")in(c=d)?Object.defineProperty(c,m,{value:h,enumerable:!0,configurable:!0,writable:!0}):c[m]=h},1322:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(5604))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_PriorityPlane=0,this._m_Center=new i.default}var t,n,r;return t=e,(n=[{key:"setCenter",value:function(e){this._m_Center.setTo(e)}},{key:"getCenter",value:function(e){return(e=e||new i.default).setTo(this._m_Center),e}},{key:"getType",value:function(){return-1}},{key:"whichSide",value:function(e){}},{key:"setTo",value:function(e){}},{key:"transform",value:function(e,t,n,r){}},{key:"transformFromMat44",value:function(e,t){}},{key:"merge",value:function(e){return null}},{key:"setPriorityPlane",value:function(e){this._m_PriorityPlane=e}},{key:"getPriorityPlane",value:function(){return this._m_PriorityPlane}},{key:"contains",value:function(e){return!1}},{key:"distance",value:function(e){return this._m_Center.distance(e)}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=_,a(_,"S_TYPE_AABB",0),a(_,"S_TYPE_SPHERE",1)},2320:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(5604))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.bufferData=new Float32Array(16)}var t,n,r;return t=e,r=[{key:"lookAt",value:function(e,t,n,r){var i=e.subRetNew(t).normal(),o=n.crossRetNew(i).normal(),a=i.crossRetNew(o).normal();return(r=r||new Array(16).fill(0))[0]=o._m_X,r[4]=o._m_Y,r[8]=o._m_Z,r[3]=0,r[1]=a._m_X,r[5]=a._m_Y,r[9]=a._m_Z,r[7]=0,r[2]=i._m_X,r[6]=i._m_Y,r[10]=i._m_Z,r[11]=0,r[12]=-(e._m_X*o._m_X+e._m_Y*o._m_Y+e._m_Z*o._m_Z),r[13]=-(e._m_X*a._m_X+e._m_Y*a._m_Y+e._m_Z*a._m_Z),r[14]=-(e._m_X*i._m_X+e._m_Y*i._m_Y+e._m_Z*i._m_Z),r[15]=1,r}},{key:"invert",value:function(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],_=e[5],s=e[6],u=e[7],l=e[8],f=e[9],c=e[10],m=e[11],h=e[12],d=e[13],p=e[14],g=e[15],S=n*_-r*a,v=n*s-i*a,y=n*u-o*a,C=r*s-i*_,T=r*u-o*_,b=i*u-o*s,P=l*d-f*h,E=l*p-c*h,D=l*g-m*h,R=f*p-c*d,w=f*g-m*d,M=c*g-m*p,A=S*M-v*w+y*R+C*D-T*E+b*P;return A?(A=1/A,t[0]=(_*M-s*w+u*R)*A,t[1]=(i*w-r*M-o*R)*A,t[2]=(d*b-p*T+g*C)*A,t[3]=(c*T-f*b-m*C)*A,t[4]=(s*D-a*M-u*E)*A,t[5]=(n*M-i*D+o*E)*A,t[6]=(p*y-h*b-g*v)*A,t[7]=(l*b-c*y+m*v)*A,t[8]=(a*w-_*D+u*P)*A,t[9]=(r*D-n*w-o*P)*A,t[10]=(h*T-d*y+g*S)*A,t[11]=(f*y-l*T-m*S)*A,t[12]=(_*E-a*R-s*P)*A,t[13]=(n*R-r*E+i*P)*A,t[14]=(d*v-h*C-p*S)*A,t[15]=(l*C-f*v+c*S)*A,t):null}},{key:"parallelM",value:function(e,t,n,r,i,o,a,_){e[t+0]=2/(1*r-n),e[t+5]=2/(1*i-o),e[t+10]=-2/(1*_-a),e[t+15]=1,e[t+12]=-(r+n)/(1*r-n),e[t+13]=-(i+o)/(1*i-o),e[t+14]=-(_+a)/(1*_-a)}},{key:"perspectiveM",value:function(e,t,n,r,i,o){var a=1/Math.tan(n*(Math.PI/360)),_=1/(i-o);e[t+0]=a/r,e[t+1]=0,e[t+2]=0,e[t+3]=0,e[t+4]=0,e[t+5]=a,e[t+6]=0,e[t+7]=0,e[t+8]=0,e[t+9]=0,e[t+10]=(o+i)*_,e[t+11]=-1,e[t+12]=0,e[t+13]=0,e[t+14]=2*o*i*_,e[t+15]=0}},{key:"multiplyMM",value:function(e,t,n,r,i,o){e.m[t+0]=i.m[0]*n.m[0]+i.m[1]*n.m[4]+i.m[2]*n.m[8]+i.m[3]*n.m[12],e.m[t+1]=i.m[0]*n.m[1]+i.m[1]*n.m[5]+i.m[2]*n.m[9]+i.m[3]*n.m[13],e.m[t+2]=i.m[0]*n.m[2]+i.m[1]*n.m[6]+i.m[2]*n.m[10]+i.m[3]*n.m[14],e.m[t+3]=i.m[0]*n.m[3]+i.m[1]*n.m[7]+i.m[2]*n.m[11]+i.m[3]*n.m[15],e.m[t+4]=i.m[4]*n.m[0]+i.m[5]*n.m[4]+i.m[6]*n.m[8]+i.m[7]*n.m[12],e.m[t+5]=i.m[4]*n.m[1]+i.m[5]*n.m[5]+i.m[6]*n.m[9]+i.m[7]*n.m[13],e.m[t+6]=i.m[4]*n.m[2]+i.m[5]*n.m[6]+i.m[6]*n.m[10]+i.m[7]*n.m[14],e.m[t+7]=i.m[4]*n.m[3]+i.m[5]*n.m[7]+i.m[6]*n.m[11]+i.m[7]*n.m[15],e.m[t+8]=i.m[8]*n.m[0]+i.m[9]*n.m[4]+i.m[10]*n.m[8]+i.m[11]*n.m[12],e.m[t+9]=i.m[8]*n.m[1]+i.m[9]*n.m[5]+i.m[10]*n.m[9]+i.m[11]*n.m[13],e.m[t+10]=i.m[8]*n.m[2]+i.m[9]*n.m[6]+i.m[10]*n.m[10]+i.m[11]*n.m[14],e.m[t+11]=i.m[8]*n.m[3]+i.m[9]*n.m[7]+i.m[10]*n.m[11]+i.m[11]*n.m[15],e.m[t+12]=i.m[12]*n.m[0]+i.m[13]*n.m[4]+i.m[14]*n.m[8]+i.m[15]*n.m[12],e.m[t+13]=i.m[12]*n.m[1]+i.m[13]*n.m[5]+i.m[14]*n.m[9]+i.m[15]*n.m[13],e.m[t+14]=i.m[12]*n.m[2]+i.m[13]*n.m[6]+i.m[14]*n.m[10]+i.m[15]*n.m[14],e.m[t+15]=i.m[12]*n.m[3]+i.m[13]*n.m[7]+i.m[14]*n.m[11]+i.m[15]*n.m[15]}},{key:"multiplyMV",value:function(e,t,n){e._m_X=t._m_X*n.m[0]+t._m_Y*n.m[4]+t._m_Z*n.m[8]+t._m_W*n.m[12],e._m_Y=t._m_X*n.m[1]+t._m_Y*n.m[5]+t._m_Z*n.m[9]+t._m_W*n.m[13],e._m_Z=t._m_X*n.m[2]+t._m_Y*n.m[6]+t._m_Z*n.m[10]+t._m_W*n.m[14],e._m_W=t._m_X*n.m[3]+t._m_Y*n.m[7]+t._m_Z*n.m[11]+t._m_W*n.m[15]}},{key:"multiplyMV3",value:function(e,t,n){return e._m_X=t._m_X*n.m[0]+t._m_Y*n.m[4]+t._m_Z*n.m[8]+n.m[12],e._m_Y=t._m_X*n.m[1]+t._m_Y*n.m[5]+t._m_Z*n.m[9]+n.m[13],e._m_Z=t._m_X*n.m[2]+t._m_Y*n.m[6]+t._m_Z*n.m[10]+n.m[14],t._m_X*n.m[3]+t._m_Y*n.m[7]+t._m_Z*n.m[11]+n.m[15]}},{key:"multiplyMV3In3x3",value:function(e,t,n){e._m_X=t._m_X*n.m[0]+t._m_Y*n.m[4]+t._m_Z*n.m[8],e._m_Y=t._m_X*n.m[1]+t._m_Y*n.m[5]+t._m_Z*n.m[9],e._m_Z=t._m_X*n.m[2]+t._m_Y*n.m[6]+t._m_Z*n.m[10]}},{key:"composeMat4",value:function(t,n,r,i){return e.fromQuaternion(n,i),i.scale(r._m_X,r._m_Y,r._m_Z),i.translate(t._m_X,t._m_Y,t._m_Z),i}},{key:"decomposeMat4",value:function(t,n,r,i){e._S_TEMP_VEC3.setToInXYZ(t.m[0],t.m[1],t.m[2]);var o=e._S_TEMP_VEC3.length();e._S_TEMP_VEC3.setToInXYZ(t.m[4],t.m[5],t.m[6]);var a=e._S_TEMP_VEC3.length();e._S_TEMP_VEC3.setToInXYZ(t.m[8],t.m[9],t.m[10]);var _=e._S_TEMP_VEC3.length();e.determinantMat4(t)<0&&(o=-o),n.setToInXYZ(t.m[12],t.m[13],t.m[14]),e._S_TEMP_MAT4.set(t);var s=1/o,u=1/a,l=1/_;e._S_TEMP_MAT4.m[0]*=s,e._S_TEMP_MAT4.m[1]*=s,e._S_TEMP_MAT4.m[2]*=s,e._S_TEMP_MAT4.m[4]*=u,e._S_TEMP_MAT4.m[5]*=u,e._S_TEMP_MAT4.m[6]*=u,e._S_TEMP_MAT4.m[8]*=l,e._S_TEMP_MAT4.m[9]*=l,e._S_TEMP_MAT4.m[10]*=l,r.fromMat44(e._S_TEMP_MAT4),i.setToInXYZ(o,a,_)}},{key:"determinantMat4",value:function(e){var t=e.m[0],n=e.m[1],r=e.m[2],i=e.m[3],o=e.m[4],a=e.m[5],_=e.m[6],s=e.m[7],u=e.m[8],l=e.m[9],f=e.m[10],c=e.m[11],m=e.m[12],h=e.m[13],d=e.m[14],p=e.m[15];return m*l*_*i-u*h*_*i-m*a*f*i+o*h*f*i+u*a*d*i-o*l*d*i-m*l*r*s+u*h*r*s+m*n*f*s-t*h*f*s-u*n*d*s+t*l*d*s+m*a*r*c-o*h*r*c-m*n*_*c+t*h*_*c+o*n*d*c-t*a*d*c-u*a*r*p+o*l*r*p+u*n*_*p-t*l*_*p-o*n*f*p+t*a*f*p}},{key:"fromQuaternion",value:function(e,t){var n=e._m_X,r=e._m_Y,i=e._m_Z,o=e._m_W,a=n+n,_=r+r,s=i+i,u=n*a,l=n*_,f=n*s,c=r*_,m=r*s,h=i*s,d=o*a,p=o*_,g=o*s;return t.m[0]=1-(c+h),t.m[4]=l-g,t.m[8]=f+p,t.m[1]=l+g,t.m[5]=1-(u+h),t.m[9]=m-d,t.m[2]=f-p,t.m[6]=m+d,t.m[10]=1-(u+c),t.m[3]=0,t.m[7]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t.m[15]=1,t}}],(n=[{key:"identity",value:function(){this.m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}},{key:"scale",value:function(e,t,n){return this.m[0]*=e,this.m[4]*=t,this.m[8]*=n,this.m[1]*=e,this.m[5]*=t,this.m[9]*=n,this.m[2]*=e,this.m[6]*=t,this.m[10]*=n,this.m[3]*=e,this.m[7]*=t,this.m[11]*=n,this}},{key:"translate",value:function(e,t,n){var r=this.m[3];this.m[0]+=r*e,this.m[1]+=r*t,this.m[2]+=r*n;var i=this.m[7];this.m[4]+=i*e,this.m[5]+=i*t,this.m[6]+=i*n;var o=this.m[11];this.m[8]+=o*e,this.m[9]+=o*t,this.m[10]+=o*n;var a=this.m[15];return this.m[12]+=a*e,this.m[13]+=a*t,this.m[14]+=a*n,this}},{key:"lookAt",value:function(t,n,r){return this.m=e.lookAt(t,n,r,this.m),this}},{key:"inert",value:function(){e.invert(this.m,e._S_TEMP_MAT4.m)&&this.set(e._S_TEMP_MAT4)}},{key:"inertRetNew",value:function(t){return e.invert(this.m,e._S_TEMP_MAT4.m)?((t=t||new e).set(e._S_TEMP_MAT4),t):null}},{key:"set",value:function(e){for(var t=0;t<16;t++)this.m[t]=e.m[t]}},{key:"setArray",value:function(e){for(var t=0;t<16;t++)this.m[t]=e[t]}},{key:"setArrayTranspose",value:function(e){for(var t=0,n=0;t<4;t++)for(var r=0;r<4;r++)this.m[n++]=e[4*r+t]}},{key:"keepRotation",value:function(){this.m[12]=this.m[13]=this.m[14]=0,this.m[15]=1}},{key:"transpose",value:function(){for(var e=[],t=0;t<this.m.length;t++)e[t]=this.m[t];for(var n=0,r=0;n<4;n++)for(var i=0;i<4;i++)this.m[r++]=e[4*i+n]}},{key:"absLocal",value:function(){for(var e=0;e<16;e++)this.m[e]=Math.abs(this.m[e])}},{key:"perspectiveM",value:function(t,n,r,i){return e.perspectiveM(this.m,0,t,n,r,i),this}},{key:"parallelM",value:function(t,n,r,i,o,a){return this.identity(),e.parallelM(this.m,0,t,n,r,i,o,a),this}},{key:"getData",value:function(){return this.m}},{key:"getBufferData",value:function(){return this.bufferData.set(this.m),this.bufferData}},{key:"toString",value:function(){return"["+this.m[0]+","+this.m[1]+","+this.m[2]+","+this.m[3]+",\n"+this.m[4]+","+this.m[5]+","+this.m[6]+","+this.m[7]+",\n"+this.m[8]+","+this.m[9]+","+this.m[10]+","+this.m[11]+",\n"+this.m[12]+","+this.m[13]+","+this.m[14]+","+this.m[15]+"]"}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=_,a(_,"_S_TEMP_MAT4",new _),a(_,"_S_TEMP_VEC3",new i.default)},431:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;Math.PI,Math.PI;var i=1/Math.PI,o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,o;return t=e,o=[{key:"toRadians",value:function(e){return.005555555555555556*e*Math.PI}},{key:"toAngle",value:function(e){return 180*e*i}},{key:"interpolateLinear",value:function(e,t,n){return t==n||e<=0?t:e>=1?n:(1-e)*t+e*n}},{key:"interpolateLinearVec3",value:function(e,t,n){return t==n||e<=0?t:e>=1?n:(t.multLength(1-e),t.add(n.mulReturn(e)),t)}}],(r=null)&&n(t.prototype,r),o&&n(t,o),e}();t.default=o,r(o,"S_HALF_PI",.5*Math.PI),r(o,"S_DEG_TO_RAD",.0174532925),r(o,"S_RAD_TO_DEG",57.295779513),r(o,"S_TWO_PI",2*Math.PI)},7088:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(5604))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Normal=new i.default,this._m_D=0}var t,n,r;return t=e,(n=[{key:"setD",value:function(e){this._m_D=e}},{key:"getD",value:function(){return this._m_D}},{key:"setNormal",value:function(e){this._m_Normal.setTo(e),this._m_Normal.normal()}},{key:"setNormaXYZ",value:function(e,t,n){this._m_Normal.setToInXYZ(e,t,n),this._m_Normal.normal()}},{key:"getNormal",value:function(){return this._m_Normal}},{key:"distance",value:function(e){return this._m_Normal.dot(e)-this._m_D}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=_,a(_,"S_SIDE_POSITIVE",1),a(_,"S_SIDE_NEGATIVE",_.S_SIDE_POSITIVE<<1),a(_,"S_SIDE_NONE",_.S_SIDE_POSITIVE<<2)},453:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(431))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _=function(){function e(t,n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_X=t||0,this._m_Y=n||0,this._m_Z=r||0,this._m_W=i||0}var t,n,r;return t=e,r=[{key:"slerp",value:function(t,n,r,i){var o,a,_=t._m_W*n._m_W+t._m_X*n._m_X+t._m_Y*n._m_Y+t._m_Z*n._m_Z,s=null;if(_<0?((s=e._S_TEMP_QUATERNION)._m_W=-t._m_W,s._m_X=-t._m_X,s._m_Y=-t._m_Y,s._m_Z=-t._m_Z,_=-_):s=t,_>.9995)o=1-r,a=r;else{var u=Math.acos(_),l=Math.sin(u);o=Math.sin((1-r)*u)/l,a=Math.sin(r*u)/l}return(i=i||e._S_TEMP_QUATERNION_2)._m_W=s._m_W*o+n._m_W*a,i._m_X=s._m_X*o+n._m_X*a,i._m_Y=s._m_Y*o+n._m_Y*a,i._m_Z=s._m_Z*o+n._m_Z*a,i}},{key:"slerp2",value:function(t,n,r,i){if(i=i||e._S_TEMP_QUATERNION_2,0===r)return i.setTo(t),i;if(1===r)return i.setTo(n),i;var o=t._m_X,a=t._m_Y,_=t._m_Z,s=t._m_W,u=s*n._m_W+o*n._m_X+a*n._m_Y+_*n._m_Z,l=null;if(u<0?((l=e._S_TEMP_QUATERNION)._m_W=-n._m_W,l._m_X=-n._m_X,l._m_Y=-n._m_Y,l._m_Z=-n._m_Z,u=-u):l=n,u>=1)return i._m_W=s,i._m_X=o,i._m_Y=a,i._m_Z=_,i;var f=1-u*u;if(f<=Number.EPSILON){var c=1-r;return i._m_W=c*s+r*l._m_W,i._m_X=c*o+r*l._m_X,i._m_Y=c*a+r*l._m_Y,i._m_Z=c*_+r*l._m_Z,i.normal(),i}var m=Math.sqrt(f),h=Math.atan2(m,u),d=Math.sin((1-r)*h)/m,p=Math.sin(r*h)/m;return i._m_W=s*d+l._m_W*p,i._m_X=o*d+l._m_X*p,i._m_Y=a*d+l._m_Y*p,i._m_Z=_*d+l._m_Z*p,i}},{key:"inter",value:function(t,n,r,i){var o=1-r;return(i=i||e._S_TEMP_QUATERNION)._m_X=t._m_X*o+n._m_X*r,i._m_Y=t._m_Y*o+n._m_Y*r,i._m_Z=t._m_Z*o+n._m_Z*r,i._m_W=t._m_W*o+n._m_W*r,i}}],(n=[{key:"setTo",value:function(e){this._m_X=e._m_X,this._m_Y=e._m_Y,this._m_Z=e._m_Z,this._m_W=e._m_W}},{key:"setToInXYZW",value:function(e,t,n,r){this._m_X=e||0,this._m_Y=t||0,this._m_Z=n||0,this._m_W=r||0}},{key:"toAngles",value:function(e){e=e||new Array(3);var t=this._m_W*this._m_W,n=this._m_X*this._m_X,r=this._m_Y*this._m_Y,o=this._m_Z*this._m_Z,a=n+r+o+t,_=this._m_X*this._m_Y+this._m_Z*this._m_W;return _>.499*a?(e[1]=2*Math.atan2(this._m_X,this._m_W),e[2]=i.default.S_HALF_PI,e[0]=0):_<-.499*a?(e[1]=-2*Math.atan2(this._m_X,this._m_W),e[2]=-i.default.S_HALF_PI,e[0]=0):(e[1]=Math.atan2(2*this._m_Y*this._m_W-2*this._m_X*this._m_Z,n-r-o+t),e[2]=Math.asin(2*_/a),e[0]=Math.atan2(2*this._m_X*this._m_W-2*this._m_Y*this._m_Z,-n+r-o+t)),e}},{key:"fromEuler",value:function(e,t,n){var r=-1;r=.5*e;var i=Math.cos(r),o=Math.sin(r);r=.5*t;var a=Math.cos(r),_=Math.sin(r);r=.5*n;var s=Math.cos(r),u=Math.sin(r),l=a*s,f=_*u,c=a*u,m=_*s;this._m_X=l*o+f*i,this._m_Y=m*i+c*o,this._m_Z=c*i-m*o,this._m_W=l*i-f*o}},{key:"fromMat44",value:function(e){var t,n=e.m[0],r=e.m[4],i=e.m[8],o=e.m[1],a=e.m[5],_=e.m[9],s=e.m[2],u=e.m[6],l=e.m[10],f=n+a+l;f>0?(t=.5/Math.sqrt(f+1),this._m_W=.25/t,this._m_X=(u-_)*t,this._m_Y=(i-s)*t,this._m_Z=(o-r)*t):n>a&&n>l?(t=2*Math.sqrt(1+n-a-l),this._m_W=(u-_)/t,this._m_X=.25*t,this._m_Y=(r+o)/t,this._m_Z=(i+s)/t):a>l?(t=2*Math.sqrt(1+a-n-l),this._m_W=(i-s)/t,this._m_X=(r+o)/t,this._m_Y=.25*t,this._m_Z=(_+u)/t):(t=2*Math.sqrt(1+l-n-a),this._m_W=(o-r)/t,this._m_X=(i+s)/t,this._m_Y=(_+u)/t,this._m_Z=.25*t)}},{key:"multVec3",value:function(e,t){t=t||e;var n=e._m_X,r=e._m_Y,i=e._m_Z,o=this._m_X,a=this._m_Y,_=this._m_Z,s=this._m_W;return t._m_X=s*s*n+2*a*s*i-2*_*s*r+o*o*n+2*a*o*r+2*_*o*i-_*_*n-a*a*n,t._m_Y=2*o*a*n+a*a*r+2*_*a*i+2*s*_*n-_*_*r+s*s*r-2*o*s*i-o*o*r,t._m_Z=2*o*_*n+2*a*_*r+_*_*i-2*s*a*n-a*a*i+2*s*o*r-o*o*i+s*s*i,t}},{key:"slerp",value:function(t,n,r){return e.slerp(this,t,n,r)}},{key:"normal",value:function(){var e=this.length();return e?(e=1/e,this._m_X*=e,this._m_Y*=e,this._m_Z*=e,this._m_W*=e):console.error("Vector3.normal异常,长度为0。"),this}},{key:"length",value:function(){var e=this._m_X*this._m_X+this._m_Y*this._m_Y+this._m_Z*this._m_Z+this._m_W*this._m_W;return e=Math.sqrt(e)}},{key:"inter",value:function(t,n,r){return e.inter(this,t,n,r)}},{key:"toString",value:function(){return"["+this._m_X+","+this._m_Y+","+this._m_Z+","+this._m_W+"]"}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=_,a(_,"_S_TEMP_QUATERNION",new _),a(_,"_S_TEMP_QUATERNION_2",new _)},9271:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_X=t||0,this._m_Y=n||0}var t,r,i;return t=e,(r=[{key:"setTo",value:function(e){this._m_X=e._m_X,this._m_Y=e._m_Y}},{key:"setToInXY",value:function(e,t){this._m_X=e||0,this._m_Y=t||0}},{key:"dot",value:function(e){return this._m_X*e._m_X+this._m_Y*e._m_Y}},{key:"cross",value:function(e,t){if(t)return t._m_X=this._m_Y*e._m_Z-this._m_Z*e._m_Y,t._m_Y=this._m_Z*e._m_X-this._m_X*e._m_Z,t;var n=this._m_Y*e._m_Z-this._m_Z*e._m_Y,r=this._m_Z*e._m_X-this._m_X*e._m_Z;return this._m_X=n,this._m_Y=r,this}},{key:"crossRetNew",value:function(t){var n=new e(0,0);return this.cross(t,n)}},{key:"divide",value:function(e,t){return t?(t._m_X=this._m_X/e._m_X,t._m_Y=this._m_Y/e._m_Y,t):(this._m_X/=e._m_X,this._m_Y/=e._m_Y,this)}},{key:"divideRetNew",value:function(t){var n=new e(0,0);return this.divide(t,n)}},{key:"mult",value:function(e,t){return t?(t._m_X=this._m_X*e._m_X,t._m_Y=this._m_Y*e._m_Y,t):(this._m_X*=e._m_X,this._m_Y*=e._m_Y,this)}},{key:"multRetNew",value:function(t){var n=new e(0,0);return this.mult(t,n)}},{key:"sub",value:function(e,t){return t?(t._m_X=this._m_X-e._m_X,t._m_Y=this._m_Y-e._m_Y,t):(this._m_X-=e._m_X,this._m_Y-=e._m_Y,this)}},{key:"subRetNew",value:function(t){var n=new e(0,0);return this.sub(t,n)}},{key:"add",value:function(e,t){return t?(t._m_X=this._m_X+e._m_X,t._m_Y=this._m_Y+e._m_Y,t):(this._m_X+=e._m_X,this._m_Y+=e._m_Y,this)}},{key:"addRetNew",value:function(t){var n=new e(0,0);return this.add(t,n)}},{key:"multLength",value:function(e,t){return t?(t._m_X=this._m_X*e,t._m_Y=this._m_Y*e,t):(this._m_X*=e,this._m_Y*=e,this)}},{key:"normal",value:function(){var e=this.length();return e?(e=1/e,this._m_X*=e,this._m_Y*=e):console.error("Vector3.normal异常,长度为0。"),this}},{key:"length",value:function(){var e=this._m_X*this._m_X+this._m_Y*this._m_Y;return e=Math.sqrt(e)}},{key:"toString",value:function(){return"["+this._m_X+","+this._m_Y+"]"}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},5604:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_X=t||0,this._m_Y=n||0,this._m_Z=r||0,this.bufferData=new Float32Array(3)}var t,r,i;return t=e,i=[{key:"inter",value:function(t,n,r,i){var o=1-r;return(i=i||e._S_TEMP_VEC3)._m_X=t._m_X*o+n._m_X*r,i._m_Y=t._m_Y*o+n._m_Y*r,i._m_Z=t._m_Z*o+n._m_Z*r,i}}],(r=[{key:"getBufferData",value:function(){return this.bufferData.set([this._m_X,this._m_Y,this._m_Z]),this.bufferData}},{key:"toArray",value:function(){return[this._m_X,this._m_Y,this._m_Z]}},{key:"setTo",value:function(e){return this._m_X=e._m_X,this._m_Y=e._m_Y,this._m_Z=e._m_Z,this}},{key:"setToInXYZ",value:function(e,t,n){return this._m_X=e||0,this._m_Y=t||0,this._m_Z=n||0,this}},{key:"dot",value:function(e){return this._m_X*e._m_X+this._m_Y*e._m_Y+this._m_Z*e._m_Z}},{key:"min",value:function(e,t){return t?(t._m_X=e._m_X<this._m_X?e._m_X:this._m_X,t._m_Y=e._m_Y<this._m_Y?e._m_Y:this._m_Y,t._m_Z=e._m_Z<this._m_Z?e._m_Z:this._m_Z,t):(this._m_X=e._m_X<this._m_X?e._m_X:this._m_X,this._m_Y=e._m_Y<this._m_Y?e._m_Y:this._m_Y,this._m_Z=e._m_Z<this._m_Z?e._m_Z:this._m_Z,this)}},{key:"max",value:function(e,t){return t?(t._m_X=e._m_X>this._m_X?e._m_X:this._m_X,t._m_Y=e._m_Y>this._m_Y?e._m_Y:this._m_Y,t._m_Z=e._m_Z>this._m_Z?e._m_Z:this._m_Z,t):(this._m_X=e._m_X>this._m_X?e._m_X:this._m_X,this._m_Y=e._m_Y>this._m_Y?e._m_Y:this._m_Y,this._m_Z=e._m_Z>this._m_Z?e._m_Z:this._m_Z,this)}},{key:"cross",value:function(e,t){if(t)return t._m_X=this._m_Y*e._m_Z-this._m_Z*e._m_Y,t._m_Y=this._m_Z*e._m_X-this._m_X*e._m_Z,t._m_Z=this._m_X*e._m_Y-this._m_Y*e._m_X,t;var n=this._m_Y*e._m_Z-this._m_Z*e._m_Y,r=this._m_Z*e._m_X-this._m_X*e._m_Z,i=this._m_X*e._m_Y-this._m_Y*e._m_X;return this._m_X=n,this._m_Y=r,this._m_Z=i,this}},{key:"crossRetNew",value:function(t){var n=new e(0,0,0);return this.cross(t,n)}},{key:"distance",value:function(e){return Math.sqrt(this.distanceSq(e))}},{key:"distanceSq",value:function(e){var t=this._m_X-e._m_X,n=this._m_Y-e._m_Y,r=this._m_Z-e._m_Z;return t*t+n*n+r*r}},{key:"divide",value:function(e,t){return t?(t._m_X=this._m_X/e._m_X,t._m_Y=this._m_Y/e._m_Y,t._m_Z=this._m_Z/e._m_Z,t):(this._m_X/=e._m_X,this._m_Y/=e._m_Y,this._m_Z/=e._m_Z,this)}},{key:"divideInXYZ",value:function(e,t,n,r){return r?(r._m_X=this._m_X/e,r._m_Y=this._m_Y/t,r._m_Z=this._m_Z/n,r):(this._m_X/=e,this._m_Y/=t,this._m_Z/=n,this)}},{key:"divideRetNew",value:function(t){var n=new e(0,0,0);return this.divide(t,n)}},{key:"divideRetNewInXYZ",value:function(t,n,r){var i=new e(0,0,0);return this.divideInXYZ(t,n,r,i)}},{key:"mult",value:function(e,t){return t?(t._m_X=this._m_X*e._m_X,t._m_Y=this._m_Y*e._m_Y,t._m_Z=this._m_Z*e._m_Z,t):(this._m_X*=e._m_X,this._m_Y*=e._m_Y,this._m_Z*=e._m_Z,this)}},{key:"multInXYZ",value:function(e,t,n,r){return r?(r._m_X=this._m_X*e,r._m_Y=this._m_Y*t,r._m_Z=this._m_Z*n,r):(this._m_X*=e,this._m_Y*=t,this._m_Z*=n,this)}},{key:"multRetNew",value:function(t){var n=new e(0,0,0);return this.mult(t,n)}},{key:"multRetNewInXYZ",value:function(t,n,r){var i=new e(0,0,0);return this.multInXYZ(t,n,r,i)}},{key:"sub",value:function(e,t){return t?(t._m_X=this._m_X-e._m_X,t._m_Y=this._m_Y-e._m_Y,t._m_Z=this._m_Z-e._m_Z,t):(this._m_X-=e._m_X,this._m_Y-=e._m_Y,this._m_Z-=e._m_Z,this)}},{key:"subInXYZ",value:function(e,t,n,r){return r?(r._m_X=this._m_X-e,r._m_Y=this._m_Y-t,r._m_Z=this._m_Z-n,r):(this._m_X-=e,this._m_Y-=t,this._m_Z-=n,this)}},{key:"subRetNew",value:function(t){var n=new e(0,0,0);return this.sub(t,n)}},{key:"subRetNewInXYZ",value:function(t,n,r){var i=new e(0,0,0);return this.subInXYZ(t,n,r,i)}},{key:"add",value:function(e,t){return t?(t._m_X=this._m_X+e._m_X,t._m_Y=this._m_Y+e._m_Y,t._m_Z=this._m_Z+e._m_Z,t):(this._m_X+=e._m_X,this._m_Y+=e._m_Y,this._m_Z+=e._m_Z,this)}},{key:"addInXYZ",value:function(e,t,n,r){return r?(reslut._m_X=this._m_X+e,reslut._m_Y=this._m_Y+t,reslut._m_Z=this._m_Z+n,reslut):(this._m_X+=e,this._m_Y+=t,this._m_Z+=n,this)}},{key:"addRetNew",value:function(t){var n=new e(0,0,0);return this.add(t,n)}},{key:"addRetNewInXYZ",value:function(t,n,r){var i=new e(0,0,0);return this.addInXYZ(t,n,r,i)}},{key:"multLength",value:function(e,t){return t?(t._m_X=this._m_X*e,t._m_Y=this._m_Y*e,t._m_Z=this._m_Z*e,t):(this._m_X*=e,this._m_Y*=e,this._m_Z*=e,this)}},{key:"normal",value:function(){var e=this.length();return e?(e=1/e,this._m_X*=e,this._m_Y*=e,this._m_Z*=e):this._m_X=this._m_Y=this._m_Z=0,this}},{key:"negate",value:function(){return new e(-this._m_X,-this._m_Y,-this._m_Z)}},{key:"length",value:function(){var e=this._m_X*this._m_X+this._m_Y*this._m_Y+this._m_Z*this._m_Z;return e=Math.sqrt(e)}},{key:"toString",value:function(){return"["+this._m_X+","+this._m_Y+","+this._m_Z+"]"}},{key:"inter",value:function(t,n,r){return e.inter(this,t,n,r)}},{key:"equals",value:function(e){return e==this||null!=e&&this._m_X==e._m_X&&this._m_Y==e._m_Y&&this._m_Z==e._m_Z}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=i,r(i,"_S_TEMP_VEC3",new i),r(i,"S_UNIT_AXIS_X",new i(1,0,0)),r(i,"S_UNIT_AXIS_Y",new i(0,1,0)),r(i,"S_UNIT_AXIS_Z",new i(0,0,1)),r(i,"S_UNIT_AXIS_NEGATIVE_X",new i(-1,0,0)),r(i,"S_UNIT_AXIS_NEGATIVE_Y",new i(0,-1,0)),r(i,"S_UNIT_AXIS_NEGATIVE_Z",new i(0,0,-1)),r(i,"S_POSITIVE_INFINITY",new i(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY)),r(i,"S_NEGATIVE_INFINITY",new i(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),r(i,"S_MAX",new i(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)),r(i,"S_MIN",new i(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE))},7141:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i,o,a=function(){function e(t,n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_X=t||0,this._m_Y=n||0,this._m_Z=r||0,this._m_W=null!=i&&null!=i?i:1,this.bufferData=new Float32Array(4)}var t,r,i;return t=e,i=[{key:"inter",value:function(t,n,r,i){var o=1-r;return(i=i||e._S_TEMP_VEC4)._m_X=t._m_X*o+n._m_X*r,i._m_Y=t._m_Y*o+n._m_Y*r,i._m_Z=t._m_Z*o+n._m_Z*r,i._m_W=1,i}}],(r=[{key:"getBufferData",value:function(){return this.bufferData.set([this._m_X,this._m_Y,this._m_Z,this._m_W]),this.bufferData}},{key:"setTo",value:function(e){return this._m_X=e._m_X,this._m_Y=e._m_Y,this._m_Z=e._m_Z,this._m_W=e._m_W,this}},{key:"setToInXYZW",value:function(e,t,n,r){return this._m_X=e||0,this._m_Y=t||0,this._m_Z=n||0,this._m_W=null!=r&&null!=r?r:1,this}},{key:"dot",value:function(e){return this._m_X*e._m_X+this._m_Y*e._m_Y+this._m_Z*e._m_Z+this._m_W*e._m_W}},{key:"cross",value:function(e,t){if(t)return t._m_X=this._m_Y*e._m_Z-this._m_Z*e._m_Y,t._m_Y=this._m_Z*e._m_X-this._m_X*e._m_Z,t._m_Z=this._m_X*e._m_Y-this._m_Y*e._m_X,t;var n=this._m_Y*e._m_Z-this._m_Z*e._m_Y,r=this._m_Z*e._m_X-this._m_X*e._m_Z,i=this._m_X*e._m_Y-this._m_Y*e._m_X;return this._m_X=n,this._m_Y=r,this._m_Z=i,this}},{key:"crossRetNew",value:function(t){var n=new e(0,0,0,1);return this.cross(t,n)}},{key:"divide",value:function(e,t){return t?(t._m_X=this._m_X/e._m_X,t._m_Y=this._m_Y/e._m_Y,t._m_Z=this._m_Z/e._m_Z,t._m_W=this._m_W/e._m_W,t):(this._m_X/=e._m_X,this._m_Y/=e._m_Y,this._m_Z/=e._m_Z,this._m_W/=e._m_W,this)}},{key:"divideRetNew",value:function(t){var n=new e(0,0,0,1);return this.divide(t,n)}},{key:"mult",value:function(e,t){return t?(t._m_X=this._m_X*e._m_X,t._m_Y=this._m_Y*e._m_Y,t._m_Z=this._m_Z*e._m_Z,t._m_W=this._m_W*e._m_W,t):(this._m_X*=e._m_X,this._m_Y*=e._m_Y,this._m_Z*=e._m_Z,this._m_W*=e._m_W,this)}},{key:"multRetNew",value:function(t){var n=new e(0,0,0,1);return this.mult(t,n)}},{key:"sub",value:function(e,t){return t?(t._m_X=this._m_X-e._m_X,t._m_Y=this._m_Y-e._m_Y,t._m_Z=this._m_Z-e._m_Z,t):(this._m_X-=e._m_X,this._m_Y-=e._m_Y,this._m_Z-=e._m_Z,this)}},{key:"subRetNew",value:function(t){var n=new e(0,0,0,1);return this.sub(t,n)}},{key:"add",value:function(e,t){return t?(t._m_X=this._m_X+e._m_X,t._m_Y=this._m_Y+e._m_Y,t._m_Z=this._m_Z+e._m_Z,t):(this._m_X+=e._m_X,this._m_Y+=e._m_Y,this._m_Z+=e._m_Z,this)}},{key:"addRetNew",value:function(t){var n=new e(0,0,0,1);return this.add(t,n)}},{key:"multLength",value:function(e,t){return t?(t._m_X=this._m_X*e,t._m_Y=this._m_Y*e,t._m_Z=this._m_Z*e,t):(this._m_X*=e,this._m_Y*=e,this._m_Z*=e,this)}},{key:"normal",value:function(){var e=this.length();return e?(e=1/e,this._m_X*=e,this._m_Y*=e,this._m_Z*=e):console.error("Vector3.normal异常,长度为0。"),this}},{key:"distanceSq",value:function(e){var t=this._m_X-e._m_X,n=this._m_Y-e._m_Y,r=this._m_Z-e._m_Z;return t*t+n*n+r*r}},{key:"distance",value:function(e){return Math.sqrt(this.distanceSq(e))}},{key:"length",value:function(){var e=this._m_X*this._m_X+this._m_Y*this._m_Y+this._m_Z*this._m_Z;return e=Math.sqrt(e)}},{key:"toString",value:function(){return"["+this._m_X+","+this._m_Y+","+this._m_Z+","+this._m_W+"]"}},{key:"inter",value:function(t,n,r){return e.inter(this,t,n,r)}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=a,r=a,i="_S_TEMP_VEC4",o=new a,i in r?Object.defineProperty(r,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[i]=o},5776:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e,t){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),i.call(this,e,t)}return t=s,(n=[{key:"getType",value:function(){return"FramePicture"}},{key:"isFramePicture",value:function(){return!0}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(7280))&&i.__esModule?i:{default:i}).default);t.default=l},4720:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=l(n(2949)),o=l(n(9784)),a=l(n(307)),_=l(n(2320)),s=l(n(2475)),u=l(n(3801));l(n(3846));function l(e){return e&&e.__esModule?e:{default:e}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var i=d(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(h,e);var t,n,r,l=m(h);function h(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),(n=l.call(this,e,t))._m_Mesh=null,n._m_ModelAABBBoundingBox=null,n._m_Material=null,n._m_IsDrawable=!0,n._m_Opaque=!0,n}return t=h,(n=[{key:"getType",value:function(){return"Geometry"}},{key:"lod",value:function(e){this._m_CurrentLod!=e&&(this._m_CurrentLod=e,null!=this._m_Mesh&&this._m_Mesh.lod(this._m_CurrentLod))}},{key:"setMaterial",value:function(e){this._m_Material=e,this._m_Mesh&&this._refreshBufLocal()}},{key:"getMaterial",value:function(){return this._m_Material}},{key:"setMesh",value:function(e){this._m_Mesh=e,this._m_Material&&this._refreshBufLocal()}},{key:"getMesh",value:function(){return this._m_Mesh}},{key:"updateBound",value:function(){this._m_Mesh&&(this._m_Mesh._updateBound(this._m_Scene.getCanvas().getGLContext()),this._m_ModelAABBBoundingBox||(this._m_ModelAABBBoundingBox=new u.default,this._m_ModelAABBBoundingBox.fromPositions(this._m_Mesh.getData(a.default.S_POSITIONS)),this._m_BoudingVolume||(this._m_BoudingVolume=new u.default),this._m_BoudingVolume.setTo(this._m_ModelAABBBoundingBox)),this._m_Mesh.lod(this._m_CurrentLod))}},{key:"getBoundingVolume",value:function(){return this._m_UpdateBoundingVolume&&(_.default.decomposeMat4(this.getWorldMatrix(),i.default.S_TEMP_VEC3,i.default.S_TEMP_Q,i.default.S_TEMP_VEC3_2),this._m_ModelAABBBoundingBox.transform(i.default.S_TEMP_VEC3_2,i.default.S_TEMP_Q,i.default.S_TEMP_VEC3,this._m_BoudingVolume),this._m_UpdateBoundingVolume=!1),this._m_BoudingVolume}},{key:"_refreshBufLocal",value:function(){}},{key:"isDrawable",value:function(){return this._m_IsDrawable}},{key:"setIsDrawable",value:function(e){this._m_IsDrawable=e}},{key:"isFramePicture",value:function(){return!1}},{key:"setOpaque",value:function(){this._m_Opaque=!0}},{key:"isOpaque",value:function(){return this._m_Opaque}},{key:"setTranslucent",value:function(){this._m_Opaque=!1}},{key:"isTranslucent",value:function(){return!this._m_Opaque}},{key:"isSky",value:function(){}},{key:"isGUI",value:function(){}},{key:"draw",value:function(e){var t=this._m_Scene.getCanvas().getGLContext(),n=e.m_LastSubShader.getContextVars(),r=null,i=null;for(var a in n)switch(a){case o.default.S_MODEL_MATRIX_SRC:t[n[a].fun](n[a].loc,!1,this.getWorldMatrix().getBufferData());break;case o.default.S_MV_SRC:r=e.getCalcContext(o.default.S_VIEW_MATRIX_SRC),_.default.multiplyMM(s.default.S_TEMP_MAT4,0,r,0,this.getWorldMatrix(),0),n[a].fun(n[a].loc,!1,s.default.S_TEMP_MAT4.getBufferData());break;case o.default.S_MVP_SRC:r=e.getCalcContext(o.default.S_VIEW_MATRIX_SRC),i=e.getCalcContext(o.default.S_PROJECT_MATRIX_SRC),_.default.multiplyMM(s.default.S_TEMP_MAT4,0,r,0,this.getWorldMatrix(),0),_.default.multiplyMM(s.default.S_TEMP_MAT4_1,0,i,0,r,0),t[n[a].fun](n[a].loc,!1,s.default.S_TEMP_MAT4_1.getBufferData())}this._m_Mesh.draw(t)}}])&&f(t.prototype,n),r&&f(t,r),h}(i.default);t.default=p},2949:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=c(n(9650)),o=c(n(2320)),a=c(n(5604)),_=c(n(453)),s=c(n(3801)),u=c(n(1550)),l=c(n(5397)),f=c(n(3846));function c(e){return e&&e.__esModule?e:{default:e}}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=g(e);if(t){var i=g(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return p(this,n)}}function p(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(c,e);var t,n,r,i=d(c);function c(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),(n=i.call(this,e,{id:l.default.nextId()+t.id}))._m_Name=t.id,n._m_CurrentLod=0,n._m_LocalMatrix=new o.default,n._m_WorldMatrix=new o.default,n._m_Parent=null,n._m_Children=[],n._m_ChildrenIDs={},n._m_LocalScale=new a.default(1,1,1),n._m_LocalRotation=new _.default(0,0,0,1),n._m_LocalTranslation=new a.default,n._m_UpdateLocalMatrix=!1,n._m_UpdateWorldMatrix=!1,n._m_BoudingVolume=null,n._m_UpdateBoundingVolume=!0,n._m_FrustumContain=u.default.S_FRUSTUM_INTERSECT_INTERSECTS,n._m_CullMode=null,n._m_CullingFlags=1,n._m_CullingFlags|=c.S_DEFAULT_FRUSTUM_CULLING,n._m_FilterFlag=c.S_DYNAMIC,n._m_ShadowMode=1,n._m_ShadowMode|=c.S_SHADOW_CAST_AND_RECEIVE,n}return t=c,(n=[{key:"getType",value:function(){return"Node"}},{key:"castShadow",value:function(e){!e||0!=(this._m_ShadowMode&c.S_SHADOW_CAST)&&0!=(this._m_ShadowMode&c.S_SHADOW_CAST_AND_RECEIVE)?(0!=(this._m_ShadowMode&c.S_SHADOW_CAST)&&(this._m_ShadowMode^=c.S_SHADOW_CAST),0!=(this._m_ShadowMode&c.S_SHADOW_CAST_AND_RECEIVE)&&(this._m_ShadowMode^=c.S_SHADOW_CAST_AND_RECEIVE,console.log("_m_ShadowMode:"+this._m_ShadowMode),this._m_ShadowMode&0==c.S_SHADOW_RECEIVE&&(this._m_ShadowMode|=c.S_SHADOW_RECEIVE))):this._m_ShadowMode|=c.S_SHADOW_CAST,this._m_Children.forEach((function(t){t.castShadow(e)}))}},{key:"isCastShadow",value:function(){return 0!=(this._m_ShadowMode&c.S_SHADOW_CAST)||0!=(this._m_ShadowMode&c.S_SHADOW_CAST_AND_RECEIVE)}},{key:"receiveShadow",value:function(e){!e||0!=(this._m_ShadowMode&c.S_SHADOW_RECEIVE)&&0!=(this._m_FilterFlag&c.S_SHADOW_CAST_AND_RECEIVE)?(0!=(this._m_ShadowMode&c.S_SHADOW_RECEIVE)&&(this._m_ShadowMode^=c.S_SHADOW_RECEIVE),0!=(this._m_ShadowMode&c.S_SHADOW_CAST_AND_RECEIVE)&&(this._m_ShadowMode^=c.S_SHADOW_CAST_AND_RECEIVE,this._m_ShadowMode&0==c.S_SHADOW_CAST&&(this._m_ShadowMode|=c.S_SHADOW_CAST))):this._m_ShadowMode|=c.S_SHADOW_RECEIVE,this._m_Children.forEach((function(t){t.receiveShadow(e)}))}},{key:"isReceiveShadow",value:function(){return 0!=(this._m_ShadowMode&c.S_SHADOW_RECEIVE)||0!=(this._m_ShadowMode&c.S_SHADOW_CAST_AND_RECEIVE)}},{key:"isDrawable",value:function(){return!1}},{key:"lod",value:function(e){this._m_CurrentLod!=e&&this._m_Children.getChildren().length>0&&this._m_Children.forEach((function(t){t.lod(e)}))}},{key:"setFilterFlag",value:function(e){this._m_FilterFlag=e}},{key:"getFilterFlag",value:function(){return this._m_FilterFlag}},{key:"getCullingFlags",value:function(){return this._m_CullingFlags}},{key:"clearCullingFlags",value:function(e){this._m_CullingFlags^=e}},{key:"addCullingFlags",value:function(e){this._m_CullingFlags|=e}},{key:"inFrustum",value:function(e){return this._m_FrustumContain=null==this._m_Parent?u.default.S_FRUSTUM_INTERSECT_INTERSECTS:this._m_Parent._m_FrustumContain,this._m_FrustumContain==u.default.S_FRUSTUM_INTERSECT_INTERSECTS&&(this._m_FrustumContain=e.frustumContains(this.getBoundingVolume())),this._m_FrustumContain!=u.default.S_FRUSTUM_INTERSECT_OUTSIDE}},{key:"getBoundingVolume",value:function(){var e=this;if(this._m_UpdateBoundingVolume){if(this._m_Children.length>0){var t=null;this._m_Children.forEach((function(n){(t=n.getBoundingVolume())&&(e._m_BoudingVolume||(e._m_BoudingVolume=new s.default),e._m_BoudingVolume.merge(t))}))}this._m_UpdateBoundingVolume=!1}return this._m_BoudingVolume}},{key:"getChildren",value:function(){return this._m_Children}},{key:"getChildrenAtName",value:function(e){var t=this._m_ChildrenIDs[e];if(t)return t;for(var n=this._m_Children.length,r=0;r<n;r++)if(t=this._m_Children[r].getChildrenAtName(e))return t;return null}},{key:"getChildrenAtIndex",value:function(e){return e>=this._m_Children.length?null:this._m_Children[e]}},{key:"getParent",value:function(){return this._m_Parent}},{key:"setLocalScale",value:function(e){this._m_LocalScale.setTo(e),this._updateLocalMatrix()}},{key:"setLocalScaleXYZ",value:function(e,t,n){this._m_LocalScale.setToInXYZ(e,t,n),this._updateLocalMatrix()}},{key:"getLocalScale",value:function(){return this._m_LocalScale}},{key:"setLocalRotation",value:function(e){this._m_LocalRotation.setTo(e),this._updateLocalMatrix()}},{key:"setLocalRotationFromEuler",value:function(e,t,n){this._m_LocalRotation.fromEuler(e,t,n),this._updateLocalMatrix()}},{key:"setLocalRotationFromXYZW",value:function(e,t,n,r){this._m_LocalRotation.setToInXYZW(e,t,n,r),this._updateLocalMatrix()}},{key:"getLocalRotation",value:function(){return this._m_LocalRotation}},{key:"setLocalTranslation",value:function(e){this._m_LocalTranslation.setTo(e),this._updateLocalMatrix()}},{key:"setLocalTranslationXYZ",value:function(e,t,n){this._m_LocalTranslation.setToInXYZ(e,t,n),this._updateLocalMatrix()}},{key:"getLocalTranslation",value:function(){return this._m_LocalTranslation}},{key:"_updateBounding",value:function(){this._m_UpdateBoundingVolume=!0}},{key:"_updateLocalMatrix",value:function(){this._m_UpdateLocalMatrix=!0,this._updateWorldMatrix(),this._updateBounding(),null!=this._m_Parent&&this._m_Parent._updateBounding(),this._m_Children.forEach((function(e){e._updateBounding()}))}},{key:"_updateWorldMatrix",value:function(){this._m_UpdateWorldMatrix=!0,this._m_Children.forEach((function(e){e._updateWorldMatrix()}))}},{key:"getLocalMatrix",value:function(){return this._m_UpdateLocalMatrix&&(o.default.composeMat4(this._m_LocalTranslation,this._m_LocalRotation,this._m_LocalScale,this._m_LocalMatrix),this._m_UpdateLocalMatrix=!1),this._m_LocalMatrix}},{key:"setLocalMatrix",value:function(e){this._m_LocalMatrix.set(e),this._updateLocalMatrix(),this._m_UpdateLocalMatrix=!1,o.default.decomposeMat4(e,this._m_LocalTranslation,this._m_LocalRotation,this._m_LocalScale)}},{key:"setLocalMatrixFromArray",value:function(e){this._m_LocalMatrix.setArray(e),this._updateLocalMatrix(),this._m_UpdateLocalMatrix=!1,o.default.decomposeMat4(this._m_LocalMatrix,this._m_LocalTranslation,this._m_LocalRotation,this._m_LocalScale)}},{key:"getWorldMatrix",value:function(){return this._m_UpdateWorldMatrix&&this._buildWorldMatrix(),this._m_WorldMatrix}},{key:"_buildWorldMatrix",value:function(){this._m_UpdateWorldMatrix&&(this.getLocalMatrix(),this._m_Parent?o.default.multiplyMM(this._m_WorldMatrix,0,this._m_Parent.getWorldMatrix(),0,this._m_LocalMatrix,0):this._m_WorldMatrix.set(this._m_LocalMatrix),this._m_UpdateWorldMatrix=!1)}},{key:"getName",value:function(){return this._m_Name}},{key:"addChildren",value:function(e){if(e instanceof c)if(null!=e._m_Parent||this._m_ChildrenIDs[e.getName()]){var t=e.getName()+l.default.nextId();f.default.warn("已存在:"+e.getName()+",重命名为:"+t),e._m_Name=t,null==e._m_Parent?(this._m_ChildrenIDs[e.getName()]=e,this._m_Children.push(e),e._m_Parent=this,e._updateWorldMatrix(),this._updateBounding()):f.default.warn(t+"已存在与父节点:"+e._m_Parent.getName())}else this._m_ChildrenIDs[e.getName()]=e,this._m_Children.push(e),e._m_Parent=this,e._updateWorldMatrix(),this._updateBounding();else f.default.error("children不是一个合法的Node!")}},{key:"removeChildren",value:function(e){if(e instanceof c&&this._m_ChildrenIDs[e.getName()]){this._m_ChildrenIDs[e.getName()]=null;var t=this._m_Children.indexOf(e);t>-1&&this._m_Children.splice(t,1),e._m_Parent=null}}},{key:"traverse",value:function(e){e&&e(this),this._m_Children.forEach((function(t){e&&e(t),t.traverse(e)}))}}])&&m(t.prototype,n),r&&m(t,r),c}(i.default);t.default=v,S(v,"S_DEFAULT_FRUSTUM_CULLING",2),S(v,"S_DYNAMIC",4),S(v,"S_ALWAYS",8),S(v,"S_NEVER",16),S(v,"S_SHADOW_RECEIVE",2),S(v,"S_SHADOW_CAST",4),S(v,"S_SHADOW_CAST_AND_RECEIVE",8),S(v,"S_SHADOW_NONE",0),S(v,"S_TEMP_VEC3",new a.default),S(v,"S_TEMP_Q",new _.default),S(v,"S_TEMP_VEC3_2",new a.default)},7280:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=f(n(4720)),o=f(n(2949)),a=f(n(307)),_=f(n(3370)),s=f(n(8113)),u=f(n(4008)),l=f(n(5397));function f(e){return e&&e.__esModule?e:{default:e}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=p(e);if(t){var i=p(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return d(this,n)}}function d(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}var g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(f,e);var t,n,r,i=h(f);function f(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(n=i.call(this,e,t))._m_Width=t.width||1,n._m_Height=t.height||1,n._m_Zindex=1,n._m_Left=0,n._m_Top=0;var r=new a.default;return r.setData(a.default.S_POSITIONS,[-1,1,1,-1,-1,1,1,1,1,1,-1,1]),r.setData(a.default.S_UV0,[0,1,0,0,1,1,1,0]),r.setData(a.default.S_INDICES,[0,1,2,2,1,3]),n.setMesh(r),n.updateBound(),n._m_FilterFlag=o.default.S_NEVER,n._m_ShadowMode=o.default.S_SHADOW_NONE,n}return t=f,(n=[{key:"getType",value:function(){return"Picture"}},{key:"useDefaultMat",value:function(){this.setMaterial(new u.default(this._m_Scene,{id:"picture_gui_"+l.default.nextId(),materialDef:s.default.parse(_.default.S_PICTURE_DEF_DATA)}))}},{key:"setSize",value:function(e,t){this._m_Width==e&&this._m_Height==t||this.setLocalScaleXYZ(e,t,1)}},{key:"setLeftTop",value:function(e,t){this._m_Left==e&&this._m_Top==t||(this._m_Left=e,this._m_Top=t,this.setLocalTranslationXYZ(this._m_Left,this._m_Top,2*this._m_Zindex-1))}},{key:"setZIndex",value:function(e){this._m_Zindex!=e&&(this._m_Zindex=Math.min(Math.max(0,e),1),this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight(),this.setLocalTranslationXYZ(this._m_Left,this._m_Top,2*this._m_Zindex-1))}},{key:"getWidthSize",value:function(){return this._m_Width*this._m_Scene.getCanvas().getWidth()}},{key:"getWidth",value:function(){return this._m_Width}},{key:"getHeightSize",value:function(){return this._m_Height*this._m_Scene.getCanvas().getHeight()}},{key:"getHeight",value:function(){return this._m_Height}},{key:"isDrawable",value:function(){return!0}},{key:"isGUI",value:function(){return!0}}])&&c(t.prototype,n),r&&c(t,r),f}(i.default);t.default=g},5765:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(4720)),o=_(n(307)),a=_(n(5397));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(_,e);var t,n,r,i=l(_);function _(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_),n=i.call(this,e,t);var r=t.xHalf||1;r<=0&&(console.error("xHalf不能小于等于0!"),r*=-1);var s=t.yHalf||1;s<=0&&(console.error("yHalf不能小于等于0!"),s*=-1);var u=t.zHalf||1;u<=0&&(console.error("zHalf不能小于等于0!"),u*=-1);var l=t.center,f=l?l._m_X:0,c=l?l._m_Y:0,m=l?l._m_Z:0,h=-r+f,d=-s+c,p=-u+m,g=r+f,S=s+c,v=u+m,y=new o.default;y.setData(o.default.S_POSITIONS,[g,S,v,h,S,v,h,d,v,g,d,v,g,S,v,g,d,v,g,d,p,g,S,p,g,S,v,g,S,p,h,S,p,h,S,v,h,S,v,h,S,p,h,d,p,h,d,v,h,d,p,g,d,p,g,d,v,h,d,v,g,d,p,h,d,p,h,S,p,g,S,p]),y.setData(o.default.S_NORMALS,[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),y.setData(o.default.S_UV0,[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0]),y.setData(o.default.S_INDICES,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var C=a.default.generatorTangents2(y.getData(o.default.S_INDICES),y.getData(o.default.S_POSITIONS),y.getData(o.default.S_UV0),y.getData(o.default.S_NORMALS));return y.setData(o.default.S_TANGENTS,C),n.setMesh(y),n.updateBound(),n}return t=_,(n=[{key:"getType",value:function(){return"Box"}}])&&s(t.prototype,n),r&&s(t,r),_}(i.default);t.default=m},4992:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(4720)),o=_(n(307)),a=_(n(5397));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(n,e);var t=u(n);function n(e,r){var i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),i=t.call(this,e,r);for(var _=void 0!==r.radiusTop?r.radiusTop:1,s=void 0!==r.radiusBottom?r.radiusBottom:1,u=void 0!==r.height?r.height:1,l=r.radialSegments||60,f=r.heightSegments||1,c=r.openEnded||!1,m=u/2,h=u/f,d=2*Math.PI/l,p=1/l,g=(i.radiusBottom,(_-s)/f),S=[],v=[],y=[],C=[],T=(90-180*Math.atan(u/(s-_))/Math.PI)/90,b=0;b<=f;b++)for(var P=_-b*g,E=m-b*h,D=0;D<=l;D++){var R=Math.sin(D*d),w=Math.cos(D*d);v.push(P*R),v.push(T),v.push(P*w),y.push(1-D*p),y.push(0+1*b/f),S.push(P*R),S.push(E),S.push(P*w)}for(var M=0;M<f;M++)for(var A=0;A<=l;A++){var L=M*(l+1)+A,I=L+l;C.push(L),C.push(I),C.push(I+1),C.push(L),C.push(I+1),C.push(L+1)}if(!c&&_>0){var x=S.length/3;v.push(0),v.push(1),v.push(0),y.push(.5),y.push(.5),S.push(0),S.push(m),S.push(0);for(var O=0;O<=l;O++){var F=Math.sin(O*d),k=Math.cos(O*d),B=.5*Math.sin(O*d)+.5,N=.5*Math.cos(O*d)+.5;v.push(_*F),v.push(1),v.push(_*k),y.push(B),y.push(N),S.push(_*F),S.push(m),S.push(_*k)}for(var V=0;V<l;V++){var G=x,U=x+1+V;C.push(U),C.push(U+1),C.push(G)}}if(!c&&s>0){var H=S.length/3;v.push(0),v.push(-1),v.push(0),y.push(.5),y.push(.5),S.push(0),S.push(0-m),S.push(0);for(var j=0;j<=l;j++){var X=Math.sin(j*d),Y=Math.cos(j*d),W=.5*Math.sin(j*d)+.5,Z=.5*Math.cos(j*d)+.5;v.push(s*X),v.push(-1),v.push(s*Y),y.push(W),y.push(Z),S.push(s*X),S.push(0-m),S.push(s*Y)}for(var z=0;z<l;z++){var q=H,K=H+1+z;C.push(q),C.push(K+1),C.push(K)}}var J=new o.default;J.setData(o.default.S_POSITIONS,S),J.setData(o.default.S_NORMALS,v),J.setData(o.default.S_UV0,y),J.setData(o.default.S_INDICES,C);var Q=a.default.generatorTangents2(J.getData(o.default.S_INDICES),J.getData(o.default.S_POSITIONS),J.getData(o.default.S_UV0),J.getData(o.default.S_NORMALS));return J.setData(o.default.S_TANGENTS,Q),i.setMesh(J),i.updateBound(),i}return n}(i.default);t.default=c},7698:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(4720)),o=_(n(307)),a=_(n(5397));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(n,e);var t=u(n);function n(e,r){var i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),i=t.call(this,e,r);var _,s,u,l,f,c,m,h,d=r.width||1,p=r.height||1,g=[],S=[],v=[],y=[],C=d/2,T=p/2,b=r.widthSegments||1,P=r.heightSegments||1,E=b+1,D=P+1,R=d/b,w=p/P;for(s=0;s<D;s++)for(_=0;_<E;_++)u=_*R-C,l=s*w-T,g.push(u),g.push(0),g.push(-l),S.push(0),S.push(1),S.push(0),v.push(_/b),v.push(1-s/P);for(s=0;s<P;s++)for(_=0;_<b;_++)f=_+E*s,c=_+E*(s+1),m=_+1+E*(s+1),h=_+1+E*s,y.push(f),y.push(c),y.push(m),y.push(m),y.push(h),y.push(f);var M=new o.default;M.setData(o.default.S_POSITIONS,g),M.setData(o.default.S_NORMALS,S),M.setData(o.default.S_UV0,v),M.setData(o.default.S_INDICES,y);var A=a.default.generatorTangents2(M.getData(o.default.S_INDICES),M.getData(o.default.S_POSITIONS),M.getData(o.default.S_UV0),M.getData(o.default.S_NORMALS));return M.setData(o.default.S_TANGENTS,A),M.setPrimitive(o.default.S_PRIMITIVE_LINES),i.setMesh(M),i.updateBound(),i}return n}(i.default);t.default=c},1645:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(4720)),o=_(n(307)),a=_(n(5397));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(n,e);var t=u(n);function n(e,r){var i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),i=t.call(this,e,r);var _=r.xSize||1;_<=0&&(console.error("xSize不能小于等于0!"),_*=-1);var s=r.zSize||1;s<=0&&(console.error("zSize不能小于等于0!"),s*=-1);var u=r.xSegments||1;u<=0&&(console.error("xSegments不能小于等于0!"),u*=-1),u<1&&(u=1);var l=r.zSegments||1;l<0&&(console.error("zSegments不能小于等于0!"),l*=-1),l<1&&(l=1);var f,c,m,h,d,p,g,S=r.center,v=S?S[0]:0,y=S?S[1]:0,C=S?S[2]:0,T=_/2,b=s/2,P=Math.floor(u)||1,E=Math.floor(l)||1,D=P+1,R=E+1,w=_/P,M=s/E,A=new Float32Array(D*R*3),L=new Float32Array(D*R*3),I=new Float32Array(D*R*2),x=0,O=0;for(f=0;f<R;f++){var F=f*M-b;for(c=0;c<D;c++)m=c*w-T,A[x]=m+v,A[x+1]=y,A[x+2]=-F+C,L[x+2]=-1,I[O]=P-c,I[O+1]=E-f,r.xRepeat||(I[O]/=P),r.zRepeat||(I[O+1]/=E),x+=3,O+=2}x=0;var k=new(A.length/3>65535?Uint32Array:Uint16Array)(P*E*6);for(f=0;f<E;f++)for(c=0;c<P;c++)h=c+D*f,d=c+D*(f+1),p=c+1+D*(f+1),g=c+1+D*f,k[x]=g,k[x+1]=d,k[x+2]=h,k[x+3]=g,k[x+4]=p,k[x+5]=d,x+=6;var B=new o.default;B.setData(o.default.S_POSITIONS,A),B.setData(o.default.S_NORMALS,L),B.setData(o.default.S_UV0,I),B.setData(o.default.S_INDICES,k);var N=a.default.generatorTangents2(B.getData(o.default.S_INDICES),B.getData(o.default.S_POSITIONS),B.getData(o.default.S_UV0),B.getData(o.default.S_NORMALS));return B.setData(o.default.S_TANGENTS,N),i.setMesh(B),i.updateBound(),i}return n}(i.default);t.default=c},6341:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(4720)),o=_(n(307)),a=_(n(5397));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(_,e);var t,n,r,i=l(_);function _(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_),n=i.call(this,e,t);var r=t.lod||1,s=t.center?t.center._m_X:0,u=t.center?t.center._m_Y:0,l=t.center?t.center._m_Z:0,f=t.radius||1;f<=0&&(console.error("radius不能小于等于0!"),f*=-1);var c=t.heightSegments||18;c<=0&&(console.error("heightSegments不能小于等于0!"),c*=-1),(c=Math.floor(r*c))<18&&(c=18);var m=t.widthSegments||18;m<=0&&(console.error("widthSegments不能小于等于0!"),m*=-1),(m=Math.floor(r*m))<18&&(m=18);var h,d,p,g,S,v,y,C,T,b,P,E,D,R,w=t.widthUVScale||.5,M=(t.heightUVScale,[]),A=[],L=[],I=[];for(h=0;h<=c;h++)for(p=h*Math.PI/c,g=Math.sin(p),S=Math.cos(p),d=0;d<=m;d++)v=2*d*Math.PI/m,y=Math.sin(v),C=Math.cos(v)*g,T=S,b=y*g,P=1-d/(m*w),E=h/(c*w),A.push(C),A.push(T),A.push(b),L.push(P),L.push(E),M.push(s+f*C),M.push(u+f*T),M.push(l+f*b);for(h=0;h<c;h++)for(d=0;d<m;d++)R=(D=h*(m+1)+d)+m+1,I.push(D+1),I.push(R+1),I.push(R),I.push(D+1),I.push(R),I.push(D);var x=new o.default;x.setData(o.default.S_POSITIONS,M),x.setData(o.default.S_NORMALS,A),x.setData(o.default.S_UV0,L),x.setData(o.default.S_INDICES,I);var O=a.default.generatorTangents2(x.getData(o.default.S_INDICES),x.getData(o.default.S_POSITIONS),x.getData(o.default.S_UV0),x.getData(o.default.S_NORMALS));return x.setData(o.default.S_TANGENTS,O),n.setMesh(x),n.updateBound(),n}return t=_,(n=[{key:"getType",value:function(){return"Sphere"}}])&&s(t.prototype,n),r&&s(t,r),_}(i.default);t.default=m},8011:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(4720)),o=_(n(307)),a=_(n(5397));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(_,e);var t,n,r,i=l(_);function _(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_),n=i.call(this,e,t);for(var r,s,u,l,f,c,m,h,d,p,g,S,v=t.radius||1,y=t.tube||.3,C=t.segmentsR||32,T=t.segmentsT||24,b=t.arc||2*Math.PI,P=[],E=[],D=[],R=[],w=0;w<=C;w++)for(var M=0;M<=T;M++)r=M/T*b,s=w/C*Math.PI*2,u=v*Math.cos(r),l=v*Math.sin(r),f=(v+y*Math.cos(s))*Math.cos(r),c=(v+y*Math.cos(s))*Math.sin(r),m=y*Math.sin(s),P.push(f),P.push(c),P.push(m),D.push(M/T),D.push(1-w/C),h=n.normalize(n.sub([f,c,m],[u,l,0],[]),[]),E.push(h[0]),E.push(h[1]),E.push(h[2]);for(var A=1;A<=C;A++)for(var L=1;L<=T;L++)d=(T+1)*A+L-1,p=(T+1)*(A-1)+L-1,g=(T+1)*(A-1)+L,S=(T+1)*A+L,R.push(d),R.push(p),R.push(g),R.push(g),R.push(S),R.push(d);var I=new o.default;I.setData(o.default.S_POSITIONS,P),I.setData(o.default.S_NORMALS,E),I.setData(o.default.S_UV0,D),I.setData(o.default.S_INDICES,R);var x=a.default.generatorTangents2(I.getData(o.default.S_INDICES),I.getData(o.default.S_POSITIONS),I.getData(o.default.S_UV0),I.getData(o.default.S_NORMALS));return I.setData(o.default.S_TANGENTS,x),n.setMesh(I),n.updateBound(),n}return t=_,(n=[{key:"normalize",value:function(e,t){var n=1/len(e);return this.mul(e,n,t)}},{key:"len",value:function(e){return Math.sqrt(this.sqLen(e))}},{key:"sqLen",value:function(e){return this.dot(e,e)}},{key:"dot",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}},{key:"mul",value:function(e,t,n){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}},{key:"sub",value:function(e,t,n){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}}])&&s(t.prototype,n),r&&s(t,r),_}(i.default);t.default=m},9468:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=l(n(4720)),o=l(n(307)),a=l(n(4008)),_=l(n(5397)),s=l(n(3370)),u=l(n(8113));function l(e){return e&&e.__esModule?e:{default:e}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var i=d(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(l,e);var t,n,r,i=m(l);function l(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),n=i.call(this,e,t);var r=new o.default;r.setData(o.default.S_POSITIONS,[3.4201992,0,-9.396927,2.7669992,2.0103426,-9.396927,1.0568995,3.2528028,-9.396927,-1.0568998,3.2528026,-9.396927,-2.7669995,2.0103424,-9.396927,-3.4201992,-2.9900332e-7,-9.396927,-2.766999,-2.010343,-9.396927,-1.0569,-3.2528026,-9.396927,1.0569001,-3.2528026,-9.396927,2.7670002,-2.0103416,-9.396927,3.4201992,0,-9.396927,6.427875,0,-7.660445,5.20026,3.7782102,-7.660445,1.9863225,6.1132727,-7.660445,-1.9863229,6.113272,-7.660445,-5.2002606,3.7782097,-7.660445,-6.427875,-5.6194267e-7,-7.660445,-5.2002597,-3.7782109,-7.660445,-1.9863232,-6.113272,-7.660445,1.9863235,-6.113272,-7.660445,5.2002616,-3.7782083,-7.660445,6.427875,0,-7.660445,8.6602545,0,-4.9999995,7.0062933,5.0903697,-4.9999995,2.6761656,8.236392,-4.9999995,-2.676166,8.236391,-4.9999995,-7.006294,5.090369,-4.9999995,-8.6602545,-7.5710346e-7,-4.9999995,-7.006293,-5.0903707,-4.9999995,-2.6761668,-8.236391,-4.9999995,2.676167,-8.236391,-4.9999995,7.006295,-5.0903673,-4.9999995,8.6602545,0,-4.9999995,9.848078,0,-1.7364818,7.9672623,5.7885547,-1.7364818,3.0432231,9.366078,-1.7364818,-3.0432239,9.366078,-1.7364818,-7.9672627,5.788554,-1.7364818,-9.848078,-8.6094633e-7,-1.7364818,-7.967262,-5.788556,-1.7364818,-3.0432243,-9.366078,-1.7364818,3.0432246,-9.366078,-1.7364818,7.9672647,-5.788552,-1.7364818,9.848078,0,-1.7364818,9.848078,0,1.7364826,7.9672623,5.7885547,1.7364826,3.0432231,9.366078,1.7364826,-3.0432239,9.366078,1.7364826,-7.9672627,5.788554,1.7364826,-9.848078,-8.6094633e-7,1.7364826,-7.967262,-5.788556,1.7364826,-3.0432243,-9.366078,1.7364826,3.0432246,-9.366078,1.7364826,7.9672647,-5.788552,1.7364826,9.848078,0,1.7364826,8.660254,0,5.0000005,7.0062923,5.090369,5.0000005,2.6761653,8.236391,5.0000005,-2.6761658,8.23639,5.0000005,-7.006293,5.0903687,5.0000005,-8.660254,-7.571034e-7,5.0000005,-7.006292,-5.09037,5.0000005,-2.6761663,-8.23639,5.0000005,2.6761665,-8.23639,5.0000005,7.0062943,-5.090367,5.0000005,8.660254,0,5.0000005,6.427875,0,7.660445,5.20026,3.7782102,7.660445,1.9863225,6.1132727,7.660445,-1.9863229,6.113272,7.660445,-5.2002606,3.7782097,7.660445,-6.427875,-5.6194267e-7,7.660445,-5.2002597,-3.7782109,7.660445,-1.9863232,-6.113272,7.660445,1.9863235,-6.113272,7.660445,5.2002616,-3.7782083,7.660445,6.427875,0,7.660445,3.4201992,0,9.396927,2.7669992,2.0103426,9.396927,1.0568995,3.2528028,9.396927,-1.0568998,3.2528026,9.396927,-2.7669995,2.0103424,9.396927,-3.4201992,-2.9900332e-7,9.396927,-2.766999,-2.010343,9.396927,-1.0569,-3.2528026,9.396927,1.0569001,-3.2528026,9.396927,2.7670002,-2.0103416,9.396927,3.4201992,0,9.396927,0,0,-10,0,0,10]),r.setData(o.default.S_INDICES,[0,11,1,1,11,12,1,12,2,2,12,13,2,13,3,3,13,14,3,14,4,4,14,15,4,15,5,5,15,16,5,16,6,6,16,17,6,17,7,7,17,18,7,18,8,8,18,19,8,19,9,9,19,20,9,20,10,10,20,21,11,22,12,12,22,23,12,23,13,13,23,24,13,24,14,14,24,25,14,25,15,15,25,26,15,26,16,16,26,27,16,27,17,17,27,28,17,28,18,18,28,29,18,29,19,19,29,30,19,30,20,20,30,31,20,31,21,21,31,32,22,33,23,23,33,34,23,34,24,24,34,35,24,35,25,25,35,36,25,36,26,26,36,37,26,37,27,27,37,38,27,38,28,28,38,39,28,39,29,29,39,40,29,40,30,30,40,41,30,41,31,31,41,42,31,42,32,32,42,43,33,44,34,34,44,45,34,45,35,35,45,46,35,46,36,36,46,47,36,47,37,37,47,48,37,48,38,38,48,49,38,49,39,39,49,50,39,50,40,40,50,51,40,51,41,41,51,52,41,52,42,42,52,53,42,53,43,43,53,54,44,55,45,45,55,56,45,56,46,46,56,57,46,57,47,47,57,58,47,58,48,48,58,59,48,59,49,49,59,60,49,60,50,50,60,61,50,61,51,51,61,62,51,62,52,52,62,63,52,63,53,53,63,64,53,64,54,54,64,65,55,66,56,56,66,67,56,67,57,57,67,68,57,68,58,58,68,69,58,69,59,59,69,70,59,70,60,60,70,71,60,71,61,61,71,72,61,72,62,62,72,73,62,73,63,63,73,74,63,74,64,64,74,75,64,75,65,65,75,76,66,77,67,67,77,78,67,78,68,68,78,79,68,79,69,69,79,80,69,80,70,70,80,81,70,81,71,71,81,82,71,82,72,72,82,83,72,83,73,73,83,84,73,84,74,74,84,85,74,85,75,75,85,86,75,86,76,76,86,87,0,1,88,1,2,88,2,3,88,3,4,88,4,5,88,5,6,88,6,7,88,7,8,88,8,9,88,9,10,88,77,89,78,78,89,79,79,89,80,80,89,81,81,89,82,82,89,83,83,89,84,84,89,85,85,89,86,86,89,87]),n.setMesh(r),n.updateBound();var f=new a.default(e,{id:t.id+_.default.nextId(),materialDef:u.default.parse(s.default.S_DEFAULT_SKY_BOX_DEF)});return n.setMaterial(f),n}return t=l,(n=[{key:"getType",value:function(){return"SkyBox"}}])&&f(t.prototype,n),r&&f(t,r),l}(i.default);t.default=p},2482:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(9650)),o=_(n(2949)),a=_(n(3846));_(n(5397));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(_,e);var t,n,r,i=l(_);function _(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_),n=i.call(this,e,t),e instanceof o.default||a.default.error("owner必须是Geometry或其子类!"),n._m_LastDistance=0,n._m_LastLodLevel=0,n._m_DistCommonDifference=t.distCommonDifference||1,n._m_LodLevelDists=[],n._m_TrisPerPixel=t.trisPerPixel||1,n._m_NumLodLevels=0,n._m_NumTris=[],n.distr(),n._m_Scene.on("render",(function(e){n._doUpdate()})),n}return t=_,(n=[{key:"getType",value:function(){return"LodControl"}},{key:"distr",value:function(){this._m_NumLodLevels=this._m_Owner.getMesh().getLodLevelCount();for(var e=0;e<this._m_NumLodLevels;e++)this._m_NumTris[e]=this._m_Owner.getMesh().getLodPrimitiveCount(e),this._m_LodLevelDists[e]=this._m_DistCommonDifference*e}},{key:"_update",value:function(){var e=this._m_Owner.getBoundingVolume(),t=this._m_Scene.getMainCamera(),n=Math.atan(t.getTop()*t.getNear()),r=Math.PI/(8*n),i=e.distance(t.getEye())/r,o=0;i>this._m_LastDistance&&Math.abs(i-this._m_LastDistance)<=this._m_DistCommonDifference||this._m_LastDistance>i&&0==this._m_LastLodLevel||this._m_LastDistance<i&&this._m_LastLodLevel==this._m_NumLodLevels-1?o=this._m_LastLodLevel:(o=i>this._m_LastDistance?this._m_LastLodLevel+1:this._m_LastLodLevel-1,o=Math.min(o,this._m_NumLodLevels),o=Math.max(o,0),this._m_LastDistance=this._m_LodLevelDists[o],this._m_LastLodLevel=o),this._m_Owner.lod(o)}}])&&s(t.prototype,n),r&&s(t,r),_}(i.default);t.default=m},9011:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=c(n(9650)),o=c(n(2949)),a=c(n(9369)),_=c(n(4720)),s=c(n(3801)),u=c(n(5604)),l=c(n(8583)),f=c(n(3846));function c(e){return e&&e.__esModule?e:{default:e}}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=g(e);if(t){var i=g(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return p(this,n)}}function p(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(c,e);var t,n,r,i=d(c);function c(e,t){var n;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),(n=i.call(this,e,t))._m_OctNode=null,e instanceof o.default&&(e.clearCullingFlags(o.default.S_DEFAULT_FRUSTUM_CULLING),n.createOct(e,4),n._m_OctNode)){var r=null,a=null;n._m_Scene.on("render",(function(e){r=n._m_Scene.getRender().getVisDrawables(),a=n._m_Scene.getFrustumCullingCamera(),n.octCulling(a,r)}))}return n}return t=c,(n=[{key:"getType",value:function(){return"OctCullingControl"}},{key:"_debug",value:function(e,t,n){var r=this;if(n.isValid()){var i=new _.default(e,{id:l.default.nextId()+"_oct"});i.setMesh(l.default.createAABBBoundingBoxMeshFromAABBBoundingBox(n.getAABBBoundingBox())),i.setMaterial(t),i.updateBound(),e.addChildren(i),n.getLeafs()&&n.getLeafs().forEach((function(n){r._debug(e,t,n)}))}}},{key:"debug",value:function(e,t){this._m_OctNode&&this._debug(e,t,this._m_OctNode)}},{key:"createOct",value:function(e,t){var n=e.getBoundingVolume();if(n){var r=new s.default,i=n.getXHalf(),o=n.getYHalf(),_=n.getZHalf(),l=Math.max(Math.max(i,o),_),c=n.getCenter();r.fromMinMax(new u.default(-l+c._m_X,-l+c._m_Y,-l+c._m_Z),new u.default(l+c._m_X,l+c._m_Y,l+c._m_Z)),this._m_OctNode=new a.default(null,r),this._m_OctNode.setValid(!0),f.default.debug("开始预建!"),this._preBuilt(this._m_OctNode,t),f.default.debug("预建完成!"),this.distrNode(e,this._m_OctNode)}}},{key:"_preBuiltOctLeaf",value:function(e,t){var n=null,r=e.getLeafs(),i=e.getAABBBoundingBox(),o=i.getMin(),_=i.getMax(),s=i.getCenter();c.S_TEMP_MIN.setToInXYZ(o._m_X,s._m_Y,o._m_Z),c.S_TEMP_MAX.setToInXYZ(s._m_X,_._m_Y,s._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t),c.S_TEMP_MIN.setToInXYZ(o._m_X,s._m_Y,s._m_Z),c.S_TEMP_MAX.setToInXYZ(s._m_X,_._m_Y,_._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t),c.S_TEMP_MIN.setToInXYZ(s._m_X,s._m_Y,o._m_Z),c.S_TEMP_MAX.setToInXYZ(_._m_X,_._m_Y,s._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t),c.S_TEMP_MIN.setToInXYZ(s._m_X,s._m_Y,s._m_Z),c.S_TEMP_MAX.setToInXYZ(_._m_X,_._m_Y,_._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t),c.S_TEMP_MIN.setToInXYZ(o._m_X,o._m_Y,o._m_Z),c.S_TEMP_MAX.setToInXYZ(s._m_X,s._m_Y,s._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t),c.S_TEMP_MIN.setToInXYZ(o._m_X,o._m_Y,s._m_Z),c.S_TEMP_MAX.setToInXYZ(s._m_X,s._m_Y,_._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t),c.S_TEMP_MIN.setToInXYZ(s._m_X,o._m_Y,o._m_Z),c.S_TEMP_MAX.setToInXYZ(_._m_X,s._m_Y,s._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t),c.S_TEMP_MIN.setToInXYZ(s._m_X,o._m_Y,s._m_Z),c.S_TEMP_MAX.setToInXYZ(_._m_X,s._m_Y,_._m_Z),c.S_TEMP_AABBBOUNDINGBOX.fromMinMax(c.S_TEMP_MIN,c.S_TEMP_MAX),n=new a.default(null,c.S_TEMP_AABBBOUNDINGBOX),r.push(n),this._preBuilt(n,t)}},{key:"_preBuilt",value:function(e,t){t>0&&(t--,e.initLeafs(),this._preBuiltOctLeaf(e,t))}},{key:"distrNode",value:function(e,t){var n=this,r=e.getChildren();r&&r.length>0?r.forEach((function(e){n.distrNode(e,t)})):e instanceof _.default&&this.distrOct(e,t)}},{key:"distrOct",value:function(e,t){var n=e.getBoundingVolume();if(t.getAABBBoundingBox().contains(n)){var r=t.getLeafs();if(null!=r){for(var i=!1,o=0;o<8;o++)if(this.distrOct(e,r[o])){i=!0,t.setValid(!0);break}return i||(t.addRef(e),t.setValid(!0)),!0}return t.addRef(e),t.setValid(!0),!0}return!1}},{key:"cullingLeafs",value:function(e,t,n){var r=this;if(e.isValid()&&e.inFrustum(t)){if(e.getRefs()){var i=t.getFrustumMask();e.getRefs().forEach((function(e){e.inFrustum(t)&&n.push(e),t.setFrustumMask(i)}))}if(e.getLeafs()){var o=t.getFrustumMask();e.getLeafs().forEach((function(e){t.setFrustumMask(o),r.cullingLeafs(e,t,n)}))}}}},{key:"octCulling",value:function(e,t){var n=e.getFrustumMask();e.setFrustumMask(0),this.cullingLeafs(this._m_OctNode,e,t),e.setFrustumMask(n)}}])&&m(t.prototype,n),r&&m(t,r),c}(i.default);t.default=v,S(v,"S_TEMP_AABBBOUNDINGBOX",new s.default),S(v,"S_TEMP_MIN",new u.default),S(v,"S_TEMP_MAX",new u.default)},9369:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n(3801)),i=o(n(1550));function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Valid=!1,this._m_Refs=t,this._m_AABBBoundingBox=new r.default,this._m_AABBBoundingBox.setTo(n),this._m_Leafs=null,this._m_FrustumContain=null}var t,n,o;return t=e,(n=[{key:"inFrustum",value:function(e){return this._m_FrustumContain=e.frustumContains(this.getAABBBoundingBox()),this._m_FrustumContain!=i.default.S_FRUSTUM_INTERSECT_OUTSIDE}},{key:"setValid",value:function(e){this._m_Valid=e}},{key:"isValid",value:function(){return this._m_Valid}},{key:"addRef",value:function(e){this._m_Refs||(this._m_Refs=[]),this._m_Refs.push(e)}},{key:"getRefs",value:function(){return this._m_Refs}},{key:"getAABBBoundingBox",value:function(){return this._m_AABBBoundingBox}},{key:"getLeaf",value:function(e){return this._m_Leafs[e]}},{key:"getLeafs",value:function(){return this._m_Leafs}},{key:"initLeafs",value:function(){this._m_Leafs=[]}}])&&a(t.prototype,n),o&&a(t,o),e}();t.default=s,_(s,"S_LEAF_TBL",0),_(s,"S_LEAF_TFL",1),_(s,"S_LEAF_TBR",2),_(s,"S_LEAF_TFR",3),_(s,"S_LEAF_BBL",4),_(s,"S_LEAF_BFL",5),_(s,"S_LEAF_BBR",6),_(s,"S_LEAF_BFR",7)},1797:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Scenes=[],this._m_SceneIds={},this._m_Stop=!1}var t,r,i;return t=e,(r=[{key:"addScene",value:function(e){this._m_SceneIds[e.id]||(this._m_SceneIds[e.id]=e,this._m_Scenes.push(e))}},{key:"removeScene",value:function(e){this._m_SceneIds[e.id]&&(this._m_SceneIds[e.id]=null,this._m_Scenes.remove(e))}},{key:"launch",value:function(){var e=this;this._m_Stop=!1;var t=this,n=Date.now();requestAnimationFrame((function r(){var i=Date.now(),o=.001*(i-n);n=i,e._m_Scenes.forEach((function(e){e.update(o),e.render(o)})),t._m_Stop||requestAnimationFrame(r)}))}},{key:"close",value:function(){this._m_Stop=!0}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},7664:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,i;return t=e,(r=[{key:"isDrawable",value:function(){}},{key:"isFramePicture",value:function(){}},{key:"isOpaque",value:function(){}},{key:"isTranslucent",value:function(){}},{key:"isTransparent",value:function(){}},{key:"draw",value:function(e){}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},3370:(e,t)=>{function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};t.default=r,n(r,"S_WIREFRAME_DEF_DATA","// 由于webGL基于openGLES3.x,其不存在openGL线框模式,所以在这里通过shader实现线框\nDef WireframeDef{\n    Params{\n        vec4 color;\n        float wireframeWidth;\n    }\n    SubTechnology Wireframe{\n        Vars{\n            vec3 bary;\n        }\n        Vs_Shader{\n            void main(){\n                #ifdef Context.Skins\n                    mat4 skinMat =\n                            Context.InWeight0.x * Context.Joints[int(Context.InJoint0.x)] +\n                            Context.InWeight0.y * Context.Joints[int(Context.InJoint0.y)] +\n                            Context.InWeight0.z * Context.Joints[int(Context.InJoint0.z)] +\n                            Context.InWeight0.w * Context.Joints[int(Context.InJoint0.w)];\n                    // vec4 pos = Context.ModelMatrix * skinMat * vec4(Context.InPosition, 1.0f);\n                    vec4 pos = skinMat * vec4(Context.InPosition, 1.0f);\n                #else\n                    vec4 pos = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                #endif\n                bary = Context.InBarycentric;\n\n\n\n                Context.OutPosition = Context.ProjectViewMatrix * pos;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                #ifdef Params.color\n                    vec4 _wireframeColor = Params.color;\n                #else\n                    vec4 _wireframeColor = vec4(0.2f, 0.2f, 0.2f, 1.0f);\n                #endif\n                #ifdef Params.wireframeWidth\n                    float _wireframeWidth = Params.wireframeWidth;\n                #else\n                    float _wireframeWidth = 0.01f;\n                #endif\n                if(any(lessThan(bary, vec3(_wireframeWidth)))){\n                    Context.OutColor = _wireframeColor;\n                }\n                else{\n                    discard;\n                }\n            }\n        }\n    }\n    Technology{\n        Sub_Pass{\n            Pass Wireframe{\n            }\n        }\n    }\n}\n"),n(r,"S_COLOR_DEF_DATA","// 颜色材质,提供指定颜色或颜色纹理并渲染\nDef ColorDef{\n    Params{\n        vec4 color;\n        sampler2D colorMap;\n        float alphaDiscard;\n    }\n    SubTechnology ScalePass{\n        Vars{\n            vec4 wordPosition;\n        }\n        Vs_Shader{\n            void main(){\n                //Context.OutPosition = Context.ProjectViewModelMatrix * vec4(Context.InPosition, 1.0f);\n                mat4 scaleMat4 = mat4(\n                    0.2f, 0.0f, 0.0f, 0.0f,\n                    0.0f, 0.2f, 0.0f, 0.0f,\n                    0.0f, 0.0f, 0.2f, 0.0f,\n                    0.0f, 0.0f, 0.0f, 1.0f\n                );\n                Context.OutPosition = Context.ProjectMatrix * Context.ViewMatrix * Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                // 使用自定义颜色输出\n                #ifdef Params.color\n                    Context.OutColor = Params.color;\n                #else\n                    // 使用纹理\n                    #ifdef Params.colorMap\n                        Context.OutColor = texture(Params.colorMap, Context.InUv0);\n                        #ifdef Params.alphaDiscard\n                            if(Context.OutColor.a < Params.alphaDiscard){\n                                discard;\n                            }\n                        #endif\n                    #else\n                        Context.OutColor = vec4(1.0f, 1.0f, 0.0f, 1.0f);\n                    #endif\n                #endif\n                vec4 wPosition = wordPosition;\n            }\n        }\n    }\n    SubTechnology ColorPass{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n        }\n        Vs_Shader{\n            void main(){\n                //Context.OutPosition = Context.ProjectViewModelMatrix * vec4(Context.InPosition, 1.0f);\n                Context.OutPosition = Context.ProjectMatrix * Context.ViewMatrix * Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                // 使用自定义颜色输出\n                #ifdef Params.color\n                    Context.OutColor = Params.color;\n                #else\n                    // 使用纹理\n                    #ifdef Params.colorMap\n                        Context.OutColor = texture(Params.colorMap, uv0);\n                        #ifdef Params.alphaDiscard\n                            if(Context.OutColor.a < Params.alphaDiscard){\n                                discard;\n                            }\n                        #endif\n                    #else\n                        Context.OutColor = vec4(1.0f, 1.0f, 1.0f, 1.0f);\n                    #endif\n                #endif\n            }\n        }\n    }\n    SubTechnology GreenPass{\n        Vars{\n            vec4 wordPosition;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = Context.ProjectMatrix * Context.ViewMatrix * Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                // 先判断Params.color是否有值\n                #ifdef Params.color\n                    Context.OutColor = Params.color;\n                #else\n                    Context.OutColor = vec4(0.0f, 1.0f, 0.0f, 1.0f);\n                #endif\n            }\n        }\n    }\n    Technology{\n        Sub_Pass{\n            Pass ColorPass{\n            }\n        }\n    }\n    Technology Green{\n        Sub_Pass{\n            Pass GreenPass{\n            }\n        }\n    }\n    // ScaleColorPass\n    Technology ScaleColor{\n        Sub_Pass{\n            //第一个pass不应该写入深度,否则第二个pass被剔除\n            //可以指定每个pass的写入状态,比如关闭深度,开启深度之类的\n            Pass ScalePass{\n                // 这个pass剔除前面\n                FaceCull Front;\n            }\n            Pass ColorPass{\n                // 这个pass剔除背面\n                FaceCull Back;\n            }\n        }\n    }\n}\n"),n(r,"S_POST_SHADOW_DEF_DATA","// PostShadowDef\nDef PostShadowDef{\n    Params{\n        // ShadowInfo\n        float shadowIntensity;\n        int filterMode;\n        bool hardwareShadow;\n        bool backfaceShadows;\n        float pcfEdge;\n        vec2 fadeInfo;\n    }\n    SubTechnology PostShadowPass{\n        Vars{\n            vec2 wUv0;\n            mat4 pvInverse;\n            vec4 pvRow2;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                pvInverse = inverse(Context.ProjectViewMatrix);\n                // glsl是列矩阵,这里我获取第二行(只需要变换得到z即可测试PSSM)\n                pvRow2 = vec4(Context.ProjectViewMatrix[0][2], Context.ProjectViewMatrix[1][2], Context.ProjectViewMatrix[2][2], Context.ProjectViewMatrix[3][2]);\n                wUv0 = Context.InUv0;\n            }\n        }\n        Fs_Shader{\n            //#extension GL_ARB_gpu_shader5 : enable\n            float shadowBorderScale = 1.0f;\n            #ifdef HARDWARE_SHADOWS\n                #define SHADOWMAP sampler2DShadow\n                #define SHADOWCOMPAREOFFSET(tex,coord,offset) textureProjOffset(tex, coord, offset)\n                #define SHADOWCOMPARE(tex,coord) textureProj(tex, coord)\n                #define SHADOWGATHER(tex,coord) textureGather(tex, coord.xy, coord.z)\n            #else\n                #define SHADOWMAP sampler2D\n                #define SHADOWCOMPAREOFFSET(tex,coord,offset) step(coord.z, textureProjOffset(tex, coord, offset).r)\n                #define SHADOWCOMPARE(tex,coord) step(coord.z, textureProj(tex, coord).r)\n                #define SHADOWGATHER(tex,coord) step(coord.z, textureGather(tex, coord.xy))\n            #endif\n\n            #define FILTER_MODE 1\n\n            #if FILTER_MODE == 10\n                #define GETSHADOW Shadow_Nearest\n                #define KERNEL 1.0\n            #elif FILTER_MODE == 1\n                #ifdef HARDWARE_SHADOWS\n                    #define GETSHADOW Shadow_Nearest\n                #else\n                    #define GETSHADOW Shadow_DoBilinear_2x2\n                #endif\n                #define KERNEL 1.0\n            #endif\n\n            #if (FILTER_MODE == 2)\n                #define GETSHADOW Shadow_DoDither_2x2\n                #define KERNEL 1.0\n            #elif FILTER_MODE == 3\n                #define GETSHADOW Shadow_DoPCF\n                #define KERNEL 4.0\n            #elif FILTER_MODE == 4\n                #define GETSHADOW Shadow_DoPCFPoisson\n                #define KERNEL 4.0\n            #elif FILTER_MODE == 5\n                #define GETSHADOW Shadow_DoPCF\n                #define KERNEL 8.0\n            #endif\n\n            float Shadow_DoShadowCompare(in SHADOWMAP tex,in vec4 projCoord){\n                return SHADOWCOMPARE(tex, projCoord);\n            }\n\n            float Shadow_BorderCheck(in vec2 coord){\n                // 最快的“hack”方法（使用 4-5 条指令）\n                vec4 t = vec4(coord.xy, 0.0f, 1.0f);\n                t = step(t.wwxy, t.xyzz);\n                return dot(t,t);\n            }\n\n            float Shadow_Nearest(in SHADOWMAP tex,in vec4 projCoord){\n                float border = Shadow_BorderCheck(projCoord.xy);\n                if (border > 0.0f){\n                    return 1.0f;\n                }\n                return SHADOWCOMPARE(tex, projCoord);\n            }\n\n            //----------------------------------ShadowFilter--------------------------------------\n            float Shadow_DoShadowCompareOffset(in SHADOWMAP tex,in vec4 projCoord,in vec2 offset){\n                vec4 coord = vec4(projCoord.xy + offset.xy * Context.SMapSizeInverse * shadowBorderScale, projCoord.zw);\n                return SHADOWCOMPARE(tex, coord);\n            }\n\n\n            float Shadow_DoDither_2x2(in SHADOWMAP tex, in vec4 projCoord){\n                float border = Shadow_BorderCheck(projCoord.xy);\n                if (border > 0.0f)\n                    return 1.0f;\n\n                float shadow = 0.0f;\n                vec2 o = vec2(ivec2(mod(floor(gl_FragCoord.xy), 2.0f))); //Strict type checking in GLSL ES\n                shadow += Shadow_DoShadowCompareOffset(tex, projCoord, (vec2(-1.5f, 1.5f)+o));\n                shadow += Shadow_DoShadowCompareOffset(tex, projCoord, (vec2( 0.5f, 1.5f)+o));\n                shadow += Shadow_DoShadowCompareOffset(tex, projCoord, (vec2(-1.5f, -0.5f)+o));\n                shadow += Shadow_DoShadowCompareOffset(tex, projCoord, (vec2( 0.5f, -0.5f)+o));\n                shadow *= 0.25f;\n                return shadow;\n            }\n\n            float Shadow_DoBilinear_2x2(in SHADOWMAP tex, in vec4 projCoord){\n                float border = Shadow_BorderCheck(projCoord.xy);\n                if (border > 0.0f){\n                    return 1.0f;\n                }\n\n                vec4 gather = vec4(0.0f);\n                #if defined GL_ARB_gpu_shader5 || defined GL_OES_gpu_shader5\n                    vec4 coord = vec4(projCoord.xyz / projCoord.www, 0.0f);\n                    gather = SHADOWGATHER(tex, coord);\n                #else\n                    gather.x = SHADOWCOMPAREOFFSET(tex, projCoord, ivec2(0, 1));\n                    gather.y = SHADOWCOMPAREOFFSET(tex, projCoord, ivec2(1, 1));\n                    gather.z = SHADOWCOMPAREOFFSET(tex, projCoord, ivec2(1, 0));\n                    gather.w = SHADOWCOMPAREOFFSET(tex, projCoord, ivec2(0, 0));\n                #endif\n\n               vec2 f = fract( projCoord.xy * Context.ShadowMapSize );\n               vec2 mx = mix( gather.wx, gather.zy, f.x );\n               return mix( mx.x, mx.y, f.y );\n            }\n\n            float Shadow_DoPCF(in SHADOWMAP tex,in vec4 projCoord){\n\n                float shadow = 0.0f;\n                float border = Shadow_BorderCheck(projCoord.xy);\n                if (border > 0.0f)\n                    return 1.0f;\n\n                float bound = KERNEL * 0.5f - 0.5f;\n                bound *= Params.pcfEdge;\n                for (float y = -bound; y <= bound; y += Params.pcfEdge){\n                    for (float x = -bound; x <= bound; x += Params.pcfEdge){\n                        shadow += Shadow_DoShadowCompareOffset(tex, projCoord, vec2(x,y));\n                    }\n                }\n\n                shadow = shadow / (KERNEL * KERNEL);\n                return shadow;\n            }\n\n            //12 tap poisson disk\n            const vec2 poissonDisk0 =  vec2(-0.1711046f, -0.425016f);\n            const vec2 poissonDisk1 =  vec2(-0.7829809f, 0.2162201f);\n            const vec2 poissonDisk2 =  vec2(-0.2380269f, -0.8835521f);\n            const vec2 poissonDisk3 =  vec2(0.4198045f, 0.1687819f);\n            const vec2 poissonDisk4 =  vec2(-0.684418f, -0.3186957f);\n            const vec2 poissonDisk5 =  vec2(0.6026866f, -0.2587841f);\n            const vec2 poissonDisk6 =  vec2(-0.2412762f, 0.3913516f);\n            const vec2 poissonDisk7 =  vec2(0.4720655f, -0.7664126f);\n            const vec2 poissonDisk8 =  vec2(0.9571564f, 0.2680693f);\n            const vec2 poissonDisk9 =  vec2(-0.5238616f, 0.802707f);\n            const vec2 poissonDisk10 = vec2(0.5653144f, 0.60262f);\n            const vec2 poissonDisk11 = vec2(0.0123658f, 0.8627419f);\n\n\n            float Shadow_DoPCFPoisson(in SHADOWMAP tex, in vec4 projCoord){\n                float shadow = 0.0f;\n                float border = Shadow_BorderCheck(projCoord.xy);\n                if (border > 0.0f){\n                    return 1.0f;\n                }\n\n                vec2 texelSize = Context.SMapSizeInverse * 4.0f * Params.pcfEdge * shadowBorderScale;\n\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk0 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk1 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk2 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk3 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk4 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk5 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk6 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk7 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk8 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk9 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk10 * texelSize, projCoord.zw));\n                shadow += SHADOWCOMPARE(tex, vec4(projCoord.xy + poissonDisk11 * texelSize, projCoord.zw));\n\n                // 除以 12\n                return shadow * 0.08333333333f;\n            }\n            //----------------------------------ShadowFilter--------------------------------------\n\n\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0f)) - vec2(1.0f);\n                pos.z  = depth * 2.0f - 1.0f;\n                pos.w  = 1.0f;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            #ifdef Context.Pssm\n                // 基于PSSM实现的DirectionalLightShadows\n                float getDirectionalLightShadows(in vec4 splits,in float shadowPosition, in SHADOWMAP shadowMap0, in SHADOWMAP shadowMap1, in SHADOWMAP shadowMap2,in SHADOWMAP shadowMap3, in vec4 projCoord0,in vec4 projCoord1,in vec4 projCoord2,in vec4 projCoord3){\n                    float shadow = 1.0f;\n                    if(shadowPosition < splits.x){\n                        shadow = GETSHADOW(shadowMap0, projCoord0 );\n                    }\n                    else if( shadowPosition <  splits.y){\n                        shadowBorderScale = 0.5f;\n                        shadow = GETSHADOW(shadowMap1, projCoord1);\n                    }\n                    else if( shadowPosition <  splits.z){\n                        shadowBorderScale = 0.25f;\n                        shadow = GETSHADOW(shadowMap2, projCoord2);\n                    }\n                    else if( shadowPosition <  splits.w){\n                        shadowBorderScale = 0.125f;\n                        shadow = GETSHADOW(shadowMap3, projCoord3);\n                    }\n                    return shadow;\n                }\n            #endif\n            #ifdef Context.PointLightShadows\n                float getPointLightShadows(in vec4 worldPos,in vec3 lightPos, in SHADOWMAP shadowMap0, in SHADOWMAP shadowMap1, in SHADOWMAP shadowMap2, in SHADOWMAP shadowMap3, in SHADOWMAP shadowMap4, in SHADOWMAP shadowMap5, in vec4 projCoord0,in vec4 projCoord1,in vec4 projCoord2,in vec4 projCoord3,in vec4 projCoord4,in vec4 projCoord5){\n                    float shadow = 1.0f;\n                    vec3 vect = worldPos.xyz - lightPos;\n                    vec3 absv = abs(vect);\n                    float maxComp = max(absv.x,max(absv.y,absv.z));\n                    if(maxComp == absv.y){\n                       if(vect.y < 0.0f){\n                           shadow = GETSHADOW(shadowMap0, projCoord0 / projCoord0.w);\n                       }\n                       else{\n                           shadow = GETSHADOW(shadowMap1, projCoord1 / projCoord1.w);\n                       }\n                    }\n                    else if(maxComp == absv.z){\n                       if(vect.z < 0.0f){\n                           shadow = GETSHADOW(shadowMap2, projCoord2 / projCoord2.w);\n                       }\n                       else{\n                           shadow = GETSHADOW(shadowMap3, projCoord3 / projCoord3.w);\n                       }\n                    }\n                    else if(maxComp == absv.x){\n                       if(vect.x < 0.0f){\n                           shadow = GETSHADOW(shadowMap4, projCoord4 / projCoord4.w);\n                       }\n                       else{\n                           shadow = GETSHADOW(shadowMap5, projCoord5 / projCoord5.w);\n                       }\n                    }\n                    return shadow;\n                }\n            #endif\n            #ifdef Context.SpotLightShadows\n                float getSpotLightShadows(in SHADOWMAP shadowMap, in  vec4 projCoord){\n                    float shadow = 1.0f;\n                    projCoord /= projCoord.w;\n                    shadow = GETSHADOW(shadowMap, projCoord);\n\n                    // 一个小的衰减，使阴影很好地融入暗部，将纹理坐标值转换为 -1,1 范围，因此纹理坐标向量的长度实际上是地面上变亮区域的半径\n                    projCoord = projCoord * 2.0f - 1.0f;\n                    float fallOff = ( length(projCoord.xy) - 0.9f ) / 0.1f;\n                    return mix(shadow, 1.0f, clamp(fallOff, 0.0f, 1.0f));\n                }\n            #endif\n            vec3 approximateNormal(in vec4 worldPos,in vec2 texCoord, in sampler2D depthMap, in vec2 resolutionInverse){\n                float step = resolutionInverse.x;\n                float stepy = resolutionInverse.y;\n                float depth2 = texture(depthMap, texCoord + vec2(step, -stepy)).r;\n                float depth3 = texture(depthMap, texCoord + vec2(-step, -stepy)).r;\n                vec4 worldPos2 = vec4(getPosition(depth2, texCoord + vec2(step, -stepy)),1.0f);\n                vec4 worldPos3 = vec4(getPosition(depth3, texCoord + vec2(-step, -stepy)),1.0f);\n\n                vec3 v1 = (worldPos - worldPos2).xyz;\n                vec3 v2 = (worldPos3 - worldPos2).xyz;\n                return normalize(cross(v1, v2));\n            }\n            const mat4 biasMat = mat4(0.5f, 0.0f, 0.0f, 0.0f,\n                                      0.0f, 0.5f, 0.0f, 0.0f,\n                                      0.0f, 0.0f, 0.5f, 0.0f,\n                                      0.5f, 0.5f, 0.5f, 1.0f);\n            void main(){\n                float depth = texture(Context.InDepth, wUv0).r;\n                Context.OutColor = texture(Context.InScreen, wUv0);\n\n                // 跳过不需要的部分,depth为1.0的基本上是背景或sky部分\n                if(depth >= 1.0f){\n                    return;\n                }\n\n                // 深度重建世界坐标\n                vec4 wPosition = vec4(getPosition(depth, wUv0), 1.0f);\n\n                vec3 lightDir;\n                #ifdef Context.Pssm\n                    lightDir = Context.LightDir;\n                #else\n                    lightDir = wPosition.xyz - Context.LightPos;\n                #endif\n\n                #ifdef Params.backfaceShadows\n                    // 丢弃背面时,由于在forward pipeline下无法获取该点法线,所以只能通过近似算法获取法线\n                    // 该近似算法依赖于深度信息,所以很容易造成Shadow Acne\n                    if(!Params.backfaceShadows){\n                        vec3 normal = approximateNormal(wPosition, wUv0, Context.InDepth, Context.ResolutionInverse);\n                        float ndotl = dot(normal, lightDir);\n                        if(ndotl > 0.0f){\n                            return;\n                        }\n                    }\n                #endif\n\n                #if !defined(Context.PointLightShadows)\n                    #if !defined(Context.Pssm)\n                        if( dot(Context.LightDir, lightDir) < 0.0f){\n                            return;\n                        }\n                    #endif\n                #endif\n\n                // 将坐标转换到光源空间\n                vec4 projCoord0 = biasMat * Context.LightViewProjectMatrix0 * wPosition;\n                vec4 projCoord1 = biasMat * Context.LightViewProjectMatrix1 * wPosition;\n                vec4 projCoord2 = biasMat * Context.LightViewProjectMatrix2 * wPosition;\n                vec4 projCoord3 = biasMat * Context.LightViewProjectMatrix3 * wPosition;\n                #ifdef Context.PointLightShadows\n                   vec4 projCoord4 = biasMat * Context.LightViewProjectMatrix4 * wPosition;\n                   vec4 projCoord5 = biasMat * Context.LightViewProjectMatrix5 * wPosition;\n                #endif\n\n                // 计算阴影\n                float shadow = 1.0f;\n\n                #if defined(Context.Pssm)\n                    float shadowPosition = pvRow2.x * wPosition.x +  pvRow2.y * wPosition.y +  pvRow2.z * wPosition.z +  pvRow2.w;\n                #else\n                    #if defined(Params.fadeInfo)\n                        float shadowPosition = pvRow2.x * wPosition.x +  pvRow2.y * wPosition.y +  pvRow2.z * wPosition.z +  pvRow2.w;\n                    #endif\n                #endif\n\n                #ifdef Context.PointLightShadows\n                    // pointLight shadow\n                    shadow = getPointLightShadows(wPosition, Context.LightPos, Context.InShadowMap0, Context.InShadowMap1, Context.InShadowMap2, Context.InShadowMap3, Context.InShadowMap4, Context.InShadowMap5, projCoord0, projCoord1, projCoord2, projCoord3, projCoord4, projCoord5);\n                #else\n                    #ifdef Context.Pssm\n                        // directionalLight shadow\n                        shadow = getDirectionalLightShadows(Context.Splits, shadowPosition, Context.InShadowMap0, Context.InShadowMap1, Context.InShadowMap2, Context.InShadowMap3, projCoord0, projCoord1, projCoord2, projCoord3);\n                    #else\n                        #ifdef Context.SpotLightShadows\n                            // spotLight shadow\n                            shadow = getSpotLightShadows(Context.InShadowMap0, projCoord0);\n                        #endif\n                    #endif\n                #endif\n\n                #ifdef Params.fadeInfo\n                    shadow = clamp(max(0.0f, mix(shadow, 1.0f,(shadowPosition - Params.fadeInfo.x) * Params.fadeInfo.y)), 0.0f, 1.0f);\n                #endif\n                #ifdef Params.shadowIntensity\n                    shadow = shadow * Params.shadowIntensity + (1.0f - Params.shadowIntensity);\n                #else\n                    shadow = shadow * 0.7f + 0.3f;\n                #endif\n                Context.OutColor = Context.OutColor * vec4(shadow, shadow, shadow, 1.0f);\n            }\n        }\n    }\n    Technology{\n        Sub_Pass PostFilter{\n            Pass PostShadowPass{\n            }\n        }\n    }\n}\n"),n(r,"S_PRE_SHADOW_DEF_DATA","// PreShadowDef\n// 这个材质定义用于捕获ShadowMap,因此,它很简单,只是简单的将深度信息渲染到指定缓冲中\nDef PreShadowDef{\n    Params{\n        bool debug;\n    }\n    SubTechnology PreShadowPass{\n        Vars{\n            vec2 wUv0;\n        }\n        Vs_Shader{\n            void main(){\n                #ifdef Context.Skins\n                    mat4 skinMat =\n                            Context.InWeight0.x * Context.Joints[int(Context.InJoint0.x)] +\n                            Context.InWeight0.y * Context.Joints[int(Context.InJoint0.y)] +\n                            Context.InWeight0.z * Context.Joints[int(Context.InJoint0.z)] +\n                            Context.InWeight0.w * Context.Joints[int(Context.InJoint0.w)];\n                    // vec4 pos = Context.ModelMatrix * skinMat * vec4(Context.InPosition, 1.0f);\n                    vec4 pos = skinMat * vec4(Context.InPosition, 1.0f);\n                #else\n                    vec4 pos = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                #endif\n                wUv0 = Context.InUv0;\n                Context.OutPosition = Context.ProjectViewMatrix * pos;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                #ifdef Params.debug\n                    if(Params.debug){\n                        Context.OutColor = vec4(vec3(gl_FragCoord.z), 1.0f);\n                    }\n                #endif\n            }\n        }\n    }\n    Technology{\n        Sub_Pass PreFrame{\n            Pass PreShadowPass{\n            }\n        }\n    }\n}\n"),n(r,"S_FOG_FILTER_DEF_DATA","// 雾化\nDef FogFilterDef{\n    Params{\n        // 雾化距离(默认1000.0f)\n        float fogDistance;\n        // 通常为1.0\n        float fogDensity;\n        // 视锥near\n        float vNear;\n        // 视锥far\n        float vFar;\n        // 雾化near\n        float fogNear;\n        // 雾化far\n        float fogFar;\n        // 雾化颜色\n        vec4 fogColor;\n    }\n    SubTechnology Fog{\n        Vars{\n            vec2 wUv0;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wUv0 = Context.InUv0;\n            }\n        }\n        Fs_Shader{\n            const float LOG2 = 1.442695f;\n            void main(){\n                Context.OutColor = texture(Context.InScreen, wUv0);\n                float depth = texture(Context.InDepth, wUv0).r;\n\n                #ifdef Params.fogDistance\n                    float _fogDistance = Params.fogDistance;\n                #else\n                    float _fogDistance = 1000.0f;\n                #endif\n                #ifdef Params.fogDensity\n                    float _fogDensity = Params.fogDensity;\n                #else\n                    float _fogDensity = 1.0f;\n                #endif\n                #ifdef Params.fogColor\n                    vec4 _fogColor = Params.fogColor;\n                #else\n                    vec4 _fogColor = vec4(1.0f);\n                #endif\n\n                // 可以简单的将视锥范围作为雾化过渡范围，如下：\n                // 此时，越靠近相机，dis越接近0，fog越接近1.0f，最终混合下Context.OutColor越清晰，远离相机时，dis小于0，fog逐渐变小，最终混合下_fogColor逐渐清晰\n                // 但是这种雾化计算dis在一个很小的非线性范围内变化\n                // float dis = (0.5f * depth + 0.5f);\n                // 所以这里变化到线性深度范围(假设near恒定为1.0)\n                float dis = 2.0f / (_fogDistance + 1.0f - depth * (_fogDistance - 1.0f));\n\n                // 一个经典的浓度过渡方程\n                float fog = exp2(-_fogDensity * _fogDensity * dis * dis * LOG2);\n                // 雾化规范到(0.0f,1.0f)\n                fog = clamp(fog, 0.0f, 1.0f);\n\n                // 混合结果\n                Context.OutColor = mix(_fogColor, Context.OutColor, fog);\n            }\n        }\n    }\n    SubTechnology LinearFog{\n        Vars{\n            vec2 wUv0;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wUv0 = Context.InUv0;\n            }\n        }\n        Fs_Shader{\n            const float LOG2 = 1.442695f;\n            void main(){\n                Context.OutColor = texture(Context.InScreen, wUv0);\n                float depth = texture(Context.InDepth, wUv0).r;\n\n                #ifdef Params.vNear\n                    float _vNear = Params.vNear;\n                #else\n                    float _vNear = 0.1f;\n                #endif\n                #ifdef Params.vFar\n                    float _vFar = Params.vFar;\n                #else\n                    float _vFar = 1000.0f;\n                #endif\n                #ifdef Params.fogNear\n                    float _fogNear = Params.fogNear;\n                #else\n                    float _fogNear = 1.0f;\n                #endif\n                #ifdef Params.fogFar\n                    float _fogFar = Params.fogFar;\n                #else\n                    float _fogFar = 1000.0f;\n                #endif\n                #ifdef Params.fogColor\n                    vec4 _fogColor = Params.fogColor;\n                #else\n                    vec4 _fogColor = vec4(1.0f);\n                #endif\n\n\n                // 线性雾化相对来说比较简单,仅考虑指定near,far内的过渡\n                float dis = (2.0f * _vNear) / (_vFar + _vNear - depth * (_vFar - _vNear));\n\n                // 雾化规范到(0.0f,1.0f)\n                float fog = smoothstep(_fogNear, _fogFar, dis * (_vFar - _vNear));\n\n                // 混合结果\n                Context.OutColor = mix(Context.OutColor, _fogColor, fog);\n            }\n        }\n    }\n    Technology{\n        Sub_Pass PostFilter{\n            Pass Fog{\n            }\n        }\n    }\n    Technology LinearFog{\n\n        Sub_Pass PostFilter{\n            Pass LinearFog{\n            }\n        }\n    }\n}\n"),n(r,"S_PICTURE_DEF_DATA","// 颜色材质,提供指定颜色或颜色纹理并渲染\nDef PictureDef{\n    Params{\n        vec4 color;\n        sampler2D colorMap;\n        float alphaDiscard;\n    }\n    SubTechnology DefaultPass{\n        Vars{\n            vec2 uv0;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                uv0 = Context.InUv0;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                // 使用自定义颜色输出\n                #ifdef Params.color\n                    Context.OutColor = Params.color;\n                #else\n                    // 使用纹理\n                    #ifdef Params.colorMap\n                        Context.OutColor = texture(Params.colorMap, uv0);\n                        #ifdef Params.alphaDiscard\n                            if(Context.OutColor.a < Params.alphaDiscard){\n                                discard;\n                            }\n                        #endif\n                    #else\n                        Context.OutColor = vec4(1.0f, 1.0f, 1.0f, 1.0f);\n                    #endif\n                #endif\n            }\n        }\n    }\n    Technology{\n        Sub_Pass{\n            Pass DefaultPass{\n            }\n        }\n    }\n}\n"),n(r,"S_GAMMA_CORRECTION_DEF_DATA","// gamma矫正\n// 由于webGL不支持硬件gamma矫正,只能通过后处理进行\nDef GammaCorrectionFilterDef{\n    Params{\n        float gammaFactor;\n        bool toneMapping;\n    }\n    SubTechnology GammaCorrectionFilter{\n        Vars{\n            vec2 uv0;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                uv0 = Context.InUv0;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                Context.OutColor = texture(Context.InScreen, uv0);\n                #ifdef Params.toneMapping\n                    if(Params.toneMapping){\n                        Context.OutColor.rgb = Context.OutColor.rgb / (Context.OutColor.rgb + vec3(1.0f));\n                    }\n                #endif\n                #ifdef Params.gammaFactor\n                    Context.OutColor.rgb = pow(Context.OutColor.rgb, vec3(Params.gammaFactor));\n                #endif\n            }\n        }\n    }\n    Technology{\n        Sub_Pass PostFilter{\n            Pass GammaCorrectionFilter{\n            }\n        }\n    }\n}\n"),n(r,"S_DEFAULT_OUT_COLOR_DEF_DATA","// 输出颜色缓冲材质\nDef DefaultOutColorDef{\n    Params{\n        float gammaFactor;\n        bool toneMapping;\n    }\n    SubTechnology DefaultOutColor{\n        Vars{\n            vec2 uv0;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                uv0 = Context.InUv0;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                Context.OutColor = texture(Context.InForwardColorMap, uv0);\n                #ifdef Params.toneMapping\n                    if(Params.toneMapping){\n                        Context.OutColor.rgb = Context.OutColor.rgb / (Context.OutColor.rgb + vec3(1.0f));\n                    }\n                #endif\n                #ifdef Params.gammaFactor\n                    Context.OutColor.rgb = pow(Context.OutColor.rgb, vec3(Params.gammaFactor));\n                #endif\n            }\n        }\n    }\n    Technology{\n        Sub_Pass{\n            Pass DefaultOutColor{\n            }\n        }\n    }\n}\n"),n(r,"S_DEFAULT_SKY_BOX_DEF","// 天空盒材质定义\nDef SkyBoxDef{\n    Params{\n        // 启用cubeMap通道\n        bool useCubeMap;\n        // 启用envMap通道\n        bool useEnvMap;\n        // 启用高动态映射\n        bool useHDR;\n        samplerCube cubeMap;\n        sampler2D envMap;\n    }\n    SubTechnology SkyBox{\n        Vars{\n            vec3 wPosition;\n        }\n        Vs_Shader{\n            void main(){\n                wPosition = Context.InPosition;\n                // 只需要旋转部分\n                vec4 pos = Context.ViewMatrix * vec4(Context.InPosition, 0.0f);\n                // 应用投影变换\n                pos.w = 1.0f;\n                pos = Context.ProjectMatrix * pos;\n                Context.OutPosition = pos.xyww;\n            }\n        }\n        Fs_Shader{\n            vec2 Optics_SphereCoord(in vec3 dir){\n                float dzplus1 = dir.z + 1.0f;\n\n                // 计算 1/2p\n                // NOTE: 仅当dir归一化时，此简化才有效。\n                float inv_two_p = 1.414f * sqrt(dzplus1);\n                //float inv_two_p = sqrt(dir.x * dir.x + dir.y * dir.y + dzplus1 * dzplus1);\n                inv_two_p *= 2.0f;\n                inv_two_p = 1.0f / inv_two_p;\n\n                // 计算texcoord\n                return (dir.xy * vec2(inv_two_p)) + vec2(0.5f);\n            }\n            const vec2 invAtan = vec2(0.159154943091895f, 0.318309886183790f);\n            #define PI 3.14159265358979323846264\n            // 转换环境纹理映射纹理坐标\n            vec2 fractTexcoord(const in vec3 v)\n            {\n                vec2 uv = vec2(atan(v.z, v.x) + PI, acos(v.y));\n                uv *= invAtan;\n                return uv;\n            }\n            void main(){\n                #ifdef Params.useCubeMap\n                    // 立方体纹理\n                    Context.OutColor = texture( Params.cubeMap, normalize( wPosition ) );\n                #else\n                    #ifdef Params.useEnvMap\n                        // 环境纹理\n                        vec2 uv = fractTexcoord( normalize( wPosition ) );\n                        #ifdef Params.useHDR\n                            // 解码hdr数据,也可以使用硬件RGB9_E5\n                            vec4 rgbe = texture( Params.envMap, uv );\n                            //rgbe.rgb *= pow(2.0f,rgbe.a*255.0f-128.0f);\n                            // 色调映射(后续在后处理统一进行)\n                            //rgbe.rgb = rgbe.rgb / (rgbe.rgb + vec3(1.0f));\n                            // 伽马(后续在后处理统一进行)\n                            //rgbe.rgb = pow(rgbe.rgb, vec3(1.0f / 2.2f));\n                            Context.OutColor.rgb = rgbe.rgb;\n                            Context.OutColor.a = 1.0f;\n                        #else\n                            Context.OutColor = texture( Params.envMap, uv );\n                        #endif\n                    #endif\n                #endif\n            }\n        }\n    }\n    Technology{\n        Sub_Pass{\n            Pass SkyBox{\n            }\n        }\n    }\n}\n"),n(r,"S_PREFILTER_DEF","// 预过滤EnvMap\nDef PrefilterDef{\n    Params{\n        float roughness;\n        float resolution;\n        samplerCube envMap;\n    }\n    SubTechnology Prefilter{\n        Vars{\n            vec3 wPosition;\n        }\n        Vs_Shader{\n            void main(){\n                wPosition = Context.InPosition;\n                // 只需要旋转部分\n                vec4 pos = Context.ViewMatrix * vec4(Context.InPosition, 0.0f);\n                // 应用投影变换\n                pos.w = 1.0f;\n                pos = Context.ProjectMatrix * pos;\n                Context.OutPosition = pos.xyww;\n            }\n        }\n\n        Fs_Shader{\n            const float PI = 3.14159265359f;\n            // ----------------------------------------------------------------------------\n            float DistributionGGX(vec3 N, vec3 H, float roughness)\n            {\n                float a = roughness*roughness;\n                float a2 = a*a;\n                float NdotH = max(dot(N, H), 0.0f);\n                float NdotH2 = NdotH*NdotH;\n\n                float nom   = a2;\n                float denom = (NdotH2 * (a2 - 1.0f) + 1.0f);\n                denom = PI * denom * denom;\n\n                return nom / denom;\n            }\n            // ----------------------------------------------------------------------------\n            // http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html\n            // 高效的VanDerCorpus计算。\n            float RadicalInverse_VdC(uint bits)\n            {\n                 bits = (bits << 16u) | (bits >> 16u);\n                 bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);\n                 bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);\n                 bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);\n                 bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);\n                 return float(bits) * 2.3283064365386963e-10; // / 0x100000000\n            }\n            // ----------------------------------------------------------------------------\n            vec2 Hammersley(uint i, uint N)\n            {\n                return vec2(float(i)/float(N), RadicalInverse_VdC(i));\n            }\n            // ----------------------------------------------------------------------------\n            vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)\n            {\n                float a = roughness*roughness;\n\n                float phi = 2.0f * PI * Xi.x;\n                float cosTheta = sqrt((1.0 - Xi.y) / (1.0f + (a*a - 1.0f) * Xi.y));\n                float sinTheta = sqrt(1.0 - cosTheta*cosTheta);\n\n                // 从球坐标到笛卡尔坐标-半角向量\n                vec3 H;\n                H.x = cos(phi) * sinTheta;\n                H.y = sin(phi) * sinTheta;\n                H.z = cosTheta;\n\n                // 从切线空间H向量到世界空间样本向量\n                vec3 up          = abs(N.z) < 0.999 ? vec3(0.0f, 0.0f, 1.0f) : vec3(1.0f, 0.0f, 0.0f);\n                vec3 tangent   = normalize(cross(up, N));\n                vec3 bitangent = cross(N, tangent);\n\n                vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n                return normalize(sampleVec);\n            }\n            void main(){\n                vec3 N = normalize(wPosition);\n\n                // 做出简化的假设，即V等于R等于法线\n                vec3 R = N;\n                vec3 V = R;\n\n                const uint SAMPLE_COUNT = 1024u;\n                vec3 prefilteredColor = vec3(0.0f);\n                float totalWeight = 0.0f;\n\n                for(uint i = 0u; i < SAMPLE_COUNT; ++i)\n                {\n                    // 生成偏向首选对齐方向的采样矢量（重要性采样）。\n                    vec2 Xi = Hammersley(i, SAMPLE_COUNT);\n                    vec3 H = ImportanceSampleGGX(Xi, N, Params.roughness);\n                    vec3 L  = normalize(2.0 * dot(V, H) * H - V);\n\n                    float NdotL = max(dot(N, L), 0.0f);\n                    if(NdotL > 0.0)\n                    {\n                        // 基于粗糙度/ pdf从环境的mip级别采样\n                        float D   = DistributionGGX(N, H, Params.roughness);\n                        float NdotH = max(dot(N, H), 0.0f);\n                        float HdotV = max(dot(H, V), 0.0f);\n                        float pdf = D * NdotH / (4.0f * HdotV) + 0.0001f;\n\n                        float saTexel  = 4.0f * PI / (6.0f * Params.resolution * Params.resolution);\n                        float saSample = 1.0f / (float(SAMPLE_COUNT) * pdf + 0.0001f);\n\n                        float mipLevel = Params.roughness == 0.0f ? 0.0f : 0.5f * log2(saSample / saTexel);\n\n                        prefilteredColor += textureLod(Params.envMap, L, mipLevel).rgb * NdotL;\n                        totalWeight      += NdotL;\n                    }\n                }\n\n                prefilteredColor = prefilteredColor / totalWeight;\n\n                Context.OutColor = vec4(prefilteredColor, 1.0f);\n            }\n        }\n    }\n    Technology{\n        Sub_Pass{\n            Pass Prefilter{\n            }\n        }\n    }\n}\n"),n(r,"S_ENV_CAPTURE_OUT_DEF","// 将环境捕捉数据渲染并查看\n// 同时,也支持将IBL作为SkyEnv进行场景环境渲染\nDef EnvCaptureOutDef{\n    Params{\n        samplerCube envCaptureMap;\n        float lod;\n    }\n    SubTechnology EnvCaptureOut{\n        Vars{\n            vec3 wPosition;\n        }\n        Vs_Shader{\n            void main(){\n                wPosition = Context.InPosition;\n                Context.OutPosition = Context.ProjectMatrix * Context.ViewMatrix * Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n            }\n        }\n        Fs_Shader{\n            void main(){\n                #ifdef Params.envCaptureMap\n                    #ifdef Params.lod\n                        Context.OutColor = textureLod(Params.envCaptureMap, normalize(wPosition), Params.lod);\n                    #else\n                        Context.OutColor = texture(Params.envCaptureMap, normalize(wPosition));\n                    #endif\n                #else\n                    Context.OutColor = vec4(1.0f);\n                #endif\n            }\n        }\n    }\n    SubTechnology EnvSkyOut{\n        Vars{\n            vec3 wPosition;\n        }\n        Vs_Shader{\n            void main(){\n                wPosition = Context.InPosition;\n                // 只需要旋转部分\n                vec4 pos = Context.ViewMatrix * vec4(Context.InPosition, 0.0f);\n                // 应用投影变换\n                pos.w = 1.0f;\n                pos = Context.ProjectMatrix * pos;\n                Context.OutPosition = pos.xyww;\n            }\n        }\n        Fs_Shader{\n            void main(){\n                #ifdef Params.envCaptureMap\n                    #ifdef Params.lod\n                        Context.OutColor = textureLod(Params.envCaptureMap, normalize(wPosition), Params.lod);\n                    #else\n                        Context.OutColor = texture(Params.envCaptureMap, normalize(wPosition));\n                    #endif\n                #else\n                    Context.OutColor = vec4(1.0f);\n                #endif\n            }\n        }\n    }\n    Technology{\n        Sub_Pass{\n            Pass EnvCaptureOut{\n            }\n        }\n    }\n    Technology EnvSky{\n        Sub_Pass{\n            Pass EnvSkyOut{\n            }\n        }\n    }\n}\n"),n(r,"S_BASIC_LIGHTING_DEF_DATA","// 基础光照材质定义\nDef BasicLightingDef{\n    Params{\n        sampler2D diffuseMap;\n        sampler2D normalMap;\n        sampler2D specularMap;\n        sampler2D normalMap;\n        vec4 ambientColor;\n        vec4 diffuseColor;\n        vec4 specularColor;\n        float shininess;\n        // 完全透明剔除因子(0-1),低于该值的透明片段被完全剔除而不进行混合\n        float alphaDiscard;\n    }\n    SubTechnology MultiPassBlinnPhongLighting{\n        Vars{\n            vec3 wNormal;\n            vec4 wTangent;\n            vec3 wPosition;\n            vec2 wUv0;\n            // 三种成分用于调和光照,可来自材质颜色的定义,也可以来自vertex_light\n            vec3 ambientSumAdjust;\n            vec4 diffuseSumAdjust;\n            vec3 specularSumAdjust;\n        }\n        Advanced{\n            RenderProgram MultiPassLighting;\n        }\n        Vs_Shader{\n            void main(){\n                #ifdef Context.Skins\n                    mat4 skinMat =\n                            Context.InWeight0.x * Context.Joints[int(Context.InJoint0.x)] +\n                            Context.InWeight0.y * Context.Joints[int(Context.InJoint0.y)] +\n                            Context.InWeight0.z * Context.Joints[int(Context.InJoint0.z)] +\n                            Context.InWeight0.w * Context.Joints[int(Context.InJoint0.w)];\n                    // vec4 pos = Context.ModelMatrix * skinMat * vec4(Context.InPosition, 1.0f);\n                    vec4 pos = skinMat * vec4(Context.InPosition, 1.0f);\n                #else\n                    vec4 pos = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                #endif\n\n\n                wPosition = (Context.ModelMatrix * vec4(Context.InPosition, 1.0f)).xyz;\n                mat3 nMat = mat3(transpose(inverse(Context.ModelMatrix)));\n                vec3 norm = normalize(nMat * Context.InNormal);\n                wTangent = vec4(normalize(nMat * Context.InTangent.xyz), Context.InTangent.w);\n                //t = normalize(t - dot(t, norm) * norm);\n                //vec3 b = cross(norm, t);\n                //tbnMat = mat3(t, b, norm);\n                wNormal = norm;\n                wUv0 = Context.InUv0;\n\n\n                // 如果是顶点光照,则在这里将光源变化到切线空间\n                ambientSumAdjust = Params.ambientColor.rgb * Context.AmbientLightColor;\n                diffuseSumAdjust = vec4(1.0f);\n                specularSumAdjust = vec3(1.0f);\n                Context.OutPosition = Context.ProjectViewMatrix * pos;\n            }\n        }\n        Fs_Shader{\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                // 对于DirLight,lightDir.w = 1.0f\n                lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n\n                //lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                //lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            // 基于BlinnPhong光照模型计算光照因子\n            // brdf.x保存漫反射部分;brdf.y保存镜面反射部分\n            void ComputeLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in float attenuation, in float shininess, out vec2 brdf){\n                // diffuse部分\n                float diffuseBRDF = max(0.0f, dot(normal, lightDir));\n                // specular部分\n                // 半角向量代替viewDir参与光照计算\n                vec3 H = normalize(viewDir + lightDir);\n                float HdotN = max(0.0f, dot(H, normal));\n                float specularBRDF = pow( HdotN, shininess );\n\n                // 衰减,对于PointLight和SpotLight来说有效,对于DirLight而言,attenuation一直为1\n                brdf.x = diffuseBRDF * attenuation;\n                brdf.y = specularBRDF * attenuation;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            void main(){\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec2 lightBRDF = vec2(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                vec4 _diffuseColor = vec4(1.0f);\n                vec4 _specularColor = vec4(1.0f);\n\n                #ifdef Params.diffuseColor\n                    _diffuseColor = Params.diffuseColor;\n                #endif\n                #ifdef Params.diffuseMap\n                    _diffuseColor = _diffuseColor * texture(Params.diffuseMap, wUv0);\n                    #ifdef Params.alphaDiscard\n                        // discard性能比较差,建议还是使用半透明渲染比较合适s\n                        if(_diffuseColor.a < Params.alphaDiscard){\n                            discard;\n                        }\n                    #endif\n                #endif\n\n                #ifdef Params.specularColor\n                    _specularColor = Params.specularColor;\n                #endif\n                #ifdef Params.specularMap\n                    _specularColor = _specularColor * texture(Params.specularMap, wUv0);\n                #endif\n\n                vec3 normal = normalize( wNormal );\n                #ifdef Params.normalMap\n                    vec3 normalHeight = texture(Params.normalMap, wUv0).xyz;\n                    vec3 tangent = normalize(wTangent.xyz);\n                    mat3 tbnMat = mat3(tangent, wTangent.w * cross(normal, tangent), normal);\n                    normal = normalize(tbnMat * ( normalHeight * 2.0f - 1.0f ));\n                #endif\n\n                float _shininess = 32.0;\n                #ifdef Params.shininess\n                    _shininess = Params.shininess;\n                #endif\n\n\n                Context.OutColor.rgb = _diffuseColor.rgb * ambientSumAdjust;\n\n\n                // 不必担心这个分支，不会影响性能\n                if(Context.MultiId == 0){\n                    for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                        // 后期改为Context.GetLightDir(Context.LightData[i]);\n                        lightColor = Context.WLightData[i];\n                        lightData1 = Context.WLightData[i + 1];\n                        ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                        //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                        // BlinnPhongLighting\n                        //vec3 h = normalize( viewDir + lightDir.xzy );\n                        //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                        // 标准PhongLighting\n                        //vec3 refDir = reflect( lightData1.xyz, normal );\n                        //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                        // 计算SpotLight的衰减\n                        float spotFallOff = 1.0;\n                        if( lightColor.w > 1.0f )\n                        {\n                            // 计算SpotLight的范围衰减\n                            spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                        }\n\n                        // 如果存在法线纹理,则进一步计算lightDir\n\n                        // 计算反射率\n                        ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                        // 最终光照值\n                        //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb * diffuseSumAdjust.rgb + vec3(lightBRDF.y) * _specularColor.rgb * specularSumAdjust.rgb);\n                        Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * diffuseSumAdjust.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * specularSumAdjust.rgb * vec3( lightBRDF.y ));\n                        //Context.OutColor.rgb = vec3(spotFallOff);\n                    }\n                }\n                else{\n                    // point和spot\n                    vec4 lightColor = Context.WLight_Data_0;\n                    vec4 lightData1 = Context.WLight_Data_1;\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                    //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                    // BlinnPhongLighting\n                    //vec3 h = normalize( viewDir + lightDir.xzy );\n                    //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                    // 标准PhongLighting\n                    //vec3 refDir = reflect( lightData1.xyz, normal );\n                    //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                    // 计算SpotLight的衰减\n                    float spotFallOff = 1.0;\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLight_Data_2, lightDir.xyz );\n                    }\n\n                    // 如果存在法线纹理,则进一步计算lightDir\n\n                    // 计算反射率\n                    ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                    // 最终光照值\n                    //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb * diffuseSumAdjust.rgb + vec3(lightBRDF.y) * _specularColor.rgb * specularSumAdjust.rgb);\n                    Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * diffuseSumAdjust.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * specularSumAdjust.rgb * vec3( lightBRDF.y ));\n                }\n                Context.OutColor.a = diffuseSumAdjust.a * _diffuseColor.a;\n            }\n        }\n    }\n\n    SubTechnology SingleBlinnPhongLighting{\n        Vars{\n            vec3 wNormal;\n            vec4 wTangent;\n            vec3 wPosition;\n            vec2 wUv0;\n            // 三种成分用于调和光照,可来自材质颜色的定义,也可以来自vertex_light\n            vec3 ambientSumAdjust;\n            vec4 diffuseSumAdjust;\n            vec3 specularSumAdjust;\n        }\n        Advanced{\n            RenderProgram SinglePassLighting;\n        }\n        Vs_Shader{\n            void main(){\n                #ifdef Context.Skins\n                    mat4 skinMat =\n                            Context.InWeight0.x * Context.Joints[int(Context.InJoint0.x)] +\n                            Context.InWeight0.y * Context.Joints[int(Context.InJoint0.y)] +\n                            Context.InWeight0.z * Context.Joints[int(Context.InJoint0.z)] +\n                            Context.InWeight0.w * Context.Joints[int(Context.InJoint0.w)];\n                    // vec4 pos = Context.ModelMatrix * skinMat * vec4(Context.InPosition, 1.0f);\n                    vec4 pos = skinMat * vec4(Context.InPosition, 1.0f);\n                #else\n                    vec4 pos = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                #endif\n\n\n                wPosition = (Context.ModelMatrix * vec4(Context.InPosition, 1.0f)).xyz;\n                mat3 nMat = mat3(transpose(inverse(Context.ModelMatrix)));\n                vec3 norm = normalize(nMat * Context.InNormal);\n                wTangent = vec4(normalize(nMat * Context.InTangent.xyz), Context.InTangent.w);\n                //t = normalize(t - dot(t, norm) * norm);\n                //vec3 b = cross(norm, t);\n                //tbnMat = mat3(t, b, norm);\n                wNormal = norm;\n                wUv0 = Context.InUv0;\n\n\n                // 如果是顶点光照,则在这里将光源变化到切线空间\n                ambientSumAdjust = Params.ambientColor.rgb * Context.AmbientLightColor;\n                diffuseSumAdjust = vec4(1.0f);\n                specularSumAdjust = vec3(1.0f);\n                Context.OutPosition = Context.ProjectViewMatrix * pos;\n            }\n        }\n        Fs_Shader{\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                // 对于DirLight,lightDir.w = 1.0f\n                lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n\n                //lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                //lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            // 基于BlinnPhong光照模型计算光照因子\n            // brdf.x保存漫反射部分;brdf.y保存镜面反射部分\n            void ComputeLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in float attenuation, in float shininess, out vec2 brdf){\n                // diffuse部分\n                float diffuseBRDF = max(0.0f, dot(normal, lightDir));\n                // specular部分\n                // 半角向量代替viewDir参与光照计算\n                vec3 H = normalize(viewDir + lightDir);\n                float HdotN = max(0.0f, dot(H, normal));\n                float specularBRDF = pow( HdotN, shininess );\n\n                // 衰减,对于PointLight和SpotLight来说有效,对于DirLight而言,attenuation一直为1\n                brdf.x = diffuseBRDF * attenuation;\n                brdf.y = specularBRDF * attenuation;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n                float falloff = clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f);\n                //if(curAngleCos > innerMinusOuter)\n                //    falloff = 1.0f;\n                //else\n                //    falloff = 0.0f;\n\n                #ifdef SRGB\n                    // Use quadratic falloff (notice the ^4)\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0, 1.0), 4.0);\n                #else\n                    // Use linear falloff\n                    return falloff;\n                #endif\n            }\n            void main(){\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec2 lightBRDF = vec2(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                vec4 _diffuseColor = vec4(1.0f);\n                vec4 _specularColor = vec4(1.0f);\n\n                #ifdef Params.diffuseColor\n                    _diffuseColor = Params.diffuseColor;\n                #endif\n                #ifdef Params.diffuseMap\n                    _diffuseColor = _diffuseColor * texture(Params.diffuseMap, wUv0);\n                    #ifdef Params.alphaDiscard\n                        // discard性能比较差,建议还是使用半透明渲染比较合适s\n                        if(_diffuseColor.a < Params.alphaDiscard){\n                            discard;\n                        }\n                    #endif\n                #endif\n\n                #ifdef Params.specularColor\n                    _specularColor = Params.specularColor;\n                #endif\n                #ifdef Params.specularMap\n                    _specularColor = _specularColor * texture(Params.specularMap, wUv0);\n                #endif\n\n                vec3 normal = normalize( wNormal );\n                #ifdef Params.normalMap\n                    vec3 normalHeight = texture(Params.normalMap, wUv0).xyz;\n                    vec3 tangent = normalize(wTangent.xyz);\n                    mat3 tbnMat = mat3(tangent, wTangent.w * cross(normal, tangent), normal);\n                    normal = normalize(tbnMat * ( normalHeight * 2.0f - 1.0f ));\n                #endif\n\n                float _shininess = 32.0;\n                #ifdef Params.shininess\n                    _shininess = Params.shininess;\n                #endif\n\n\n                Context.OutColor.rgb = _diffuseColor.rgb * ambientSumAdjust;\n                for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                    // 后期改为Context.GetLightDir(Context.LightData[i]);\n                    lightColor = Context.WLightData[i];\n                    lightData1 = Context.WLightData[i + 1];\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                    //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                    // BlinnPhongLighting\n                    //vec3 h = normalize( viewDir + lightDir.xzy );\n                    //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                    // 标准PhongLighting\n                    //vec3 refDir = reflect( lightData1.xyz, normal );\n                    //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                    // 计算SpotLight的衰减\n                    float spotFallOff = 1.0;\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                    }\n\n                    // 如果存在法线纹理,则进一步计算lightDir\n\n                    // 计算反射率\n                    ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                    // 最终光照值\n                    //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb * diffuseSumAdjust.rgb + vec3(lightBRDF.y) * _specularColor.rgb * specularSumAdjust.rgb);\n                    Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * diffuseSumAdjust.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * specularSumAdjust.rgb * vec3( lightBRDF.y ));\n                    //Context.OutColor.rgb = vec3(spotFallOff);\n                }\n                Context.OutColor.a = diffuseSumAdjust.a * _diffuseColor.a;\n            }\n        }\n    }\n\n    SubTechnology ColorSubTechnology{\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = Context.ProjectViewMatrix * Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n            }\n        }\n        Fs_Shader{\n            void main(){\n                Context.OutColor = vec4(1.0f, 0.0f, 0.0f, 1.0f);\n            }\n        }\n    }\n    // 默认为SinglePass\n    Technology {\n        Sub_Pass Forward{\n            Pass SingleBlinnPhongLighting{\n            }\n        }\n    }\n    Technology MultiPass{\n        Sub_Pass Forward{\n            Pass MultiPassBlinnPhongLighting{\n            }\n        }\n    }\n    Technology Color{\n        Sub_Pass Forward{\n            Pass ColorSubTechnology{\n            }\n        }\n    }\n}\n"),n(r,"S_DEFERRED_LIGHTING_DEF_DATA","// 默认的延迟光照材质定义\nDef DeferredLightingDef{\n    Params{\n        sampler2D diffuseMap;\n        sampler2D normalMap;\n        sampler2D specularMap;\n        sampler2D normalMap;\n        vec4 ambientColor;\n        vec4 diffuseColor;\n        vec4 specularColor;\n        float shininess;\n        // 完全透明剔除因子(0-1),低于该值的透明片段被完全剔除而不进行混合\n        float alphaDiscard;\n    }\n    SubTechnology GBufferPass{\n        Vars{\n            vec3 wNormal;\n            vec4 wTangent;\n            vec3 wPosition;\n            vec2 wUv0;\n            // 三种成分用于调和光照,可来自材质颜色的定义,也可以来自vertex_light\n            vec3 ambientSumAdjust;\n            vec4 diffuseSumAdjust;\n            vec3 specularSumAdjust;\n        }\n        Vs_Shader{\n            void main(){\n                #ifdef Context.Skins\n                    mat4 skinMat =\n                            Context.InWeight0.x * Context.Joints[int(Context.InJoint0.x)] +\n                            Context.InWeight0.y * Context.Joints[int(Context.InJoint0.y)] +\n                            Context.InWeight0.z * Context.Joints[int(Context.InJoint0.z)] +\n                            Context.InWeight0.w * Context.Joints[int(Context.InJoint0.w)];\n                    // vec4 pos = Context.ModelMatrix * skinMat * vec4(Context.InPosition, 1.0f);\n                    vec4 pos = skinMat * vec4(Context.InPosition, 1.0f);\n                #else\n                    vec4 pos = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                #endif\n\n\n                wPosition = (Context.ModelMatrix * vec4(Context.InPosition, 1.0f)).xyz;\n                mat3 nMat = mat3(transpose(inverse(Context.ModelMatrix)));\n                vec3 norm = normalize(nMat * Context.InNormal);\n                wTangent = vec4(normalize(nMat * Context.InTangent.xyz), Context.InTangent.w);\n                //t = normalize(t - dot(t, norm) * norm);\n                //vec3 b = cross(norm, t);\n                //tbnMat = mat3(t, b, norm);\n                wNormal = norm;\n                wUv0 = Context.InUv0;\n\n\n                // 如果是顶点光照,则在这里将光源变化到切线空间\n                ambientSumAdjust = Params.ambientColor.rgb;\n                diffuseSumAdjust = vec4(1.0f);\n                specularSumAdjust = vec3(1.0f);\n                Context.OutPosition = Context.ProjectViewMatrix * pos;\n            }\n        }\n        Fs_Shader{\n            void main(){\n\n                vec4 _diffuseColor = vec4(1.0f);\n                vec4 _specularColor = vec4(1.0f);\n\n                #ifdef Params.diffuseColor\n                    _diffuseColor = Params.diffuseColor;\n                #endif\n                #ifdef Params.diffuseMap\n                    _diffuseColor = _diffuseColor * texture(Params.diffuseMap, wUv0);\n                    #ifdef Params.alphaDiscard\n                        // discard性能比较差,建议还是使用半透明渲染比较合适s\n                        if(_diffuseColor.a < Params.alphaDiscard){\n                            discard;\n                        }\n                    #endif\n                #endif\n\n                #ifdef Params.specularColor\n                    _specularColor = Params.specularColor;\n                #endif\n                #ifdef Params.specularMap\n                    _specularColor = _specularColor * texture(Params.specularMap, wUv0);\n                #endif\n\n                vec3 normal = normalize( wNormal );\n                #ifdef Params.normalMap\n                    vec3 normalHeight = texture(Params.normalMap, wUv0).xyz;\n                    vec3 tangent = normalize(wTangent.xyz);\n                    mat3 tbnMat = mat3(tangent, wTangent.w * cross(normal, tangent), normal);\n                    normal = normalize(tbnMat * ( normalHeight * 2.0f - 1.0f ));\n                #endif\n\n                float _shininess = 32.0;\n                #ifdef Params.shininess\n                    _shininess = Params.shininess;\n                #endif\n\n\n\n\n                Context.OutGBuffer0.xyz = _diffuseColor.rgb * diffuseSumAdjust.rgb;\n                Context.OutGBuffer0.w   = diffuseSumAdjust.a * _diffuseColor.a * 0.1f + _shininess;\n                Context.OutGBuffer1.xyz = normal.xyz;\n                Context.OutGBuffer2.rgb = _specularColor.rgb * specularSumAdjust.rgb * 10.0f + ambientSumAdjust * 0.1f;\n                Context.OutGBuffer2.a = _shininess;\n            }\n        }\n    }\n    SubTechnology DeferredShadingPass{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram SinglePassLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                // 对于DirLight,lightDir.w = 1.0f\n                lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n\n                //lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                //lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            // 基于BlinnPhong光照模型计算光照因子\n            // brdf.x保存漫反射部分;brdf.y保存镜面反射部分\n            void ComputeLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in float attenuation, in float shininess, out vec2 brdf){\n                // diffuse部分\n                float diffuseBRDF = max(0.0f, dot(normal, lightDir));\n                // specular部分\n                // 半角向量代替viewDir参与光照计算\n                vec3 H = normalize(viewDir + lightDir);\n                float HdotN = max(0.0f, dot(H, normal));\n                float specularBRDF = pow( HdotN, shininess );\n\n                // 衰减,对于PointLight和SpotLight来说有效,对于DirLight而言,attenuation一直为1\n                brdf.x = diffuseBRDF * attenuation;\n                brdf.y = specularBRDF * attenuation;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 _diffuseColor = texture(Context.InGBuffer0, uv0);\n                vec4 _specularColorDecode = texture(Context.InGBuffer2, uv0);\n                vec3 _specularColor = floor(_specularColorDecode.rgb) * 0.1f;\n                vec3 _ambientColor = min(fract(_specularColorDecode.rgb) * 10.0f, vec3(1.0f));\n                float _shininess = floor(_diffuseColor.w);\n                float alpha     = min(fract(_diffuseColor.w) * 10.0f, 1.0f);\n                vec3 normal = texture(Context.InGBuffer1, uv0).xyz;\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec2 lightBRDF = vec2(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                Context.OutColor.rgb = _diffuseColor.rgb * Context.AmbientLightColor * _ambientColor;\n                for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                    // 后期改为Context.GetLightDir(Context.LightData[i]);\n                    lightColor = Context.WLightData[i];\n                    lightData1 = Context.WLightData[i + 1];\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                    //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                    // BlinnPhongLighting\n                    //vec3 h = normalize( viewDir + lightDir.xzy );\n                    //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                    // 标准PhongLighting\n                    //vec3 refDir = reflect( lightData1.xyz, normal );\n                    //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                    // 计算SpotLight的衰减\n                    float spotFallOff = 1.0;\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                    }\n\n                    // 如果存在法线纹理,则进一步计算lightDir\n\n                    // 计算反射率\n                    ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                    // 最终光照值\n                    //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb + vec3(lightBRDF.y) * _specularColor.rgb);\n                    Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * vec3( lightBRDF.y ));\n                    //Context.OutColor.rgb = vec3(spotFallOff);\n                }\n                Context.OutColor.a = alpha;\n            }\n        }\n    }\n    SubTechnology DeferredShadingPass2{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram MultiPassLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                // 对于DirLight,lightDir.w = 1.0f\n                lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n\n                //lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                //lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            // 基于BlinnPhong光照模型计算光照因子\n            // brdf.x保存漫反射部分;brdf.y保存镜面反射部分\n            void ComputeLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in float attenuation, in float shininess, out vec2 brdf){\n                // diffuse部分\n                float diffuseBRDF = max(0.0f, dot(normal, lightDir));\n                // specular部分\n                // 半角向量代替viewDir参与光照计算\n                vec3 H = normalize(viewDir + lightDir);\n                float HdotN = max(0.0f, dot(H, normal));\n                float specularBRDF = pow( HdotN, shininess );\n\n                // 衰减,对于PointLight和SpotLight来说有效,对于DirLight而言,attenuation一直为1\n                brdf.x = diffuseBRDF * attenuation;\n                brdf.y = specularBRDF * attenuation;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 _diffuseColor = texture(Context.InGBuffer0, uv0);\n                vec4 _specularColorDecode = texture(Context.InGBuffer2, uv0);\n                vec3 _specularColor = floor(_specularColorDecode.rgb) * 0.1f;\n                vec3 _ambientColor = min(fract(_specularColorDecode.rgb) * 10.0f, vec3(1.0f));\n                float _shininess = floor(_diffuseColor.w);\n                float alpha     = min(fract(_diffuseColor.w) * 10.0f, 1.0f);\n                vec3 normal = texture(Context.InGBuffer1, uv0).xyz;\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec2 lightBRDF = vec2(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                Context.OutColor.rgb = _diffuseColor.rgb * Context.AmbientLightColor * _ambientColor;\n\n\n                // 不必担心这个分支，不会影响性能\n                if(Context.MultiId == 0){\n                    for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                        // 后期改为Context.GetLightDir(Context.LightData[i]);\n                        lightColor = Context.WLightData[i];\n                        lightData1 = Context.WLightData[i + 1];\n                        ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                        //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                        // BlinnPhongLighting\n                        //vec3 h = normalize( viewDir + lightDir.xzy );\n                        //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                        // 标准PhongLighting\n                        //vec3 refDir = reflect( lightData1.xyz, normal );\n                        //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                        // 计算SpotLight的衰减\n                        float spotFallOff = 1.0;\n                        if( lightColor.w > 1.0f )\n                        {\n                            // 计算SpotLight的范围衰减\n                            spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                        }\n\n                        // 如果存在法线纹理,则进一步计算lightDir\n\n                        // 计算反射率\n                        ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                        // 最终光照值\n                        //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb + vec3(lightBRDF.y) * _specularColor.rgb);\n                        Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * vec3( lightBRDF.y ));\n                        //Context.OutColor.rgb = vec3(spotFallOff);\n                    }\n                }\n                else{\n                    // point和spot\n                    lightColor = Context.WLight_Data_0;\n                    lightData1 = Context.WLight_Data_1;\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                    //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                    // BlinnPhongLighting\n                    //vec3 h = normalize( viewDir + lightDir.xzy );\n                    //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                    // 标准PhongLighting\n                    //vec3 refDir = reflect( lightData1.xyz, normal );\n                    //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                    // 计算SpotLight的衰减\n                    float spotFallOff = 1.0;\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLight_Data_2, lightDir.xyz );\n                    }\n\n                    // 如果存在法线纹理,则进一步计算lightDir\n\n                    // 计算反射率\n                    ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                    // 最终光照值\n                    //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb + vec3(lightBRDF.y) * _specularColor.rgb);\n                    Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * vec3( lightBRDF.y ));\n                }\n\n\n                Context.OutColor.a = alpha;\n            }\n        }\n    }\n    SubTechnology GlobalPass{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram TilePassLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                // 对于DirLight,lightDir.w = 1.0f\n                lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n\n                //lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                //lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            // 基于BlinnPhong光照模型计算光照因子\n            // brdf.x保存漫反射部分;brdf.y保存镜面反射部分\n            void ComputeLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in float attenuation, in float shininess, out vec2 brdf){\n                // diffuse部分\n                float diffuseBRDF = max(0.0f, dot(normal, lightDir));\n                // specular部分\n                // 半角向量代替viewDir参与光照计算\n                vec3 H = normalize(viewDir + lightDir);\n                float HdotN = max(0.0f, dot(H, normal));\n                float specularBRDF = pow( HdotN, shininess );\n\n                // 衰减,对于PointLight和SpotLight来说有效,对于DirLight而言,attenuation一直为1\n                brdf.x = diffuseBRDF * attenuation;\n                brdf.y = specularBRDF * attenuation;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n                float falloff = clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f);\n                //if(curAngleCos > innerMinusOuter)\n                //    falloff = 1.0f;\n                //else\n                //    falloff = 0.0f;\n\n                #ifdef SRGB\n                    // Use quadratic falloff (notice the ^4)\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0, 1.0), 4.0);\n                #else\n                    // Use linear falloff\n                    return falloff;\n                #endif\n            }\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 _diffuseColor = texture(Context.InGBuffer0, uv0);\n                vec4 _specularColorDecode = texture(Context.InGBuffer2, uv0);\n                vec3 _specularColor = floor(_specularColorDecode.rgb) * 0.1f;\n                vec3 _ambientColor = min(fract(_specularColorDecode.rgb) * 10.0f, vec3(1.0f));\n                float _shininess = floor(_diffuseColor.w);\n                float alpha     = min(fract(_diffuseColor.w) * 10.0f, 1.0f);\n                vec3 normal = texture(Context.InGBuffer1, uv0).xyz;\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec2 lightBRDF = vec2(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                Context.OutColor.rgb = _diffuseColor.rgb * Context.AmbientLightColor * _ambientColor;\n                for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                    // 后期改为Context.GetLightDir(Context.LightData[i]);\n                    lightColor = Context.WLightData[i];\n                    lightData1 = Context.WLightData[i + 1];\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                    //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                    // BlinnPhongLighting\n                    //vec3 h = normalize( viewDir + lightDir.xzy );\n                    //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                    // 标准PhongLighting\n                    //vec3 refDir = reflect( lightData1.xyz, normal );\n                    //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                    // 计算SpotLight的衰减\n                    float spotFallOff = 1.0;\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                    }\n\n                    // 如果存在法线纹理,则进一步计算lightDir\n\n                    // 计算反射率\n                    ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                    // 最终光照值\n                    //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb + vec3(lightBRDF.y) * _specularColor.rgb);\n                    Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * vec3( lightBRDF.y ));\n                    //Context.OutColor.rgb = vec3(spotFallOff);\n                }\n                Context.OutColor.a = alpha;\n            }\n        }\n    }\n    SubTechnology TilePass{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram TilePassLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                // 对于DirLight,lightDir.w = 1.0f\n                lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n\n                //lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                //lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            // 基于BlinnPhong光照模型计算光照因子\n            // brdf.x保存漫反射部分;brdf.y保存镜面反射部分\n            void ComputeLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in float attenuation, in float shininess, out vec2 brdf){\n                // diffuse部分\n                float diffuseBRDF = max(0.0f, dot(normal, lightDir));\n                // specular部分\n                // 半角向量代替viewDir参与光照计算\n                vec3 H = normalize(viewDir + lightDir);\n                float HdotN = max(0.0f, dot(H, normal));\n                float specularBRDF = pow( HdotN, shininess );\n\n                // 衰减,对于PointLight和SpotLight来说有效,对于DirLight而言,attenuation一直为1\n                brdf.x = diffuseBRDF * attenuation;\n                brdf.y = specularBRDF * attenuation;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n                float falloff = clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f);\n                //if(curAngleCos > innerMinusOuter)\n                //    falloff = 1.0f;\n                //else\n                //    falloff = 0.0f;\n\n                #ifdef SRGB\n                    // Use quadratic falloff (notice the ^4)\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0, 1.0), 4.0);\n                #else\n                    // Use linear falloff\n                    return falloff;\n                #endif\n            }\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 _diffuseColor = texture(Context.InGBuffer0, uv0);\n                vec4 _specularColorDecode = texture(Context.InGBuffer2, uv0);\n                vec3 _specularColor = floor(_specularColorDecode.rgb) * 0.1f;\n                vec3 _ambientColor = min(fract(_specularColorDecode.rgb) * 10.0f, vec3(1.0f));\n                float _shininess = floor(_diffuseColor.w);\n                float alpha     = min(fract(_diffuseColor.w) * 10.0f, 1.0f);\n                vec3 normal = texture(Context.InGBuffer1, uv0).xyz;\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec2 lightBRDF = vec2(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                Context.OutColor.rgb = vec3(0.0f);\n                // Tile Based Shading\n                // 获取tile信息\n                vec3 tile = texture(Context.InTileLightDecode, uv0).xyz;\n                int uoffset = int(tile.x);\n                int voffset = int(tile.z);\n                int count = int(tile.y);\n                if(count > 0){\n                    int lightId;\n                    float temp;\n                    int offset;\n                    // lightIndex采样范围规范化单位\n                    float uvSize = 1.0f / (Context.TileLightOffsetSize - 1.0f);\n                    vec2 lightUV;\n                    // lightData采样范围规范单位\n                    float lightUVSize = 1.0f / (float(Context.TileLightNum) - 1.0f);\n                    vec2 lightDataUV;\n                    for(int i = 0;i < count;i++){\n                        temp = float(uoffset + i);\n                        offset = 0;\n\n                        if(temp >= Context.TileLightOffsetSize){\n                            temp -= Context.TileLightOffsetSize;\n                            offset++;\n                        }\n                        if(temp == Context.TileLightOffsetSize){\n                            temp = 0.0f;\n                        }\n\n                        // lightIndexUV\n                        lightUV = vec2(temp * uvSize, float(voffset + offset) * uvSize);\n                        lightId = int(texture(Context.InTileLightIndex, lightUV).x);\n\n                        // 光源信息\n                        lightDataUV = vec2(float(lightId) * lightUVSize);\n                        lightColor = texture(Context.InTileWLightData0, lightDataUV);\n                        lightData1 = texture(Context.InTileWLightData1, lightDataUV);\n\n                        // point和spot\n                        ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n                        //lightBRDF.x = max( 0.0f, dot( normal, lightDir.xyz ) );\n\n                        // BlinnPhongLighting\n                        //vec3 h = normalize( viewDir + lightDir.xzy );\n                        //lightBRDF.y = pow( max( 0.0f, dot( normal, h ) ), 32.0f );\n                        // 标准PhongLighting\n                        //vec3 refDir = reflect( lightData1.xyz, normal );\n                        //lightBRDF.y = pow( max( 0.0f, dot( viewDir, refDir ) ), 32.0f);\n\n                        // 计算SpotLight的衰减\n                        float spotFallOff = 1.0;\n                        if( lightColor.w > 1.0f )\n                        {\n                            // 计算SpotLight的范围衰减\n                            spotFallOff = ComputeSpotFalloff( texture(Context.InTileWLightData2, lightDataUV), lightDir.xyz );\n                        }\n\n                        // 如果存在法线纹理,则进一步计算lightDir\n\n                        // 计算反射率\n                        ComputeLighting(normal, viewDir, lightDir.xyz, lightDir.w * spotFallOff, _shininess, lightBRDF);\n\n                        // 最终光照值\n                        //Context.OutColor.rgb += lightColor.rgb * (vec3(lightBRDF.x) * _diffuseColor.rgb + vec3(lightBRDF.y) * _specularColor.rgb);\n                        Context.OutColor.rgb += lightColor.rgb * ( _diffuseColor.rgb * vec3( lightBRDF.x ) + _specularColor.rgb * vec3( lightBRDF.y ));\n                    }\n                }\n                Context.OutColor.a = alpha;\n            }\n        }\n    }\n    Technology{\n        Sub_Pass DeferredShading{\n            Pass GBufferPass{\n            }\n            Pass DeferredShadingPass{\n            }\n        }\n    }\n    Technology MultiPassDeferred{\n        Sub_Pass DeferredShading{\n            Pass GBufferPass{\n            }\n            Pass DeferredShadingPass2{\n            }\n        }\n    }\n    Technology TileDeferred{\n        Sub_Pass TileDeferredShading{\n            Pass GBufferPass{\n            }\n            Pass GlobalPass{\n            }\n            Pass TilePass{\n            }\n        }\n    }\n}\n"),n(r,"S_PRINCIPLED_DEFERRED_LIGHTING_DEF_DATA","// 默认的延迟光照材质定义,实现PBR材质\nDef DeferredLightingDef{\n    Params{\n        // 基础参数\n        vec4 baseColor;\n        sampler2D baseColorMap;\n        sampler2D normalMap;\n\n        // lightMap或AO\n        sampler2D lightMap;\n        bool aoMap;\n        bool lightMapTexCoord;\n\n        // 自发光\n        vec4 emissive;\n        float emissivePower;\n        float emissiveIntensity;\n\n        // metallic管线\n        float metallic;\n        float roughness;\n        sampler2D metallicRoughnessMap;\n        sampler2D metallicMap;\n        sampler2D roughnessMap;\n\n        // specular管线\n        bool useSpecGloss;\n        sampler2D specularGlossinessMap;\n        sampler2D specularMap;\n        sampler2D glossinessMap;\n        vec4 specular;\n        float glossiness;\n\n        // alphaDiscard\n        float alphaDiscard;\n    }\n    SubTechnology GBufferPass{\n        Vars{\n            vec3 wNormal;\n            vec4 wTangent;\n            vec3 wPosition;\n            vec2 wUv0;\n            vec2 wUv1;\n        }\n        Vs_Shader{\n            void main(){\n                #ifdef Context.Skins\n                    mat4 skinMat =\n                            Context.InWeight0.x * Context.Joints[int(Context.InJoint0.x)] +\n                            Context.InWeight0.y * Context.Joints[int(Context.InJoint0.y)] +\n                            Context.InWeight0.z * Context.Joints[int(Context.InJoint0.z)] +\n                            Context.InWeight0.w * Context.Joints[int(Context.InJoint0.w)];\n                    // vec4 pos = Context.ModelMatrix * skinMat * vec4(Context.InPosition, 1.0f);\n                    vec4 pos = skinMat * vec4(Context.InPosition, 1.0f);\n                #else\n                    vec4 pos = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                #endif\n\n\n                wPosition = (Context.ModelMatrix * vec4(Context.InPosition, 1.0f)).xyz;\n                mat3 nMat = mat3(transpose(inverse(Context.ModelMatrix)));\n                vec3 norm = normalize(nMat * Context.InNormal);\n                //vec3 t = normalize(nMat * Context.InTangent);\n                wTangent = vec4(normalize(nMat * Context.InTangent.xyz), Context.InTangent.w);\n                //t = normalize(t - dot(t, norm) * norm);\n                //vec3 b = cross(norm, t);\n                //tbnMat = mat3(t, b, norm);\n                wNormal = norm;\n                wUv0 = Context.InUv0;\n                #ifdef Params.lightMapTexCoord\n                    wUv1 = Context.InUv1;\n                #endif\n\n\n                Context.OutPosition = Context.ProjectViewMatrix * pos;\n            }\n        }\n        Fs_Shader{\n            #define GAMMA 2.2f\n            void main(){\n\n                #ifdef Params.baseColor\n                    #ifdef Params.baseColorMap\n                        vec4 albedo = texture(Params.baseColorMap, wUv0) * Params.baseColor;\n                    #else\n                        vec4 albedo = Params.baseColor;\n                    #endif\n                #else\n                    #ifdef Params.baseColorMap\n                        vec4 albedo = texture(Params.baseColorMap, wUv0);\n                    #else\n                        vec4 albedo = vec4(1.0f);\n                    #endif\n                #endif\n\n                #ifdef Params.alphaDiscard\n                    if(albedo.a < Params.alphaDiscard){\n                        discard;\n                    }\n                #endif\n\n                vec3 normal = wNormal;\n                #ifdef Params.normalMap\n                    // 这里做了一种简化,理论上应该在fs阶段计算tbn,但是从插值的角度来看,可以简化为tbn插值,减少在fs阶段计算tbn开销(虽然这么做不精确,但是折中下可以接受)\n                    vec3 normalHeight = texture(Params.normalMap, wUv0).xyz;\n                    vec3 tangent = normalize(wTangent.xyz);\n                    mat3 tbnMat = mat3(tangent, wTangent.w * cross(normal, tangent), normal);\n                    normal = normalize(tbnMat * ( normalHeight * 2.0f - 1.0f ));\n                #endif\n\n                #ifdef Params.metallicRoughnessMap\n                    vec2 rm = texture(Params.metallicRoughnessMap, wUv0).gb;\n                    #ifdef Params.roughness\n                        float _roughness = rm.x * max(Params.roughness, 1e-4);\n                    #else\n                        float _roughness = rm.x;\n                    #endif\n                    #ifdef Params.metallic\n                        float _metallic = rm.y * max(Params.metallic, 0.0f);\n                    #else\n                        float _metallic = rm.y;\n                    #endif\n                #else\n                    #ifdef Params.roughnessMap\n                        #ifdef Params.roughness\n                            float _roughness = texture(Params.roughnessMap, wUv0).r * max(Params.roughness, 1e-4);\n                        #else\n                            float _roughness = texture(Params.roughnessMap, wUv0).r;\n                        #endif\n                    #else\n                        #ifdef Params.roughness\n                            float _roughness = max(Params.roughness, 1e-4);\n                        #else\n                            float _roughness = 1.0f;\n                        #endif\n                    #endif\n                    #ifdef Params.metallicMap\n                        #ifdef Params.metallic\n                            float _metallic = texture(Params.metallicMap, wUv0).r * max(Params.metallic, 0.0f);\n                        #else\n                            float _metallic = texture(Params.metallicMap, wUv0).r;\n                        #endif\n                    #else\n                        #ifdef Params.metallic\n                            float _metallic = max(Params.metallic, 0.0f);\n                        #else\n                            float _metallic = 1.0f;\n                        #endif\n                    #endif\n                #endif\n\n                #ifdef Params.useSpecGloss\n                    #ifdef Params.specularGlossinessMap\n                        vec4 _specularColor = texture(Params.specularGlossinessMap, wUv0);\n                        #ifdef Params.glossiness\n                            float _glossiness = _specularColor.a * Params.glossiness;\n                        #else\n                            float _glossiness = _specularColor.a;\n                        #endif\n                        #ifdef Params.specular\n                            _specularColor *= Params.specular;\n                        #endif\n                    #else\n                        #ifdef Params.specularMap\n                            vec4 _specularColor = texture(Params.specularMap, wUv0);\n                        #else\n                            vec4 _specularColor = vec4(1.0f);\n                        #endif\n                        #ifdef Params.specular\n                            _specularColor *= Params.specular;\n                        #endif\n                        #ifdef Params.glossinessMap\n                            #ifdef Params.glossiness\n                                float _glossiness = texture(Params.glossinessMap, wUv0).r * Params.glossiness;\n                            #else\n                                float _glossiness = texture(Params.glossinessMap, wUv0).r;\n                            #endif\n                        #else\n                            #ifdef Params.glossiness\n                                float _glossiness = Params.glossiness;\n                            #else\n                                float _glossiness = 1.0f;\n                            #endif\n                        #endif\n                    #endif\n                    vec4 _diffuseColor = albedo;\n                    _roughness = 1.0f - _glossiness;\n                    vec3 fZero = _specularColor.rgb;\n                #else\n                    float nonMetalSpec = 0.04f;\n                    vec4 _specularColor = (nonMetalSpec - nonMetalSpec * _metallic) + albedo * _metallic;\n                    vec4 _diffuseColor = albedo - albedo * _metallic;\n                    vec3 fZero = vec3( 0.5f );\n                #endif\n\n                #ifdef Params.lightMap\n                    vec3 _lightMapColor;\n                    #ifdef Params.lightMapTexCoord\n                        _lightMapColor = texture(Params.lightMap, wUv1).rgb;\n                    #else\n                        _lightMapColor = texture(Params.lightMap, wUv0).rgb;\n                    #endif\n                    #ifdef Params.aoMap\n                        _lightMapColor.gb = _lightMapColor.rr;\n                        vec3 ao = _lightMapColor;\n                    #else\n                        _specularColor.rgb *= _lightMapColor;\n                        _diffuseColor.rgb  *= _lightMapColor;\n                        vec3 ao = vec3(1.0f);\n                    #endif\n                #else\n                    vec3 ao = vec3(1.0f);\n                #endif\n\n\n\n\n                Context.OutGBuffer0.xyz = floor(_diffuseColor.rgb * 100.0f) + ao * 0.1f;\n                Context.OutGBuffer0.w   = albedo.a;\n                Context.OutGBuffer1.xyz = floor(normal.xyz * 1000.0f) + wNormal * 0.001f;\n                Context.OutGBuffer2.rgb = floor(_specularColor.rgb * 100.0f) + fZero * 0.1f;\n                Context.OutGBuffer2.a = floor(_roughness * 100.0f) + _metallic * 0.1f;\n            }\n        }\n    }\n    SubTechnology DeferredShadingPass{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram SinglePassIBLLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                #ifdef Context.Srgb\n                    lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                    lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n                #else\n                    // 对于DirLight,lightDir.w = 1.0f\n                    lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n                #endif\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            #define PI 3.14159265358979323846264\n            // 镜面反射菲涅尔计算\n            vec3 F_Shlick(float vh,\tvec3 F0){\n                float fresnelFact = pow(2.0f, (-5.55473f * vh - 6.98316f) * vh);\n                return mix(F0, vec3(1.0f, 1.0f, 1.0f), fresnelFact);\n            }\n            vec3 F_Schlick2(float cosTheta, vec3 F0)\n            {\n                return F0 + (1.0f - F0) * pow(1.0f - cosTheta, 5.0f);\n            }\n            // 计算直接光照\n            void ComputeDirectLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 diffuseColor, in vec3 fZero, in float roughness, in float ndotv, out vec3 directLighting){\n                vec3 h = normalize(lightDir + viewDir);\n                float ndotl = max( dot( normal, lightDir ), 0.0f );\n                float ndoth = max( dot( normal, h), 0.0f );\n                float hdotv = max( dot( h, viewDir ), 0.0f );\n\n                // 这里,不使用c/Π计算diffuse fr(x, wi, wo)\n                // 而假设恒定\n                vec3 diffuse = vec3( ndotl ) * lightColor * diffuseColor;\n\n                // cook-torrence,BRDF : http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf\n                float alpha = roughness * roughness;\n\n                // D, GGX 法线分布函数\n                float alpha2 = alpha * alpha;\n                float sum = (( ndoth * ndoth ) * ( alpha2 - 1.0f ) + 1.0f);\n                float denom = PI * sum * sum;\n                float D = alpha2 / denom;\n\n                // F, 菲涅尔项\n                vec3 F = F_Shlick( hdotv, fZero );\n\n                // G, 几何遮挡项\n                float k = alpha * 0.5f;\n                float G_V = ndotv + sqrt( ( ndotv - ndotv * k ) * ndotv + k );\n                float G_L = ndotl + sqrt( ( ndotl - ndotl * k ) * ndotl + k );\n                float G = 1.0f / max( G_V * G_L ,0.01f );\n\n                // specularBRDF\n                float t = D * G * ndotl;\n                vec3 specular =  vec3( t ) * F * lightColor;\n\n                directLighting = diffuse + specular;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            // 球谐函数\n            vec3 sphericalHarmonics( const in vec3 normal, const vec3 sph[9] ){\n                float x = normal.x;\n                float y = normal.y;\n                float z = normal.z;\n\n                vec3 result = (\n                    sph[0] +\n\n                    sph[1] * y +\n                    sph[2] * z +\n                    sph[3] * x +\n\n                    sph[4] * y * x +\n                    sph[5] * y * z +\n                    sph[6] * (3.0f * z * z - 1.0f) +\n                    sph[7] * (z * x) +\n                    sph[8] * (x*x - y*y)\n                );\n\n                return max(result, vec3(0.0f));\n            }\n            // 镜面反射趋势朝向\n            vec3 getSpecularDominantDir(const in vec3 N, const in vec3 R, const in float realRoughness){\n\n                float smoothness = 1.0f - realRoughness;\n                float lerpFactor = smoothness * (sqrt(smoothness) + realRoughness);\n                // 当我们在立方体贴图中获取时，结果未规范化\n                vec3 dominant = mix(N, R, lerpFactor);\n\n                return dominant;\n            }\n            // 拟合方程\n            // 关于镜面部分，有很多优化地方，除了常见的优化，还有很多可以替代方案，几乎可以在保证画质的前提下，在移动端35帧率提升到60帧率，详细可参考我的笔记:https://www.cnblogs.com/JhonKkk/p/14313882.html\n            vec3 integrateBRDFApprox( const in vec3 specular, in float roughness, in float NoV ){\n                const vec4 c0 = vec4( -1.0f, -0.0275f, -0.572f, 0.022f );\n                const vec4 c1 = vec4( 1.0f, 0.0425f, 1.04f, -0.04f );\n                vec4 r = roughness * c0 + c1;\n                float a004 = min( r.x * r.x, exp2( -9.28f * NoV ) ) * r.x + r.y;\n                vec2 ab = vec2( -1.04f, 1.04f ) * a004 + r.zw;\n                return specular * ab.x + ab.y;\n            }\n            // 近似镜面IBL多项式\n            vec3 approximateSpecularIBLPolynomial(in samplerCube envMap, in vec3 specularColor , in float roughness, in float ndotv, in vec3 refVec, in float mipMaps){\n                float lod = sqrt( roughness ) * (mipMaps - 1.0f);\n                vec3 prefilteredColor = textureLod(envMap, refVec.xyz, lod).rgb;\n                return prefilteredColor * integrateBRDFApprox(specularColor, roughness, ndotv);\n            }\n            #define GAMMA 2.2f\n            #define GAMMA_T 1.0f / GAMMA\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 buff0 = texture(Context.InGBuffer0, uv0);\n                vec4 buff2 = texture(Context.InGBuffer2, uv0);\n                vec3 _diffuseColor = floor(buff0.rgb) * 0.01f * Context.AmbientLightColor;\n                vec3 _specularColor = floor(buff2.rgb) * 0.01f;\n                vec3 ao = min(fract(buff0.rgb) * 10.0f, vec3(1.0f));\n                vec3 fZero = min(fract(buff2.rgb) * 10.0f, vec3(0.5f));\n                float _roughness = floor(buff2.w) * 0.01f;\n                vec3 n = texture(Context.InGBuffer1, uv0).xyz;\n                vec3 normal = normalize(floor(n) * 0.001f);\n                vec3 wNormal = normalize(fract(n) * 1000.0f);\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec3 directLighting = vec3(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                float ndotv = max( dot( normal, viewDir ), 0.0f );\n                for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                    lightColor = Context.WLightData[i];\n                    lightData1 = Context.WLightData[i + 1];\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n\n                    // 计算PointLight的衰减\n                    float spotFallOff = 1.0 * lightDir.w;\n                    // 计算SpotLight的衰减\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                    }\n\n                    ComputeDirectLighting(normal, viewDir, lightDir.xyz, lightColor.rgb, _diffuseColor.rgb, fZero, _roughness, ndotv, directLighting);\n                    Context.OutColor.rgb += directLighting * spotFallOff;\n                }\n\n                if(Context.BlendGiProbes){\n                    #ifdef Context.GIProbes\n                        // 作为webGL项目,暂时不实现探针混合(但作为可拓展,仍然加结尾s命名)\n\n                        // 计算反射视线\n                        vec3 _rv = reflect( -viewDir.xyz, normal.xyz );\n                        float _r = fract( Context.WGIProbe.w );\n                        float _mipMaps = Context.WGIProbe.w - _r;\n                        _rv = _r * ( wPosition.xyz - Context.WGIProbe.xyz ) + _rv;\n\n                        // 使用球谐计算diffuse( 避免Irr采样 )\n                        vec3 giLighting = sphericalHarmonics(normal.xyz, Context.ShCoeffs) * _diffuseColor.rgb;\n\n                        float horiz = dot(_rv, wNormal);\n                        float horizFadePower = 1.0f - _roughness;\n                        horiz = clamp( 1.0f + horizFadePower * horiz, 0.0f, 1.0f );\n                        horiz *= horiz;\n\n                        vec3 _dominantR = getSpecularDominantDir( normal, _rv.xyz, _roughness * _roughness );\n                        giLighting += approximateSpecularIBLPolynomial(Context.InPrefEnvMap, _specularColor.rgb, _roughness, ndotv, _dominantR, _mipMaps) * vec3( horiz );\n                        giLighting *= ao;\n\n                        Context.OutColor.rgb += giLighting * step( 0.0f, Context.WGIProbe.w );\n                        // Context.OutColor.rgb = textureLod(Context.InPrefEnvMap, normal.xyz, 0.0f).rgb;\n                    #endif\n                }\n\n                Context.OutColor.a = buff0.a;\n            }\n        }\n    }\n    SubTechnology DeferredShadingPass2{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram MultiPassIBLLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                #ifdef Context.Srgb\n                    lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                    lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n                #else\n                    // 对于DirLight,lightDir.w = 1.0f\n                    lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n                #endif\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            #define PI 3.14159265358979323846264\n            // 镜面反射菲涅尔计算\n            vec3 F_Shlick(float vh,\tvec3 F0){\n                float fresnelFact = pow(2.0f, (-5.55473f * vh - 6.98316f) * vh);\n                return mix(F0, vec3(1.0f, 1.0f, 1.0f), fresnelFact);\n            }\n            vec3 F_Schlick2(float cosTheta, vec3 F0)\n            {\n                return F0 + (1.0f - F0) * pow(1.0f - cosTheta, 5.0f);\n            }\n            // 计算直接光照\n            void ComputeDirectLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 diffuseColor, in vec3 fZero, in float roughness, in float ndotv, out vec3 directLighting){\n                vec3 h = normalize(lightDir + viewDir);\n                float ndotl = max( dot( normal, lightDir ), 0.0f );\n                float ndoth = max( dot( normal, h), 0.0f );\n                float hdotv = max( dot( h, viewDir ), 0.0f );\n\n                // 这里,不使用c/Π计算diffuse fr(x, wi, wo)\n                // 而假设恒定\n                vec3 diffuse = vec3( ndotl ) * lightColor * diffuseColor;\n\n                // cook-torrence,BRDF : http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf\n                float alpha = roughness * roughness;\n\n                // D, GGX 法线分布函数\n                float alpha2 = alpha * alpha;\n                float sum = (( ndoth * ndoth ) * ( alpha2 - 1.0f ) + 1.0f);\n                float denom = PI * sum * sum;\n                float D = alpha2 / denom;\n\n                // F, 菲涅尔项\n                vec3 F = F_Shlick( hdotv, fZero );\n\n                // G, 几何遮挡项\n                float k = alpha * 0.5f;\n                float G_V = ndotv + sqrt( ( ndotv - ndotv * k ) * ndotv + k );\n                float G_L = ndotl + sqrt( ( ndotl - ndotl * k ) * ndotl + k );\n                float G = 1.0f / max( G_V * G_L ,0.01f );\n\n                // specularBRDF\n                float t = D * G * ndotl;\n                vec3 specular =  vec3( t ) * F * lightColor;\n\n                directLighting = diffuse + specular;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            // 球谐函数\n            vec3 sphericalHarmonics( const in vec3 normal, const vec3 sph[9] ){\n                float x = normal.x;\n                float y = normal.y;\n                float z = normal.z;\n\n                vec3 result = (\n                    sph[0] +\n\n                    sph[1] * y +\n                    sph[2] * z +\n                    sph[3] * x +\n\n                    sph[4] * y * x +\n                    sph[5] * y * z +\n                    sph[6] * (3.0f * z * z - 1.0f) +\n                    sph[7] * (z * x) +\n                    sph[8] * (x*x - y*y)\n                );\n\n                return max(result, vec3(0.0f));\n            }\n            // 镜面反射趋势朝向\n            vec3 getSpecularDominantDir(const in vec3 N, const in vec3 R, const in float realRoughness){\n\n                float smoothness = 1.0f - realRoughness;\n                float lerpFactor = smoothness * (sqrt(smoothness) + realRoughness);\n                // 当我们在立方体贴图中获取时，结果未规范化\n                vec3 dominant = mix(N, R, lerpFactor);\n\n                return dominant;\n            }\n            // 拟合方程\n            // 关于镜面部分，有很多优化地方，除了常见的优化，还有很多可以替代方案，几乎可以在保证画质的前提下，在移动端35帧率提升到60帧率，详细可参考我的笔记:https://www.cnblogs.com/JhonKkk/p/14313882.html\n            vec3 integrateBRDFApprox( const in vec3 specular, in float roughness, in float NoV ){\n                const vec4 c0 = vec4( -1.0f, -0.0275f, -0.572f, 0.022f );\n                const vec4 c1 = vec4( 1.0f, 0.0425f, 1.04f, -0.04f );\n                vec4 r = roughness * c0 + c1;\n                float a004 = min( r.x * r.x, exp2( -9.28f * NoV ) ) * r.x + r.y;\n                vec2 ab = vec2( -1.04f, 1.04f ) * a004 + r.zw;\n                return specular * ab.x + ab.y;\n            }\n            // 近似镜面IBL多项式\n            vec3 approximateSpecularIBLPolynomial(in samplerCube envMap, in vec3 specularColor , in float roughness, in float ndotv, in vec3 refVec, in float mipMaps){\n                float lod = sqrt( roughness ) * (mipMaps - 1.0f);\n                vec3 prefilteredColor = textureLod(envMap, refVec.xyz, lod).rgb;\n                return prefilteredColor * integrateBRDFApprox(specularColor, roughness, ndotv);\n            }\n            #define GAMMA 2.2f\n            #define GAMMA_T 1.0f / GAMMA\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 buff0 = texture(Context.InGBuffer0, uv0);\n                vec4 buff2 = texture(Context.InGBuffer2, uv0);\n                vec3 _diffuseColor = floor(buff0.rgb) * 0.01f * Context.AmbientLightColor;\n                vec3 _specularColor = floor(buff2.rgb) * 0.01f;\n                vec3 ao = min(fract(buff0.rgb) * 10.0f, vec3(1.0f));\n                vec3 fZero = min(fract(buff2.rgb) * 10.0f, vec3(1.0f));\n                float _roughness = floor(buff2.w) * 0.01f;\n                vec3 n = texture(Context.InGBuffer1, uv0).xyz;\n                vec3 normal = normalize(floor(n) * 0.001f);\n                vec3 wNormal = normalize(fract(n) * 1000.0f);\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec3 directLighting = vec3(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                float ndotv = max( dot( normal, viewDir ), 0.0f );\n                if(Context.MultiId == 0){\n                    for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                        lightColor = Context.WLightData[i];\n                        lightData1 = Context.WLightData[i + 1];\n                        ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n\n                        // 计算PointLight的衰减\n                        float spotFallOff = 1.0 * lightDir.w;\n                        // 计算SpotLight的衰减\n                        if( lightColor.w > 1.0f )\n                        {\n                            // 计算SpotLight的范围衰减\n                            spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                        }\n\n                        ComputeDirectLighting(normal, viewDir, lightDir.xyz, lightColor.rgb, _diffuseColor.rgb, fZero, _roughness, ndotv, directLighting);\n                        Context.OutColor.rgb += directLighting * spotFallOff;\n                    }\n                }\n                else{\n                    lightColor = Context.WLight_Data_0;\n                    lightData1 = Context.WLight_Data_1;\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n\n                    // 计算PointLight的衰减\n                    float spotFallOff = 1.0 * lightDir.w;\n                    // 计算SpotLight的衰减\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLight_Data_2, lightDir.xyz );\n                    }\n\n                    ComputeDirectLighting(normal, viewDir, lightDir.xyz, lightColor.rgb, _diffuseColor.rgb, fZero, _roughness, ndotv, directLighting);\n                    Context.OutColor.rgb += directLighting * spotFallOff;\n                }\n\n                if(Context.BlendGiProbes){\n                    #ifdef Context.GIProbes\n                        // 作为webGL项目,暂时不实现探针混合(但作为可拓展,仍然加结尾s命名)\n\n                        // 计算反射视线\n                        vec3 _rv = reflect( -viewDir.xyz, normal.xyz );\n                        float _r = fract( Context.WGIProbe.w );\n                        float _mipMaps = Context.WGIProbe.w - _r;\n                        _rv = _r * ( wPosition.xyz - Context.WGIProbe.xyz ) + _rv;\n\n                        // 使用球谐计算diffuse( 避免Irr采样 )\n                        vec3 giLighting = sphericalHarmonics(normal.xyz, Context.ShCoeffs) * _diffuseColor.rgb;\n\n                        float horiz = dot(_rv, wNormal);\n                        float horizFadePower = 1.0f - _roughness;\n                        horiz = clamp( 1.0f + horizFadePower * horiz, 0.0f, 1.0f );\n                        horiz *= horiz;\n\n                        vec3 _dominantR = getSpecularDominantDir( normal, _rv.xyz, _roughness * _roughness );\n                        giLighting += approximateSpecularIBLPolynomial(Context.InPrefEnvMap, _specularColor.rgb, _roughness, ndotv, _dominantR, _mipMaps) * vec3( horiz );\n                        giLighting *= ao;\n\n                        Context.OutColor.rgb += giLighting * step( 0.0f, Context.WGIProbe.w );\n                        // Context.OutColor.rgb = textureLod(Context.InPrefEnvMap, normal.xyz, 0.0f).rgb;\n                    #endif\n                }\n\n                Context.OutColor.a = buff0.a;\n            }\n        }\n    }\n    SubTechnology GlobalPass{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram TilePassIBLLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                #ifdef Context.Srgb\n                    lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                    lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n                #else\n                    // 对于DirLight,lightDir.w = 1.0f\n                    lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n                #endif\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            #define PI 3.14159265358979323846264\n            // 镜面反射菲涅尔计算\n            vec3 F_Shlick(float vh,\tvec3 F0){\n                float fresnelFact = pow(2.0f, (-5.55473f * vh - 6.98316f) * vh);\n                return mix(F0, vec3(1.0f, 1.0f, 1.0f), fresnelFact);\n            }\n            vec3 F_Schlick2(float cosTheta, vec3 F0)\n            {\n                return F0 + (1.0f - F0) * pow(1.0f - cosTheta, 5.0f);\n            }\n            // 计算直接光照\n            void ComputeDirectLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 diffuseColor, in vec3 fZero, in float roughness, in float ndotv, out vec3 directLighting){\n                vec3 h = normalize(lightDir + viewDir);\n                float ndotl = max( dot( normal, lightDir ), 0.0f );\n                float ndoth = max( dot( normal, h), 0.0f );\n                float hdotv = max( dot( h, viewDir ), 0.0f );\n\n                // 这里,不使用c/Π计算diffuse fr(x, wi, wo)\n                // 而假设恒定\n                vec3 diffuse = vec3( ndotl ) * lightColor * diffuseColor;\n\n                // cook-torrence,BRDF : http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf\n                float alpha = roughness * roughness;\n\n                // D, GGX 法线分布函数\n                float alpha2 = alpha * alpha;\n                float sum = (( ndoth * ndoth ) * ( alpha2 - 1.0f ) + 1.0f);\n                float denom = PI * sum * sum;\n                float D = alpha2 / denom;\n\n                // F, 菲涅尔项\n                vec3 F = F_Shlick( hdotv, fZero );\n\n                // G, 几何遮挡项\n                float k = alpha * 0.5f;\n                float G_V = ndotv + sqrt( ( ndotv - ndotv * k ) * ndotv + k );\n                float G_L = ndotl + sqrt( ( ndotl - ndotl * k ) * ndotl + k );\n                float G = 1.0f / max( G_V * G_L ,0.01f );\n\n                // specularBRDF\n                float t = D * G * ndotl;\n                vec3 specular =  vec3( t ) * F * lightColor;\n\n                directLighting = diffuse + specular;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            // 球谐函数\n            vec3 sphericalHarmonics( const in vec3 normal, const vec3 sph[9] ){\n                float x = normal.x;\n                float y = normal.y;\n                float z = normal.z;\n\n                vec3 result = (\n                    sph[0] +\n\n                    sph[1] * y +\n                    sph[2] * z +\n                    sph[3] * x +\n\n                    sph[4] * y * x +\n                    sph[5] * y * z +\n                    sph[6] * (3.0f * z * z - 1.0f) +\n                    sph[7] * (z * x) +\n                    sph[8] * (x*x - y*y)\n                );\n\n                return max(result, vec3(0.0f));\n            }\n            // 镜面反射趋势朝向\n            vec3 getSpecularDominantDir(const in vec3 N, const in vec3 R, const in float realRoughness){\n\n                float smoothness = 1.0f - realRoughness;\n                float lerpFactor = smoothness * (sqrt(smoothness) + realRoughness);\n                // 当我们在立方体贴图中获取时，结果未规范化\n                vec3 dominant = mix(N, R, lerpFactor);\n\n                return dominant;\n            }\n            // 拟合方程\n            // 关于镜面部分，有很多优化地方，除了常见的优化，还有很多可以替代方案，几乎可以在保证画质的前提下，在移动端35帧率提升到60帧率，详细可参考我的笔记:https://www.cnblogs.com/JhonKkk/p/14313882.html\n            vec3 integrateBRDFApprox( const in vec3 specular, in float roughness, in float NoV ){\n                const vec4 c0 = vec4( -1.0f, -0.0275f, -0.572f, 0.022f );\n                const vec4 c1 = vec4( 1.0f, 0.0425f, 1.04f, -0.04f );\n                vec4 r = roughness * c0 + c1;\n                float a004 = min( r.x * r.x, exp2( -9.28f * NoV ) ) * r.x + r.y;\n                vec2 ab = vec2( -1.04f, 1.04f ) * a004 + r.zw;\n                return specular * ab.x + ab.y;\n            }\n            // 近似镜面IBL多项式\n            vec3 approximateSpecularIBLPolynomial(in samplerCube envMap, in vec3 specularColor , in float roughness, in float ndotv, in vec3 refVec, in float mipMaps){\n                float lod = sqrt( roughness ) * (mipMaps - 1.0f);\n                vec3 prefilteredColor = textureLod(envMap, refVec.xyz, lod).rgb;\n                return prefilteredColor * integrateBRDFApprox(specularColor, roughness, ndotv);\n            }\n            #define GAMMA 2.2f\n            #define GAMMA_T 1.0f / GAMMA\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 buff0 = texture(Context.InGBuffer0, uv0);\n                vec4 buff2 = texture(Context.InGBuffer2, uv0);\n                vec3 _diffuseColor = floor(buff0.rgb) * 0.01f * Context.AmbientLightColor;\n                vec3 _specularColor = floor(buff2.rgb) * 0.01f;\n                vec3 ao = min(fract(buff0.rgb) * 10.0f, vec3(1.0f));\n                vec3 fZero = min(fract(buff2.rgb) * 10.0f, vec3(0.5f));\n                float _roughness = floor(buff2.w) * 0.01f;\n                vec3 n = texture(Context.InGBuffer1, uv0).xyz;\n                vec3 normal = normalize(floor(n) * 0.001f);\n                vec3 wNormal = normalize(fract(n) * 1000.0f);\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec3 directLighting = vec3(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                float ndotv = max( dot( normal, viewDir ), 0.0f );\n                for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                    lightColor = Context.WLightData[i];\n                    lightData1 = Context.WLightData[i + 1];\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n\n                    // 计算PointLight的衰减\n                    float spotFallOff = 1.0 * lightDir.w;\n                    // 计算SpotLight的衰减\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                    }\n\n                    ComputeDirectLighting(normal, viewDir, lightDir.xyz, lightColor.rgb, _diffuseColor.rgb, fZero, _roughness, ndotv, directLighting);\n                    Context.OutColor.rgb += directLighting * spotFallOff;\n                }\n\n                if(Context.BlendGiProbes){\n                    #ifdef Context.GIProbes\n                        // 作为webGL项目,暂时不实现探针混合(但作为可拓展,仍然加结尾s命名)\n\n                        // 计算反射视线\n                        vec3 _rv = reflect( -viewDir.xyz, normal.xyz );\n                        float _r = fract( Context.WGIProbe.w );\n                        float _mipMaps = Context.WGIProbe.w - _r;\n                        _rv = _r * ( wPosition.xyz - Context.WGIProbe.xyz ) + _rv;\n\n                        // 使用球谐计算diffuse( 避免Irr采样 )\n                        vec3 giLighting = sphericalHarmonics(normal.xyz, Context.ShCoeffs) * _diffuseColor.rgb;\n\n                        float horiz = dot(_rv, wNormal);\n                        float horizFadePower = 1.0f - _roughness;\n                        horiz = clamp( 1.0f + horizFadePower * horiz, 0.0f, 1.0f );\n                        horiz *= horiz;\n\n                        vec3 _dominantR = getSpecularDominantDir( normal, _rv.xyz, _roughness * _roughness );\n                        giLighting += approximateSpecularIBLPolynomial(Context.InPrefEnvMap, _specularColor.rgb, _roughness, ndotv, _dominantR, _mipMaps) * vec3( horiz );\n                        giLighting *= ao;\n\n                        Context.OutColor.rgb += giLighting * step( 0.0f, Context.WGIProbe.w );\n                        // Context.OutColor.rgb = textureLod(Context.InPrefEnvMap, normal.xyz, 0.0f).rgb;\n                    #endif\n                }\n                Context.OutColor.a = buff0.a;\n            }\n        }\n    }\n    SubTechnology TilePass{\n        Vars{\n            vec4 wordPosition;\n            vec2 uv0;\n            mat4 pvInverse;\n        }\n        Advanced{\n            RenderProgram TilePassIBLLighting;\n        }\n        Vs_Shader{\n            void main(){\n                Context.OutPosition = vec4(Context.InPosition, 1.0f);\n                wordPosition = Context.OutPosition;\n                uv0 = Context.InUv0;\n                pvInverse = inverse(Context.ProjectViewMatrix);\n            }\n        }\n        Fs_Shader{\n            vec3 getPosition(in float depth, in vec2 newTexCoord){\n\n                vec4 pos;\n                pos.xy = (newTexCoord * vec2(2.0)) - vec2(1.0);\n                pos.z  = depth * 2.0 - 1.0;\n                pos.w  = 1.0;\n                pos    = pvInverse * pos;\n                pos.xyz /= pos.w;\n                return pos.xyz;\n            }\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                #ifdef Context.Srgb\n                    lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                    lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n                #else\n                    // 对于DirLight,lightDir.w = 1.0f\n                    lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n                #endif\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            #define PI 3.14159265358979323846264\n            // 镜面反射菲涅尔计算\n            vec3 F_Shlick(float vh,\tvec3 F0){\n                float fresnelFact = pow(2.0f, (-5.55473f * vh - 6.98316f) * vh);\n                return mix(F0, vec3(1.0f, 1.0f, 1.0f), fresnelFact);\n            }\n            vec3 F_Schlick2(float cosTheta, vec3 F0)\n            {\n                return F0 + (1.0f - F0) * pow(1.0f - cosTheta, 5.0f);\n            }\n            // 计算直接光照\n            void ComputeDirectLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 diffuseColor, in vec3 fZero, in float roughness, in float ndotv, out vec3 directLighting){\n                vec3 h = normalize(lightDir + viewDir);\n                float ndotl = max( dot( normal, lightDir ), 0.0f );\n                float ndoth = max( dot( normal, h), 0.0f );\n                float hdotv = max( dot( h, viewDir ), 0.0f );\n\n                // 这里,不使用c/Π计算diffuse fr(x, wi, wo)\n                // 而假设恒定\n                vec3 diffuse = vec3( ndotl ) * lightColor * diffuseColor;\n\n                // cook-torrence,BRDF : http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf\n                float alpha = roughness * roughness;\n\n                // D, GGX 法线分布函数\n                float alpha2 = alpha * alpha;\n                float sum = (( ndoth * ndoth ) * ( alpha2 - 1.0f ) + 1.0f);\n                float denom = PI * sum * sum;\n                float D = alpha2 / denom;\n\n                // F, 菲涅尔项\n                vec3 F = F_Shlick( hdotv, fZero );\n\n                // G, 几何遮挡项\n                float k = alpha * 0.5f;\n                float G_V = ndotv + sqrt( ( ndotv - ndotv * k ) * ndotv + k );\n                float G_L = ndotl + sqrt( ( ndotl - ndotl * k ) * ndotl + k );\n                float G = 1.0f / max( G_V * G_L ,0.01f );\n\n                // specularBRDF\n                float t = D * G * ndotl;\n                vec3 specular =  vec3( t ) * F * lightColor;\n\n                directLighting = diffuse + specular;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            // 球谐函数\n            vec3 sphericalHarmonics( const in vec3 normal, const vec3 sph[9] ){\n                float x = normal.x;\n                float y = normal.y;\n                float z = normal.z;\n\n                vec3 result = (\n                    sph[0] +\n\n                    sph[1] * y +\n                    sph[2] * z +\n                    sph[3] * x +\n\n                    sph[4] * y * x +\n                    sph[5] * y * z +\n                    sph[6] * (3.0f * z * z - 1.0f) +\n                    sph[7] * (z * x) +\n                    sph[8] * (x*x - y*y)\n                );\n\n                return max(result, vec3(0.0f));\n            }\n            // 镜面反射趋势朝向\n            vec3 getSpecularDominantDir(const in vec3 N, const in vec3 R, const in float realRoughness){\n\n                float smoothness = 1.0f - realRoughness;\n                float lerpFactor = smoothness * (sqrt(smoothness) + realRoughness);\n                // 当我们在立方体贴图中获取时，结果未规范化\n                vec3 dominant = mix(N, R, lerpFactor);\n\n                return dominant;\n            }\n            // 拟合方程\n            // 关于镜面部分，有很多优化地方，除了常见的优化，还有很多可以替代方案，几乎可以在保证画质的前提下，在移动端35帧率提升到60帧率，详细可参考我的笔记:https://www.cnblogs.com/JhonKkk/p/14313882.html\n            vec3 integrateBRDFApprox( const in vec3 specular, in float roughness, in float NoV ){\n                const vec4 c0 = vec4( -1.0f, -0.0275f, -0.572f, 0.022f );\n                const vec4 c1 = vec4( 1.0f, 0.0425f, 1.04f, -0.04f );\n                vec4 r = roughness * c0 + c1;\n                float a004 = min( r.x * r.x, exp2( -9.28f * NoV ) ) * r.x + r.y;\n                vec2 ab = vec2( -1.04f, 1.04f ) * a004 + r.zw;\n                return specular * ab.x + ab.y;\n            }\n            // 近似镜面IBL多项式\n            vec3 approximateSpecularIBLPolynomial(in samplerCube envMap, in vec3 specularColor , in float roughness, in float ndotv, in vec3 refVec, in float mipMaps){\n                float lod = sqrt( roughness ) * (mipMaps - 1.0f);\n                vec3 prefilteredColor = textureLod(envMap, refVec.xyz, lod).rgb;\n                return prefilteredColor * integrateBRDFApprox(specularColor, roughness, ndotv);\n            }\n            #define GAMMA 2.2f\n            #define GAMMA_T 1.0f / GAMMA\n            void main(){\n                float depth = texture(Context.InGDepth, uv0).r;\n                if(depth >= 1.0){\n                    Context.OutColor = vec4(0.0f, 0.0f, 0.0f, 1.0f);\n                    return;\n                }\n                vec3 wPosition = getPosition(depth, uv0);\n                vec4 buff0 = texture(Context.InGBuffer0, uv0);\n                vec4 buff2 = texture(Context.InGBuffer2, uv0);\n                vec3 _diffuseColor = floor(buff0.rgb) * 0.01f * Context.AmbientLightColor;\n                vec3 _specularColor = floor(buff2.rgb) * 0.01f;\n                vec3 ao = min(fract(buff0.rgb) * 10.0f, vec3(1.0f));\n                vec3 fZero = min(fract(buff2.rgb) * 10.0f, vec3(0.5f));\n                float _roughness = floor(buff2.w) * 0.01f;\n                vec3 n = texture(Context.InGBuffer1, uv0).xyz;\n                vec3 normal = normalize(floor(n) * 0.001f);\n                vec3 wNormal = normalize(fract(n) * 1000.0f);\n                // 计算光照\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec3 directLighting = vec3(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                Context.OutColor.rgb = vec3(0.0f);\n                // Tile Based Shading\n                // 获取tile信息\n                vec3 tile = texture(Context.InTileLightDecode, uv0).xyz;\n                int uoffset = int(tile.x);\n                int voffset = int(tile.z);\n                int count = int(tile.y);\n                if(count > 0){\n                    int lightId;\n                    float temp;\n                    int offset;\n                    // lightIndex采样范围规范化单位\n                    float uvSize = 1.0f / (Context.TileLightOffsetSize - 1.0f);\n                    vec2 lightUV;\n                    // lightData采样范围规范单位\n                    float lightUVSize = 1.0f / (float(Context.TileLightNum) - 1.0f);\n                    vec2 lightDataUV;\n                    for(int i = 0;i < count;i++){\n                        temp = float(uoffset + i);\n                        offset = 0;\n\n                        if(temp >= Context.TileLightOffsetSize){\n                            temp -= Context.TileLightOffsetSize;\n                            offset++;\n                        }\n                        if(temp == Context.TileLightOffsetSize){\n                            temp = 0.0f;\n                        }\n\n                        // lightIndexUV\n                        lightUV = vec2(temp * uvSize, float(voffset + offset) * uvSize);\n                        lightId = int(texture(Context.InTileLightIndex, lightUV).x);\n\n                        // 光源信息\n                        lightDataUV = vec2(float(lightId) * lightUVSize);\n                        lightColor = texture(Context.InTileWLightData0, lightDataUV);\n                        lightData1 = texture(Context.InTileWLightData1, lightDataUV);\n\n                        float ndotv = max( dot( normal, viewDir ), 0.0f );\n                        ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n\n                        // 计算PointLight的衰减\n                        float spotFallOff = 1.0 * lightDir.w;\n                        // 计算SpotLight的衰减\n                        if( lightColor.w > 1.0f )\n                        {\n                            // 计算SpotLight的范围衰减\n                            spotFallOff = ComputeSpotFalloff( texture(Context.InTileWLightData2, lightDataUV), lightDir.xyz );\n                        }\n\n                        ComputeDirectLighting(normal, viewDir, lightDir.xyz, lightColor.rgb, _diffuseColor.rgb, fZero, _roughness, ndotv, directLighting);\n                        Context.OutColor.rgb += directLighting * spotFallOff;\n                    }\n                }\n                Context.OutColor.a = buff0.a;\n            }\n        }\n    }\n    Technology{\n        Sub_Pass DeferredShading{\n            Pass GBufferPass{\n            }\n            Pass DeferredShadingPass{\n            }\n        }\n    }\n    Technology MultiPassDeferred{\n        Sub_Pass DeferredShading{\n            Pass GBufferPass{\n            }\n            Pass DeferredShadingPass2{\n            }\n        }\n    }\n    Technology TileDeferred{\n        Sub_Pass TileDeferredShading{\n            Pass GBufferPass{\n            }\n            Pass GlobalPass{\n            }\n            Pass TilePass{\n            }\n        }\n    }\n}\n"),n(r,"S_PRINCIPLED_LIGHTING_DEF","// 原理化光照材质定义\nDef PrincipledLightingDef{\n    Params{\n        // 基础参数\n        vec4 baseColor;\n        sampler2D baseColorMap;\n        sampler2D normalMap;\n\n        // lightMap或AO\n        sampler2D lightMap;\n        bool aoMap;\n        bool lightMapTexCoord;\n\n        // 自发光\n        sampler2D emissiveMap;\n        vec4 emissive;\n        float emissivePower;\n        float emissiveIntensity;\n\n        // metallic管线\n        float metallic;\n        float roughness;\n        sampler2D metallicRoughnessMap;\n        sampler2D metallicMap;\n        sampler2D roughnessMap;\n\n        // specular管线\n        bool useSpecGloss;\n        sampler2D specularGlossinessMap;\n        sampler2D specularMap;\n        sampler2D glossinessMap;\n        vec4 specular;\n        float glossiness;\n\n        // alphaDiscard\n        float alphaDiscard;\n    }\n    SubTechnology SPPrincipledLighting{\n        Vars{\n            vec3 wNormal;\n            vec4 wTangent;\n            vec3 wPosition;\n            vec2 wUv0;\n            vec2 wUv1;\n        }\n        Advanced{\n            RenderProgram SinglePassIBLLighting;\n        }\n        Vs_Shader{\n            void main(){\n                #ifdef Context.Skins\n                    mat4 skinMat =\n                            Context.InWeight0.x * Context.Joints[int(Context.InJoint0.x)] +\n                            Context.InWeight0.y * Context.Joints[int(Context.InJoint0.y)] +\n                            Context.InWeight0.z * Context.Joints[int(Context.InJoint0.z)] +\n                            Context.InWeight0.w * Context.Joints[int(Context.InJoint0.w)];\n                    // vec4 pos = Context.ModelMatrix * skinMat * vec4(Context.InPosition, 1.0f);\n                    vec4 pos = skinMat * vec4(Context.InPosition, 1.0f);\n                #else\n                    vec4 pos = Context.ModelMatrix * vec4(Context.InPosition, 1.0f);\n                #endif\n\n\n                wPosition = (Context.ModelMatrix * vec4(Context.InPosition, 1.0f)).xyz;\n                mat3 nMat = mat3(transpose(inverse(Context.ModelMatrix)));\n                vec3 norm = normalize(nMat * Context.InNormal);\n                //vec3 t = normalize(nMat * Context.InTangent);\n                wTangent = vec4(normalize(nMat * Context.InTangent.xyz), Context.InTangent.w);\n                //t = normalize(t - dot(t, norm) * norm);\n                //vec3 b = cross(norm, t);\n                //tbnMat = mat3(t, b, norm);\n                wNormal = norm;\n                wUv0 = Context.InUv0;\n                #ifdef Params.lightMapTexCoord\n                    wUv1 = Context.InUv1;\n                #endif\n\n\n                Context.OutPosition = Context.ProjectViewMatrix * pos;\n            }\n        }\n\n        Fs_Shader{\n            // 计算光照方向\n            // 对于DirLight,PointLight以及SpotLight,lightType依次为0.0,1.0,2.0\n            // 输出光照方向\n            // lightDir.w存储衰减率(对于DirLight,衰减值一直为1,对于Point或Spot,衰减值随着半径而变小,衰减值越小,表示衰减度越大)\n            void ComputeLightDir(in vec3 worldPos, in float lightType, in vec4 position, out vec4 lightDir, out vec3 lightVec){\n                // 只有lightType = 0.0时,posLight为0.0,否则posLight为1.0\n                float posLight = step(0.5f, lightType);\n\n                // 计算光照位置\n                // 对于DirLight,lightVec = position.xyz * sign(-0.5f) = position.xyz * -1.0f;其中position代表DirLight的方向\n                // 对于PointLight和SpotLight,lightVec = position.xyz * sign(1.0f - 0.5f) - (worldPos * 1.0f) = positions.xyz * 1.0f - worldPos;其中position代表Light的位置\n                lightVec = position.xyz * sign(posLight - 0.5f) - (worldPos * posLight);\n                float dist = length(lightVec);\n\n                #ifdef Context.Srgb\n                    lightDir.w = (1.0f - position.w * dist) / (1.0f + position.w * dist * dist);\n                    lightDir.w = clamp(lightDir.w, 1.0f - posLight, 1.0f);\n                #else\n                    // 对于DirLight,lightDir.w = 1.0f\n                    lightDir.w = clamp(1.0f - position.w * dist * posLight, 0.0f, 1.0f);\n                #endif\n\n                // 归一化\n                lightDir.xyz = lightVec / vec3(dist);\n            }\n            #define PI 3.14159265358979323846264\n            // 镜面反射菲涅尔计算\n            vec3 F_Shlick(float vh,\tvec3 F0){\n            \tfloat fresnelFact = pow(2.0f, (-5.55473f * vh - 6.98316f) * vh);\n            \treturn mix(F0, vec3(1.0f, 1.0f, 1.0f), fresnelFact);\n            }\n            vec3 F_Schlick2(float cosTheta, vec3 F0)\n            {\n                return F0 + (1.0f - F0) * pow(1.0f - cosTheta, 5.0f);\n            }\n            // 计算直接光照\n            void ComputeDirectLighting(in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 diffuseColor, in vec3 fZero, in float roughness, in float ndotv, out vec3 directLighting){\n                vec3 h = normalize(lightDir + viewDir);\n                float ndotl = max( dot( normal, lightDir ), 0.0f );\n                float ndoth = max( dot( normal, h), 0.0f );\n                float hdotv = max( dot( h, viewDir ), 0.0f );\n\n                // 这里,不使用c/Π计算diffuse fr(x, wi, wo)\n                // 而假设恒定\n                vec3 diffuse = vec3( ndotl ) * lightColor * diffuseColor;\n\n                // cook-torrence,BRDF : http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf\n                float alpha = roughness * roughness;\n\n                // D, GGX 法线分布函数\n                float alpha2 = alpha * alpha;\n                float sum = (( ndoth * ndoth ) * ( alpha2 - 1.0f ) + 1.0f);\n                float denom = PI * sum * sum;\n                float D = alpha2 / denom;\n\n                // F, 菲涅尔项\n                vec3 F = F_Shlick( hdotv, fZero );\n\n                // G, 几何遮挡项\n                float k = alpha * 0.5f;\n                float G_V = ndotv + sqrt( ( ndotv - ndotv * k ) * ndotv + k );\n                float G_L = ndotl + sqrt( ( ndotl - ndotl * k ) * ndotl + k );\n                float G = 1.0f / max( G_V * G_L ,0.01f );\n\n                // specularBRDF\n                float t = D * G * ndotl;\n                vec3 specular =  vec3( t ) * F * lightColor;\n\n                directLighting = diffuse + specular;\n            }\n            // 返回Spot范围衰减\n            float ComputeSpotFalloff(in vec4 spotDirection, in vec3 lightDir){\n                float curAngleCos = dot(lightDir, -spotDirection.xyz);\n                float innerAngleCos = floor(spotDirection.w) * 0.001f;\n                float outerAngleCos = fract(spotDirection.w);\n                float innerMinusOuter = innerAngleCos - outerAngleCos;\n\n                #ifndef Context.Srgb\n                    // 使用二次衰减（请注意^ 4）\n                    return pow(clamp((curAngleCos - outerAngleCos) / innerMinusOuter, 0.0f, 1.0f), 4.0f);\n                #else\n                    // 线性空间衰减\n                    return clamp((curAngleCos - outerAngleCos) / innerMinusOuter, step(spotDirection.w, 0.001f), 1.0f);\n                #endif\n            }\n            // 球谐函数\n            vec3 sphericalHarmonics( const in vec3 normal, const vec3 sph[9] ){\n                float x = normal.x;\n                float y = normal.y;\n                float z = normal.z;\n\n                vec3 result = (\n                    sph[0] +\n\n                    sph[1] * y +\n                    sph[2] * z +\n                    sph[3] * x +\n\n                    sph[4] * y * x +\n                    sph[5] * y * z +\n                    sph[6] * (3.0f * z * z - 1.0f) +\n                    sph[7] * (z * x) +\n                    sph[8] * (x*x - y*y)\n                );\n\n                return max(result, vec3(0.0f));\n            }\n            // 镜面反射趋势朝向\n            vec3 getSpecularDominantDir(const in vec3 N, const in vec3 R, const in float realRoughness){\n\n                float smoothness = 1.0f - realRoughness;\n                float lerpFactor = smoothness * (sqrt(smoothness) + realRoughness);\n                // 当我们在立方体贴图中获取时，结果未规范化\n                vec3 dominant = mix(N, R, lerpFactor);\n\n                return dominant;\n            }\n            // 拟合方程\n            // 关于镜面部分，有很多优化地方，除了常见的优化，还有很多可以替代方案，几乎可以在保证画质的前提下，在移动端35帧率提升到60帧率，详细可参考我的笔记:https://www.cnblogs.com/JhonKkk/p/14313882.html\n            vec3 integrateBRDFApprox( const in vec3 specular, in float roughness, in float NoV ){\n                const vec4 c0 = vec4( -1.0f, -0.0275f, -0.572f, 0.022f );\n                const vec4 c1 = vec4( 1.0f, 0.0425f, 1.04f, -0.04f );\n                vec4 r = roughness * c0 + c1;\n                float a004 = min( r.x * r.x, exp2( -9.28f * NoV ) ) * r.x + r.y;\n                vec2 ab = vec2( -1.04f, 1.04f ) * a004 + r.zw;\n                return specular * ab.x + ab.y;\n            }\n            // 近似镜面IBL多项式\n            vec3 approximateSpecularIBLPolynomial(in samplerCube envMap, in vec3 specularColor , in float roughness, in float ndotv, in vec3 refVec, in float mipMaps){\n                float lod = sqrt( roughness ) * (mipMaps - 1.0f);\n                vec3 prefilteredColor = textureLod(envMap, refVec.xyz, lod).rgb;\n                return prefilteredColor * integrateBRDFApprox(specularColor, roughness, ndotv);\n            }\n            #define GAMMA 2.2f\n            #define GAMMA_T 1.0f / GAMMA\n            void main(){\n                vec4 lightColor;\n                vec4 lightData1;\n                vec4 lightDir = vec4(0.0f);\n                vec3 lightVec = vec3(0.0f);\n                vec3 directLighting = vec3(0.0f);\n                vec3 viewDir = normalize(Context.CameraPosition.xyz - wPosition.xyz);\n\n                #ifdef Params.baseColor\n                    #ifdef Params.baseColorMap\n                        vec4 albedo = texture(Params.baseColorMap, wUv0) * Params.baseColor * vec4(Context.AmbientLightColor, 1.0);\n                    #else\n                        vec4 albedo = Params.baseColor * vec4(Context.AmbientLightColor, 1.0);\n                    #endif\n                #else\n                    #ifdef Params.baseColorMap\n                        vec4 albedo = texture(Params.baseColorMap, wUv0) * vec4(Context.AmbientLightColor, 1.0);\n                    #else\n                        vec4 albedo = vec4(1.0f) * vec4(Context.AmbientLightColor, 1.0);\n                    #endif\n                #endif\n\n                #ifdef Params.alphaDiscard\n                    if(albedo.a < Params.alphaDiscard){\n                        discard;\n                    }\n                #endif\n\n                vec3 normal = wNormal;\n                #ifdef Params.normalMap\n                    // 这里做了一种简化,理论上应该在fs阶段计算tbn,但是从插值的角度来看,可以简化为tbn插值,减少在fs阶段计算tbn开销(虽然这么做不精确,但是折中下可以接受)\n                    vec3 normalHeight = texture(Params.normalMap, wUv0).xyz;\n                    vec3 tangent = normalize(wTangent.xyz);\n                    mat3 tbnMat = mat3(tangent, wTangent.w * cross(normal, tangent), normal);\n                    normal = normalize(tbnMat * ( normalHeight * 2.0f - 1.0f ));\n                #endif\n\n                #ifdef Params.metallicRoughnessMap\n                    vec2 rm = texture(Params.metallicRoughnessMap, wUv0).gb;\n                    #ifdef Params.roughness\n                        float _roughness = rm.x * max(Params.roughness, 1e-4);\n                    #else\n                        float _roughness = rm.x;\n                    #endif\n                    #ifdef Params.metallic\n                        float _metallic = rm.y * max(Params.metallic, 0.0f);\n                    #else\n                        float _metallic = rm.y;\n                    #endif\n                #else\n                    #ifdef Params.roughnessMap\n                        #ifdef Params.roughness\n                            float _roughness = texture(Params.roughnessMap, wUv0).r * max(Params.roughness, 1e-4);\n                        #else\n                            float _roughness = texture(Params.roughnessMap, wUv0).r;\n                        #endif\n                    #else\n                        #ifdef Params.roughness\n                            float _roughness = max(Params.roughness, 1e-4);\n                        #else\n                            float _roughness = 1.0f;\n                        #endif\n                    #endif\n                    #ifdef Params.metallicMap\n                        #ifdef Params.metallic\n                            float _metallic = texture(Params.metallicMap, wUv0).r * max(Params.metallic, 0.0f);\n                        #else\n                            float _metallic = texture(Params.metallicMap, wUv0).r;\n                        #endif\n                    #else\n                        #ifdef Params.metallic\n                            float _metallic = max(Params.metallic, 0.0f);\n                        #else\n                            float _metallic = 1.0f;\n                        #endif\n                    #endif\n                #endif\n\n                #ifdef Params.useSpecGloss\n                    #ifdef Params.specularGlossinessMap\n                        vec4 _specularColor = texture(Params.specularGlossinessMap, wUv0);\n                        #ifdef Params.glossiness\n                            float _glossiness = _specularColor.a * Params.glossiness;\n                        #else\n                            float _glossiness = _specularColor.a;\n                        #endif\n                        #ifdef Params.specular\n                            _specularColor *= Params.specular;\n                        #endif\n                    #else\n                        #ifdef Params.specularMap\n                            vec4 _specularColor = texture(Params.specularMap, wUv0);\n                        #else\n                            vec4 _specularColor = vec4(1.0f);\n                        #endif\n                        #ifdef Params.specular\n                            _specularColor *= Params.specular;\n                        #endif\n                        #ifdef Params.glossinessMap\n                            #ifdef Params.glossiness\n                                float _glossiness = texture(Params.glossinessMap, wUv0).r * Params.glossiness;\n                            #else\n                                float _glossiness = texture(Params.glossinessMap, wUv0).r;\n                            #endif\n                        #else\n                            #ifdef Params.glossiness\n                                float _glossiness = Params.glossiness;\n                            #else\n                                float _glossiness = 1.0f;\n                            #endif\n                        #endif\n                    #endif\n                    vec4 _diffuseColor = albedo;\n                    _roughness = 1.0f - _glossiness;\n                    vec3 fZero = _specularColor.rgb;\n                #else\n                    float nonMetalSpec = 0.04f;\n                    vec4 _specularColor = (nonMetalSpec - nonMetalSpec * _metallic) + albedo * _metallic;\n                    vec4 _diffuseColor = albedo - albedo * _metallic;\n                    vec3 fZero = vec3( 0.5f );\n                #endif\n\n                #ifdef Params.lightMap\n                    vec3 _lightMapColor;\n                    #ifdef Params.lightMapTexCoord\n                        _lightMapColor = texture(Params.lightMap, wUv1).rgb;\n                    #else\n                        _lightMapColor = texture(Params.lightMap, wUv0).rgb;\n                    #endif\n                    #ifdef Params.aoMap\n                        _lightMapColor.gb = _lightMapColor.rr;\n                        vec3 ao = _lightMapColor;\n                    #else\n                        _specularColor.rgb *= _lightMapColor;\n                        _diffuseColor.rgb  *= _lightMapColor;\n                        vec3 ao = vec3(1.0f);\n                    #endif\n                #else\n                    vec3 ao = vec3(1.0f);\n                #endif\n\n                float ndotv = max( dot( normal, viewDir ), 0.0f );\n                for( int i = 0;i < Context.CurLightCount;i+=3 ){\n                    lightColor = Context.WLightData[i];\n                    lightData1 = Context.WLightData[i + 1];\n                    ComputeLightDir(wPosition, lightColor.w, lightData1, lightDir, lightVec);\n\n                    // 计算PointLight的衰减\n                    float spotFallOff = 1.0 * lightDir.w;\n                    // 计算SpotLight的衰减\n                    if( lightColor.w > 1.0f )\n                    {\n                        // 计算SpotLight的范围衰减\n                        spotFallOff = ComputeSpotFalloff( Context.WLightData[i + 2], lightDir.xyz );\n                    }\n\n                    ComputeDirectLighting(normal, viewDir, lightDir.xyz, lightColor.rgb, _diffuseColor.rgb, fZero, _roughness, ndotv, directLighting);\n                    Context.OutColor.rgb += directLighting * spotFallOff;\n                }\n\n                if(Context.BlendGiProbes){\n                    #ifdef Context.GIProbes\n                        // 作为webGL项目,暂时不实现探针混合(但作为可拓展,仍然加结尾s命名)\n\n                        // 计算反射视线\n                        vec3 _rv = reflect( -viewDir.xyz, normal.xyz );\n                        float _r = fract( Context.WGIProbe.w );\n                        float _mipMaps = Context.WGIProbe.w - _r;\n                        _rv = _r * ( wPosition.xyz - Context.WGIProbe.xyz ) + _rv;\n\n                        // 使用球谐计算diffuse( 避免Irr采样 )\n                        vec3 giLighting = sphericalHarmonics(normal.xyz, Context.ShCoeffs) * _diffuseColor.rgb;\n\n                        float horiz = dot(_rv, wNormal);\n                        float horizFadePower = 1.0f - _roughness;\n                        horiz = clamp( 1.0f + horizFadePower * horiz, 0.0f, 1.0f );\n                        horiz *= horiz;\n\n                        vec3 _dominantR = getSpecularDominantDir( normal, _rv.xyz, _roughness * _roughness );\n                        giLighting += approximateSpecularIBLPolynomial(Context.InPrefEnvMap, _specularColor.rgb, _roughness, ndotv, _dominantR, _mipMaps) * vec3( horiz );\n                        giLighting *= ao;\n\n                        Context.OutColor.rgb += giLighting * step( 0.0f, Context.WGIProbe.w );\n                        // Context.OutColor.rgb = textureLod(Context.InPrefEnvMap, normal.xyz, 0.0f).rgb;\n                    #endif\n                }\n\n                #ifdef Params.emissive\n                    float _emissivePower = 3.0f;\n                    #ifdef Params.emissivePower\n                        _emissivePower = Params.emissivePower;\n                    #endif\n                    float _emissiveIntensity = 2.0f;\n                    #ifdef Params.emissiveIntensity\n                        _emissiveIntensity = Params.emissiveIntensity;\n                    #endif\n                    #ifdef Params.emissiveMap\n                        vec4 eMap = texture(Params.emissiveMap, wUv0);\n                        Context.OutColor.rgb += Params.emissive.rgb * eMap.rgb * pow(Params.emissive.a * eMap.a, _emissivePower) * _emissiveIntensity;\n                    #else\n                        Context.OutColor.rgb += Params.emissive.rgb * pow(Params.emissive.a, _emissivePower) * _emissiveIntensity;\n                    #endif\n                #else\n                    #ifdef Params.emissiveMap\n                        float _emissivePower = 3.0f;\n                        #ifdef Params.emissivePower\n                            _emissivePower = Params.emissivePower;\n                        #endif\n                        float _emissiveIntensity = 2.0f;\n                        #ifdef Params.emissiveIntensity\n                            _emisiveIntensity = Params.emissiveIntensity;\n                        #endif\n                        vec4 eMap = texture(Params.emissiveMap, wUv0);\n                        Context.OutColor.rgb += eMap.rgb * pow(eMap.a, _emissivePower) * _emissiveIntensity;\n                    #endif\n                #endif\n\n                Context.OutColor.a = albedo.a;\n\n            }\n        }\n    }\n\n    Technology{\n        Sub_Pass{\n            Pass SPPrincipledLighting{\n            }\n        }\n    }\n}\n")},512:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t){var n,r,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=null,(r="_m_Render")in(n=this)?Object.defineProperty(n,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[r]=i,this._m_Render=t.render}var t,r,i;return t=e,(r=[{key:"render",value:function(e){}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},6528:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),i.call(this,e)}return t=s,(n=[{key:"render",value:function(e){}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(870))&&i.__esModule?i:{default:i}).default);t.default=l},870:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(512)),o=_(n(8435)),a=_(n(3061));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(_,e);var t,n,r,i=l(_);function _(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_),i.call(this,e)}return t=_,(n=[{key:"render",value:function(e){var t=this,n=e.frameContext,r=e.gl,i=e.scene,s=e.lights,u=!1,l=null,f=!1,c=null,m=!1,h=function(o){n.getRenderState().store();var s=null;e.bucket[o].forEach((function(e){u=!1;var m=i.getComponent(o),h=m.getCurrentTechnology().getSubPasss(a.default.DEFERRED_SHADING);if(h){if(l=h.getSubShaderMaps(),s=_.S_DEFERRED_SHADING_PASS_GROUP[0],null==l[s]&&(s=_.S_DEFERRED_SHADING_PASS_GROUP_2[0]),f)n.m_LastFrameBuffer!=n.getFrameBuffer(l[s].subShader.getFBId()||a.default.DEFAULT_DEFERRED_SHADING_FRAMEBUFFER)&&console.error("使用了不同的dfb>>>");else{f=!0;var d=n.getFrameBuffer(l[s].subShader.getFBId()||a.default.DEFAULT_DEFERRED_SHADING_FRAMEBUFFER);r.bindFramebuffer(r.FRAMEBUFFER,d.getFrameBuffer()),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),n.m_LastFrameBuffer=d}l[s].renderState&&(u=t._m_Render._checkRenderState(r,l[s].renderState,n.getRenderState())),m._selectSubShader(l[s].subShader),e.draw(n),s=_.S_DEFERRED_SHADING_PASS_GROUP[1],c=l[s]?l[s]:l[_.S_DEFERRED_SHADING_PASS_GROUP_2[1]]}u&&t._checkRenderState(r,n.getRenderState().restore(),n.getRenderState())}))};for(var d in e.bucket)h(d);if(f&&c){m=!0;var p=n.m_LastFrameBuffer;r.bindFramebuffer(r.FRAMEBUFFER,n._m_DefaultFrameBuffer),n.m_LastFrameBuffer=n._m_DefaultFrameBuffer,r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),n.m_LastSubShaderId!=c.subShader.getDefId()&&(c.subShader.needCompile()&&c.subShader._compile(r,n),c.subShader.use(r),n.m_LastSubShaderId=c.subShader.getDefId()),n.m_LastSubShader!=c.subShader&&(n.m_LastSubShader=c.subShader),c.renderState&&this._m_Render._checkRenderState(r,c.renderState,n.getRenderState());var g=p.getFramePicture(),S=c.subShader.getRenderDatas();for(var v in S)r.activeTexture(r.TEXTURE0+S[v].loc),r.bindTexture(r.TEXTURE_2D,n.getFrameBuffer(S[v].refId).getTexture(S[v].dataId).getLoc());"On"==n.getRenderState().getFlag(o.default.S_STATES[3])&&r.disable(r.DEPTH_TEST),this._m_Render._m_RenderPrograms[c.subShader.getRenderProgramType()].draw(r,i,n,g,s),"On"==n.getRenderState().getFlag(o.default.S_STATES[3])&&r.enable(r.DEPTH_TEST),r.bindFramebuffer(r.READ_FRAMEBUFFER,p.getFrameBuffer()),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,n._m_DefaultFrameBuffer),r.blitFramebuffer(0,0,i.getCanvas().getWidth(),i.getCanvas().getHeight(),0,0,i.getCanvas().getWidth(),i.getCanvas().getHeight(),r.DEPTH_BUFFER_BIT,r.NEAREST),r.bindFramebuffer(r.FRAMEBUFFER,n._m_DefaultFrameBuffer)}return m}}])&&s(t.prototype,n),r&&s(t,r),_}(i.default);t.default=h,m(h,"S_DEFERRED_SHADING_G_BUFFER_PASS","GBufferPass"),m(h,"S_DEFERRED_SHADING_DEFERRED_SHADING_PASS","DeferredShadingPass"),m(h,"S_DEFERRED_SHADING_PASS_GROUP",[h.S_DEFERRED_SHADING_G_BUFFER_PASS,h.S_DEFERRED_SHADING_DEFERRED_SHADING_PASS]),m(h,"S_DEFERRED_SHADING_PASS_GROUP_2",[0,1])},5734:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(512)),o=a(n(3061));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(a,e);var t,n,r,i=u(a);function a(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),i.call(this,e)}return t=a,(n=[{key:"render",value:function(e){var t=this,n=e.frameContext,r=e.gl,i=e.scene,a=e.lights,_=!1,s=null;if(n.getRenderState().store(),e.opaque)for(var u in e.bucket){_=!1;var l=i.getComponent(u),f=l.getCurrentTechnology().getSubPasss(o.default.FORWARD);if(f)for(var c in s=f.getSubShaders())s[c].renderState&&(_=this._m_Render._checkRenderState(r,s[c].renderState,n.getRenderState())),l._selectSubShader(s[c].subShader),this._m_Render._m_RenderPrograms[s[c].subShader.getRenderProgramType()].drawArrays(r,i,n,e.bucket[u],a);_&&this._m_Render._checkRenderState(r,n.getRenderState().restore(),n.getRenderState())}else e.translucent&&e.bucket.forEach((function(e){_=!1;var u=e.getMaterial(),l=u.getCurrentTechnology().getSubPasss(o.default.FORWARD);if(l)for(var f in s=l.getSubShaders())s[f].renderState&&(_=t._checkRenderState(r,s[f].renderState,n.getRenderState())),u._selectSubShader(s[f].subShader),t._m_Render._m_RenderPrograms[s[f].subShader.getRenderProgramType()].draw(r,i,n,e,a);_&&t._m_Render._checkRenderState(r,n.restore(),n.getRenderState())}))}}])&&_(t.prototype,n),r&&_(t,r),a}(i.default);t.default=c},9526:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function a(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=s(e);if(t){var i=s(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return _(this,n)}}function _(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var u=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}(n,e);var t=a(n);function n(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),t.call(this,e)}return n}(((i=n(512))&&i.__esModule?i:{default:i}).default);t.default=u},6987:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(3061)),o=a(n(8435));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(l,e);var t,n,r,a=u(l);function l(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),(t=a.call(this,e))._init(),t}return t=l,(n=[{key:"_init",value:function(){}},{key:"render",value:function(e){var t=this,n=e.frameContext,r=e.gl,a=e.scene,_=e.lights,s=!1,u=null,f=!1,c=null,m=null,h=!1,d=function(o){n.getRenderState().store();var _=null;e.bucket[o].forEach((function(e){s=!1;var h=a.getComponent(o),d=h.getCurrentTechnology().getSubPasss(i.default.TILE_DEFERRED_SHADING);if(d){if(u=d.getSubShaderMaps(),_=l.S_TILE_DEFERRED_SHADING_PASS_GROUP[0],null==u[_]&&(_=l.S_TILE_DEFERRED_SHADING_PASS_GROUP_2[0]),f)n.m_LastFrameBuffer!=n.getFrameBuffer(u[_].subShader.getFBId()||i.default.DEFAULT_DEFERRED_SHADING_FRAMEBUFFER)&&console.error("使用了不同的dfb>>>");else{f=!0;var p=n.getFrameBuffer(u[_].subShader.getFBId()||i.default.DEFAULT_DEFERRED_SHADING_FRAMEBUFFER);r.bindFramebuffer(r.FRAMEBUFFER,p.getFrameBuffer()),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),n.m_LastFrameBuffer=p}u[_].renderState&&(s=t._m_Render._checkRenderState(r,u[_].renderState,n.getRenderState())),h._selectSubShader(u[_].subShader),e.draw(n),_=l.S_TILE_DEFERRED_SHADING_PASS_GROUP[1],c=u[_]?u[_]:u[l.S_TILE_DEFERRED_SHADING_PASS_GROUP_2[1]],_=l.S_TILE_DEFERRED_SHADING_PASS_GROUP[2],m=u[_]?u[_]:u[l.S_TILE_DEFERRED_SHADING_PASS_GROUP_2[2]]}s&&t._checkRenderState(r,n.getRenderState().restore(),n.getRenderState())}))};for(var p in e.bucket)d(p);if(f&&c&&m){h=!0;var g=n.m_LastFrameBuffer;r.bindFramebuffer(r.FRAMEBUFFER,n._m_DefaultFrameBuffer),n.m_LastFrameBuffer=n._m_DefaultFrameBuffer,r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),"On"==n.getRenderState().getFlag(o.default.S_STATES[3])&&r.disable(r.DEPTH_TEST);var S=[],v=[],y=null;_.forEach((function(e){"DirectionalLight"==(y=e.getType())?S.push(e):"PointLight"!=y&&"SpotLight"!=y||v.push(e)})),n.m_LastSubShaderId!=c.subShader.getDefId()&&(c.subShader.needCompile()&&c.subShader._compile(r,n),c.subShader.use(r),n.m_LastSubShaderId=c.subShader.getDefId()),n.m_LastSubShader!=c.subShader&&(n.m_LastSubShader=c.subShader),c.renderState&&this._m_Render._checkRenderState(r,c.renderState,n.getRenderState());var C=g.getFramePicture(),T=c.subShader.getRenderDatas();for(var b in T)r.activeTexture(r.TEXTURE0+T[b].loc),r.bindTexture(r.TEXTURE_2D,n.getFrameBuffer(T[b].refId).getTexture(T[b].dataId).getLoc());for(var P in this._m_Render._m_RenderPrograms[c.subShader.getRenderProgramType()].draw(r,a,n,C,S,0),n.m_LastSubShaderId!=m.subShader.getDefId()&&(m.subShader.needCompile()&&m.subShader._compile(r,n),m.subShader.use(r),n.m_LastSubShaderId=m.subShader.getDefId()),n.m_LastSubShader!=m.subShader&&(n.m_LastSubShader=m.subShader),m.renderState&&this._m_Render._checkRenderState(r,m.renderState,n.getRenderState()),T)r.activeTexture(r.TEXTURE0+T[P].loc),r.bindTexture(r.TEXTURE_2D,n.getFrameBuffer(T[P].refId).getTexture(T[P].dataId).getLoc());this._m_Render._m_RenderPrograms[m.subShader.getRenderProgramType()].draw(r,a,n,C,v,1),"On"==n.getRenderState().getFlag(o.default.S_STATES[3])&&r.enable(r.DEPTH_TEST),r.bindFramebuffer(r.READ_FRAMEBUFFER,g.getFrameBuffer()),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,n._m_DefaultFrameBuffer),r.blitFramebuffer(0,0,a.getCanvas().getWidth(),a.getCanvas().getHeight(),0,0,a.getCanvas().getWidth(),a.getCanvas().getHeight(),r.DEPTH_BUFFER_BIT,r.NEAREST),r.bindFramebuffer(r.FRAMEBUFFER,n._m_DefaultFrameBuffer)}return h}}])&&_(t.prototype,n),r&&_(t,r),l}(a(n(870)).default);t.default=m,c(m,"S_TILE_DEFERRED_SHADING_G_BUFFER_PASS","GBufferPass"),c(m,"S_TILE_DEFERRED_SHADING_GLOBAL_PASS","GlobalPass"),c(m,"S_TILE_DEFERRED_SHADING_TILE_PASS","TilePass"),c(m,"S_TILE_DEFERRED_SHADING_PASS_GROUP",[m.S_TILE_DEFERRED_SHADING_G_BUFFER_PASS,m.S_TILE_DEFERRED_SHADING_GLOBAL_PASS,m.S_TILE_DEFERRED_SHADING_TILE_PASS]),c(m,"S_TILE_DEFERRED_SHADING_PASS_GROUP_2",[0,1,2])},1393:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i,o,a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,i;return t=e,(r=[{key:"draw",value:function(e,t,n,r,i){r.draw(n)}},{key:"drawArrays",value:function(e,t,n,r,i){r.forEach((function(e){e.draw(n)}))}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=a,o=null,(i="PROGRAM_TYPE")in(r=a)?Object.defineProperty(r,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[i]=o},8388:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=f(n(1393)),o=f(n(8435)),a=(f(n(7539)),f(n(2475))),_=f(n(2320)),s=(f(n(3846)),f(n(9784))),u=f(n(5604)),l=f(n(7141));function f(e){return e&&e.__esModule?e:{default:e}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=g(e);if(t){var i=g(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return d(this,n)}}function d(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(f,e);var t,n,r,i=h(f);function f(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),S(p(t=i.call(this,e)),"_m_PV",null),S(p(t),"_m_Temp_Vec3",new u.default),S(p(t),"_m_Temp_Vec4",new l.default),S(p(t),"_m_Temp_Vec4_2",new l.default),S(p(t),"_m_Temp_Vec4_3",new l.default),S(p(t),"_m_Cam_Up",new l.default),S(p(t),"_m_Cam_Left",new l.default),S(p(t),"_m_Light_Left",new l.default),S(p(t),"_m_Light_Up",new l.default),S(p(t),"_m_Light_Center",new l.default),S(p(t),"_m_ViewPortWidth",-1),S(p(t),"_m_ViewPortHeight",-1),S(p(t),"_m_CamLeftCoeff",-1),S(p(t),"_m_CamTopCoeff",-1),t._m_AccumulationLights=new o.default,t._m_AccumulationLights.setFlag(o.default.S_STATES[4],"On"),t._m_AccumulationLights.setFlag(o.default.S_STATES[1],"Off"),t._m_AccumulationLights.setFlag(o.default.S_STATES[5],["SRC_ALPHA","ONE"]),t._m_ClipLights=new o.default,t._m_ClipLights.setFlag(o.default.S_STATES[6],"On"),t._m_m_LastSubShader=null,t}return t=f,(n=[{key:"_blendGIProbes",value:function(e,t,n){var r=n.m_LastSubShader.getContextVars();if(null!=r[f.S_WGIPROBE_SRC]){if(this._m_m_LastSubShader!=n.m_LastSubShader){var i=t.getGIProbes()[0],o=a.default.S_TEMP_VEC4;o.setToInXYZW(i.getPosition()._m_X,i.getPosition()._m_Y,i.getPosition()._m_Z,1/i.getRadius()+i.getPrefilterMipmap()),e.uniform4fv(r[f.S_WGIPROBE_SRC].loc,o.getBufferData(),0,4),o=i.getShCoeffsBufferData(),null!=r[f.S_SH_COEFFS_SRC]&&e.uniform3fv(r[f.S_SH_COEFFS_SRC].loc,o.getBufferData(),0,27),null!=r[f.S_PREF_ENV_MAP_SRC]&&i.getPrefilterEnvMap()._upload(e,r[f.S_PREF_ENV_MAP_SRC].loc),this._m_m_LastSubShader=n.m_LastSubShader}}else{var _=t.getGIProbes();_&&_.length>0&&n.m_LastMaterial.addDefine(s.default.S_GIPROBES_SRC,!0)}}},{key:"_lightClip",value:function(e,t,n){var r=t.getBoundingVolume(),i=r.getRadius(),o=i*this._m_CamLeftCoeff,a=i*this._m_CamTopCoeff,s=r.getCenter(this._m_Temp_Vec3);s=this._m_Temp_Vec4.setToInXYZW(s._m_X,s._m_Y,s._m_Z,1),this._m_Temp_Vec4._m_W=1,this._m_Temp_Vec4_2._m_W=1,this._m_Temp_Vec4_3._m_W=1;var u=this._m_Cam_Left.multLength(o,this._m_Temp_Vec4_2).add(s),l=this._m_Cam_Up.multLength(a,this._m_Temp_Vec4_3).add(s);_.default.multiplyMV(this._m_Light_Left,u,this._m_PV),_.default.multiplyMV(this._m_Light_Up,l,this._m_PV),_.default.multiplyMV(this._m_Light_Center,s,this._m_PV),this._m_Light_Left._m_X/=this._m_Light_Left._m_W,this._m_Light_Left._m_Y/=this._m_Light_Left._m_W,this._m_Light_Up._m_X/=this._m_Light_Up._m_W,this._m_Light_Up._m_Y/=this._m_Light_Up._m_W,this._m_Light_Center._m_X/=this._m_Light_Center._m_W,this._m_Light_Center._m_Y/=this._m_Light_Center._m_W,this._m_Light_Left._m_X=this._m_ViewPortWidth*(1+this._m_Light_Left._m_X),this._m_Light_Up._m_X=this._m_ViewPortWidth*(1+this._m_Light_Up._m_X),this._m_Light_Center._m_X=this._m_ViewPortWidth*(1+this._m_Light_Center._m_X),this._m_Light_Left._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Left._m_Y),this._m_Light_Up._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Up._m_Y),this._m_Light_Center._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Center._m_Y);var f=Math.abs(this._m_Light_Left._m_X-this._m_Light_Center._m_X),c=Math.abs(this._m_Light_Center._m_Y-this._m_Light_Up._m_Y),m=-1,h=-1;return this._m_Light_Center._m_Z<-this._m_Light_Center._m_W?(m=-this._m_Light_Center._m_X-f,h=-this._m_Light_Center._m_Y+c):(m=this._m_Light_Center._m_X-f,h=this._m_Light_Center._m_Y+c),e.scissor(m,2*this._m_ViewPortHeight-h,2*f,2*c),!0}},{key:"_uploadLights",value:function(e,t,n,r,i,o,s,u,l){var c=n.m_LastSubShader.getContextVars(),m=t.enableGIProbes();if(null!=c[f.S_MULTI_ID_SRC]&&e.uniform1i(c[f.S_MULTI_ID_SRC].loc,u),null!=c[f.S_BLEND_GI_PROBES]&&e.uniform1i(c[f.S_BLEND_GI_PROBES].loc,l&&m),0==u){if(null!=c[f.S_AMBIENT_LIGHT_COLOR])if(0==o){var h=t.AmbientLightColor;e.uniform3f(c[f.S_AMBIENT_LIGHT_COLOR].loc,h._m_X,h._m_Y,h._m_Z)}else e.uniform3f(c[f.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());m&&this._blendGIProbes(e,t,n);var d=null,p=null;null!=c[f.S_V_LIGHT_DATA]?(p=1,d=c[f.S_V_LIGHT_DATA].loc):null!=c[f.S_W_LIGHT_DATA]&&(p=0,d=c[f.S_W_LIGHT_DATA].loc);var g=i+o>r.length?r.length-o:i;if(null==d)return g+o;for(var S=null,v=null,y=a.default.S_LIGHT_DATA_4,C=y.getArray(),T=a.default.S_TEMP_VEC4,b=a.default.S_TEMP_VEC4_2,P=o,E=0,D=g+o;P<D;P++,E+=12)v=(S=r[P]).getColor(),C[E]=v._m_X,C[E+1]=v._m_Y,C[E+2]=v._m_Z,C[E+3]=S.getTypeId(),"DirectionalLight"===S.getType()&&(p?(b.setToInXYZW(S.getDirection()._m_X,S.getDirection()._m_Y,S.getDirection()._m_Z,0),_.default.multiplyMV(T,b,t.getMainCamera().getViewMatrix()),C[E+4]=T._m_X,C[E+5]=T._m_Y,C[E+6]=T._m_Z,C[E+7]=-1):(C[E+4]=S.getDirection()._m_X,C[E+5]=S.getDirection()._m_Y,C[E+6]=S.getDirection()._m_Z,C[E+7]=-1),C[E+8]=0,C[E+9]=0,C[E+10]=0,C[E+11]=0);return e.uniform4fv(d,y.getBufferData(),0,12*g),null!=c[f.S_CUR_LIGHT_COUNT]&&e.uniform1i(c[f.S_CUR_LIGHT_COUNT].loc,3*g),g+o}if(1==u){var R,w=null;if(w=r[s],o>0&&!this._lightClip(e,w,!0))return o<=0?-1:0;if(null!=c[f.S_AMBIENT_LIGHT_COLOR])if(o<=0){var M=t.AmbientLightColor;e.uniform3f(c[f.S_AMBIENT_LIGHT_COLOR].loc,M._m_X,M._m_Y,M._m_Z)}else e.uniform3f(c[f.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());m&&this._blendGIProbes(e,t,n);var A=null,L=null,I=null,x=null,O=a.default.S_TEMP_VEC4,F=a.default.S_TEMP_VEC4_2,k=a.default.S_TEMP_VEC4_3;if(null!=c[f.S_V_LIGHT_DATA0]?(x=1,A=c[f.S_V_LIGHT_DATA0].loc,L=c[f.S_V_LIGHT_DATA1].loc,I=c[f.S_V_LIGHT_DATA2].loc):null!=c[f.S_W_LIGHT_DATA0]&&(x=0,A=c[f.S_W_LIGHT_DATA0].loc,L=c[f.S_W_LIGHT_DATA1].loc,I=c[f.S_W_LIGHT_DATA2].loc),null==x)return 1;switch(R=w.getColor(),O.setToInXYZW(R._m_X,R._m_Y,R._m_Z,w.getTypeId()),w.getType()){case"PointLight":x||F.setToInXYZW(w.getPosition()._m_X,w.getPosition()._m_Y,w.getPosition()._m_Z,w.getInRadius()),k.setToInXYZW(0,0,0,0);break;case"SpotLight":x||F.setToInXYZW(w.getPosition()._m_X,w.getPosition()._m_Y,w.getPosition()._m_Z,w.getInvSpotRange()),k.setToInXYZW(w.getDirection()._m_X,w.getDirection()._m_Y,w.getDirection()._m_Z,w.getPackedAngleCos())}return null!=A&&e.uniform4f(A,O._m_X,O._m_Y,O._m_Z,O._m_W),null!=L&&e.uniform4f(L,F._m_X,F._m_Y,F._m_Z,F._m_W),null!=I&&e.uniform4f(I,k._m_X,k._m_Y,k._m_Z,k._m_W),1}return 0}},{key:"draw",value:function(e,t,n,r,i){if(0==i.length){var o=n.m_LastSubShader.getContextVars(),a=t.enableGIProbes();if(a&&this._blendGIProbes(e,t,n),null!=o[f.S_BLEND_GI_PROBES]&&e.uniform1i(o[f.S_BLEND_GI_PROBES].loc,a),null!=o[f.S_MULTI_ID_SRC]&&e.uniform1i(o[f.S_MULTI_ID_SRC].loc,0),null!=o[f.S_AMBIENT_LIGHT_COLOR]){var _=t.AmbientLightColor;e.uniform3f(o[f.S_AMBIENT_LIGHT_COLOR].loc,_._m_X,_._m_Y,_._m_Z)}return null!=o[f.S_CUR_LIGHT_COUNT]&&e.uniform1i(o[f.S_CUR_LIGHT_COUNT].loc,0),void r.draw(n)}var s=t.getRender().getBatchLightSize();n.getRenderState().store();var u=[],l=[],c=null;i.forEach((function(e){"DirectionalLight"==(c=e.getType())?u.push(e):"PointLight"!=c&&"SpotLight"!=c||l.push(e)}));for(var m=0;m<u.length;)m=this._uploadLights(e,t,n,u,s,m,-1,0,0==m),r.draw(n);var h=0;if(l.length>0){t.getRender()._checkRenderState(e,this._m_ClipLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),e.scissor(0,0,2*this._m_ViewPortWidth,2*this._m_ViewPortHeight),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var d=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(d.m[0],d.m[4],d.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(d.m[1],d.m[5],d.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(d.m[0],d.m[4],d.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(d.m[1],d.m[5],d.m[9],1)}for(;h<l.length;)m=this._uploadLights(e,t,n,l,s,0!=m?m:h,h,1,0==m&&0==h),h++,1==m&&r.draw(n);t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=m}},{key:"drawArrays",value:function(e,t,n,r,i){if(0==i.length){var o=n.m_LastSubShader.getContextVars(),a=t.enableGIProbes();if(a&&this._blendGIProbes(e,t,n),null!=o[f.S_BLEND_GI_PROBES]&&e.uniform1i(o[f.S_BLEND_GI_PROBES].loc,a),null!=o[f.S_MULTI_ID_SRC]&&e.uniform1i(o[f.S_MULTI_ID_SRC].loc,0),null!=o[f.S_AMBIENT_LIGHT_COLOR]){var _=t.AmbientLightColor;e.uniform3f(o[f.S_AMBIENT_LIGHT_COLOR].loc,_._m_X,_._m_Y,_._m_Z)}return null!=o[f.S_CUR_LIGHT_COUNT]&&e.uniform1i(o[f.S_CUR_LIGHT_COUNT].loc,0),void r.forEach((function(e){e.draw(n)}))}var s=t.getRender().getBatchLightSize();n.getRenderState().store();var u=[],l=[],c=null;i.forEach((function(e){"DirectionalLight"==(c=e.getType())?u.push(e):"PointLight"!=c&&"SpotLight"!=c||l.push(e)}));for(var m=0;m<u.length;)m=this._uploadLights(e,t,n,u,s,m,-1,0,0==m),iDrawable.draw(n);var h=0;if(l.length>0){t.getRender()._checkRenderState(e,this._m_ClipLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),e.scissor(0,0,2*this._m_ViewPortWidth,2*this._m_ViewPortHeight),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var d=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(d.m[0],d.m[4],d.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(d.m[1],d.m[5],d.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(d.m[0],d.m[4],d.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(d.m[1],d.m[5],d.m[9],1)}for(;h<l.length;)m=this._uploadLights(e,t,n,l,s,0!=m?m:h,h,1,0==m&&0==h),h++,1==m&&r.forEach((function(e){e.draw(n)}));t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=m}}])&&c(t.prototype,n),r&&c(t,r),f}(i.default);t.default=v,S(v,"PROGRAM_TYPE","MultiPassIBLLighting"),S(v,"S_CUR_LIGHT_COUNT","_curLightCount"),S(v,"S_AMBIENT_LIGHT_COLOR","_ambientLightColor"),S(v,"S_BLEND_GI_PROBES","_blend_gi_probes"),S(v,"S_MULTI_ID_SRC","_multiId"),S(v,"S_V_LIGHT_DATA","_vLightData"),S(v,"S_W_LIGHT_DATA","_wLightData"),S(v,"S_V_LIGHT_DATA0","_vLight_Data_0"),S(v,"S_V_LIGHT_DATA1","_vLight_Data_1"),S(v,"S_V_LIGHT_DATA2","_vLight_Data_2"),S(v,"S_W_LIGHT_DATA0","_wLight_Data_0"),S(v,"S_W_LIGHT_DATA1","_wLight_Data_1"),S(v,"S_W_LIGHT_DATA2","_wLight_Data_2"),S(v,"S_PREF_ENV_MAP_SRC","_prefEnvMap"),S(v,"S_WGIPROBE_SRC","_wGIProbe"),S(v,"S_SH_COEFFS_SRC","_ShCoeffs")},4658:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=l(n(1393)),o=l(n(8435)),a=(l(n(7539)),l(n(2475))),_=l(n(2320)),s=l(n(7141)),u=l(n(5604));function l(e){return e&&e.__esModule?e:{default:e}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=p(e);if(t){var i=p(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(l,e);var t,n,r,i=m(l);function l(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),g(d(t=i.call(this,e)),"_m_PV",null),g(d(t),"_m_Temp_Vec3",new u.default),g(d(t),"_m_Temp_Vec4",new s.default),g(d(t),"_m_Temp_Vec4_2",new s.default),g(d(t),"_m_Temp_Vec4_3",new s.default),g(d(t),"_m_Cam_Up",new s.default),g(d(t),"_m_Cam_Left",new s.default),g(d(t),"_m_Light_Left",new s.default),g(d(t),"_m_Light_Up",new s.default),g(d(t),"_m_Light_Center",new s.default),g(d(t),"_m_ViewPortWidth",-1),g(d(t),"_m_ViewPortHeight",-1),g(d(t),"_m_CamLeftCoeff",-1),g(d(t),"_m_CamTopCoeff",-1),t._m_AccumulationLights=new o.default,t._m_AccumulationLights.setFlag(o.default.S_STATES[4],"On"),t._m_AccumulationLights.setFlag(o.default.S_STATES[1],"Off"),t._m_AccumulationLights.setFlag(o.default.S_STATES[5],["SRC_ALPHA","ONE"]),t._m_ClipLights=new o.default,t._m_ClipLights.setFlag(o.default.S_STATES[6],"On"),t}return t=l,(n=[{key:"_uploadLights",value:function(e,t,n,r,i,o,s,u){var f=n.m_LastSubShader.getContextVars();if(null!=f[l.S_MULTI_ID_SRC]&&e.uniform1i(f[l.S_MULTI_ID_SRC].loc,u),0==u){if(null!=f[l.S_AMBIENT_LIGHT_COLOR])if(0==o){var c=t.AmbientLightColor;e.uniform3f(f[l.S_AMBIENT_LIGHT_COLOR].loc,c._m_X,c._m_Y,c._m_Z)}else e.uniform3f(f[l.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());var m=null,h=null;null!=f[l.S_V_LIGHT_DATA]?(h=1,m=f[l.S_V_LIGHT_DATA].loc):null!=f[l.S_W_LIGHT_DATA]&&(h=0,m=f[l.S_W_LIGHT_DATA].loc);var d=i+o>r.length?r.length-o:i,p=null,g=null;if(null==m)return d+o;for(var S=a.default.S_LIGHT_DATA,v=S.getArray(),y=a.default.S_TEMP_VEC4,C=a.default.S_TEMP_VEC4_2,T=o,b=0,P=d+o;T<P;T++,b+=12)g=(p=r[T]).getColor(),v[b]=g._m_X,v[b+1]=g._m_Y,v[b+2]=g._m_Z,v[b+3]=p.getTypeId(),"DirectionalLight"===p.getType()&&(h?(C.setToInXYZW(p.getDirection()._m_X,p.getDirection()._m_Y,p.getDirection()._m_Z,0),_.default.multiplyMV(y,C,t.getMainCamera().getViewMatrix()),v[b+4]=y._m_X,v[b+5]=y._m_Y,v[b+6]=y._m_Z,v[b+7]=-1):(v[b+4]=p.getDirection()._m_X,v[b+5]=p.getDirection()._m_Y,v[b+6]=p.getDirection()._m_Z,v[b+7]=-1),v[b+8]=0,v[b+9]=0,v[b+10]=0,v[b+11]=0);return e.uniform4fv(m,S.getBufferData(),0,12*d),null!=f[l.S_CUR_LIGHT_COUNT]&&e.uniform1i(f[l.S_CUR_LIGHT_COUNT].loc,3*d),d+o}if(1==u){var E,D=null;if(D=r[s],o>0&&!this._lightClip(e,D,!0))return o<=0?-1:0;if(null!=f[l.S_AMBIENT_LIGHT_COLOR])if(o<=0){var R=t.AmbientLightColor;e.uniform3f(f[l.S_AMBIENT_LIGHT_COLOR].loc,R._m_X,R._m_Y,R._m_Z)}else e.uniform3f(f[l.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());var w=null,M=null,A=null,L=null,I=a.default.S_TEMP_VEC4,x=a.default.S_TEMP_VEC4_2,O=a.default.S_TEMP_VEC4_3;if(null!=f[l.S_V_LIGHT_DATA0]?(L=1,w=f[l.S_V_LIGHT_DATA0].loc,M=f[l.S_V_LIGHT_DATA1].loc,A=f[l.S_V_LIGHT_DATA2].loc):null!=f[l.S_W_LIGHT_DATA0]&&(L=0,w=f[l.S_W_LIGHT_DATA0].loc,M=f[l.S_W_LIGHT_DATA1].loc,A=f[l.S_W_LIGHT_DATA2].loc),null==L)return 1;switch(E=D.getColor(),I.setToInXYZW(E._m_X,E._m_Y,E._m_Z,D.getTypeId()),D.getType()){case"PointLight":L||x.setToInXYZW(D.getPosition()._m_X,D.getPosition()._m_Y,D.getPosition()._m_Z,D.getInRadius()),O.setToInXYZW(0,0,0,0);break;case"SpotLight":L||x.setToInXYZW(D.getPosition()._m_X,D.getPosition()._m_Y,D.getPosition()._m_Z,D.getInvSpotRange()),O.setToInXYZW(D.getDirection()._m_X,D.getDirection()._m_Y,D.getDirection()._m_Z,D.getPackedAngleCos())}return null!=w&&e.uniform4f(w,I._m_X,I._m_Y,I._m_Z,I._m_W),null!=M&&e.uniform4f(M,x._m_X,x._m_Y,x._m_Z,x._m_W),null!=A&&e.uniform4f(A,O._m_X,O._m_Y,O._m_Z,O._m_W),1}return 0}},{key:"_lightClip",value:function(e,t,n){var r=t.getBoundingVolume(),i=r.getRadius(),o=i*this._m_CamLeftCoeff,a=i*this._m_CamTopCoeff,s=r.getCenter(this._m_Temp_Vec3);s=this._m_Temp_Vec4.setToInXYZW(s._m_X,s._m_Y,s._m_Z,1),this._m_Temp_Vec4._m_W=1,this._m_Temp_Vec4_2._m_W=1,this._m_Temp_Vec4_3._m_W=1;var u=this._m_Cam_Left.multLength(o,this._m_Temp_Vec4_2).add(s),l=this._m_Cam_Up.multLength(a,this._m_Temp_Vec4_3).add(s);_.default.multiplyMV(this._m_Light_Left,u,this._m_PV),_.default.multiplyMV(this._m_Light_Up,l,this._m_PV),_.default.multiplyMV(this._m_Light_Center,s,this._m_PV),this._m_Light_Left._m_X/=this._m_Light_Left._m_W,this._m_Light_Left._m_Y/=this._m_Light_Left._m_W,this._m_Light_Up._m_X/=this._m_Light_Up._m_W,this._m_Light_Up._m_Y/=this._m_Light_Up._m_W,this._m_Light_Center._m_X/=this._m_Light_Center._m_W,this._m_Light_Center._m_Y/=this._m_Light_Center._m_W,this._m_Light_Left._m_X=this._m_ViewPortWidth*(1+this._m_Light_Left._m_X),this._m_Light_Up._m_X=this._m_ViewPortWidth*(1+this._m_Light_Up._m_X),this._m_Light_Center._m_X=this._m_ViewPortWidth*(1+this._m_Light_Center._m_X),this._m_Light_Left._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Left._m_Y),this._m_Light_Up._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Up._m_Y),this._m_Light_Center._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Center._m_Y);var f=Math.abs(this._m_Light_Left._m_X-this._m_Light_Center._m_X),c=Math.abs(this._m_Light_Center._m_Y-this._m_Light_Up._m_Y),m=-1,h=-1;return this._m_Light_Center._m_Z<-this._m_Light_Center._m_W?(m=-this._m_Light_Center._m_X-f,h=-this._m_Light_Center._m_Y+c):(m=this._m_Light_Center._m_X-f,h=this._m_Light_Center._m_Y+c),e.scissor(m,2*this._m_ViewPortHeight-h,2*f,2*c),!0}},{key:"_lightCvvTest",value:function(e,t,n,r,i,o){return r<-o||e>n||i>o||t<-n}},{key:"draw",value:function(e,t,n,r,i){if(0==i.length){var o=n.m_LastSubShader.getContextVars();if(null!=o[l.S_MULTI_ID_SRC]&&e.uniform1i(o[l.S_MULTI_ID_SRC].loc,0),null!=o[l.S_AMBIENT_LIGHT_COLOR]){var a=t.AmbientLightColor;e.uniform3f(o[l.S_AMBIENT_LIGHT_COLOR].loc,a._m_X,a._m_Y,a._m_Z)}return null!=o[l.S_CUR_LIGHT_COUNT]&&e.uniform1i(o[l.S_CUR_LIGHT_COUNT].loc,0),void r.draw(n)}var _=t.getRender().getBatchLightSize();n.getRenderState().store();var s=[],u=[];i.forEach((function(e){"DirectionalLight"==e.getType()?s.push(e):u.push(e)}));for(var f=0;f<s.length;)f=this._uploadLights(e,t,n,s,_,f,-1,0),r.draw(n);var c=0;if(u.length>0){t.getRender()._checkRenderState(e,this._m_ClipLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),e.scissor(0,0,2*this._m_ViewPortWidth,2*this._m_ViewPortHeight),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var m=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(m.m[0],m.m[4],m.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(m.m[1],m.m[5],m.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(m.m[0],m.m[4],m.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(m.m[1],m.m[5],m.m[9],1)}for(;c<u.length;)f=this._uploadLights(e,t,n,u,_,0!=f?f:c,c,1),c++,1==f&&r.draw(n);t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=f}},{key:"drawArrays",value:function(e,t,n,r,i){if(0==i.length){var o=n.m_LastSubShader.getContextVars();if(null!=o[l.S_MULTI_ID_SRC]&&e.uniform1i(o[l.S_MULTI_ID_SRC].loc,0),null!=o[l.S_AMBIENT_LIGHT_COLOR]){var a=t.AmbientLightColor;e.uniform3f(o[l.S_AMBIENT_LIGHT_COLOR].loc,a._m_X,a._m_Y,a._m_Z)}return null!=o[l.S_CUR_LIGHT_COUNT]&&e.uniform1i(o[l.S_CUR_LIGHT_COUNT].loc,0),void r.forEach((function(e){e.draw(n)}))}var _=t.getRender().getBatchLightSize();n.getRenderState().store();var s=[],u=[];i.forEach((function(e){"DirectionalLight"==e.getType()?s.push(e):u.push(e)}));for(var f=0;f<s.length;)f=this._uploadLights(e,t,n,s,_,f,-1,0),r.forEach((function(e){e.draw(n)}));var c=0;if(u.length>0){t.getRender()._checkRenderState(e,this._m_ClipLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),e.scissor(0,0,2*this._m_ViewPortWidth,2*this._m_ViewPortHeight),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var m=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(m.m[0],m.m[4],m.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(m.m[1],m.m[5],m.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(m.m[0],m.m[4],m.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(m.m[1],m.m[5],m.m[9],1)}for(;c<u.length;)f=this._uploadLights(e,t,n,u,_,0!=f?f:c,c,1),c++,1==f&&r.forEach((function(e){e.draw(n)}));t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=f}}])&&f(t.prototype,n),r&&f(t,r),l}(i.default);t.default=S,g(S,"PROGRAM_TYPE","MultiPassLighting"),g(S,"S_CUR_LIGHT_COUNT","_curLightCount"),g(S,"S_AMBIENT_LIGHT_COLOR","_ambientLightColor"),g(S,"S_MULTI_ID_SRC","_multiId"),g(S,"S_V_LIGHT_DATA","_vLightData"),g(S,"S_W_LIGHT_DATA","_wLightData"),g(S,"S_V_LIGHT_DATA0","_vLight_Data_0"),g(S,"S_V_LIGHT_DATA1","_vLight_Data_1"),g(S,"S_V_LIGHT_DATA2","_vLight_Data_2"),g(S,"S_W_LIGHT_DATA0","_wLight_Data_0"),g(S,"S_W_LIGHT_DATA1","_wLight_Data_1"),g(S,"S_W_LIGHT_DATA2","_wLight_Data_2")},8546:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=u(n(1393)),o=u(n(8435)),a=(u(n(7539)),u(n(2475))),_=u(n(2320)),s=(u(n(3846)),u(n(9784)));function u(e){return e&&e.__esModule?e:{default:e}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function c(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=h(e);if(t){var i=h(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return m(this,n)}}function m(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(u,e);var t,n,r,i=c(u);function u(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(t=i.call(this,e))._m_AccumulationLights=new o.default,t._m_AccumulationLights.setFlag(o.default.S_STATES[4],"On"),t._m_AccumulationLights.setFlag(o.default.S_STATES[1],"Off"),t._m_AccumulationLights.setFlag(o.default.S_STATES[5],["ONE","ONE"]),t._m_m_LastSubShader=null,t}return t=u,(n=[{key:"_blendGIProbes",value:function(e,t,n){var r=n.m_LastSubShader.getContextVars();if(null!=r[u.S_WGIPROBE_SRC]){if(this._m_m_LastSubShader!=n.m_LastSubShader){var i=t.getGIProbes()[0],o=a.default.S_TEMP_VEC4;o.setToInXYZW(i.getPosition()._m_X,i.getPosition()._m_Y,i.getPosition()._m_Z,1/i.getRadius()+i.getPrefilterMipmap()),e.uniform4fv(r[u.S_WGIPROBE_SRC].loc,o.getBufferData(),0,4),o=i.getShCoeffsBufferData(),null!=r[u.S_SH_COEFFS_SRC]&&e.uniform3fv(r[u.S_SH_COEFFS_SRC].loc,o.getBufferData(),0,27),null!=r[u.S_PREF_ENV_MAP_SRC]&&i.getPrefilterEnvMap()._upload(e,r[u.S_PREF_ENV_MAP_SRC].loc),this._m_m_LastSubShader=n.m_LastSubShader}}else{var _=t.getGIProbes();_&&_.length>0&&n.m_LastMaterial.addDefine(s.default.S_GIPROBES_SRC,!0)}}},{key:"_uploadLights",value:function(e,t,n,r,i,o,s){var l=n.m_LastSubShader.getContextVars(),f=t.enableGIProbes();if(null!=l[u.S_BLEND_GI_PROBES]&&e.uniform1i(l[u.S_BLEND_GI_PROBES].loc,s&&f),null!=l[u.S_AMBIENT_LIGHT_COLOR])if(0==o){var c=t.AmbientLightColor;e.uniform3f(l[u.S_AMBIENT_LIGHT_COLOR].loc,c._m_X,c._m_Y,c._m_Z)}else e.uniform3f(l[u.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());f&&this._blendGIProbes(e,t,n);var m=null,h=null;null!=l[u.S_V_LIGHT_DATA]?(h=1,m=l[u.S_V_LIGHT_DATA].loc):null!=l[u.S_W_LIGHT_DATA]&&(h=0,m=l[u.S_W_LIGHT_DATA].loc);var d=i+o>r.length?r.length-o:i;if(null==m)return d+o;for(var p=null,g=null,S=a.default.S_LIGHT_DATA_4,v=S.getArray(),y=a.default.S_TEMP_VEC4,C=a.default.S_TEMP_VEC4_2,T=o,b=0,P=d+o;T<P;T++,b+=12)switch(g=(p=r[T]).getColor(),v[b]=g._m_X,v[b+1]=g._m_Y,v[b+2]=g._m_Z,v[b+3]=p.getTypeId(),p.getType()){case"DirectionalLight":h?(C.setToInXYZW(p.getDirection()._m_X,p.getDirection()._m_Y,p.getDirection()._m_Z,0),_.default.multiplyMV(y,C,t.getMainCamera().getViewMatrix()),v[b+4]=y._m_X,v[b+5]=y._m_Y,v[b+6]=y._m_Z,v[b+7]=-1):(v[b+4]=p.getDirection()._m_X,v[b+5]=p.getDirection()._m_Y,v[b+6]=p.getDirection()._m_Z,v[b+7]=-1),v[b+8]=0,v[b+9]=0,v[b+10]=0,v[b+11]=0;break;case"PointLight":h||(v[b+4]=p.getPosition()._m_X,v[b+5]=p.getPosition()._m_Y,v[b+6]=p.getPosition()._m_Z,v[b+7]=p.getInRadius()),v[b+8]=0,v[b+9]=0,v[b+10]=0,v[b+11]=0;break;case"SpotLight":h||(v[b+4]=p.getPosition()._m_X,v[b+5]=p.getPosition()._m_Y,v[b+6]=p.getPosition()._m_Z,v[b+7]=p.getInvSpotRange()),v[b+8]=p.getDirection()._m_X,v[b+9]=p.getDirection()._m_Y,v[b+10]=p.getDirection()._m_Z,v[b+11]=p.getPackedAngleCos()}return e.uniform4fv(m,S.getBufferData(),0,12*d),null!=l[u.S_CUR_LIGHT_COUNT]&&e.uniform1i(l[u.S_CUR_LIGHT_COUNT].loc,3*d),d+o}},{key:"draw",value:function(e,t,n,r,i){if(0!=i.length){var o=t.getRender().getBatchLightSize(),a=0;for(n.getRenderState().store();a<i.length;)a=this._uploadLights(e,t,n,i,o,a,0==a),r.draw(n);t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=a}else{var _=n.m_LastSubShader.getContextVars(),s=t.enableGIProbes();if(s&&this._blendGIProbes(e,t,n),null!=_[u.S_BLEND_GI_PROBES]&&e.uniform1i(_[u.S_BLEND_GI_PROBES].loc,s),null!=_[u.S_CUR_LIGHT_COUNT]&&e.uniform1i(_[u.S_CUR_LIGHT_COUNT].loc,0),null!=_[u.S_AMBIENT_LIGHT_COLOR]){var l=t.AmbientLightColor;e.uniform3f(_[u.S_AMBIENT_LIGHT_COLOR].loc,l._m_X,l._m_Y,l._m_Z)}r.draw(n)}}},{key:"drawArrays",value:function(e,t,n,r,i){if(0!=i.length){var o=t.getRender().getBatchLightSize(),a=0;for(n.getRenderState().store();a<i.length;)a=this._uploadLights(e,t,n,i,o,a,0==a),r.forEach((function(e){e.draw(n)}));t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=a}else{var _=n.m_LastSubShader.getContextVars(),s=t.enableGIProbes();if(s&&this._blendGIProbes(e,t,n),null!=_[u.S_BLEND_GI_PROBES]&&e.uniform1i(_[u.S_BLEND_GI_PROBES].loc,s),null!=_[u.S_CUR_LIGHT_COUNT]&&e.uniform1i(_[u.S_CUR_LIGHT_COUNT].loc,0),null!=_[u.S_AMBIENT_LIGHT_COLOR]){var l=t.AmbientLightColor;e.uniform3f(_[u.S_AMBIENT_LIGHT_COLOR].loc,l._m_X,l._m_Y,l._m_Z)}r.forEach((function(e){e.draw(n)}))}}}])&&l(t.prototype,n),r&&l(t,r),u}(i.default);t.default=p,d(p,"PROGRAM_TYPE","SinglePassIBLLighting"),d(p,"S_CUR_LIGHT_COUNT","_curLightCount"),d(p,"S_AMBIENT_LIGHT_COLOR","_ambientLightColor"),d(p,"S_BLEND_GI_PROBES","_blend_gi_probes"),d(p,"S_V_LIGHT_DATA","_vLightData"),d(p,"S_W_LIGHT_DATA","_wLightData"),d(p,"S_PREF_ENV_MAP_SRC","_prefEnvMap"),d(p,"S_WGIPROBE_SRC","_wGIProbe"),d(p,"S_SH_COEFFS_SRC","_ShCoeffs")},6148:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=s(n(1393)),o=s(n(8435)),a=(s(n(7539)),s(n(2475))),_=s(n(2320));function s(e){return e&&e.__esModule?e:{default:e}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=m(e);if(t){var i=m(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return c(this,n)}}function c(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(s,e);var t,n,r,i=f(s);function s(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(t=i.call(this,e))._m_AccumulationLights=new o.default,t._m_AccumulationLights.setFlag(o.default.S_STATES[4],"On"),t._m_AccumulationLights.setFlag(o.default.S_STATES[1],"Off"),t._m_AccumulationLights.setFlag(o.default.S_STATES[5],["ONE","ONE"]),t}return t=s,(n=[{key:"_uploadLights",value:function(e,t,n,r,i,o){var u=n.m_LastSubShader.getContextVars();if(null!=u[s.S_AMBIENT_LIGHT_COLOR])if(0==o){var l=t.AmbientLightColor;e.uniform3f(u[s.S_AMBIENT_LIGHT_COLOR].loc,l._m_X,l._m_Y,l._m_Z)}else e.uniform3f(u[s.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());var f=null,c=null;null!=u[s.S_V_LIGHT_DATA]?(c=1,f=u[s.S_V_LIGHT_DATA].loc):null!=u[s.S_W_LIGHT_DATA]&&(c=0,f=u[s.S_W_LIGHT_DATA].loc);var m=i+o>r.length?r.length-o:i;if(null==f)return m+o;for(var h=null,d=null,p=a.default.S_LIGHT_DATA,g=p.getArray(),S=a.default.S_TEMP_VEC4,v=a.default.S_TEMP_VEC4_2,y=o,C=0,T=m+o;y<T;y++,C+=12)switch(d=(h=r[y]).getColor(),g[C]=d._m_X,g[C+1]=d._m_Y,g[C+2]=d._m_Z,g[C+3]=h.getTypeId(),h.getType()){case"DirectionalLight":c?(v.setToInXYZW(h.getDirection()._m_X,h.getDirection()._m_Y,h.getDirection()._m_Z,0),_.default.multiplyMV(S,v,t.getMainCamera().getViewMatrix()),g[C+4]=S._m_X,g[C+5]=S._m_Y,g[C+6]=S._m_Z,g[C+7]=-1):(g[C+4]=h.getDirection()._m_X,g[C+5]=h.getDirection()._m_Y,g[C+6]=h.getDirection()._m_Z,g[C+7]=-1),g[C+8]=0,g[C+9]=0,g[C+10]=0,g[C+11]=0;break;case"PointLight":c||(g[C+4]=h.getPosition()._m_X,g[C+5]=h.getPosition()._m_Y,g[C+6]=h.getPosition()._m_Z,g[C+7]=h.getInRadius()),g[C+8]=0,g[C+9]=0,g[C+10]=0,g[C+11]=0;break;case"SpotLight":c||(g[C+4]=h.getPosition()._m_X,g[C+5]=h.getPosition()._m_Y,g[C+6]=h.getPosition()._m_Z,g[C+7]=h.getInvSpotRange()),g[C+8]=h.getDirection()._m_X,g[C+9]=h.getDirection()._m_Y,g[C+10]=h.getDirection()._m_Z,g[C+11]=h.getPackedAngleCos()}return e.uniform4fv(f,p.getBufferData(),0,12*m),null!=u[s.S_CUR_LIGHT_COUNT]&&e.uniform1i(u[s.S_CUR_LIGHT_COUNT].loc,3*m),m+o}},{key:"draw",value:function(e,t,n,r,i){if(0==i.length){var o=n.m_LastSubShader.getContextVars();if(null!=o[s.S_AMBIENT_LIGHT_COLOR]){var a=t.AmbientLightColor;e.uniform3f(o[s.S_AMBIENT_LIGHT_COLOR].loc,a._m_X,a._m_Y,a._m_Z)}return null!=o[s.S_CUR_LIGHT_COUNT]&&e.uniform1i(o[s.S_CUR_LIGHT_COUNT].loc,0),void r.draw(n)}for(var _=t.getRender().getBatchLightSize(),u=0;u<i.length;)u=this._uploadLights(e,t,n,i,_,u),r.draw(n);t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=u}},{key:"drawArrays",value:function(e,t,n,r,i){if(0==i.length){var o=n.m_LastSubShader.getContextVars();if(null!=o[s.S_AMBIENT_LIGHT_COLOR]){var a=t.AmbientLightColor;e.uniform3f(o[s.S_AMBIENT_LIGHT_COLOR].loc,a._m_X,a._m_Y,a._m_Z)}return null!=o[s.S_CUR_LIGHT_COUNT]&&e.uniform1i(o[s.S_CUR_LIGHT_COUNT].loc,0),void r.forEach((function(e){e.draw(n)}))}var _=t.getRender().getBatchLightSize(),u=0;for(n.getRenderState().store();u<i.length;)u=this._uploadLights(e,t,n,i,_,u),r.forEach((function(e){e.draw(n)}));t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState()),n.BatchLightLastIndex=u}}])&&u(t.prototype,n),r&&u(t,r),s}(i.default);t.default=d,h(d,"PROGRAM_TYPE","SinglePassLighting"),h(d,"S_CUR_LIGHT_COUNT","_curLightCount"),h(d,"S_AMBIENT_LIGHT_COLOR","_ambientLightColor"),h(d,"S_V_LIGHT_DATA","_vLightData"),h(d,"S_W_LIGHT_DATA","_wLightData")},2987:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=c(n(1393)),o=c(n(2320)),a=c(n(8435)),_=c(n(9784)),s=c(n(2475)),u=c(n(5604)),l=c(n(7141)),f=c(n(5141));function c(e){return e&&e.__esModule?e:{default:e}}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=S(e);if(t){var i=S(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return p(this,n)}}function p(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return g(e)}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(c,e);var t,n,r,i=d(c);function c(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),v(g(t=i.call(this,e)),"_m_Tiles",[]),v(g(t),"_m_LightsIndex",[]),v(g(t),"_m_LightsDecode",[]),v(g(t),"_m_LightsDecodeData",null),v(g(t),"_m_LightsIndexData",null),v(g(t),"_m_LightsData0",null),v(g(t),"_m_LightsData1",null),v(g(t),"_m_LightsData2",null),v(g(t),"_m_LightsData0Array",[]),v(g(t),"_m_LightsData1Array",[]),v(g(t),"_m_LightsData2Array",[]),v(g(t),"_m_PV",null),v(g(t),"_m_Temp_Vec3",new u.default),v(g(t),"_m_Temp_Vec4",new l.default),v(g(t),"_m_Temp_Vec4_2",new l.default),v(g(t),"_m_Temp_Vec4_3",new l.default),v(g(t),"_m_Cam_Up",new l.default),v(g(t),"_m_Cam_Left",new l.default),v(g(t),"_m_Light_Left",new l.default),v(g(t),"_m_Light_Up",new l.default),v(g(t),"_m_Light_Center",new l.default),v(g(t),"_m_ViewPortWidth",-1),v(g(t),"_m_ViewPortHeight",-1),v(g(t),"_m_CamLeftCoeff",-1),v(g(t),"_m_CamTopCoeff",-1),t._m_AccumulationLights=new a.default,t._m_AccumulationLights.setFlag(a.default.S_STATES[4],"On"),t._m_AccumulationLights.setFlag(a.default.S_STATES[1],"Off"),t._m_AccumulationLights.setFlag(a.default.S_STATES[5],["ONE","ONE"]),t}return t=c,(n=[{key:"_blendGIProbes",value:function(e,t,n){var r=n.m_LastSubShader.getContextVars();if(null!=r[c.S_WGIPROBE_SRC]){if(this._m_m_LastSubShader!=n.m_LastSubShader){var i=t.getGIProbes()[0],o=s.default.S_TEMP_VEC4;o.setToInXYZW(i.getPosition()._m_X,i.getPosition()._m_Y,i.getPosition()._m_Z,1/i.getRadius()+i.getPrefilterMipmap()),e.uniform4fv(r[c.S_WGIPROBE_SRC].loc,o.getBufferData(),0,4),o=i.getShCoeffsBufferData(),null!=r[c.S_SH_COEFFS_SRC]&&e.uniform3fv(r[c.S_SH_COEFFS_SRC].loc,o.getBufferData(),0,27),null!=r[c.S_PREF_ENV_MAP_SRC]&&i.getPrefilterEnvMap()._upload(e,r[c.S_PREF_ENV_MAP_SRC].loc),this._m_m_LastSubShader=n.m_LastSubShader}}else{var a=t.getGIProbes();a&&a.length>0&&n.m_LastMaterial.addDefine(_.default.S_GIPROBES_SRC,!0)}}},{key:"_createTexture",value:function(e,t,n,r){var i=new f.default(e);return e.getCanvas().getGLContext(),i.setTextureFormat(t,n,r),i.setWrap(e,f.default.S_WRAPS.S_CLAMP_TO_EDGE,f.default.S_WRAPS.S_CLAMP_TO_EDGE),i.setFilter(e,f.default.S_FILTERS.S_NEAREST,f.default.S_FILTERS.S_NEAREST),i.updateTextureFilter(),i.setAlignment(1),i}},{key:"_reset",value:function(e,t,n){this._m_LightsIndexData||(this._m_LightsIndexData=this._createTexture(t,e.RGB32F,e.RGB,e.FLOAT)),this._m_LightsDecodeData||(this._m_LightsDecodeData=this._createTexture(t,e.RGB32F,e.RGB,e.FLOAT)),this._m_LightsData0||(this._m_LightsData0=this._createTexture(t,e.RGBA32F,e.RGBA,e.FLOAT)),this._m_LightsData0Array.length=0,this._m_LightsData1||(this._m_LightsData1=this._createTexture(t,e.RGBA32F,e.RGBA,e.FLOAT)),this._m_LightsData1Array.length=0,this._m_LightsData2||(this._m_LightsData2=this._createTexture(t,e.RGBA32F,e.RGBA,e.FLOAT)),this._m_LightsData2Array.length=0;for(var r=0;r<n;r++)this._m_Tiles[r]=[];this._m_LightsDecode.length=0,this._m_LightsIndex.length=0}},{key:"_lightClip",value:function(e,t){var n=t.getBoundingVolume(),r=n.getRadius(),i=r*this._m_CamLeftCoeff,a=r*this._m_CamTopCoeff,_=n.getCenter(this._m_Temp_Vec3);_=this._m_Temp_Vec4.setToInXYZW(_._m_X,_._m_Y,_._m_Z,1),this._m_Temp_Vec4._m_W=1,this._m_Temp_Vec4_2._m_W=1,this._m_Temp_Vec4_3._m_W=1;var s=this._m_Cam_Left.multLength(i,this._m_Temp_Vec4_2).add(_),u=this._m_Cam_Up.multLength(a,this._m_Temp_Vec4_3).add(_);o.default.multiplyMV(this._m_Light_Left,s,this._m_PV),o.default.multiplyMV(this._m_Light_Up,u,this._m_PV),o.default.multiplyMV(this._m_Light_Center,_,this._m_PV),this._m_Light_Left._m_X/=this._m_Light_Left._m_W,this._m_Light_Left._m_Y/=this._m_Light_Left._m_W,this._m_Light_Up._m_X/=this._m_Light_Up._m_W,this._m_Light_Up._m_Y/=this._m_Light_Up._m_W,this._m_Light_Center._m_X/=this._m_Light_Center._m_W,this._m_Light_Center._m_Y/=this._m_Light_Center._m_W,this._m_Light_Left._m_X=this._m_ViewPortWidth*(1+this._m_Light_Left._m_X),this._m_Light_Up._m_X=this._m_ViewPortWidth*(1+this._m_Light_Up._m_X),this._m_Light_Center._m_X=this._m_ViewPortWidth*(1+this._m_Light_Center._m_X),this._m_Light_Left._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Left._m_Y),this._m_Light_Up._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Up._m_Y),this._m_Light_Center._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Center._m_Y);var l=Math.abs(this._m_Light_Left._m_X-this._m_Light_Center._m_X),f=Math.abs(this._m_Light_Center._m_Y-this._m_Light_Up._m_Y),c=-1,m=-1;this._m_Light_Center._m_Z<-this._m_Light_Center._m_W?(c=-this._m_Light_Center._m_X-l,m=-this._m_Light_Center._m_Y+f):(c=this._m_Light_Center._m_X-l,m=this._m_Light_Center._m_Y+f);var h=2*this._m_ViewPortHeight-m;return{left:c,right:2*l+c,top:2*f+h,bottom:h}}},{key:"_tile",value:function(e,t,n,r,i,o,a){for(var _=Math.max(Math.floor(o.left/e),0),s=Math.min(Math.ceil(o.right/e),t),u=Math.max(Math.floor(o.bottom/e),0),l=Math.min(Math.ceil(o.top/e),n),f=0,c=_;c<s;c++)for(var m=u;m<l;m++)(f=c+m*t)>=0&&f<r&&i[f].push(a)}},{key:"_tileLightDecode",value:function(e,t,n,r,i,o,a){var _=t.m_LastSubShader.getContextVars(),s=-1;s=a.length;var u=null;if(null!=_[c.S_LIGHT_NUM_SRC]&&e.uniform1i(_[c.S_LIGHT_NUM_SRC].loc,s),null!=_[c.S_TILE_V_LIGHT_DATA_0])u=1;else{if(null==_[c.S_TILE_W_LIGHT_DATA_0])return 0;u=0}for(var l=0,f=0,m=null;l<n;l++){s=(m=r[l]).length;for(var h=0;h<s;h++)this._m_LightsIndex.push(m[h]),this._m_LightsIndex.push(0),this._m_LightsIndex.push(0);this._m_LightsDecode.push(f),this._m_LightsDecode.push(s),this._m_LightsDecode.push(-1),f+=s}var d=Math.ceil(Math.sqrt(this._m_LightsIndex.length/3));null!=_[c.S_TILE_LIGHT_OFFSET_SIZE]&&e.uniform1f(_[c.S_TILE_LIGHT_OFFSET_SIZE].loc,d);for(var p=this._m_LightsIndex.length,g=d*d*3;p<g;p++)this._m_LightsIndex.push(-1);for(var S=0,v=this._m_LightsDecode.length;S<v;S+=3)this._m_LightsDecode[S+2]=this._m_LightsDecode[S]/d,this._m_LightsDecode[S]%=d;null!=_[c.S_TILE_LIGHT_DECODE_SRC]&&this._m_LightsDecodeData.uploadArrayData(_[c.S_TILE_LIGHT_DECODE_SRC].loc,i,o,new Float32Array(this._m_LightsDecode)),null!=_[c.S_TILE_LIGHT_INDEX_SRC]&&this._m_LightsIndexData.uploadArrayData(_[c.S_TILE_LIGHT_INDEX_SRC].loc,d,d,new Float32Array(this._m_LightsIndex));var y=null,C=null;s=a.length;for(var T=0;T<s;T++)switch(C=(y=a[T]).getColor(),this._m_LightsData0Array.push(C._m_X),this._m_LightsData0Array.push(C._m_Y),this._m_LightsData0Array.push(C._m_Z),this._m_LightsData0Array.push(y.getTypeId()),y.getType()){case"PointLight":u||(this._m_LightsData1Array.push(y.getPosition()._m_X),this._m_LightsData1Array.push(y.getPosition()._m_Y),this._m_LightsData1Array.push(y.getPosition()._m_Z),this._m_LightsData1Array.push(y.getInRadius())),this._m_LightsData2Array.push(0),this._m_LightsData2Array.push(0),this._m_LightsData2Array.push(0),this._m_LightsData2Array.push(0);break;case"SpotLight":u||(this._m_LightsData1Array.push(y.getPosition()._m_X),this._m_LightsData1Array.push(y.getPosition()._m_Y),this._m_LightsData1Array.push(y.getPosition()._m_Z),this._m_LightsData1Array.push(y.getInvSpotRange())),this._m_LightsData2Array.push(y.getDirection()._m_X),this._m_LightsData2Array.push(y.getDirection()._m_Y),this._m_LightsData2Array.push(y.getDirection()._m_Z),this._m_LightsData2Array.push(y.getPackedAngleCos())}var b=_[c.S_TILE_W_LIGHT_DATA_0]?_[c.S_TILE_W_LIGHT_DATA_0]:_[c.S_TILE_V_LIGHT_DATA_0];return b&&this._m_LightsData0.uploadArrayData(b.loc,this._m_LightsData0Array.length/4,1,new Float32Array(this._m_LightsData0Array)),(b=_[c.S_TILE_W_LIGHT_DATA_1]?_[c.S_TILE_W_LIGHT_DATA_1]:_[c.S_TILE_V_LIGHT_DATA_1])&&this._m_LightsData1.uploadArrayData(b.loc,this._m_LightsData1Array.length/4,1,new Float32Array(this._m_LightsData1Array)),(b=_[c.S_TILE_W_LIGHT_DATA_2]?_[c.S_TILE_W_LIGHT_DATA_2]:_[c.S_TILE_V_LIGHT_DATA_2])&&this._m_LightsData2.uploadArrayData(b.loc,this._m_LightsData2Array.length/4,1,new Float32Array(this._m_LightsData2Array)),1}},{key:"_uploadLights",value:function(e,t,n,r,i,a,_){var u=n.m_LastSubShader.getContextVars(),l=t.enableGIProbes();if(null!=u[c.S_BLEND_GI_PROBES]&&e.uniform1i(u[c.S_BLEND_GI_PROBES].loc,_&&l),null!=u[c.S_AMBIENT_LIGHT_COLOR])if(0==a){var f=t.AmbientLightColor;e.uniform3f(u[c.S_AMBIENT_LIGHT_COLOR].loc,f._m_X,f._m_Y,f._m_Z)}else e.uniform3f(u[c.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());l&&this._blendGIProbes(e,t,n);var m=null,h=null;null!=u[c.S_V_LIGHT_DATA]?(h=1,m=u[c.S_V_LIGHT_DATA].loc):null!=u[c.S_W_LIGHT_DATA]&&(h=0,m=u[c.S_W_LIGHT_DATA].loc);var d=i+a>r.length?r.length-a:i;if(null==m)return d+a;for(var p=null,g=null,S=s.default.S_LIGHT_DATA_4,v=S.getArray(),y=s.default.S_TEMP_VEC4,C=s.default.S_TEMP_VEC4_2,T=a,b=0,P=d+a;T<P;T++,b+=12)g=(p=r[T]).getColor(),v[b]=g._m_X,v[b+1]=g._m_Y,v[b+2]=g._m_Z,v[b+3]=p.getTypeId(),"DirectionalLight"===p.getType()&&(h?(C.setToInXYZW(p.getDirection()._m_X,p.getDirection()._m_Y,p.getDirection()._m_Z,0),o.default.multiplyMV(y,C,t.getMainCamera().getViewMatrix()),v[b+4]=y._m_X,v[b+5]=y._m_Y,v[b+6]=y._m_Z,v[b+7]=-1):(v[b+4]=p.getDirection()._m_X,v[b+5]=p.getDirection()._m_Y,v[b+6]=p.getDirection()._m_Z,v[b+7]=-1),v[b+8]=0,v[b+9]=0,v[b+10]=0,v[b+11]=0);return e.uniform4fv(m,S.getBufferData(),0,12*d),null!=u[c.S_CUR_LIGHT_COUNT]&&e.uniform1i(u[c.S_CUR_LIGHT_COUNT].loc,3*d),d+a}},{key:"draw",value:function(e,t,n,r,i,o){if(n.getRenderState().store(),0==o){if(0==i.length){var a=n.m_LastSubShader.getContextVars(),_=t.enableGIProbes();if(_&&this._blendGIProbes(e,t,n),null!=a[c.S_BLEND_GI_PROBES]&&e.uniform1i(a[c.S_BLEND_GI_PROBES].loc,_),null!=a[c.S_AMBIENT_LIGHT_COLOR]){var s=t.AmbientLightColor;e.uniform3f(a[c.S_AMBIENT_LIGHT_COLOR].loc,s._m_X,s._m_Y,s._m_Z)}return null!=a[c.S_CUR_LIGHT_COUNT]&&e.uniform1i(a[c.S_CUR_LIGHT_COUNT].loc,0),void r.draw(n)}for(var u=t.getRender().getBatchLightSize(),l=0;l<i.length;)l=this._uploadLights(e,t,n,i,u,l,0==l),r.draw(n)}else if(1==o){if(0==i.length)return;var f=null,m=t.getRender().getTileInfo(),h=m.tileSize,d=m.tileWidth,p=m.tileHeight,g=m.tileNum;if(this._reset(e,t,g),i.length>0){t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var S=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(S.m[0],S.m[4],S.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(S.m[1],S.m[5],S.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(S.m[0],S.m[4],S.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(S.m[1],S.m[5],S.m[9],1)}for(var v=0,y=i.length;v<y;v++)(f=this._lightClip(e,i[v]))&&this._tile(h,d,p,g,this._m_Tiles,f,v);this._tileLightDecode(e,n,g,this._m_Tiles,d,p,i),r.draw(n)}t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState())}},{key:"drawArrays",value:function(e,t,n,r,i,o){if(n.getRenderState().store(),0==o){if(0==i.length){var a=n.m_LastSubShader.getContextVars(),_=t.enableGIProbes();if(_&&this._blendGIProbes(e,t,n),null!=a[c.S_BLEND_GI_PROBES]&&e.uniform1i(a[c.S_BLEND_GI_PROBES].loc,_),null!=a[c.S_AMBIENT_LIGHT_COLOR]){var s=t.AmbientLightColor;e.uniform3f(a[c.S_AMBIENT_LIGHT_COLOR].loc,s._m_X,s._m_Y,s._m_Z)}return null!=a[c.S_CUR_LIGHT_COUNT]&&e.uniform1i(a[c.S_CUR_LIGHT_COUNT].loc,0),void r.forEach((function(e){e.draw(n)}))}for(var u=t.getRender().getBatchLightSize(),l=0;l<i.length;)l=this._uploadLights(e,t,n,i,u,l,0==l),r.forEach((function(e){e.draw(n)}))}else if(1==o){if(0==i.length)return;var f=null,m=t.getRender().getTileInfo(),h=m.tileSize,d=m.tileWidth,p=m.tileHeight,g=m.tileNum;if(this._reset(e,t,g),i.length>0){t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var S=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(S.m[0],S.m[4],S.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(S.m[1],S.m[5],S.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(S.m[0],S.m[4],S.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(S.m[1],S.m[5],S.m[9],1)}for(var v=0,y=i.length;v<y;v++)(f=this._lightClip(e,i[v]))&&this._tile(h,d,p,g,this._m_Tiles,f,v);this._tileLightDecode(e,n,g,this._m_Tiles,d,p,i),r.forEach((function(e){e.draw(n)}))}t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState())}}])&&m(t.prototype,n),r&&m(t,r),c}(i.default);t.default=y,v(y,"PROGRAM_TYPE","TilePassIBLLighting"),v(y,"S_CUR_LIGHT_COUNT","_curLightCount"),v(y,"S_AMBIENT_LIGHT_COLOR","_ambientLightColor"),v(y,"S_V_LIGHT_DATA","_vLightData"),v(y,"S_W_LIGHT_DATA","_wLightData"),v(y,"S_LIGHT_NUM_SRC","_lightNum"),v(y,"S_TILE_LIGHT_DECODE_SRC","_tileLightDecode"),v(y,"S_TILE_LIGHT_INDEX_SRC","_tileLightIndex"),v(y,"S_TILE_LIGHT_OFFSET_SIZE","_tileLightOffsetSize"),v(y,"S_TILE_W_LIGHT_DATA_0","_tileWLightData0"),v(y,"S_TILE_V_LIGHT_DATA_0","_tileVLightData0"),v(y,"S_TILE_W_LIGHT_DATA_1","_tileWLightData1"),v(y,"S_TILE_V_LIGHT_DATA_1","_tileVLightData1"),v(y,"S_TILE_W_LIGHT_DATA_2","_tileWLightData2"),v(y,"S_TILE_V_LIGHT_DATA_2","_tileVLightData2"),v(y,"S_PREF_ENV_MAP_SRC","_prefEnvMap"),v(y,"S_WGIPROBE_SRC","_wGIProbe"),v(y,"S_SH_COEFFS_SRC","_ShCoeffs"),v(y,"S_BLEND_GI_PROBES","_blend_gi_probes")},2390:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=f(n(1393)),o=f(n(2320)),a=f(n(8435)),_=f(n(2475)),s=f(n(5604)),u=f(n(7141)),l=f(n(5141));function f(e){return e&&e.__esModule?e:{default:e}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=g(e);if(t){var i=g(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return d(this,n)}}function d(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(f,e);var t,n,r,i=h(f);function f(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),S(p(t=i.call(this,e)),"_m_Tiles",[]),S(p(t),"_m_LightsIndex",[]),S(p(t),"_m_LightsDecode",[]),S(p(t),"_m_LightsDecodeData",null),S(p(t),"_m_LightsIndexData",null),S(p(t),"_m_LightsData0",null),S(p(t),"_m_LightsData1",null),S(p(t),"_m_LightsData2",null),S(p(t),"_m_LightsData0Array",[]),S(p(t),"_m_LightsData1Array",[]),S(p(t),"_m_LightsData2Array",[]),S(p(t),"_m_PV",null),S(p(t),"_m_Temp_Vec3",new s.default),S(p(t),"_m_Temp_Vec4",new u.default),S(p(t),"_m_Temp_Vec4_2",new u.default),S(p(t),"_m_Temp_Vec4_3",new u.default),S(p(t),"_m_Cam_Up",new u.default),S(p(t),"_m_Cam_Left",new u.default),S(p(t),"_m_Light_Left",new u.default),S(p(t),"_m_Light_Up",new u.default),S(p(t),"_m_Light_Center",new u.default),S(p(t),"_m_ViewPortWidth",-1),S(p(t),"_m_ViewPortHeight",-1),S(p(t),"_m_CamLeftCoeff",-1),S(p(t),"_m_CamTopCoeff",-1),t._m_AccumulationLights=new a.default,t._m_AccumulationLights.setFlag(a.default.S_STATES[4],"On"),t._m_AccumulationLights.setFlag(a.default.S_STATES[1],"Off"),t._m_AccumulationLights.setFlag(a.default.S_STATES[5],["ONE","ONE"]),t}return t=f,(n=[{key:"_createTexture",value:function(e,t,n,r){var i=new l.default(e);return e.getCanvas().getGLContext(),i.setTextureFormat(t,n,r),i.setWrap(e,l.default.S_WRAPS.S_CLAMP_TO_EDGE,l.default.S_WRAPS.S_CLAMP_TO_EDGE),i.setFilter(e,l.default.S_FILTERS.S_NEAREST,l.default.S_FILTERS.S_NEAREST),i.updateTextureFilter(),i.setAlignment(1),i}},{key:"_reset",value:function(e,t,n){this._m_LightsIndexData||(this._m_LightsIndexData=this._createTexture(t,e.RGB32F,e.RGB,e.FLOAT)),this._m_LightsDecodeData||(this._m_LightsDecodeData=this._createTexture(t,e.RGB32F,e.RGB,e.FLOAT)),this._m_LightsData0||(this._m_LightsData0=this._createTexture(t,e.RGBA32F,e.RGBA,e.FLOAT)),this._m_LightsData0Array.length=0,this._m_LightsData1||(this._m_LightsData1=this._createTexture(t,e.RGBA32F,e.RGBA,e.FLOAT)),this._m_LightsData1Array.length=0,this._m_LightsData2||(this._m_LightsData2=this._createTexture(t,e.RGBA32F,e.RGBA,e.FLOAT)),this._m_LightsData2Array.length=0;for(var r=0;r<n;r++)this._m_Tiles[r]=[];this._m_LightsDecode.length=0,this._m_LightsIndex.length=0}},{key:"_lightClip",value:function(e,t){var n=t.getBoundingVolume(),r=n.getRadius(),i=r*this._m_CamLeftCoeff,a=r*this._m_CamTopCoeff,_=n.getCenter(this._m_Temp_Vec3);_=this._m_Temp_Vec4.setToInXYZW(_._m_X,_._m_Y,_._m_Z,1),this._m_Temp_Vec4._m_W=1,this._m_Temp_Vec4_2._m_W=1,this._m_Temp_Vec4_3._m_W=1;var s=this._m_Cam_Left.multLength(i,this._m_Temp_Vec4_2).add(_),u=this._m_Cam_Up.multLength(a,this._m_Temp_Vec4_3).add(_);o.default.multiplyMV(this._m_Light_Left,s,this._m_PV),o.default.multiplyMV(this._m_Light_Up,u,this._m_PV),o.default.multiplyMV(this._m_Light_Center,_,this._m_PV),this._m_Light_Left._m_X/=this._m_Light_Left._m_W,this._m_Light_Left._m_Y/=this._m_Light_Left._m_W,this._m_Light_Up._m_X/=this._m_Light_Up._m_W,this._m_Light_Up._m_Y/=this._m_Light_Up._m_W,this._m_Light_Center._m_X/=this._m_Light_Center._m_W,this._m_Light_Center._m_Y/=this._m_Light_Center._m_W,this._m_Light_Left._m_X=this._m_ViewPortWidth*(1+this._m_Light_Left._m_X),this._m_Light_Up._m_X=this._m_ViewPortWidth*(1+this._m_Light_Up._m_X),this._m_Light_Center._m_X=this._m_ViewPortWidth*(1+this._m_Light_Center._m_X),this._m_Light_Left._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Left._m_Y),this._m_Light_Up._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Up._m_Y),this._m_Light_Center._m_Y=this._m_ViewPortHeight*(1-this._m_Light_Center._m_Y);var l=Math.abs(this._m_Light_Left._m_X-this._m_Light_Center._m_X),f=Math.abs(this._m_Light_Center._m_Y-this._m_Light_Up._m_Y),c=-1,m=-1;this._m_Light_Center._m_Z<-this._m_Light_Center._m_W?(c=-this._m_Light_Center._m_X-l,m=-this._m_Light_Center._m_Y+f):(c=this._m_Light_Center._m_X-l,m=this._m_Light_Center._m_Y+f);var h=2*this._m_ViewPortHeight-m;return{left:c,right:2*l+c,top:2*f+h,bottom:h}}},{key:"_tile",value:function(e,t,n,r,i,o,a){for(var _=Math.max(Math.floor(o.left/e),0),s=Math.min(Math.ceil(o.right/e),t),u=Math.max(Math.floor(o.bottom/e),0),l=Math.min(Math.ceil(o.top/e),n),f=0,c=_;c<s;c++)for(var m=u;m<l;m++)(f=c+m*t)>=0&&f<r&&i[f].push(a)}},{key:"_tileLightDecode",value:function(e,t,n,r,i,o,a){var _=t.m_LastSubShader.getContextVars(),s=-1;s=a.length;var u=null;if(null!=_[f.S_LIGHT_NUM_SRC]&&e.uniform1i(_[f.S_LIGHT_NUM_SRC].loc,s),null!=_[f.S_TILE_V_LIGHT_DATA_0])u=1;else{if(null==_[f.S_TILE_W_LIGHT_DATA_0])return 0;u=0}for(var l=0,c=0,m=null;l<n;l++){s=(m=r[l]).length;for(var h=0;h<s;h++)this._m_LightsIndex.push(m[h]),this._m_LightsIndex.push(0),this._m_LightsIndex.push(0);this._m_LightsDecode.push(c),this._m_LightsDecode.push(s),this._m_LightsDecode.push(-1),c+=s}var d=Math.ceil(Math.sqrt(this._m_LightsIndex.length/3));null!=_[f.S_TILE_LIGHT_OFFSET_SIZE]&&e.uniform1f(_[f.S_TILE_LIGHT_OFFSET_SIZE].loc,d);for(var p=this._m_LightsIndex.length,g=d*d*3;p<g;p++)this._m_LightsIndex.push(-1);for(var S=0,v=this._m_LightsDecode.length;S<v;S+=3)this._m_LightsDecode[S+2]=this._m_LightsDecode[S]/d,this._m_LightsDecode[S]%=d;null!=_[f.S_TILE_LIGHT_DECODE_SRC]&&this._m_LightsDecodeData.uploadArrayData(_[f.S_TILE_LIGHT_DECODE_SRC].loc,i,o,new Float32Array(this._m_LightsDecode)),null!=_[f.S_TILE_LIGHT_INDEX_SRC]&&this._m_LightsIndexData.uploadArrayData(_[f.S_TILE_LIGHT_INDEX_SRC].loc,d,d,new Float32Array(this._m_LightsIndex));var y=null,C=null;s=a.length;for(var T=0;T<s;T++)switch(C=(y=a[T]).getColor(),this._m_LightsData0Array.push(C._m_X),this._m_LightsData0Array.push(C._m_Y),this._m_LightsData0Array.push(C._m_Z),this._m_LightsData0Array.push(y.getTypeId()),y.getType()){case"PointLight":u||(this._m_LightsData1Array.push(y.getPosition()._m_X),this._m_LightsData1Array.push(y.getPosition()._m_Y),this._m_LightsData1Array.push(y.getPosition()._m_Z),this._m_LightsData1Array.push(y.getInRadius())),this._m_LightsData2Array.push(0),this._m_LightsData2Array.push(0),this._m_LightsData2Array.push(0),this._m_LightsData2Array.push(0);break;case"SpotLight":u||(this._m_LightsData1Array.push(y.getPosition()._m_X),this._m_LightsData1Array.push(y.getPosition()._m_Y),this._m_LightsData1Array.push(y.getPosition()._m_Z),this._m_LightsData1Array.push(y.getInvSpotRange())),this._m_LightsData2Array.push(y.getDirection()._m_X),this._m_LightsData2Array.push(y.getDirection()._m_Y),this._m_LightsData2Array.push(y.getDirection()._m_Z),this._m_LightsData2Array.push(y.getPackedAngleCos())}var b=_[f.S_TILE_W_LIGHT_DATA_0]?_[f.S_TILE_W_LIGHT_DATA_0]:_[f.S_TILE_V_LIGHT_DATA_0];return b&&this._m_LightsData0.uploadArrayData(b.loc,this._m_LightsData0Array.length/4,1,new Float32Array(this._m_LightsData0Array)),(b=_[f.S_TILE_W_LIGHT_DATA_1]?_[f.S_TILE_W_LIGHT_DATA_1]:_[f.S_TILE_V_LIGHT_DATA_1])&&this._m_LightsData1.uploadArrayData(b.loc,this._m_LightsData1Array.length/4,1,new Float32Array(this._m_LightsData1Array)),(b=_[f.S_TILE_W_LIGHT_DATA_2]?_[f.S_TILE_W_LIGHT_DATA_2]:_[f.S_TILE_V_LIGHT_DATA_2])&&this._m_LightsData2.uploadArrayData(b.loc,this._m_LightsData2Array.length/4,1,new Float32Array(this._m_LightsData2Array)),1}},{key:"_uploadLights",value:function(e,t,n,r,i,a){var s=n.m_LastSubShader.getContextVars();if(null!=s[f.S_AMBIENT_LIGHT_COLOR])if(0==a){var u=t.AmbientLightColor;e.uniform3f(s[f.S_AMBIENT_LIGHT_COLOR].loc,u._m_X,u._m_Y,u._m_Z)}else e.uniform3f(s[f.S_AMBIENT_LIGHT_COLOR].loc,0,0,0),t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState());var l=null,c=null;null!=s[f.S_V_LIGHT_DATA]?(c=1,l=s[f.S_V_LIGHT_DATA].loc):null!=s[f.S_W_LIGHT_DATA]&&(c=0,l=s[f.S_W_LIGHT_DATA].loc);var m=i+a>r.length?r.length-a:i;if(null==l)return m+a;for(var h=null,d=null,p=_.default.S_LIGHT_DATA,g=p.getArray(),S=_.default.S_TEMP_VEC4,v=_.default.S_TEMP_VEC4_2,y=a,C=0,T=m+a;y<T;y++,C+=12)d=(h=r[y]).getColor(),g[C]=d._m_X,g[C+1]=d._m_Y,g[C+2]=d._m_Z,g[C+3]=h.getTypeId(),"DirectionalLight"===h.getType()&&(c?(v.setToInXYZW(h.getDirection()._m_X,h.getDirection()._m_Y,h.getDirection()._m_Z,0),o.default.multiplyMV(S,v,t.getMainCamera().getViewMatrix()),g[C+4]=S._m_X,g[C+5]=S._m_Y,g[C+6]=S._m_Z,g[C+7]=-1):(g[C+4]=h.getDirection()._m_X,g[C+5]=h.getDirection()._m_Y,g[C+6]=h.getDirection()._m_Z,g[C+7]=-1),g[C+8]=0,g[C+9]=0,g[C+10]=0,g[C+11]=0);return e.uniform4fv(l,p.getBufferData(),0,12*m),null!=s[f.S_CUR_LIGHT_COUNT]&&e.uniform1i(s[f.S_CUR_LIGHT_COUNT].loc,3*m),m+a}},{key:"draw",value:function(e,t,n,r,i,o){if(n.getRenderState().store(),0==o){if(0==i.length){var a=n.m_LastSubShader.getContextVars();if(null!=a[f.S_AMBIENT_LIGHT_COLOR]){var _=t.AmbientLightColor;e.uniform3f(a[f.S_AMBIENT_LIGHT_COLOR].loc,_._m_X,_._m_Y,_._m_Z)}return null!=a[f.S_CUR_LIGHT_COUNT]&&e.uniform1i(a[f.S_CUR_LIGHT_COUNT].loc,0),void r.draw(n)}for(var s=t.getRender().getBatchLightSize(),u=0;u<i.length;)u=this._uploadLights(e,t,n,i,s,u),r.draw(n)}else if(1==o){if(0==i.length)return;var l=null,c=t.getRender().getTileInfo(),m=c.tileSize,h=c.tileWidth,d=c.tileHeight,p=c.tileNum;if(this._reset(e,t,p),i.length>0){t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var g=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(g.m[0],g.m[4],g.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(g.m[1],g.m[5],g.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(g.m[0],g.m[4],g.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(g.m[1],g.m[5],g.m[9],1)}for(var S=0,v=i.length;S<v;S++)(l=this._lightClip(e,i[S]))&&this._tile(m,h,d,p,this._m_Tiles,l,S);this._tileLightDecode(e,n,p,this._m_Tiles,h,d,i),r.draw(n)}t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState())}},{key:"drawArrays",value:function(e,t,n,r,i,o){if(n.getRenderState().store(),0==o){if(0==i.length){var a=n.m_LastSubShader.getContextVars();if(null!=a[f.S_AMBIENT_LIGHT_COLOR]){var _=t.AmbientLightColor;e.uniform3f(a[f.S_AMBIENT_LIGHT_COLOR].loc,_._m_X,_._m_Y,_._m_Z)}return null!=a[f.S_CUR_LIGHT_COUNT]&&e.uniform1i(a[f.S_CUR_LIGHT_COUNT].loc,0),void r.forEach((function(e){e.draw(n)}))}for(var s=t.getRender().getBatchLightSize(),u=0;u<i.length;)u=this._uploadLights(e,t,n,i,s,u),r.forEach((function(e){e.draw(n)}))}else if(1==o){if(0==i.length)return;var l=null,c=t.getRender().getTileInfo(),m=c.tileSize,h=c.tileWidth,d=c.tileHeight,p=c.tileNum;if(this._reset(e,t,p),i.length>0){t.getRender()._checkRenderState(e,this._m_AccumulationLights,n.getRenderState()),this._m_ViewPortWidth=.5*t.getMainCamera().getWidth(),this._m_ViewPortHeight=.5*t.getMainCamera().getHeight(),this._m_PV=t.getMainCamera().getProjectViewMatrix(!0);var g=t.getMainCamera().getViewMatrix();this._m_Temp_Vec3.setToInXYZ(g.m[0],g.m[4],g.m[8]),this._m_CamLeftCoeff=1/t.getMainCamera().getFrustumPlane(1).getNormal().dot(this._m_Temp_Vec3),this._m_Temp_Vec3.setToInXYZ(g.m[1],g.m[5],g.m[9]),this._m_CamTopCoeff=1/t.getMainCamera().getFrustumPlane(2).getNormal().dot(this._m_Temp_Vec3),this._m_Cam_Left.setToInXYZW(g.m[0],g.m[4],g.m[8],1).multLength(-1),this._m_Cam_Up.setToInXYZW(g.m[1],g.m[5],g.m[9],1)}for(var S=0,v=i.length;S<v;S++)(l=this._lightClip(e,i[S]))&&this._tile(m,h,d,p,this._m_Tiles,l,S);this._tileLightDecode(e,n,p,this._m_Tiles,h,d,i),r.forEach((function(e){e.draw(n)}))}t.getRender()._checkRenderState(e,n.getRenderState().restore(),n.getRenderState())}}])&&c(t.prototype,n),r&&c(t,r),f}(i.default);t.default=v,S(v,"PROGRAM_TYPE","TilePassLighting"),S(v,"S_CUR_LIGHT_COUNT","_curLightCount"),S(v,"S_AMBIENT_LIGHT_COLOR","_ambientLightColor"),S(v,"S_V_LIGHT_DATA","_vLightData"),S(v,"S_W_LIGHT_DATA","_wLightData"),S(v,"S_LIGHT_NUM_SRC","_lightNum"),S(v,"S_TILE_LIGHT_DECODE_SRC","_tileLightDecode"),S(v,"S_TILE_LIGHT_INDEX_SRC","_tileLightIndex"),S(v,"S_TILE_LIGHT_OFFSET_SIZE","_tileLightOffsetSize"),S(v,"S_TILE_W_LIGHT_DATA_0","_tileWLightData0"),S(v,"S_TILE_V_LIGHT_DATA_0","_tileVLightData0"),S(v,"S_TILE_W_LIGHT_DATA_1","_tileWLightData1"),S(v,"S_TILE_V_LIGHT_DATA_1","_tileVLightData1"),S(v,"S_TILE_W_LIGHT_DATA_2","_tileWLightData2"),S(v,"S_TILE_V_LIGHT_DATA_2","_tileVLightData2")},3061:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=R(n(6798)),o=R(n(9650)),a=R(n(8435)),_=R(n(7341)),s=R(n(9784)),u=R(n(4008)),l=R(n(8113)),f=R(n(1393)),c=R(n(6148)),m=R(n(8546)),h=R(n(3846)),d=R(n(3370)),p=R(n(9510)),g=R(n(2475)),S=R(n(5734)),v=R(n(870)),y=R(n(4658)),C=R(n(8388)),T=R(n(2390)),b=R(n(6987)),P=R(n(2987)),E=R(n(1759)),D=R(n(1491));function R(e){return e&&e.__esModule?e:{default:e}}function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function M(e,t){return M=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},M(e,t)}function A(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I(e);if(t){var i=I(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return L(this,n)}}function L(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function I(e){return I=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},I(e)}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var O=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&M(e,t)}(R,e);var t,n,r,o=A(R);function R(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,R),(n=o.call(this,e,t))._m_Drawables=[],n._m_DrawableIDs={},n._m_VisDrawables=[],n._m_FramePictures=[],n._m_FramePictureIDs=[],n._m_Sky=null,n._m_Pipeline={},n._m_PipelineConfig={},n._m_PriorityTechnology="",n._m_PostFilterSwap=0,n._m_PostFilterPipelineSwap=[],n._m_FrameContext=new i.default,n._m_RenderPrograms={},n._m_OpaqueRenderState=new a.default,n._m_TranslucentRenderState=new a.default,n._m_TranslucentRenderState.setFlag(a.default.S_STATES[4],"On"),n._m_TranslucentRenderState.setFlag(a.default.S_STATES[5],["SRC_ALPHA","ONE_MINUS_SRC_ALPHA"]),n._m_BatchLightSize=4,n._m_GammaCorrection=!0,n._m_GammaFactor=.45,n._m_ToneMapping=!1,n._m_TileInfo={tileSize:0,tileWidth:0,tileHeight:0,tileNum:0},n._m_Scene.getCanvas().on("resize",(function(e,t){n.updateTileInfo(e,t)})),n.setTileSize(32),n}return t=R,(n=[{key:"getType",value:function(){return"Render"}},{key:"updateTileInfo",value:function(e,t){var n=this._m_TileInfo.tileSize;this._m_TileInfo.tileWidth=Math.floor(e/n),this._m_TileInfo.tileHeight=Math.floor(t/n),this._m_TileInfo.tileNum=this._m_TileInfo.tileWidth*this._m_TileInfo.tileHeight}},{key:"setTileSize",value:function(e){e!=this._m_TileInfo.tileSize&&(this._m_TileInfo.tileSize=e,this.updateTileInfo(this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight()))}},{key:"getTileInfo",value:function(){return this._m_TileInfo}},{key:"setPriorityTechnology",value:function(e){this._m_PriorityTechnology=e}},{key:"getPriorityTechnology",value:function(){return this._m_PriorityTechnology}},{key:"setBatchLightSize",value:function(e){e!=this._m_BatchLightSize&&(e>50&&(e=50),g.default.mallocLightData(e),this._m_BatchLightSize=e,s.default.resizeBatchLightSize(e))}},{key:"getBatchLightSize",value:function(){return this._m_BatchLightSize}},{key:"startUp",value:function(){var e=this,t=this._m_Scene.getCanvas().getGLContext(),n=t.getExtension("WEBKIT_WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture");h.default.debug("depthEXT:",n);var r=this._m_Scene.getCanvas().getWidth(),i=this._m_Scene.getCanvas().getHeight(),o=new _.default(t,R.DEFAULT_DEFERRED_SHADING_FRAMEBUFFER,r,i);this._m_FrameContext.addFrameBuffer(R.DEFAULT_DEFERRED_SHADING_FRAMEBUFFER,o),o.addTexture(t,s.default.S_G_BUFFER0_SRC,t.RGBA16F,0,t.RGBA,t.FLOAT,t.COLOR_ATTACHMENT0,!0),o.addTexture(t,s.default.S_G_BUFFER1_SRC,t.RGBA32F,0,t.RGBA,t.FLOAT,t.COLOR_ATTACHMENT1,!0),o.addTexture(t,s.default.S_G_BUFFER2_SRC,t.RGBA16F,0,t.RGBA,t.FLOAT,t.COLOR_ATTACHMENT2,!0),o.addTexture(t,s.default.S_G_DEPTH_SRC,t.DEPTH_COMPONENT24,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,t.DEPTH_ATTACHMENT,!1),o.finish(t,this._m_Scene,!0);var a=new _.default(t,R.DEFAULT_FORWARD_SHADING_FRAMEBUFFER,r,i);this._m_FrameContext.addFrameBuffer(R.DEFAULT_FORWARD_SHADING_FRAMEBUFFER,a),a.addTexture(t,s.default.S_FORWARD_COLOR_MAP_SRC,t.RGBA16F,0,t.RGBA,t.FLOAT,t.COLOR_ATTACHMENT0,!1),a.addBuffer(t,"depth",t.DEPTH_COMPONENT24,t.DEPTH_ATTACHMENT),a.finish(t,this._m_Scene,!0);var p=new u.default(this._m_Scene,{id:"for_m",frameContext:this.getFrameContext(),materialDef:l.default.parse(d.default.S_DEFAULT_OUT_COLOR_DEF_DATA)});p.setParam("gammaFactor",(new E.default).valueOf(this._m_GammaFactor)),a.getFramePicture().setMaterial(p),this._m_FrameContext._m_DefaultFrameBuffer=a.getFrameBuffer();var g=new _.default(t,R.DEFAULT_POST_FILTER_SHADING_FRAMEBUFFER,r,i);this._m_PostFilterPipelineSwap.push(g),this._m_FrameContext.addFrameBuffer(R.DEFAULT_POST_FILTER_SHADING_FRAMEBUFFER,g),g.addTexture(t,s.default.S_IN_SCREEN_SRC,t.RGBA16F,0,t.RGBA,t.FLOAT,t.COLOR_ATTACHMENT0,!1),g.addTexture(t,s.default.S_IN_DEPTH_SRC,t.DEPTH_COMPONENT24,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,t.DEPTH_ATTACHMENT,!1),g.finish(t,this._m_Scene,!1),this._m_FrameContext._m_DefaultPostFilterFrameBuffer=g.getFrameBuffer();var D=new _.default(t,R.DEFAULT_POST_FILTER_SHADING_FRAMEBUFFER2,r,i);this._m_PostFilterPipelineSwap.push(D),this._m_FrameContext.addFrameBuffer(R.DEFAULT_POST_FILTER_SHADING_FRAMEBUFFER2,D),D.addTexture(t,s.default.S_IN_SCREEN_SRC,t.RGBA16F,0,t.RGBA,t.FLOAT,t.COLOR_ATTACHMENT0,!1),D.addTexture(t,s.default.S_IN_DEPTH_SRC,t.DEPTH_COMPONENT24,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,t.DEPTH_ATTACHMENT,!1),D.finish(t,this._m_Scene,!1),this._m_RenderPrograms[f.default.PROGRAM_TYPE]=new f.default,this._m_RenderPrograms[c.default.PROGRAM_TYPE]=new c.default,this._m_RenderPrograms[y.default.PROGRAM_TYPE]=new y.default,this._m_RenderPrograms[m.default.PROGRAM_TYPE]=new m.default,this._m_RenderPrograms[C.default.PROGRAM_TYPE]=new C.default,this._m_RenderPrograms[T.default.PROGRAM_TYPE]=new T.default,this._m_RenderPrograms[P.default.PROGRAM_TYPE]=new P.default,this._m_PipelineConfig[R.FORWARD]=new S.default({render:this}),this._m_PipelineConfig[R.DEFERRED_SHADING]=new v.default({render:this}),this._m_PipelineConfig[R.TILE_DEFERRED_SHADING]=new b.default({render:this}),this.enablePipeline(R.FORWARD),this.enablePipeline(R.DEFERRED_SHADING),this._m_Scene.getCanvas().on("resize",(function(n,r){e._m_FrameContext.resize(t,n,r),e._m_FrameContext._m_DefaultFrameBuffer=e._m_FrameContext.getFrameBuffer(R.DEFAULT_FORWARD_SHADING_FRAMEBUFFER).getFrameBuffer(),e._m_FrameContext._m_DefaultPostFilterFrameBuffer=e._m_FrameContext.getFrameBuffer(R.DEFAULT_POST_FILTER_SHADING_FRAMEBUFFER).getFrameBuffer()}))}},{key:"beginPostFilter",value:function(){var e=this._m_Scene.getCanvas().getGLContext();e.bindFramebuffer(e.READ_FRAMEBUFFER,this._m_FrameContext._m_DefaultFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._m_FrameContext._m_DefaultPostFilterFrameBuffer),e.blitFramebuffer(0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight(),0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight(),e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,this._m_PostFilterPipelineSwap[1].getFrameBuffer()),"On"==this._m_FrameContext.getRenderState().getFlag(a.default.S_STATES[3])&&e.disable(e.DEPTH_TEST)}},{key:"swapPostFilter",value:function(){var e=this._m_Scene.getCanvas().getGLContext();e.bindFramebuffer(e.READ_FRAMEBUFFER,this._m_PostFilterPipelineSwap[1].getFrameBuffer()),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._m_FrameContext._m_DefaultPostFilterFrameBuffer),e.blitFramebuffer(0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight(),0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight(),e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,this._m_PostFilterPipelineSwap[1].getFrameBuffer())}},{key:"finishPostFilter",value:function(){var e=this._m_Scene.getCanvas().getGLContext();e.bindFramebuffer(e.READ_FRAMEBUFFER,this._m_FrameContext._m_DefaultPostFilterFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._m_FrameContext._m_DefaultFrameBuffer),e.blitFramebuffer(0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight(),0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight(),e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,this._m_FrameContext._m_DefaultFrameBuffer)}},{key:"enablePipeline",value:function(e){var t=-1;switch(e){case R.FORWARD:t=0;break;case R.DEFERRED_SHADING:case R.TILE_DEFERRED_SHADING:t=1}t>=0?this._m_Pipeline[t]=this._m_PipelineConfig[e]:h.default.warn("无效pipeline!")}},{key:"getVisDrawables",value:function(){return this._m_VisDrawables}},{key:"getDrawableIDs",value:function(){return this._m_DrawableIDs}},{key:"getFrameContext",value:function(){return this._m_FrameContext}},{key:"setSky",value:function(e){this._m_Sky!=e&&(this._m_Sky=e)}},{key:"getSky",value:function(){return this._m_Sky}},{key:"addDrawable",value:function(e){e.isFramePicture&&e.isFramePicture()?this._m_FramePictureIDs[e.getId()]||(this._m_FramePictureIDs[e.getId()]=e,this._m_FramePictures.push(e)):e.isSky&&e.isSky()||this._m_DrawableIDs[e.getId()]||(this._m_DrawableIDs[e.getId()]=e,this._m_Drawables.push(e))}},{key:"removeDrawable",value:function(e){this._m_DrawableIDs[e.getId()]&&(this._m_DrawableIDs[e.getId()]=null,this._m_Drawables.remove(e))}},{key:"_checkRenderState",value:function(e,t,n){var r=t.getState(),i=!1;for(var o in r)if(n.getFlag(o)!=r[o])switch(i=!0,n.setFlag(o,r[o]),o){case a.default.S_STATES[0]:switch(r[o]){case a.default.S_FACE_CULL_BACK:e.enable(e.CULL_FACE),e.cullFace(e.BACK);break;case a.default.S_FACE_CULL_FRONT:e.enable(e.CULL_FACE),e.cullFace(e.FRONT);break;case a.default.S_FACE_CULL_FRONT_AND_BACK:e.enable(e.CULL_FACE),e.cullFace(e.FRONT_AND_BACK);break;case a.default.S_FACE_CULL_OFF:e.disable(e.CULL_FACE)}break;case a.default.S_STATES[1]:"On"==r[o]?e.depthMask(!0):"Off"==r[o]&&e.depthMask(!1);break;case a.default.S_STATES[2]:"On"==r[o]?e.colorMask(!0,!0,!0,!0):"Off"==r[o]&&e.colorMask(!1,!1,!1,!1);break;case a.default.S_STATES[3]:"On"==r[o]?e.enable(e.DEPTH_TEST):"Off"==r[o]&&e.disable(e.DEPTH_TEST);break;case a.default.S_STATES[4]:"On"==r[o]?e.enable(e.BLEND):"Off"==r[o]&&e.disable(e.BLEND);break;case a.default.S_STATES[5]:var _=null,s=null;switch(r[o][0]){case"SRC_ALPHA":_=e.SRC_ALPHA;break;case"ONE":_=e.ONE}switch(r[o][1]){case"SRC_ALPHA":s=e.SRC_ALPHA;case"ONE_MINUS_SRC_COLOR":s=e.ONE_MINUS_SRC_COLOR;break;case"ONE_MINUS_SRC_ALPHA":s=e.ONE_MINUS_SRC_ALPHA;break;case"ONE":s=e.ONE}null!=_&&null!=s&&e.blendFunc(_,s);break;case a.default.S_STATES[6]:"On"==r[o]?e.enable(e.SCISSOR_TEST):"Off"==r[o]&&e.disable(e.SCISSOR_TEST);break;case a.default.S_STATES[7]:"On"==r[o]?e.enable(e.POLYGON_OFFSET_FILL):"Off"==r[o]&&e.disable(e.POLYGON_OFFSET_FILL);break;case a.default.S_STATES[8]:e.polygonOffset(r[o][0],r[o][1])}return i}},{key:"_resetFrameContext",value:function(){this._m_FrameContext.reset()}},{key:"_drawFrame",value:function(e){var t=this._m_Scene.getCanvas().getGLContext();this.fire(R.PRE_FRAME,[e]),this._resetFrameContext(),this._checkRenderState(t,this._m_FrameContext.getRenderState().reset(),this._m_FrameContext.getRenderState());var n=this._m_VisDrawables,r=!1,i=!1,o=!1,_=!1,s=this._m_Scene.getVisLights(),u={},l=[],f=[];n.forEach((function(e){e.isGUI()?(o=!0,f[e.getMaterial().getId()]||(f[e.getMaterial().getId()]=[]),f[e.getMaterial().getId()].push(e)):e.isOpaque()?(r=!0,u[e.getMaterial().getId()]||(u[e.getMaterial().getId()]=[]),u[e.getMaterial().getId()].push(e)):e.isTranslucent()&&(i=!0,l.push(e))})),this.fire(R.POST_QUEUE,[e]),r&&this._checkRenderState(t,this._m_OpaqueRenderState,this._m_FrameContext.getRenderState()),_=this._m_Pipeline[1].render({gl:t,scene:this._m_Scene,frameContext:this._m_FrameContext,lights:s,bucket:u});var c=this._m_Scene.getMainCamera().demandFilter();if(_||((this._m_GammaCorrection||c)&&(_=!0,t.bindFramebuffer(t.FRAMEBUFFER,this._m_FrameContext._m_DefaultFrameBuffer),this._m_FrameContext.m_LastFrameBuffer=this._m_FrameContext._m_DefaultFrameBuffer),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)),this._m_Pipeline[0].render({gl:t,scene:this._m_Scene,frameContext:this._m_FrameContext,lights:s,opaque:!0,bucket:u}),this._drawEnv(t,s),i&&(this._checkRenderState(t,this._m_TranslucentRenderState,this._m_FrameContext.getRenderState()),l=p.default.sortTranslucentBucket(this._m_Scene.getMainCamera(),l),this._m_Pipeline[0].render({gl:t,scene:this._m_Scene,frameContext:this._m_FrameContext,lights:s,translucent:!0,bucket:l})),c&&this.beginPostFilter(),this.fire(R.POST_FRAME,[e]),c&&("On"==this._m_FrameContext.getRenderState().getFlag(a.default.S_STATES[3])&&t.enable(t.DEPTH_TEST),this.finishPostFilter()),o&&(this._checkRenderState(t,this._m_TranslucentRenderState,this._m_FrameContext.getRenderState()),this._m_Pipeline[0].render({gl:t,scene:this._m_Scene,frameContext:this._m_FrameContext,lights:s,opaque:!0,bucket:f})),_){t.bindFramebuffer(t.FRAMEBUFFER,null);var m=this._m_FrameContext.getFrameBuffer(R.DEFAULT_FORWARD_SHADING_FRAMEBUFFER).getFramePicture(),h=m.getMaterial().getCurrentTechnology().getSubPasss(R.FORWARD);m.getMaterial()._selectSubShader(h.getSubShaders()[0].subShader);var d=h.getSubShaders()[0].subShader.getRenderDatas();for(var g in"On"==this._m_FrameContext.getRenderState().getFlag(a.default.S_STATES[3])&&t.disable(t.DEPTH_TEST),d)t.activeTexture(t.TEXTURE0+d[g].loc),t.bindTexture(t.TEXTURE_2D,this._m_FrameContext.getFrameBuffer(d[g].refId).getTexture(d[g].dataId).getLoc());m.draw(this._m_FrameContext),"On"==this._m_FrameContext.getRenderState().getFlag(a.default.S_STATES[3])&&t.enable(t.DEPTH_TEST),this._m_FrameContext.m_LastFrameBuffer=null}}},{key:"useDefaultFrame",value:function(){if(null!=this._m_FrameContext.m_LastFrameBuffer){var e=this._m_Scene.getCanvas().getGLContext();e.bindFramebuffer(e.FRAMEBUFFER,null),this._m_FrameContext.m_LastFrameBuffer=null}}},{key:"setViewPort",value:function(e,t,n,r,i){e.viewport(t,n,r,i)}},{key:"useForcedMat",value:function(e,t,n){var r=t.getCurrentTechnology().getSubPasss(e);if(r){var i=r.getSubShaders(),o=0;for(var a in i){if(o==n){t._selectSubShader(i[a].subShader);var _=i[a].subShader.getRenderDatas(),s=this._m_Scene.getCanvas().getGLContext();for(var u in _)s.activeTexture(s.TEXTURE0+_[u].loc),s.bindTexture(s.TEXTURE_2D,this._m_FrameContext.getFrameBuffer(_[u].refId).getTexture(_[u].dataId).getLoc());break}o++}}}},{key:"draw",value:function(e,t,n,r){var i=null,o=null,a=null;if(n){var _=this._m_FrameContext.m_LastFrameBuffer,s=null;for(var u in n)if(a=(o=this._m_Scene.getComponent(u)).getCurrentTechnology().getSubPasss(t))for(var l in i=a.getSubShaders()){o._selectSubShader(i[l].subShader),null!=i[l].subShader.getFBId()?(s=this._m_FrameContext.getFrameBuffer(i[l].subShader.getFBId()),this._m_FrameContext.m_LastFrameBuffer!=s&&(this._m_FrameContext.m_LastFrameBuffer=s,e.bindFramebuffer(e.FRAMEBUFFER,s.getFrameBuffer()),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT))):this._m_FrameContext.m_LastFrameBuffer!=_&&(e.bindFramebuffer(e.FRAMEBUFFER,_),this._m_FrameContext.m_LastFrameBuffer=_);var f=i[l].subShader.getRenderDatas();for(var c in f)e.activeTexture(e.TEXTURE0+f[c].loc),e.bindTexture(e.TEXTURE_2D,this._m_FrameContext.getFrameBuffer(f[c].refId).getTexture(f[c].dataId).getLoc());i[l].renderState&&this._checkRenderState(e,i[l].renderState,this._m_FrameContext.getRenderState()),this._m_RenderPrograms[i[l].subShader.getRenderProgramType()].drawArrays(e,this._m_Scene,this._m_FrameContext,n[u],r)}this._m_FrameContext.m_LastFrameBuffer!=_&&(e.bindFramebuffer(e.FRAMEBUFFER,_),this._m_FrameContext.m_LastFrameBuffer=_)}}},{key:"_drawEnv",value:function(e,t){if(this._m_Sky){var n=null,r=this._m_Sky.getMaterial(),i=r.getCurrentTechnology().getSubPasss(R.FORWARD);if(i)for(var o in n=i.getSubShaders())n[o].renderState&&this._checkRenderState(e,n[o].renderState,this._m_FrameContext.getRenderState()),r._selectSubShader(n[o].subShader),this._m_RenderPrograms[n[o].subShader.getRenderProgramType()].draw(e,this._m_Scene,this._m_FrameContext,this._m_Sky,t)}}},{key:"enableGammaCorrection",value:function(e){this._m_GammaCorrection=e}},{key:"enableToneMapping",value:function(e){e!=this._m_ToneMapping&&(this._m_ToneMapping=e,this._m_FrameContext.getFrameBuffer(R.DEFAULT_FORWARD_SHADING_FRAMEBUFFER).getFramePicture().getMaterial().setParam("toneMapping",(new D.default).valueOf(this._m_ToneMapping)))}},{key:"setGammaFactor",value:function(e){e!=this._m_GammaFactor&&(this._m_GammaFactor=e,this._m_FrameContext.getFrameBuffer(R.DEFAULT_FORWARD_SHADING_FRAMEBUFFER).getFramePicture().getMaterial().setParam("gammaFactor",(new E.default).valueOf(this._m_GammaFactor)))}},{key:"render",value:function(e){this._drawFrame(e)}},{key:"_sortDrawList",value:function(){}}])&&w(t.prototype,n),r&&w(t,r),R}(o.default);t.default=O,x(O,"FORWARD","Forward"),x(O,"DEFERRED_SHADING","DeferredShading"),x(O,"TILE_DEFERRED_SHADING","TileDeferredShading"),x(O,"DEFAULT_DEFERRED_SHADING_FRAMEBUFFER","DefaultDeferredShadingFrameBuffer"),x(O,"DEFAULT_FORWARD_SHADING_FRAMEBUFFER","DefaultForwardShadingFrameBuffer"),x(O,"DEFAULT_POST_FILTER_SHADING_FRAMEBUFFER","DefaultPostFilterShadingFrameBuffer"),x(O,"DEFAULT_POST_FILTER_SHADING_FRAMEBUFFER2","DefaultPostFilterShadingFrameBuffer2"),x(O,"PRE_FRAME","preFrame"),x(O,"POST_QUEUE","postQueue"),x(O,"POST_FRAME","postFrame")},9510:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.m_OpaqueBucket={},this.m_TranslucentBucket={}}var t,r,i;return t=e,i=[{key:"sortTranslucentBucket",value:function(t,n){var r=e._TEMP_BUCKET_ARRAY;r.length=0;var i=e._TEMP_ARRAY;i.length=0;var o=t.getEye();return n.forEach((function(e){i.push([e.getLocalTranslation().distanceSq(o),e])})),i.sort((function(e,t){return t[0]-e[0]})),i.forEach((function(e){r.push(e[1])})),r}}],(r=[{key:"addToOpaque",value:function(e){}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=i,r(i,"_TEMP_BUCKET_ARRAY",[]),r(i,"_TEMP_ARRAY",[])},1550:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=h(n(9650)),o=h(n(5604)),a=h(n(2320)),_=h(n(2475)),s=h(n(9784)),u=h(n(7088)),l=h(n(431)),f=h(n(3846)),c=h(n(3061)),m=h(n(7120));function h(e){return e&&e.__esModule?e:{default:e}}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function g(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=v(e);if(t){var i=v(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S(this,n)}}function S(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var C=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(h,e);var t,n,r,i=g(h);function h(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),(n=i.call(this,e,t))._m_Eye=new o.default(0,0,10),n._m_At=new o.default(0,0,-10),n._m_Up=new o.default(0,1,0),n._m_Dir=new o.default,n._m_ViewMatrix=new a.default,n._m_ProjectMatrix=new a.default,n._m_ProjectViewMatrix=new a.default,n._m_ViewMatrixUpdate=!1,n._m_ProjectMatrixUpdate=!1,n._m_ProjectViewMatrixUpdate=!1,n._m_ParallelProjection=null!=t.parallelProjection&&t.parallelProjection,n._m_Fovy=t.fovy||45,n._m_FixedAspect=null!=t.aspect&&t.aspect,n._m_IsRenderingCamera=!1,n._m_FrustumPlane=[];for(var r=0;r<6;r++)n._m_FrustumPlane.push(new u.default);n._m_FrustumNear=.1,n._m_FrustumFar=1e3,n._m_FrustumLeft=0,n._m_FrustumRight=0,n._m_FrustumTop=0,n._m_FrustumBottom=0,n._m_CoeffLeft=new Array(2).fill(0),n._m_CoeffRight=new Array(2).fill(0),n._m_CoeffBottom=new Array(2).fill(0),n._m_CoeffTop=new Array(2).fill(0),n._m_FrustumMask=0;var _=n._m_Scene.getCanvas(),s=_.getGLContext();return n._m_Width=t.width||_.getWidth(),n._m_Height=t.height||_.getHeight(),n._m_FixedSize=null!=t.fixedSize&&t.fixedSize,n._m_ViewMatrix.lookAt(n._m_Eye,n._m_At,n._m_Up),n._m_ViewMatrixUpdate=!0,n._m_ProjectMatrixUpdate=!0,n._m_UpdateCameraPosition=!0,s.viewport(0,0,n._m_Width,n._m_Height),n._init(),_.on("resize",(function(){n._m_FixedSize||(n._m_Width=_.getWidth(),n._m_Height=_.getHeight(),n._m_IsRenderingCamera&&s.viewport(0,0,n._m_Width,n._m_Height),n._m_ParallelProjection?n._m_ProjectMatrix.parallelM(n._m_FrustumLeft,n._m_FrustumRight,n._m_FrustumTop,n._m_FrustumBottom,n._m_FrustumNear,n._m_FrustumFar):n._m_ProjectMatrix.perspectiveM(n._m_Fovy,n._m_FixedAspect?n._m_FixedAspect:1*n._m_Width/n._m_Height,n._m_FrustumNear,n._m_FrustumFar),n._m_ProjectMatrixUpdate=!0),n._doUpdate()})),n._m_Filters=[],n._m_Scene.getRender().on(c.default.POST_QUEUE,(function(e){n._m_IsRenderingCamera&&n.demandFilter()&&n._m_Filters.forEach((function(e){e.isEnable()&&e.preFrame()}))})),n._m_Scene.getRender().on(c.default.POST_FRAME,(function(e){n._m_IsRenderingCamera&&n.demandFilter()&&n._m_Filters.forEach((function(e){e.isEnable()&&(e.postFilter(),n._m_Scene.getRender().swapPostFilter())}))})),n}return t=h,(n=[{key:"_init",value:function(){if(this._m_ParallelProjection)this._m_FrustumNear=1,this._m_FrustumFar=2,this._m_FrustumLeft=-.5,this._m_FrustumRight=.5,this._m_FrustumTop=.5,this._m_FrustumBottom=-.5,this._m_ProjectMatrix.parallelM(this._m_FrustumLeft,this._m_FrustumRight,this._m_FrustumTop,this._m_FrustumBottom,this._m_FrustumNear,this._m_FrustumFar);else{var e=1*this._m_Width/this._m_Height,t=.1*Math.tan(.5*l.default.toRadians(this._m_Fovy)),n=t*e;f.default.debug("w:"+n+";h:"+t+";as:"+e),this._m_FrustumLeft=-n,this._m_FrustumRight=n,this._m_FrustumBottom=-t,this._m_FrustumTop=t,this._m_FrustumNear=.1,this._m_FrustumFar=1e3,this._m_ProjectMatrix.perspectiveM(this._m_Fovy,this._m_FixedAspect?this._m_FixedAspect:1*this._m_Width/this._m_Height,this._m_FrustumNear,this._m_FrustumFar)}var r=this._m_Scene.getRender().getFrameContext(),i=this._m_Scene.getCanvas().getGLContext();if(r.getContextBlock("MAT"))this.MAT=r.getContextBlock("MAT");else{var o=i.createBuffer();this.MAT=o,i.bindBuffer(i.UNIFORM_BUFFER,o),i.bufferData(i.UNIFORM_BUFFER,192,i.STATIC_DRAW),i.bindBuffer(i.UNIFORM_BUFFER,null),i.bindBufferRange(i.UNIFORM_BUFFER,s.default.BLOCKS.MAT.blockIndex,o,0,192),r.addContextBlock("MAT",this.MAT)}if(r.getContextBlock("VIEW"))this.VIEW=r.getContextBlock("VIEW");else{var a=i.createBuffer();this.VIEW=a,i.bindBuffer(i.UNIFORM_BUFFER,a),i.bufferData(i.UNIFORM_BUFFER,12,i.STATIC_DRAW),i.bindBuffer(i.UNIFORM_BUFFER,null),i.bindBufferRange(i.UNIFORM_BUFFER,s.default.BLOCKS.VIEW.blockIndex,a,0,12),r.addContextBlock("VIEW",this.VIEW)}this._doUpdate()}},{key:"setFrustum",value:function(e,t,n,r,i,o){this._m_FrustumNear=i,this._m_FrustumFar=o,this._m_FrustumLeft=e,this._m_FrustumRight=t,this._m_FrustumTop=n,this._m_FrustumBottom=r,this._m_ProjectMatrix.parallelM(this._m_FrustumLeft,this._m_FrustumRight,this._m_FrustumTop,this._m_FrustumBottom,this._m_FrustumNear,this._m_FrustumFar)}},{key:"setFrustumPerspective",value:function(e,t,n,r){this._m_ParallelProjection=!1,this._m_Fovy=e,this._m_FixedAspect=t;var i=Math.tan(.5*l.default.toRadians(this._m_Fovy))*n,o=i*this._m_FixedAspect;this._m_FrustumLeft=-o,this._m_FrustumRight=o,this._m_FrustumBottom=-i,this._m_FrustumTop=i,this._m_FrustumNear=n,this._m_FrustumFar=r,this._m_ProjectMatrix.perspectiveM(this._m_Fovy,this._m_FixedAspect?this._m_FixedAspect:1*this._m_Width/this._m_Height,this._m_FrustumNear,this._m_FrustumFar)}},{key:"forceUpdateProjection",value:function(){this._m_ParallelProjection?this._m_ProjectMatrix.parallelM(this._m_FrustumLeft,this._m_FrustumRight,this._m_FrustumTop,this._m_FrustumBottom,this._m_FrustumNear,this._m_FrustumFar):this._m_ProjectMatrix.perspectiveM(this._m_Fovy,this._m_FixedAspect?this._m_FixedAspect:1*this._m_Width/this._m_Height,this._m_FrustumNear,this._m_FrustumFar)}},{key:"addFilterFromMaterial",value:function(e){var t=m.default.newFilterFromMaterial(this,e);return this._m_Filters.push(t),t}},{key:"addFilter",value:function(e,t){for(var n=[],r=0,i=Math.min(t,this._m_Filters.length);r<i;r++)n.push(this._m_Filters[r]);n.push(e),r++;for(var o=this._m_Filters.length;r<o;r++)n.push(this._m_Filters[r]);this._m_Filters=n}},{key:"getFilters",value:function(){return this._m_Filters}},{key:"demandFilter",value:function(){return null!=this._m_Filters&&this._m_Filters.length>0}},{key:"getLeft",value:function(){return this._m_FrustumLeft}},{key:"getRight",value:function(){return this._m_FrustumRight}},{key:"getTop",value:function(){return this._m_FrustumTop}},{key:"getBottom",value:function(){return this._m_FrustumBottom}},{key:"getNear",value:function(){return this._m_FrustumNear}},{key:"getFar",value:function(){return this._m_FrustumFar}},{key:"setFar",value:function(e){this._m_FrustumFar=e}},{key:"setIsRenderingCamera",value:function(e){this._m_IsRenderingCamera=e,this._m_UpdateCameraPosition=!0,this._m_ViewMatrixUpdate=!0,this._m_ProjectMatrixUpdate=!0,this._m_ProjectViewMatrixUpdate=!0,e&&this._doUpdate(!0)}},{key:"getFrustumPlane",value:function(e){return this._m_FrustumPlane[e]}},{key:"getFrustumMask",value:function(){return this._m_FrustumMask}},{key:"setFrustumMask",value:function(e){this._m_FrustumMask=e}},{key:"getAt",value:function(){return this._m_At}},{key:"setAt",value:function(e){this._m_At.setTo(e)}},{key:"getEye",value:function(){return this._m_Eye}},{key:"setEye",value:function(e){this._m_Eye.setTo(e)}},{key:"getUp",value:function(){return this._m_Up}},{key:"setUp",value:function(e){this._m_Up.setTo(e)}},{key:"getDir",value:function(){return this._m_Dir}},{key:"lookAt",value:function(e,t,n){this._m_Eye.setTo(e),this._m_At.setTo(t),this._m_At.sub(this._m_Eye,this._m_Dir),this._m_Dir.normal(),n.cross(this._m_Dir,h.S_TEMP_VEC3).normal(),this._m_Dir.cross(h.S_TEMP_VEC3,this._m_Up).normal(),this._m_ViewMatrix.lookAt(this._m_Eye,this._m_At,this._m_Up),this._m_ViewMatrixUpdate=!0,this._doUpdate()}},{key:"isParallelProjection",value:function(){return this._m_ParallelProjection}},{key:"_updateFrustum",value:function(){if(this._m_ParallelProjection)this._m_CoeffLeft[0]=1,this._m_CoeffLeft[1]=0,this._m_CoeffRight[0]=-1,this._m_CoeffRight[1]=0,this._m_CoeffBottom[0]=1,this._m_CoeffBottom[1]=0,this._m_CoeffTop[0]=-1,this._m_CoeffTop[1]=0;else{var e=this._m_FrustumNear*this._m_FrustumNear,t=this._m_FrustumLeft*this._m_FrustumLeft,n=this._m_FrustumRight*this._m_FrustumRight,r=this._m_FrustumBottom*this._m_FrustumBottom,i=this._m_FrustumTop*this._m_FrustumTop,o=1/Math.sqrt(e+t);this._m_CoeffLeft[0]=-this._m_FrustumNear*o,this._m_CoeffLeft[1]=-this._m_FrustumLeft*o,o=1/Math.sqrt(e+n),this._m_CoeffRight[0]=this._m_FrustumNear*o,this._m_CoeffRight[1]=this._m_FrustumRight*o,o=1/Math.sqrt(e+r),this._m_CoeffBottom[0]=this._m_FrustumNear*o,this._m_CoeffBottom[1]=-this._m_FrustumBottom*o,o=1/Math.sqrt(e+i),this._m_CoeffTop[0]=-this._m_FrustumNear*o,this._m_CoeffTop[1]=this._m_FrustumTop*o}h.S_TEMP_VEC3.setToInXYZ(-this._m_ViewMatrix.m[0],-this._m_ViewMatrix.m[4],-this._m_ViewMatrix.m[8]),h.S_TEMP_VEC3_2.setToInXYZ(this._m_ViewMatrix.m[1],this._m_ViewMatrix.m[5],this._m_ViewMatrix.m[9]),h.S_TEMP_VEC3_3.setTo(this._m_Dir);var a=h.S_TEMP_VEC3_3.dot(this._m_Eye),_=this._m_FrustumPlane[h.S_LEFT_PLANE].getNormal();_._m_X=h.S_TEMP_VEC3._m_X*this._m_CoeffLeft[0],_._m_Y=h.S_TEMP_VEC3._m_Y*this._m_CoeffLeft[0],_._m_Z=h.S_TEMP_VEC3._m_Z*this._m_CoeffLeft[0],_.addInXYZ(h.S_TEMP_VEC3_3._m_X*this._m_CoeffLeft[1],h.S_TEMP_VEC3_3._m_Y*this._m_CoeffLeft[1],h.S_TEMP_VEC3_3._m_Z*this._m_CoeffLeft[1]),this._m_FrustumPlane[h.S_LEFT_PLANE].setD(this._m_Eye.dot(_));var s=this._m_FrustumPlane[h.S_RIGHT_PLANE].getNormal();s._m_X=h.S_TEMP_VEC3._m_X*this._m_CoeffRight[0],s._m_Y=h.S_TEMP_VEC3._m_Y*this._m_CoeffRight[0],s._m_Z=h.S_TEMP_VEC3._m_Z*this._m_CoeffRight[0],s.addInXYZ(h.S_TEMP_VEC3_3._m_X*this._m_CoeffRight[1],h.S_TEMP_VEC3_3._m_Y*this._m_CoeffRight[1],h.S_TEMP_VEC3_3._m_Z*this._m_CoeffRight[1]),this._m_FrustumPlane[h.S_RIGHT_PLANE].setD(this._m_Eye.dot(s));var u=this._m_FrustumPlane[h.S_BOTTOM_PLANE].getNormal();u._m_X=h.S_TEMP_VEC3_2._m_X*this._m_CoeffBottom[0],u._m_Y=h.S_TEMP_VEC3_2._m_Y*this._m_CoeffBottom[0],u._m_Z=h.S_TEMP_VEC3_2._m_Z*this._m_CoeffBottom[0],u.addInXYZ(h.S_TEMP_VEC3_3._m_X*this._m_CoeffBottom[1],h.S_TEMP_VEC3_3._m_Y*this._m_CoeffBottom[1],h.S_TEMP_VEC3_3._m_Z*this._m_CoeffBottom[1]),this._m_FrustumPlane[h.S_BOTTOM_PLANE].setD(this._m_Eye.dot(u));var l=this._m_FrustumPlane[h.S_TOP_PLANE].getNormal();l._m_X=h.S_TEMP_VEC3_2._m_X*this._m_CoeffTop[0],l._m_Y=h.S_TEMP_VEC3_2._m_Y*this._m_CoeffTop[0],l._m_Z=h.S_TEMP_VEC3_2._m_Z*this._m_CoeffTop[0],l.addInXYZ(h.S_TEMP_VEC3_3._m_X*this._m_CoeffTop[1],h.S_TEMP_VEC3_3._m_Y*this._m_CoeffTop[1],h.S_TEMP_VEC3_3._m_Z*this._m_CoeffTop[1]),this._m_FrustumPlane[h.S_TOP_PLANE].setD(this._m_Eye.dot(l)),this._m_ParallelProjection&&(this._m_FrustumPlane[h.S_LEFT_PLANE].setD(this._m_FrustumPlane[h.S_LEFT_PLANE].getD()+this._m_FrustumLeft),this._m_FrustumPlane[h.S_RIGHT_PLANE].setD(this._m_FrustumPlane[h.S_RIGHT_PLANE].getD()-this._m_FrustumRight),this._m_FrustumPlane[h.S_TOP_PLANE].setD(this._m_FrustumPlane[h.S_TOP_PLANE].getD()-this._m_FrustumTop),this._m_FrustumPlane[h.S_BOTTOM_PLANE].setD(this._m_FrustumPlane[h.S_BOTTOM_PLANE].getD()+this._m_FrustumBottom)),this._m_FrustumPlane[h.S_FAR_PLANE].setNormaXYZ(-h.S_TEMP_VEC3_3._m_X,-h.S_TEMP_VEC3_3._m_Y,-h.S_TEMP_VEC3_3._m_Z),this._m_FrustumPlane[h.S_FAR_PLANE].setD(-(a+this._m_FrustumFar)),this._m_FrustumPlane[h.S_NEAR_PLANE].setNormaXYZ(h.S_TEMP_VEC3_3._m_X,h.S_TEMP_VEC3_3._m_Y,h.S_TEMP_VEC3_3._m_Z),this._m_FrustumPlane[h.S_NEAR_PLANE].setD(a+this._m_FrustumNear)}},{key:"_update",value:function(){var e=this._m_Scene.getCanvas().getGLContext();e.bindBuffer(e.UNIFORM_BUFFER,this.MAT);var t=this._m_Scene.getRender().getFrameContext();this._m_ViewMatrixUpdate&&(this._m_UpdateCameraPosition=!0,this._m_ProjectViewMatrixUpdate=!0,(t.getContext(s.default.S_VIEW_MATRIX_SRC)||t.getContext(s.default.S_VP_SRC)||t.getContext(s.default.S_MVP_SRC))&&(this._m_IsRenderingCamera&&(e.bufferSubData(e.UNIFORM_BUFFER,0,this._m_ViewMatrix.getBufferData()),t.setCalcContext(s.default.S_VIEW_MATRIX_SRC,this._m_ViewMatrix)),this._m_ViewMatrixUpdate=!1)),this._m_ProjectMatrixUpdate&&(this._m_ProjectViewMatrixUpdate=!0,(t.getContext(s.default.S_PROJECT_MATRIX_SRC)||t.getContext(s.default.S_VP_SRC)||t.getContext(s.default.S_MVP_SRC))&&(this._m_IsRenderingCamera&&(e.bufferSubData(e.UNIFORM_BUFFER,64,this._m_ProjectMatrix.getBufferData()),t.setCalcContext(s.default.S_PROJECT_MATRIX_SRC,this._m_ProjectMatrix)),this._m_ProjectMatrixUpdate=!1)),this._m_ProjectViewMatrixUpdate&&t.getContext(s.default.S_VP_SRC)&&(a.default.multiplyMM(this._m_ProjectViewMatrix,0,this._m_ProjectMatrix,0,this._m_ViewMatrix,0),this._m_IsRenderingCamera&&(e.bufferSubData(e.UNIFORM_BUFFER,128,this._m_ProjectViewMatrix.getBufferData()),t.setCalcContext(s.default.S_VP_SRC,this._m_ProjectViewMatrix)),this._m_ProjectViewMatrixUpdate=!1),e.bindBuffer(e.UNIFORM_BUFFER,null),this._m_UpdateCameraPosition&&t.getContext(s.default.S_CAMERA_POSITION_SRC)&&(this._m_IsRenderingCamera&&(e.bindBuffer(e.UNIFORM_BUFFER,this.VIEW),e.bufferSubData(e.UNIFORM_BUFFER,0,this._m_Eye.getBufferData()),e.bindBuffer(e.UNIFORM_BUFFER,null)),this._m_UpdateCameraPosition=!1),(this._m_ViewMatrixUpdate||this._m_ProjectMatrixUpdate||this._m_ProjectViewMatrixUpdate)&&this._doUpdate(),this._updateFrustum(),this.fire(h.S_CAMERA_UPDATE_EVENT,[this._m_ViewMatrix,this._m_ProjectMatrix,this._m_ProjectViewMatrix])}},{key:"setViewMatrix",value:function(e){this._m_ViewMatrix.set(e);var t=this._m_ViewMatrix.inertRetNew(_.default.S_TEMP_MAT4);t&&(this._m_Eye.setToInXYZ(t.m[12],t.m[13],t.m[14]),this._m_Up.setToInXYZ(t.m[4],t.m[5],t.m[6]),_.default.S_TEMP_VEC3.setToInXYZ(-t.m[8],-t.m[9],-t.m[10]),_.default.S_TEMP_VEC3.add(this._m_Eye,this._m_At),this._m_At.sub(this._m_Eye,this._m_Dir),this._m_Dir.normal()),this._m_ViewMatrixUpdate=!0,this._doUpdate()}},{key:"getViewMatrix",value:function(){return this._m_ViewMatrix}},{key:"getProjectViewMatrix",value:function(e){return e&&a.default.multiplyMM(this._m_ProjectViewMatrix,0,this._m_ProjectMatrix,0,this._m_ViewMatrix,0),this._m_ProjectViewMatrix}},{key:"setProjectMatrix",value:function(e){this._m_ProjectMatrix.set(e),this._m_ProjectMatrixUpdate=!0,this._doUpdate()}},{key:"getHeight",value:function(){return this._m_Height}},{key:"getWidth",value:function(){return this._m_Width}},{key:"scroll",value:function(e){this._m_ProjectMatrix.perspectiveM(e,1*this._m_Width/this._m_Height,this._m_FrustumNear,this._m_FrustumFar),this._m_ProjectMatrixUpdate=!0,this._doUpdate()}},{key:"getProjectMatrix",value:function(){return this._m_ProjectMatrix}},{key:"frustumContains",value:function(e){if(e){for(var t=0,n=0,r=0,i=h.S_FRUSTUM_INTERSECT_INSIDE,o=6;o>=0;o--)if(o!=e.getPriorityPlane()&&(t=1<<(n=6==o?e.getPriorityPlane():o),0==(this._m_FrustumMask&t))){if((r=e.whichSide(this._m_FrustumPlane[n]))==u.default.S_SIDE_NEGATIVE)return e.setPriorityPlane(n),h.S_FRUSTUM_INTERSECT_OUTSIDE;r==u.default.S_SIDE_POSITIVE?this._m_FrustumMask|=t:i=h.S_FRUSTUM_INTERSECT_INTERSECTS}return i}return h.S_FRUSTUM_INTERSECT_INSIDE}},{key:"getWorldCoordinates",value:function(e,t,n,r){r||(r=new o.default),n?(a.default.multiplyMM(this._m_ProjectViewMatrix,0,this._m_ProjectMatrix,0,this._m_ViewMatrix,0),h.S_TEMP_MAT4.set(this._m_ProjectViewMatrix)):h.S_TEMP_MAT4.set(this._m_ProjectMatrix),h.S_TEMP_MAT4.inert();var i=this.getWidth(),_=this.getHeight();h.S_TEMP_VEC3.setToInXYZ((e._m_X/i-0)/1*2-1,(e._m_Y/_-0)/1*2-1,2*t-1);var s=a.default.multiplyMV3(r,h.S_TEMP_VEC3,h.S_TEMP_MAT4);return r.multLength(1/s),r}}])&&d(t.prototype,n),r&&d(t,r),h}(i.default);t.default=C,y(C,"S_TEMP_MAT4",new a.default),y(C,"S_TEMP_VEC3",new o.default),y(C,"S_TEMP_VEC3_2",new o.default),y(C,"S_TEMP_VEC3_3",new o.default),y(C,"S_TEMP_VEC3_4",new o.default),y(C,"S_CAMERA_UPDATE_EVENT","camera_update_event"),y(C,"S_FRUSTUM_INTERSECT_INTERSECTS",0),y(C,"S_FRUSTUM_INTERSECT_INSIDE",1),y(C,"S_FRUSTUM_INTERSECT_OUTSIDE",2),y(C,"S_LEFT_PLANE",0),y(C,"S_RIGHT_PLANE",1),y(C,"S_BOTTOM_PLANE",2),y(C,"S_TOP_PLANE",3),y(C,"S_FAR_PLANE",4),y(C,"S_NEAR_PLANE",5)},4939:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=h(n(9650)),o=h(n(3061)),a=h(n(5109)),_=h(n(1550)),s=h(n(5489)),u=h(n(513)),l=h(n(2949)),f=h(n(7280)),c=h(n(2815)),m=h(n(5604));function h(e){return e&&e.__esModule?e:{default:e}}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function g(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=y(e);if(t){var i=y(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S(this,n)}}function S(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}var C=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(S,e);var t,n,r,h=g(S);function S(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,S),(t=h.call(this,null,e))._m_TaskQueue=new s.default,t._m_Canvas=new a.default(v(t),{id:"default_canvas",canvas:e.cavnas}),t._m_Render=new o.default(v(t),{id:"default_render"}),t._m_MainCamera=new _.default(v(t),{id:"mainCamera"}),t._m_FrustumCullingCamera=t._m_MainCamera,t._m_MainCamera.setIsRenderingCamera(!0),t._m_Nodes=[],t._m_NodeIds={},t._m_Lights=[],t._m_AmbientLightColor=new m.default(1,1,1),t._m_EnableLights=[],t._m_VisLights=[],t._m_LightIds={},t._m_EnableLightIds={},t._m_GIProbes=[],t._m_GIProbeIds={},t._m_RefProbes=[],t._m_RefProbeIds={},t._m_Render.startUp(),t}return t=S,n=[{key:"getType",value:function(){return"Scene"}},{key:"AmbientLightColor",get:function(){return this._m_AmbientLightColor}},{key:"setAmbientLightColor",value:function(e,t,n){this._m_AmbientLightColor.setToInXYZ(e,t,n)}},{key:"getLights",value:function(){return this._m_Lights}},{key:"getEnableLights",value:function(){return this._m_EnableLights}},{key:"enableLight",value:function(e){this._m_EnableLightIds[e.getId()]||(this._m_EnableLightIds[e.getId()]=e,e.enable(),this._m_EnableLights.push(e))}},{key:"disableLight",value:function(e){if(this._m_EnableLightIds[e.getId()]){this._m_EnableLightIds[e.getId()]=null,e.disable();var t=this._m_EnableLights.indexOf(e);t>-1&&this._m_EnableLights.splice(t,1)}}},{key:"getVisLights",value:function(){return this._m_VisLights}},{key:"getLight",value:function(e){return this._m_LightIds[e]}},{key:"getGIProbes",value:function(){return this._m_GIProbes}},{key:"enableGIProbes",value:function(){return this._m_GIProbes.length>0&&this._m_GIProbes[0].isEnable()}},{key:"getGIProbe",value:function(e){return this._m_GIProbeIds[e]}},{key:"scheduleTask",value:function(e,t){this._m_TaskQueue.push(e),this._m_TaskQueue.push(t)}},{key:"runTasks",value:function(){for(var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,r=n>0?(new Date).getTime():0,i=0,o=this._m_TaskQueue.length;o>0&&(n<0||r<n);)e=this._m_TaskQueue.shift(),o-=2,(t=this._m_TaskQueue.shift())?e.call(t):e(),n>0&&(r=(new Date).getTime()),i++;return i}},{key:"getMainCamera",value:function(){return this._m_MainCamera}},{key:"setMainCamera",value:function(e){this._m_MainCamera!=e&&this._m_MainCamera&&this._m_MainCamera.setIsRenderingCamera(!1),this._m_MainCamera=e,this._m_MainCamera.setIsRenderingCamera(!0)}},{key:"setFrustumCullingCamera",value:function(e){this._m_FrustumCullingCamera=e}},{key:"getFrustumCullingCamera",value:function(){return this._m_FrustumCullingCamera}},{key:"getRender",value:function(){return this._m_Render}},{key:"getCanvas",value:function(){return this._m_Canvas}},{key:"setSky",value:function(e){null!=e&&"SkyBox"!=e.getType()||this._m_Render.setSky(e)}},{key:"getSky",value:function(){return this._m_Render.getSky()}},{key:"addSceneNode",value:function(e){e instanceof l.default&&!(e instanceof f.default)&&(this._m_NodeIds[e.getId()]||(this._m_Nodes.push(e),this._m_NodeIds[e.getId()]=e))}},{key:"getSceneNode",value:function(e){return this._m_Nodes[e]}},{key:"getSceneNodes",value:function(){return this._m_Nodes}},{key:"addComponentInScene",value:function(e){e instanceof i.default?this._m_ComponentIDs[e.getId()]?console.warn("组件[["+e.getId()+"]]已存在!!"):("Scene"!=e.getType()&&(this._m_ComponentIDs[e.getId()]=e,this._m_Components.push(e)),e.isDrawable&&e.isDrawable()&&this._m_Render.addDrawable(e),e instanceof u.default&&(e instanceof c.default?this._m_GIProbeIds[e.getId()]||(this._m_GIProbes.push(e),this._m_GIProbeIds[e.getId()]=e):this._m_LightIds[e.getId()]||(this._m_Lights.push(e),this._m_LightIds[e.getId()]=e))):console.error("component必须是一个Component对象!!")}},{key:"removeComponentInScene",value:function(e){e instanceof i.default&&this._m_ComponentIDs[e.getId()]&&(this._m_ComponentIDs[e.getId()]=null,this._m_Components.remove(e),e.isDrawable&&e.isDrawable()&&this._m_Render.removeDrawable(e))}},{key:"_gatherVisDrawable",value:function(e,t){var n=this;e.isDrawable&&e.isDrawable()?t.push(e):e.getChildren().length>0&&e.getChildren().forEach((function(e){n._gatherVisDrawable(e,t)}))}},{key:"_frustumCulling",value:function(e,t){var n=this;if(e.inFrustum(this._m_FrustumCullingCamera))if(e.isDrawable&&e.isDrawable())t.push(e);else if(e.getChildren().length>0){var r=this._m_FrustumCullingCamera.getFrustumMask();e.getChildren().forEach((function(e){e instanceof u.default||(e.getFilterFlag()==l.default.S_DYNAMIC?e.getCullingFlags()&l.default.S_DEFAULT_FRUSTUM_CULLING&&(n._m_FrustumCullingCamera.setFrustumMask(r),n._frustumCulling(e,t)):e.getFilterFlag()==l.default.S_NEVER&&n._gatherVisDrawable(e,t))}))}}},{key:"update",value:function(e){this.runTasks(),this.fire("update",[e])}},{key:"render",value:function(e){var t=this,n=this._m_Render.getVisDrawables();if(n.length=0,this.fire("render",[e]),this._m_Nodes.forEach((function(e){e.getFilterFlag()==l.default.S_DYNAMIC?e.getCullingFlags()&l.default.S_DEFAULT_FRUSTUM_CULLING&&(t._m_FrustumCullingCamera.setFrustumMask(0),t._frustumCulling(e,n)):e.getFilterFlag()==l.default.S_NEVER&&t._gatherVisDrawable(e,n)})),this._m_VisLights.length=0,this._m_EnableLights.length>0){var r=this._m_FrustumCullingCamera.getFrustumMask();this._m_FrustumCullingCamera.setFrustumMask(0),this._m_EnableLights.forEach((function(e){"GIProbe"!=e.getType()&&"RefProbe"!=e.getType()&&(e._m_Mark^=u.default.S_VISIBLE_LIGHT,e.getFilterFlag()==l.default.S_DYNAMIC?e.inFrustum(t._m_FrustumCullingCamera)&&(e._m_Mark|=u.default.S_VISIBLE_LIGHT,t._m_VisLights.push(e)):e.getFilterFlag()==l.default.S_NEVER&&(e._m_Mark|=u.default.S_VISIBLE_LIGHT,t._m_VisLights.push(e)))})),this._m_FrustumCullingCamera.setFrustumMask(r)}this._m_Render.render(e)}}],n&&d(t.prototype,n),r&&d(t,r),S}(i.default);t.default=C},5602:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=C(n(9650)),o=C(n(513)),a=C(n(8435)),_=C(n(3061)),s=C(n(2320)),u=C(n(7341)),l=(C(n(9784)),C(n(4008))),f=C(n(5397)),c=C(n(8113)),m=C(n(3370)),h=C(n(7280)),d=C(n(1359)),p=C(n(1491)),g=C(n(5776)),S=C(n(9271)),v=C(n(1759)),y=C(n(4690));function C(e){return e&&e.__esModule?e:{default:e}}function T(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t){return b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},b(e,t)}function P(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=R(e);if(t){var i=R(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return E(this,n)}}function E(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return D(e)}function D(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function R(e){return R=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},R(e)}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var M=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&b(e,t)}(C,e);var t,n,r,i=P(C);function C(e,t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,C),w(D(n=i.call(this,e,t)),"_m_ShadowSplitType",C.S_QUADRATIC_SCALING),w(D(n),"_m_MainCamera",void 0),w(D(n),"_m_PreShadowMat",void 0),w(D(n),"_m_PostShadowMat",void 0),w(D(n),"_m_NbShadowMaps",1),w(D(n),"_m_Light",void 0),w(D(n),"_m_SkipPass",void 0),w(D(n),"_m_ShadowGeometryCasts",[]),w(D(n),"_m_ShadowGeometryReceivers",[]),w(D(n),"_m_FadeInfo",null),w(D(n),"_m_ZFarOverride",0),w(D(n),"_m_FadeLength",0),w(D(n),"_m_BackfaceShadows",!1),w(D(n),"_m_PCFEdge",1),w(D(n),"_m_ShadowIntensity",.7),w(D(n),"_m_ResolutionInverse",new S.default),w(D(n),"_m_ShadowMapSizeInverse",new S.default),w(D(n),"_m_LVPM",[]),w(D(n),"_m_ShadowFB",[]),w(D(n),"_m_ShadowMapSize",512),w(D(n),"_m_ShadowMapSizes",[]),w(D(n),"_m_BiasFactor",1),w(D(n),"_m_BiasUnits",1),w(D(n),"_m_ShadowRenderState",new a.default),w(D(n),"_m_ShadowRenderState2",new a.default),w(D(n),"_m_UploadShadowMaps",[]),w(D(n),"_m_UploadLightViews",[]),w(D(n),"_m_Enable",!0),w(D(n),"_m_DebugShadowMap",[]),w(D(n),"_m_Debug",!1),n._m_NbShadowMaps=t.nbShadowMaps,n._m_ShadowMapSize=t.shadowMapSize,n._m_Debug=null!=t.debug&&t.debug,n._m_BackfaceShadows=null!=t.backfaceShadows&&t.backfaceShadows,n._m_ShadowSplitType=t.shadowSplitType||n._m_ShadowSplitType;for(var r=n._m_Scene.getCanvas().getGLContext(),o=n._m_ShadowMapSize,_=Math.min(1/n._m_NbShadowMaps,.25),y=0;y<n._m_NbShadowMaps;y++)if(n._m_LVPM[y]=new s.default,n._m_ShadowSplitType==C.S_QUADRATIC_SCALING?(n._m_ShadowFB[y]=new u.default(r,"ShadowFB_"+y,o,o),n._m_ShadowMapSizes[y]=o,o/=2,o=Math.max(o,128)):n._m_ShadowSplitType==C.S_FIXED?n._m_ShadowFB[y]=new u.default(r,"ShadowFB_"+y,n._m_ShadowMapSize,n._m_ShadowMapSize):Log.error("错误的阴影类型!"),n._m_ShadowFB[y].setFixedSize(!0),n._m_Debug&&n._m_ShadowFB[y].addTexture(r,"ShadowFBDefaultColor",r.RGBA,0,r.RGBA,r.UNSIGNED_BYTE,r.COLOR_ATTACHMENT0,!1),n._m_ShadowFB[y].addTexture(r,C.S_SHADOW_MAP_ARRAY_SRC[y],r.DEPTH_COMPONENT16,0,r.DEPTH_COMPONENT,r.UNSIGNED_SHORT,r.DEPTH_ATTACHMENT,!1),n._m_ShadowFB[y].finish(r,n._m_Scene,!1),n._m_UploadShadowMaps[y]=C.S_SHADOW_MAP_ARRAY_SRC[y],n._m_UploadLightViews[y]=C.S_LIGHT_SHADOW_VP_ARRAY_SRC[y],n._m_Debug){n._m_DebugShadowMap[y]=new h.default(n._m_Scene,{id:"debug_shadow_map_"+y}),n._m_DebugShadowMap[y].setSize(_,.3),n._m_DebugShadowMap[y].setLeftTop(2.01*_*y-(1-_),-.7),n._m_DebugShadowMap[y].useDefaultMat();var T=new d.default(n._m_Scene);T.setTextureFormat(d.default.S_TEXTURE_FORMAT.S_RGBA,d.default.S_TEXTURE_FORMAT.S_RGBA,d.default.S_TEXTURE_FORMAT.S_UNSIGNED_BYTE),T.target(n._m_ShadowFB[y]),n._m_DebugShadowMap[y].getMaterial().setParam("colorMap",T),n._m_DebugShadowMap[y].setZIndex(0)}n._m_ShadowRenderState.setFlag(a.default.S_STATES[0],a.default.S_FACE_CULL_FRONT),n._m_Debug||n._m_ShadowRenderState.setFlag(a.default.S_STATES[2],"Off"),n._m_ShadowRenderState.setFlag(a.default.S_STATES[7],"On"),n._m_ShadowRenderState.setFlag(a.default.S_STATES[8],[n._m_BiasFactor,n._m_BiasUnits]),n._m_ShadowRenderState2.setFlag(a.default.S_STATES[1],"Off"),n._m_PreShadowMat=new l.default(n._m_Scene,{id:"preShadowMat_"+f.default.nextId(),materialDef:c.default.parse(m.default.S_PRE_SHADOW_DEF_DATA)}),n._m_Debug&&n._m_PreShadowMat.setParam("debug",(new p.default).valueOf(!0)),n._m_PostShadowMat=new l.default(n._m_Scene,{id:"postShadowMat_"+f.default.nextId(),materialDef:c.default.parse(m.default.S_POST_SHADOW_DEF_DATA)}),n._m_PostShadowMat.setParam("pcfEdge",(new v.default).valueOf(n._m_PCFEdge)),n._m_PostShadowMat.setParam("shadowIntensity",(new v.default).valueOf(n._m_ShadowIntensity)),n._m_ShadowMapSizeInverse.setToInXY(1/n._m_ShadowMapSize,1/n._m_ShadowMapSize);var b=n._m_Scene.getCanvas().getWidth(),P=n._m_Scene.getCanvas().getHeight();return n._m_ResolutionInverse.setToInXY(1/b,1/P),n._m_PostShadowMat.setParam("backfaceShadows",(new p.default).valueOf(n._m_BackfaceShadows)),n._m_Scene.getCanvas().on("resize",(function(e,t){n._m_ResolutionInverse.setToInXY(1/e,1/t)})),n.initMat(),n._m_FramePicture=new g.default(n._m_Scene,{id:n._m_Id+"_picture"}),n._m_Scene.getMainCamera().addFilter(D(n),0),n}return t=C,(n=[{key:"isEnable",value:function(){return this._m_Enable}},{key:"enable",value:function(e){this._m_Enable=e}},{key:"initMat",value:function(){}},{key:"setBackfaceShadows",value:function(e){this._m_BackfaceShadows!=e&&(this._m_BackfaceShadows=e,this._m_PostShadowMat.setParam("backfaceShadows",(new p.default).valueOf(this._m_BackfaceShadows)))}},{key:"isBackfaceShadows",value:function(){return this._m_BackfaceShadows}},{key:"setBias",value:function(e,t){this._m_BiasFactor=e,this._m_BiasUnits=t,this._m_ShadowRenderState.setFlag(a.default.S_STATES[8],[this._m_BiasFactor,this._m_BiasUnits])}},{key:"getBiasFactor",value:function(){return this._m_BiasFactor}},{key:"getBiasUnits",value:function(){return this._m_BiasUnits}},{key:"setFade",value:function(e,t){this._m_FadeInfo||(this._m_FadeInfo=new y.default);var n=this._m_FadeInfo.valueFromXY(e,t);this._m_PostShadowMat.setParam("fadeInfo",n)}},{key:"setFadeExtend",value:function(e){this._m_ZFarOverride!=e&&(this._m_ZFarOverride=e),0==this._m_ZFarOverride?this._m_FadeInfo&&this.setFade(0,0):this.setFade(this._m_ZFarOverride-this._m_FadeLength,1/this._m_FadeLength)}},{key:"getFadeExtend",value:function(){return this._m_ZFarOverride}},{key:"setFadeLength",value:function(e){this._m_FadeLength!=e&&(this._m_FadeLength=e),0==this._m_ZFarOverride?this._m_FadeInfo&&this.setFade(0,0):this.setFade(this._m_ZFarOverride-this._m_FadeLength,1/this._m_FadeLength)}},{key:"getFadeLength",value:function(){return this._m_FadeLength}},{key:"setPCFEdge",value:function(e){this._m_PCFEdge!=e&&(this._m_PCFEdge=e,this._m_PostShadowMat.setParam("pcfEdge",(new v.default).valueOf(this._m_PCFEdge)))}},{key:"getPCFEdge",value:function(){return this._m_PCFEdge}},{key:"setShadowIntensity",value:function(e){this._m_ShadowIntensity!=e&&(this._m_ShadowIntensity=e,this._m_PostShadowMat.setParam("shadowIntensity",(new v.default).valueOf(this._m_ShadowIntensity)))}},{key:"getShadowIntensity",value:function(){return this._m_ShadowIntensity}},{key:"setLight",value:function(e){this._m_Light=e}},{key:"getLight",value:function(){return this._m_Light}},{key:"updateShadowCams",value:function(){}},{key:"visLight",value:function(){return 0!=(this._m_Light._m_Mark&o.default.S_VISIBLE_LIGHT)}},{key:"generateShadowMap",value:function(e,t,n,r){this._m_ShadowGeometryCasts.length=0,this._m_ShadowGeometryCasts=this.getShadowGeometryCasts(r,this._m_ShadowGeometryCasts);var i=this.getShadowCam(r);this._m_LVPM[r].set(i.getProjectViewMatrix(!0)),this._m_Scene.setMainCamera(i),this._m_ShadowFB[r].use(t),this._m_ShadowFB[r].clear(e),this._m_ShadowGeometryCasts.forEach((function(e){e.draw(n)}))}},{key:"getShadowGeometryCasts",value:function(e,t){return t}},{key:"getShadowGeometryReceivers",value:function(e){return e}},{key:"getShadowCam",value:function(e){}},{key:"_uploadInfo",value:function(e,t){for(var n=t.m_LastSubShader.getContextVars(),r=null,i=0;i<this._m_NbShadowMaps;i++)null!=(r=n[C.S_SHADOW_MAP_ARRAY_SRC[i]])&&(e.activeTexture(e.TEXTURE0+r.loc),e.bindTexture(e.TEXTURE_2D,this._m_ShadowFB[i].getTexture(C.S_SHADOW_MAP_ARRAY_SRC[i]).getLoc())),null!=(r=n[C.S_LIGHT_SHADOW_VP_ARRAY_SRC[i]])&&e[r.fun](r.loc,!1,this._m_LVPM[i].getBufferData());this._m_BackfaceShadows||null!=(r=n[C.S_RESOLUTION_INVERSE])&&e.uniform2f(r.loc,this._m_ResolutionInverse._m_X,this._m_ResolutionInverse._m_Y),null!=(r=n[C.S_SHADOW_MAP_SIZE])&&e.uniform1f(r.loc,this._m_ShadowMapSize),null!=(r=n[C.S_SHADOW_MAP_SIZE_INVERSE])&&e.uniform2f(r.loc,this._m_ShadowMapSizeInverse._m_X,this._m_ShadowMapSizeInverse._m_Y)}},{key:"preFrame",value:function(){if(this._m_ShadowGeometryReceivers.length=0,this._m_SkipPass=!this.visLight(),!this._m_SkipPass){this.updateShadowCams();var e=this._m_Scene.getRender();this._m_MainCamera=this._m_Scene.getMainCamera();var t=e.getFrameContext(),n=this._m_Scene.getCanvas().getGLContext();t.getRenderState().store(),this._m_ShadowSplitType==C.S_FIXED&&e.setViewPort(n,0,0,this._m_ShadowMapSize,this._m_ShadowMapSize),e._checkRenderState(n,this._m_ShadowRenderState,t.getRenderState()),e.useForcedMat("PreFrame",this._m_PreShadowMat,0);for(var r=0;r<this._m_NbShadowMaps;r++)this._m_ShadowSplitType==C.S_QUADRATIC_SCALING&&e.setViewPort(n,0,0,this._m_ShadowMapSizes[r],this._m_ShadowMapSizes[r]),this.generateShadowMap(n,e,t,r);this._m_Scene.setMainCamera(this._m_MainCamera),this._m_Scene.getRender().useDefaultFrame(),e.setViewPort(n,0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight()),e._checkRenderState(n,t.getRenderState().restore(),t.getRenderState())}}},{key:"postFilter",value:function(){if(!this._m_SkipPass){var e=this._m_Scene.getRender(),t=e.getFrameContext(),n=this._m_Scene.getCanvas().getGLContext();if(t.getRenderState().store(),e._checkRenderState(n,this._m_ShadowRenderState2,t.getRenderState()),e.useForcedMat("PostFilter",this._m_PostShadowMat,0),this._uploadInfo(n,t),this._m_FramePicture.draw(t),this._m_Debug)for(var r=0;r<this._m_NbShadowMaps;r++)e.useForcedMat(_.default.FORWARD,this._m_DebugShadowMap[r].getMaterial(),0),this._m_DebugShadowMap[r].draw(t);e._checkRenderState(n,t.getRenderState().restore(),t.getRenderState())}}}])&&T(t.prototype,n),r&&T(t,r),C}(i.default);t.default=M,w(M,"S_QUADRATIC_SCALING",1),w(M,"S_FIXED",2),w(M,"S_SHADOW_MAP_ARRAY_SRC",{0:"_shadowMap0",1:"_shadowMap1",2:"_shadowMap2",3:"_shadowMap3",4:"_shadowMap4",5:"_shadowMap5",6:"_shadowMap6"}),w(M,"S_LIGHT_SHADOW_VP_ARRAY_SRC",{0:"_lightViewProjectMatrix0",1:"_lightViewProjectMatrix1",2:"_lightViewProjectMatrix2",3:"_lightViewProjectMatrix3",4:"_lightViewProjectMatrix4",5:"_lightViewProjectMatrix5",6:"_lightViewProjectMatrix6"}),w(M,"S_LIGHT_DIR","_lightDir"),w(M,"S_LIGHT_POS","_lightPos"),w(M,"S_SPLITS","_splits"),w(M,"S_FADEINFO","_fadeInfo"),w(M,"S_RESOLUTION_INVERSE","_ResolutionInverse"),w(M,"S_SHADOW_MAP_SIZE","_shadowMapSize"),w(M,"S_SHADOW_MAP_SIZE_INVERSE","_sMapSizeInverse")},6177:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=m(n(5602)),o=m(n(3846)),a=m(n(1550)),_=m(n(5397)),s=m(n(5604)),u=m(n(1266)),l=m(n(7141)),f=m(n(2949)),c=m(n(9784));function m(e){return e&&e.__esModule?e:{default:e}}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=y(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},d(e,t,n||e)}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function g(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=y(e);if(t){var i=y(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S(this,n)}}function S(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(S,e);var t,n,r,m=g(S);function S(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,S),t.nbShadowMaps=t.nbSplits,C(v(n=m.call(this,e,t)),"_m_SplitsVec4",new l.default),C(v(n),"_m_SplitsArray",null),C(v(n),"_m_ShadowCam",null),C(v(n),"_m_Points",new Array(8)),C(v(n),"_m_TempVec3",new s.default),C(v(n),"_m_Lambda",.65),C(v(n),"_m_Stabilize",!0),n.init(t.nbSplits,t.shadowMapSize),n}return t=S,(n=[{key:"init",value:function(e,t){this._m_NbShadowMaps=Math.max(Math.min(e,4),1),this._m_NbShadowMaps!=e&&o.default.error("PSSM分割级别只能为1-4之间,指定的分割级别为:"+e),this._m_SplitsArray=new Array(this._m_NbShadowMaps+1),this._m_ShadowCam=new a.default(this._m_Scene,{id:"DirectionalLightShadowProcess_"+_.default.nextId(),width:t,height:t,fixedSize:!0,parallelProjection:!0}),this._m_ShadowCam.setEye(new s.default(0,0,0));for(var n=0;n<8;n++)this._m_Points[n]=new s.default}},{key:"initMat",value:function(){d(y(S.prototype),"initMat",this).call(this),this._m_PostShadowMat.addDefine(c.default.S_PSSM_SRC,!1)}},{key:"_uploadInfo",value:function(e,t){d(y(S.prototype),"_uploadInfo",this).call(this,e,t);var n=t.m_LastSubShader.getContextVars(),r=null;if(r=n[i.default.S_LIGHT_DIR]){var o=this._m_Light.getDirection();e.uniform3f(r.loc,o._m_X,o._m_Y,o._m_Z)}(r=n[i.default.S_SPLITS])&&e.uniform4f(r.loc,this._m_SplitsVec4._m_X,this._m_SplitsVec4._m_Y,this._m_SplitsVec4._m_Z,this._m_SplitsVec4._m_W)}},{key:"updateShadowCams",value:function(){if(null!=this._m_Light){var e=this._m_Scene.getMainCamera(),t=this._m_ZFarOverride;0==t&&(t=e.getFar());var n=Math.max(e.getNear(),.001);u.default.calculateLightConeScope(e,n,t,1,this._m_Points),this._m_ShadowCam.setFar(t);var r=this._m_ShadowCam.getEye();if(this._m_ShadowCam.lookAt(r,r.add(this._m_Light.getDirection(),this._m_TempVec3),this._m_ShadowCam.getUp()),this._m_ShadowCam._updateFrustum(),this._m_ShadowCam.forceUpdateProjection(),this._m_ShadowCam.getProjectViewMatrix(!0),u.default.calculateSplits(this._m_SplitsArray,n,t,this._m_Lambda),e.isParallelProjection())for(var i=1*(t-n),a=0;a<this._m_NbShadowMaps;a++)this._m_SplitsArray[a]/=i;switch(this._m_SplitsArray.length){case 5:this._m_SplitsVec4._m_W=this._m_SplitsArray[4];case 4:this._m_SplitsVec4._m_Z=this._m_SplitsArray[3];case 3:this._m_SplitsVec4._m_Y=this._m_SplitsArray[2];case 2:case 1:this._m_SplitsVec4._m_X=this._m_SplitsArray[1]}}else o.default.warn("无效光源!")}},{key:"getShadowCam",value:function(e){return this._m_ShadowCam}},{key:"getShadowGeometryCasts",value:function(e,t){return u.default.calculateLightConeScope(this._m_MainCamera,this._m_SplitsArray[e],this._m_SplitsArray[e+1],1,this._m_Points),0==this._m_ShadowGeometryReceivers.length&&u.default.calculateGeometriesInFrustum(this._m_Scene.getRender().getVisDrawables(),this._m_MainCamera,f.default.S_SHADOW_RECEIVE,this._m_ShadowGeometryReceivers),u.default.calculateShadowCamera(this._m_Scene.getSceneNodes(),this._m_ShadowGeometryReceivers,this._m_ShadowCam,this._m_Points,t,this._m_Stabilize?this._m_ShadowMapSize:0),t}},{key:"getShadowGeometryReceivers",value:function(e){0==e.length&&u.default.calculateGeometriesInFrustum(this._m_Scene.getRender().getVisDrawables(),this._m_MainCamera,f.default.S_SHADOW_RECEIVE,e)}}])&&h(t.prototype,n),r&&h(t,r),S}(i.default);t.default=T},4867:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=f(n(5602)),o=f(n(1550)),a=f(n(5397)),_=f(n(5604)),s=(f(n(4048)),f(n(1266))),u=f(n(2949)),l=f(n(9784));function f(e){return e&&e.__esModule?e:{default:e}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return m="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=S(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},m(e,t,n||e)}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=S(e);if(t){var i=S(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return p(this,n)}}function p(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return g(e)}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(p,e);var t,n,r,f=d(p);function p(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,p),t.nbShadowMaps=p._S_FACE_NUMS,t.shadowSplitType=2,v(g(n=f.call(this,e,t)),"_m_ShadowCams",new Array(p._S_FACE_NUMS)),v(g(n),"_m_Position",new _.default),v(g(n),"_m_Radius",0),v(g(n),"_m_UpdateCasterCam",!1),n.init(t.shadowMapSize),n}return t=p,(n=[{key:"init",value:function(e){for(var t=0;t<p._S_FACE_NUMS;t++)this._m_ShadowCams[t]=new o.default(this._m_Scene,{id:this._m_Id+"_"+t+a.default.nextId(),width:e,height:e,fixedSize:!0})}},{key:"initMat",value:function(){m(S(p.prototype),"initMat",this).call(this),this._m_PostShadowMat.addDefine(l.default.S_POINTLIGHT_SHADOWS_SRC,!1)}},{key:"_uploadInfo",value:function(e,t){var n;m(S(p.prototype),"_uploadInfo",this).call(this,e,t),(n=t.m_LastSubShader.getContextVars()[i.default.S_LIGHT_POS])&&e.uniform3f(n.loc,this._m_Position._m_X,this._m_Position._m_Y,this._m_Position._m_Z)}},{key:"updateShadowCams",value:function(){if(this._m_Radius==this._m_Light.getRadius()&&this._m_Position.equals(this._m_Light.getPosition())){if(this._m_UpdateCasterCam){this._m_UpdateCasterCam=!1;for(var e=0;e<p._S_FACE_NUMS;e++)this._m_ShadowCams[e].setFrustumPerspective(90,1,.1,this._m_Radius),this._m_ShadowCams[e]._updateFrustum()}}else this._m_Radius=this._m_Light.getRadius(),this._m_Position.setTo(this._m_Light.getPosition()),this._calc()}},{key:"getShadowCam",value:function(e){return this._m_ShadowCams[e]}},{key:"getShadowGeometryCasts",value:function(e,t){var n=this;return this._m_Scene.getSceneNodes().forEach((function(r){s.default.calculateNodeInFrustum(r,n._m_ShadowCams[e],u.default.S_SHADOW_CAST,t)})),this._m_UpdateCasterCam=!0,this._m_ShadowCams[e].setFrustumPerspective(90,1,.1,1e3),this._m_ShadowCams[e].getProjectViewMatrix(!0),t}},{key:"_calc",value:function(){for(var e=p._S_TEMP_VEC3_0,t=0;t<p._S_FACE_NUMS;t++)p._S_CAPTURE_CONFIG[t].dir.add(this._m_Position,e),this._m_ShadowCams[t].lookAt(this._m_Position,e,p._S_CAPTURE_CONFIG[t].up),this._m_ShadowCams[t].setFrustumPerspective(90,1,.1,this._m_Radius),this._m_ShadowCams[t]._updateFrustum()}}])&&c(t.prototype,n),r&&c(t,r),p}(i.default);t.default=y,v(y,"_S_CAPTURE_CONFIG",[{dir:new _.default(0,-1,0),up:new _.default(0,0,-1)},{dir:new _.default(0,1,0),up:new _.default(0,0,1)},{dir:new _.default(0,0,-1),up:new _.default(0,1,0)},{dir:new _.default(0,0,1),up:new _.default(0,1,0)},{dir:new _.default(-1,0,0),up:new _.default(0,1,0)},{dir:new _.default(1,0,0),up:new _.default(0,1,0)}]),v(y,"_S_FACE_NUMS",6),v(y,"_S_TEMP_VEC3_0",new _.default)},1266:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=u(n(5604)),i=u(n(2949)),o=u(n(2320)),a=u(n(3801)),_=u(n(8578)),s=u(n(513));function u(e){return e&&e.__esModule?e:{default:e}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,u;return t=e,u=[{key:"calculateLightConeScope",value:function(t,n,r,i,o){var a=1*t.getTop()/t.getNear(),_=1*n,s=1*r,u=1*t.getTop(),l=1*t.getRight()/u,f=-1,c=-1,m=-1,h=-1;t.isParallelProjection()?(c=(f=u)*l,h=(m=u)*l):(c=(f=a*_)*l,h=(m=a*s)*l);var d=t.getEye(),p=t.getDir(),g=t.getUp(),S=p.cross(g,e.S_TEMP_VEC3_1).normal(),v=p.multLength(s,e.S_TEMP_VEC3_2).add(d),y=p.multLength(_,e.S_TEMP_VEC3_3).add(d),C=g.multLength(f,e.S_TEMP_VEC3_4),T=g.multLength(m,e.S_TEMP_VEC3_5),b=S.multLength(c,e.S_TEMP_VEC3_6),P=S.multLength(h,e.S_TEMP_VEC3_7);if(y.sub(C,o[0]).sub(b),y.add(C,o[1]).sub(b),y.add(C,o[2]).add(b),y.sub(C,o[3]).add(b),v.sub(T,o[4]).sub(P),v.add(T,o[5]).sub(P),v.add(T,o[6]).add(P),v.sub(T,o[7]).add(P),1!=i){for(var E=e.S_TEMP_VEC3_8.setToInXYZ(0,0,0),D=0;D<8;D++)E.add(o[D]);E.multLength(1/8);for(var R=e.S_TEMP_VEC3_0,w=0;w<8;w++)o[w].sub(E,R),R.multLength(i-1),o[w].add(R)}}},{key:"calculateSplits",value:function(e,t,n,r){for(var i=-1,o=-1,a=-1,_=1*n/t,s=n-t,u=0,l=e.length;u<l;u++)i=1*u/l,o=t*Math.pow(_,i),a=t+s*i,e[u]=o*r+a*(1-r);e[0]=t,e[e.length-1]=n}},{key:"calculateShadowCamera",value:function(t,n,r,i,s,u){r.isParallelProjection()&&(r.setFrustum(-1,1,1,-1,-r.getFar(),r.getFar()),r.forceUpdateProjection());var l=r.getProjectViewMatrix(!0),f=e.calculateBoundaryFromPoints(i,l,e.S_AABB_BOUNDARY_BOX0),c=new a.default,m=new a.default,h=0,d=0,p=null,g=null,S=null;n.forEach((function(t){p=t.getBoundingVolume(),g=e.S_AABB_BOUNDARY_BOX1,p.transformFromMat44(l,e.S_AABB_BOUNDARY_BOX1),f.contains(g)&&(S=g.getCenter(),Math.abs(S._m_X)!=Number.MAX_VALUE&&!Number.isNaN(S._m_X)&&Number.isFinite(S._m_X)&&(m.merge(g),d++))}));var v=new _.default(l,h,f,c,s);t.forEach((function(e){v.calculate(e)})),(h=v._m_CasterCount)!=d&&c.setHalfInXYZ(c.getXHalf()+2,c.getYHalf()+2,c.getZHalf()+2);var y=c.getMin(e.S_TEMP_VEC3_00),C=c.getMax(e.S_TEMP_VEC3_11),T=m.getMin(e.S_TEMP_VEC3_22),b=m.getMax(e.S_TEMP_VEC3_33),P=f.getMin(e.S_TEMP_VEC3_44),E=f.getMax(e.S_TEMP_VEC3_55);P._m_Z=0;var D,R,w,M,A,L,I=r.getProjectMatrix(),x=e.S_TEMP_VEC3_8,O=e.S_TEMP_VEC3_7;x._m_X=Math.max(Math.max(y._m_X,T._m_X),P._m_X),O._m_X=Math.min(Math.min(C._m_X,b._m_X),E._m_X),x._m_Y=Math.max(Math.max(y._m_Y,T._m_Y),P._m_Y),O._m_Y=Math.min(Math.min(C._m_Y,b._m_Y),E._m_Y),x._m_Z=Math.min(y._m_Z,P._m_Z),O._m_Z=Math.min(b._m_Z,E._m_Z),D=2/(O._m_X-x._m_X),R=2/(O._m_Y-x._m_Y);var F=.5*u;if(0!=F&&D>0&&R>0){var k=.1;D=1/Math.ceil(1/D*k)*k,R=1/Math.ceil(1/R*k)*k}M=-.5*(O._m_X+x._m_X)*D,A=-.5*(O._m_Y+x._m_Y)*R,0!=F&&D>0&&R>0&&(M=1*Math.ceil(M*F)/F,A=1*Math.ceil(A*F)/F),w=1/(O._m_Z-x._m_Z),L=-x._m_Z*w;var B=e.S_TEMP_MAT44_0;B.setArray([D,0,0,0,0,R,0,0,0,0,w,0,M,A,L,1]);var N=e.S_TEMP_MAT44_1;o.default.multiplyMM(N,0,B,0,I,0),r.setProjectMatrix(N)}},{key:"calculateBoundaryFromPoints",value:function(t,n,i){for(var _=e.S_TEMP_VEC3_0.setTo(r.default.S_MIN),s=e.S_TEMP_VEC3_1.setTo(r.default.S_MAX),u=e.S_TEMP_VEC3_2,l=0,f=0,c=t.length;f<c;f++)l=o.default.multiplyMV3(u,t[f],n),u.multLength(1/l),_.min(u),s.max(u);var m=_.add(s,e.S_TEMP_VEC3_3).multLength(.5),h=s.sub(_,e.S_TEMP_VEC3_4).multLength(.5),d=i||new a.default;return d.setCenter(m),d.setHalfInXYZ(h._m_X+2,h._m_Y+2,h._m_Z+2.5),d}},{key:"calculateGeometriesInFrustum",value:function(t,n,r,i){var o=n.getFrustumMask();e._cull(t,n,r,i),n.setFrustumMask(o)}},{key:"calculateNodeInFrustum",value:function(t,n,r,i){var o=n.getFrustumMask();n.setFrustumMask(0),e._cull2(t,n,r,i),n.setFrustumMask(o)}},{key:"_cull",value:function(t,n,r,i){t.forEach((function(t){n.setFrustumMask(0),t.inFrustum(n)&&e._parseShadowMode(t,r)&&i.push(t)}))}},{key:"_cull2",value:function(t,n,r,o){if(t.getFilterFlag()!=i.default.S_ALWAYS&&t.inFrustum(n))if(t.isDrawable&&t.isDrawable()&&!t.isGUI())e._parseShadowMode(t,r)&&o.push(t);else if(t.getChildren().length>0){var a=n.getFrustumMask();t.getChildren().forEach((function(t){t instanceof s.default||(n.setFrustumMask(a),e._cull2(t,n,r,o))}))}}},{key:"_parseShadowMode",value:function(e,t){if(t!=i.default.S_SHADOW_NONE)switch(t){case i.default.S_SHADOW_CAST:return e.isCastShadow();case i.default.S_SHADOW_RECEIVE:return e.isReceiveShadow();case i.default.S_SHADOW_CAST_AND_RECEIVE:return!0}return!1}}],(n=null)&&l(t.prototype,n),u&&l(t,u),e}();t.default=c,f(c,"S_TEMP_VEC3_0",new r.default),f(c,"S_TEMP_VEC3_1",new r.default),f(c,"S_TEMP_VEC3_2",new r.default),f(c,"S_TEMP_VEC3_3",new r.default),f(c,"S_TEMP_VEC3_4",new r.default),f(c,"S_TEMP_VEC3_5",new r.default),f(c,"S_TEMP_VEC3_6",new r.default),f(c,"S_TEMP_VEC3_7",new r.default),f(c,"S_TEMP_VEC3_8",new r.default),f(c,"S_TEMP_VEC3_00",new r.default),f(c,"S_TEMP_VEC3_11",new r.default),f(c,"S_TEMP_VEC3_22",new r.default),f(c,"S_TEMP_VEC3_33",new r.default),f(c,"S_TEMP_VEC3_44",new r.default),f(c,"S_TEMP_VEC3_55",new r.default),f(c,"S_TEMP_MAT44_0",new o.default),f(c,"S_TEMP_MAT44_1",new o.default),f(c,"S_AABB_BOUNDARY_BOX0",new a.default),f(c,"S_AABB_BOUNDARY_BOX1",new a.default)},8578:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;_(n(4720));var r=_(n(2949)),i=_(n(3801)),o=_(n(1322)),a=_(n(5604));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t,n,r,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),u(this,"_m_VP",void 0),u(this,"_m_CasterCount",void 0),u(this,"_m_SplitBoundaryBox",void 0),u(this,"_m_CasterBoundaryBox",void 0),u(this,"_m_SplitOccluders",void 0),this._m_VP=t,this._m_CasterCount=n,this._m_SplitBoundaryBox=r,this._m_CasterBoundaryBox=i,this._m_SplitOccluders=o}var t,n,i;return t=e,(n=[{key:"calculate",value:function(e){return this._calculate(e),this._m_CasterCount}},{key:"_calculate",value:function(t){var n=this;if(t.getFilterFlag()!=r.default.S_ALWAYS)if(t.isDrawable&&t.isDrawable()&&!t.isGUI()){if(t.isCastShadow()){var i=t.getBoundingVolume(),a=e.S_AABB_BOUNDARY_BOX0;i.transformFromMat44(this._m_VP,e.S_AABB_BOUNDARY_BOX0);var _=this._m_SplitBoundaryBox.contains(a);if(_||i.getType()!=o.default.S_TYPE_AABB)_&&(this._m_CasterBoundaryBox.merge(a),this._m_CasterCount++,null!=this._m_SplitOccluders&&this._m_SplitOccluders.push(t));else if(a.setZHalf(a.getZHalf()+50),a.setCenter(a.getCenter(e.S_TEMP_VEC3_0).addInXYZ(0,0,25)),this._m_SplitBoundaryBox.contains(a)){var s=a.getCenter(e.S_TEMP_VEC3_1)._m_X;Math.abs(s)!=Number.MAX_VALUE&&!Number.isNaN(s)&&Number.isFinite(s)&&(a.setZHalf(a.getZHalf()-50),a.setCenter(a.getCenter(e.S_TEMP_VEC3_0).subInXYZ(0,0,25)),this._m_CasterBoundaryBox.merge(a),this._m_CasterCount++),null!=this._m_SplitOccluders&&this._m_SplitOccluders.push(t)}}}else if(t instanceof r.default){var u=t.getBoundingVolume();if(null!=u){var l=e.S_AABB_BOUNDARY_BOX0;u.transformFromMat44(this._m_VP,e.S_AABB_BOUNDARY_BOX0);var f=this._m_SplitBoundaryBox.contains(l);f||l.getType()!=o.default.S_TYPE_AABB||(l.setZHalf(l.getZHalf()+50),l.setCenter(l.getCenter(e.S_TEMP_VEC3_0).addInXYZ(0,0,25)),f=this._m_SplitBoundaryBox.contains(l)),f&&t.getChildren().forEach((function(e){n._calculate(e)}))}}}}])&&s(t.prototype,n),i&&s(t,i),e}();t.default=l,u(l,"S_TEMP_VEC3_0",new a.default),u(l,"S_TEMP_VEC3_1",new a.default),u(l,"S_TEMP_VEC3_2",new a.default),u(l,"S_AABB_BOUNDARY_BOX0",new i.default),u(l,"S_AABB_BOUNDARY_BOX1",new i.default)},948:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=m(n(5602)),o=m(n(1550)),a=m(n(2949)),_=m(n(5397)),s=m(n(5604)),u=m(n(3846)),l=m(n(1266)),f=m(n(431)),c=m(n(9784));function m(e){return e&&e.__esModule?e:{default:e}}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=y(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},d(e,t,n||e)}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function g(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=y(e);if(t){var i=y(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S(this,n)}}function S(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(S,e);var t,n,r,m=g(S);function S(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,S),t.nbShadowMaps=1,C(v(n=m.call(this,e,t)),"_m_ShadowCam",void 0),C(v(n),"_m_OutAngle",-1),C(v(n),"_m_SpotRange",-1),C(v(n),"_m_Position",new s.default),C(v(n),"_m_Direction",new s.default),C(v(n),"_m_UpdateCasterCam",!1),C(v(n),"_m_TempVec3",new s.default),n.init(t.shadowMapSize),n}return t=S,(n=[{key:"init",value:function(e){this._m_ShadowCam=new o.default(this._m_Scene,{id:this._m_Id+"_"+_.default.nextId(),width:e,height:e,fixedSize:!0})}},{key:"initMat",value:function(){d(y(S.prototype),"initMat",this).call(this),this._m_PostShadowMat.addDefine(c.default.S_SPOTLIGHT_SHADOWS_SRC,!1)}},{key:"_uploadInfo",value:function(e,t){d(y(S.prototype),"_uploadInfo",this).call(this,e,t);var n=t.m_LastSubShader.getContextVars(),r=null;if(r=n[i.default.S_LIGHT_DIR]){var o=this._m_Light.getDirection();e.uniform3f(r.loc,o._m_X,o._m_Y,o._m_Z)}if(r=n[i.default.S_LIGHT_POS]){var a=this._m_Light.getPosition();e.uniform3f(r.loc,a._m_X,a._m_Y,a._m_Z)}}},{key:"getShadowCam",value:function(e){return this._m_ShadowCam}},{key:"updateShadowCams",value:function(){null!=this._m_Light?this._m_OutAngle==this._m_Light.getOuterAngle()&&this._m_SpotRange==this._m_Light.getSpotRange()&&this._m_Position.equals(this._m_Light.getPosition())&&this._m_Direction.equals(this._m_Light.getDirection())?this._m_UpdateCasterCam&&(this._m_UpdateCasterCam=!1,this._m_ShadowCam.setFrustumPerspective(this._m_OutAngle*f.default.S_RAD_TO_DEG*2,1,1,this._m_SpotRange),this._m_ShadowCam._updateFrustum()):(this._m_OutAngle=this._m_Light.getOuterAngle(),this._m_SpotRange=this._m_Light.getSpotRange(),this._m_Position.setTo(this._m_Light.getPosition()),this._m_Direction.setTo(this._m_Light.getDirection()),this._m_ShadowCam.setFrustumPerspective(this._m_OutAngle*f.default.S_RAD_TO_DEG*2,1,1,this._m_SpotRange),this._m_ShadowCam.lookAt(this._m_Position,this._m_Position.add(this._m_Direction,this._m_TempVec3),this._m_ShadowCam.getUp()),this._m_ShadowCam._updateFrustum(),this._m_ShadowCam.getProjectViewMatrix(!0)):u.default.warn("无效光源!")}},{key:"getShadowGeometryCasts",value:function(e,t){var n=this;return this._m_Scene.getSceneNodes().forEach((function(e){l.default.calculateNodeInFrustum(e,n._m_ShadowCam,a.default.S_SHADOW_CAST,t)})),this._m_UpdateCasterCam=!0,this._m_ShadowCam.setFrustumPerspective(this._m_OutAngle*f.default.S_RAD_TO_DEG*2,1,1,1e3),this._m_ShadowCam.getProjectViewMatrix(!0),t}}])&&h(t.prototype,n),r&&h(t,r),S}(i.default);t.default=T},1193:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(3846))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"_get",value:function(e,t,n,r){r=r||{sync:!0};var i=new XMLHttpRequest;if(i.open(n||"POST",e,r.sync),r&&r.inflate&&(i.responseType="arraybuffer"),0==r.sync)return i.send(null),200===i.status?i.responseText:null;i.onreadystatechange=function(){4===i.readyState&&200===i.status&&t(i.response)},i.send(null)}},{key:"getBasePath",value:function(e){var t=e.lastIndexOf("/");return-1===t?e:e.substring(0,t+1)}},{key:"loadFile",value:function(e,t,n,r){(r=r||{type:"GET",sync:!0}).type=r.type||"GET",r.sync=null==r.sync||r.sync;var o=new XMLHttpRequest;o.open(r.type,e,r.sync);var a=r&&r.inflate;if(i.default.debug("inflate:"+a),a&&(o.responseType="arraybuffer",i.default.debug("二进制")),0==r.sync)return o.send(null),200===o.status?o.responseText:null;o.addEventListener("load",(function(e){var r=e.target.response;200===o.status?t&&t(r):0===o.status?(i.default.warn("loadFile: HTTP Status 0 received."),t&&t(r)):n&&n(e)}),!1),o.addEventListener("error",(function(e){n&&n(e)}),!1),o.send(null)}},{key:"loadMaterialSourceDef",value:function(t,n){return e._get(t,null,"GET",{sync:!1})}},{key:"loadModel",value:function(e,t){}}],(n=null)&&o(t.prototype,n),r&&o(t,r),e}();t.default=a},66:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.object=t,this.listeners={}}var t,r,i;return t=e,r=[{key:"removeA",value:function(e){for(var t,n,r=arguments,i=r.length;i>1&&e.length;)for(t=r[--i];-1!==(n=e.indexOf(t));)e.splice(n,1);return e}},{key:"isset",value:function(e){for(var t=0;t<arguments.length;t++)if(void 0===arguments[t]||null==arguments[t])return!1;return!0}},{key:"isArray",value:function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{key:"register",value:function(e,t,n){"string"==typeof e&&"function"==typeof t&&(this.listeners[e]||(this.listeners[e]=new Array),this.listeners[e].push({object:this.isset(n)?n:this.object,callback:t}))}},{key:"unregister",value:function(e,t,n){if("string"==typeof e&&"function"==typeof t&&(n=this.isset(n)?n:this.object,this.listeners[e]))for(var r=0;r<this.listeners[e].length;r++)if(this.listeners[e][r].object==n&&this.listeners[e][r].callback==t){this.listeners[e].splice(r,1);break}}},{key:"trigger",value:function(e,t,n){if("string"!=typeof e)return!1;if(t=t||new Array,this.isset(t)?this.isArray(t)||(t=[t]):t=new Array,"mouse"==e.substring(0,5).toLowerCase()&&(t[0]=this.normalizeEvent(t[0])),!this.listeners[e]||0==this.listeners[e].length)return!0;for(var r=this.listeners[e].slice(0),i=0;i<r.length;i++)if(!1===(this.isset(n)?r[i].callback.apply(n,t):r[i].callback.apply(r[i].object,t)))return!1;return!0}},{key:"normalizeEvent",value:function(e){return e}}],r&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},3846:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=console.log,o=console.info,a=console.warn,_=console.debug,s=console.error,u=console.time,l=console.timeEnd,f=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,f;return t=e,f=[{key:"debug",value:function(){}},{key:"log",value:function(){}},{key:"info",value:function(){}},{key:"warn",value:function(){}},{key:"error",value:function(){}},{key:"time",value:function(){}},{key:"timeEnd",value:function(){}},{key:"timeCalc",value:function(){}},{key:"enable",value:function(t,n){switch(t){case e.S_DEBUG:e.debug=n?_:function(){};break;case e.S_INFO:e.info=n?o:function(){};break;case e.S_LOG:e.log=n?i:function(){};break;case e.S_WARN:e.warn=n?a:function(){};break;case e.S_ERROR:e.error=n?s:function(){};break;case e.S_TIME:e.time=n?u:function(){},e.timeEnd=n?l:function(){};break;case e.S_TIME_CALC:e.timeCalc=n?function(e){return e?(e.time=(new Date).getTime()-e.time,e):((e={}).time=(new Date).getTime(),e)}:function(){}}}}],(r=null)&&n(t.prototype,r),f&&n(t,f),e}();t.default=f,r(f,"S_DEBUG",0),r(f,"S_INFO",1),r(f,"S_WARN",2),r(f,"S_LOG",3),r(f,"S_ERROR",4),r(f,"S_TIME",5),r(f,"S_TIME_CALC",6),f.enable(f.S_LOG,!0),f.enable(f.S_INFO,!0),f.enable(f.S_DEBUG,!0),f.enable(f.S_ERROR,!0),f.enable(f.S_WARN,!0),f.enable(f.S_TIME,!0)},8583:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n(9271)),i=o(n(307));function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var _,s,u,l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,o;return t=e,o=[{key:"nextId",value:function(){return--e.count}},{key:"pushVec3ToArray",value:function(e,t){e.push(t._m_X),e.push(t._m_Y),e.push(t._m_Z)}},{key:"createProbeMesh",value:function(){var e=new i.default;return e.setData(i.default.S_POSITIONS,[3.4201992,0,-9.396927,2.7669992,2.0103426,-9.396927,1.0568995,3.2528028,-9.396927,-1.0568998,3.2528026,-9.396927,-2.7669995,2.0103424,-9.396927,-3.4201992,-2.9900332e-7,-9.396927,-2.766999,-2.010343,-9.396927,-1.0569,-3.2528026,-9.396927,1.0569001,-3.2528026,-9.396927,2.7670002,-2.0103416,-9.396927,3.4201992,0,-9.396927,6.427875,0,-7.660445,5.20026,3.7782102,-7.660445,1.9863225,6.1132727,-7.660445,-1.9863229,6.113272,-7.660445,-5.2002606,3.7782097,-7.660445,-6.427875,-5.6194267e-7,-7.660445,-5.2002597,-3.7782109,-7.660445,-1.9863232,-6.113272,-7.660445,1.9863235,-6.113272,-7.660445,5.2002616,-3.7782083,-7.660445,6.427875,0,-7.660445,8.6602545,0,-4.9999995,7.0062933,5.0903697,-4.9999995,2.6761656,8.236392,-4.9999995,-2.676166,8.236391,-4.9999995,-7.006294,5.090369,-4.9999995,-8.6602545,-7.5710346e-7,-4.9999995,-7.006293,-5.0903707,-4.9999995,-2.6761668,-8.236391,-4.9999995,2.676167,-8.236391,-4.9999995,7.006295,-5.0903673,-4.9999995,8.6602545,0,-4.9999995,9.848078,0,-1.7364818,7.9672623,5.7885547,-1.7364818,3.0432231,9.366078,-1.7364818,-3.0432239,9.366078,-1.7364818,-7.9672627,5.788554,-1.7364818,-9.848078,-8.6094633e-7,-1.7364818,-7.967262,-5.788556,-1.7364818,-3.0432243,-9.366078,-1.7364818,3.0432246,-9.366078,-1.7364818,7.9672647,-5.788552,-1.7364818,9.848078,0,-1.7364818,9.848078,0,1.7364826,7.9672623,5.7885547,1.7364826,3.0432231,9.366078,1.7364826,-3.0432239,9.366078,1.7364826,-7.9672627,5.788554,1.7364826,-9.848078,-8.6094633e-7,1.7364826,-7.967262,-5.788556,1.7364826,-3.0432243,-9.366078,1.7364826,3.0432246,-9.366078,1.7364826,7.9672647,-5.788552,1.7364826,9.848078,0,1.7364826,8.660254,0,5.0000005,7.0062923,5.090369,5.0000005,2.6761653,8.236391,5.0000005,-2.6761658,8.23639,5.0000005,-7.006293,5.0903687,5.0000005,-8.660254,-7.571034e-7,5.0000005,-7.006292,-5.09037,5.0000005,-2.6761663,-8.23639,5.0000005,2.6761665,-8.23639,5.0000005,7.0062943,-5.090367,5.0000005,8.660254,0,5.0000005,6.427875,0,7.660445,5.20026,3.7782102,7.660445,1.9863225,6.1132727,7.660445,-1.9863229,6.113272,7.660445,-5.2002606,3.7782097,7.660445,-6.427875,-5.6194267e-7,7.660445,-5.2002597,-3.7782109,7.660445,-1.9863232,-6.113272,7.660445,1.9863235,-6.113272,7.660445,5.2002616,-3.7782083,7.660445,6.427875,0,7.660445,3.4201992,0,9.396927,2.7669992,2.0103426,9.396927,1.0568995,3.2528028,9.396927,-1.0568998,3.2528026,9.396927,-2.7669995,2.0103424,9.396927,-3.4201992,-2.9900332e-7,9.396927,-2.766999,-2.010343,9.396927,-1.0569,-3.2528026,9.396927,1.0569001,-3.2528026,9.396927,2.7670002,-2.0103416,9.396927,3.4201992,0,9.396927,0,0,-10,0,0,10]),e.setData(i.default.S_NORMALS,[-.34201992,-0,.9396927,-.27669993,-.20103426,.9396927,-.10568996,-.32528028,.9396927,.10568998,-.32528028,.9396927,.27669996,-.20103423,.9396927,.34201992,2.990033e-8,.9396927,.2766999,.20103431,.9396927,.10569,.32528028,.9396927,-.10569002,.32528028,.9396927,-.27670002,.20103417,.9396927,-.34201992,-0,.9396927,-.6427875,-0,.76604456,-.520026,-.37782103,.76604456,-.19863226,-.6113273,.76604456,.19863228,-.61132723,.76604456,.5200261,-.37782097,.76604456,.6427875,5.6194267e-8,.76604456,.52002597,.3778211,.76604456,.19863233,.61132723,.76604456,-.19863234,.61132723,.76604456,-.52002615,.37782082,.76604456,-.6427875,-0,.76604456,-.86602545,-0,.49999997,-.70062935,-.50903696,.49999997,-.26761654,-.82363915,.4999999,.2676166,-.8236391,.49999997,.70062935,-.5090369,.4999999,.86602545,7.5710346e-8,.49999997,.70062923,.509037,.4999999,.2676167,.8236391,.49999997,-.26761672,.8236391,.49999997,-.7006295,.5090367,.4999999,-.86602545,-0,.49999997,-.9848078,-0,.17364818,-.7967262,-.57885545,.17364818,-.30432233,-.93660784,.17364818,.3043224,-.93660784,.17364818,.7967263,-.57885545,.17364818,.9848078,8.609464e-8,.17364818,.79672617,.57885563,.17364818,.30432245,.93660784,.17364818,-.30432245,.93660784,.17364818,-.79672647,.5788552,.17364818,-.9848078,-0,.17364818,-.9848078,-0,-.17364827,-.7967262,-.57885545,-.17364827,-.30432233,-.93660784,-.17364827,.3043224,-.93660784,-.17364827,.7967263,-.57885545,-.17364827,.9848078,8.609464e-8,-.17364827,.7967261,.5788556,-.17364825,.30432242,.9366078,-.17364825,-.30432245,.9366078,-.17364825,-.79672647,.5788552,-.17364827,-.9848078,-0,-.17364827,-.8660254,-0,-.50000006,-.70062923,-.50903696,-.50000006,-.26761654,-.8236391,-.50000006,.2676166,-.82363904,-.50000006,.7006293,-.5090369,-.50000006,.8660254,7.571034e-8,-.50000006,.7006292,.509037,-.50000006,.26761663,.82363904,-.50000006,-.26761666,.82363904,-.50000006,-.7006294,.5090367,-.50000006,-.8660254,-0,-.50000006,-.6427875,-0,-.76604456,-.520026,-.37782103,-.76604456,-.19863226,-.6113273,-.76604456,.19863228,-.61132723,-.76604456,.5200261,-.37782097,-.76604456,.6427875,5.6194267e-8,-.76604456,.52002597,.3778211,-.76604456,.19863233,.61132723,-.76604456,-.19863234,.61132723,-.76604456,-.52002615,.37782082,-.76604456,-.6427875,-0,-.76604456,-.34201992,-0,-.9396927,-.27669993,-.20103426,-.9396927,-.10568996,-.32528028,-.9396927,.10568998,-.32528028,-.9396927,.27669996,-.20103423,-.9396927,.34201992,2.990033e-8,-.9396927,.2766999,.20103431,-.9396927,.10569,.32528028,-.9396927,-.10569002,.32528028,-.9396927,-.27670002,.20103417,-.9396927,-.34201992,-0,-.9396927,0,0,1,0,0,-1]),e.setData(i.default.S_INDICES,[0,11,1,1,11,12,1,12,2,2,12,13,2,13,3,3,13,14,3,14,4,4,14,15,4,15,5,5,15,16,5,16,6,6,16,17,6,17,7,7,17,18,7,18,8,8,18,19,8,19,9,9,19,20,9,20,10,10,20,21,11,22,12,12,22,23,12,23,13,13,23,24,13,24,14,14,24,25,14,25,15,15,25,26,15,26,16,16,26,27,16,27,17,17,27,28,17,28,18,18,28,29,18,29,19,19,29,30,19,30,20,20,30,31,20,31,21,21,31,32,22,33,23,23,33,34,23,34,24,24,34,35,24,35,25,25,35,36,25,36,26,26,36,37,26,37,27,27,37,38,27,38,28,28,38,39,28,39,29,29,39,40,29,40,30,30,40,41,30,41,31,31,41,42,31,42,32,32,42,43,33,44,34,34,44,45,34,45,35,35,45,46,35,46,36,36,46,47,36,47,37,37,47,48,37,48,38,38,48,49,38,49,39,39,49,50,39,50,40,40,50,51,40,51,41,41,51,52,41,52,42,42,52,53,42,53,43,43,53,54,44,55,45,45,55,56,45,56,46,46,56,57,46,57,47,47,57,58,47,58,48,48,58,59,48,59,49,49,59,60,49,60,50,50,60,61,50,61,51,51,61,62,51,62,52,52,62,63,52,63,53,53,63,64,53,64,54,54,64,65,55,66,56,56,66,67,56,67,57,57,67,68,57,68,58,58,68,69,58,69,59,59,69,70,59,70,60,60,70,71,60,71,61,61,71,72,61,72,62,62,72,73,62,73,63,63,73,74,63,74,64,64,74,75,64,75,65,65,75,76,66,77,67,67,77,78,67,78,68,68,78,79,68,79,69,69,79,80,69,80,70,70,80,81,70,81,71,71,81,82,71,82,72,72,82,83,72,83,73,73,83,84,73,84,74,74,84,85,74,85,75,75,85,86,75,86,76,76,86,87,0,1,88,1,2,88,2,3,88,3,4,88,4,5,88,5,6,88,6,7,88,7,8,88,8,9,88,9,10,88,77,89,78,78,89,79,79,89,80,80,89,81,81,89,82,82,89,83,83,89,84,84,89,85,85,89,86,86,89,87]),e}},{key:"createAABBBoundingBoxMeshFromAABBBoundingBox",value:function(e){var t=new i.default,n=e.getMin(),r=e.getMax(),o=[n._m_X,n._m_Y,n._m_Z,n._m_X,n._m_Y,r._m_Z,r._m_X,n._m_Y,n._m_Z,r._m_X,n._m_Y,r._m_Z,n._m_X,r._m_Y,n._m_Z,n._m_X,r._m_Y,r._m_Z,r._m_X,r._m_Y,n._m_Z,r._m_X,r._m_Y,r._m_Z];return t.setData(i.default.S_POSITIONS,o),t.setData(i.default.S_INDICES,[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7]),t.setPrimitive(i.default.S_PRIMITIVE_LINES),t}},{key:"createViewFrustumMeshFromCamera",value:function(t,n){var o=t.getWidth(),a=t.getHeight(),_=[];e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(0,0),0,n||!0)),e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(0,a),0,n||!0)),e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(o,a),0,n||!0)),e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(o,0),0,n||!0)),e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(0,0),1,n||!0)),e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(0,a),1,n||!0)),e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(o,a),1,n||!0)),e.pushVec3ToArray(_,t.getWorldCoordinates(new r.default(o,0),1,n||!0));var s=new i.default;return s.setData(i.default.S_POSITIONS,_),s.setData(i.default.S_INDICES,[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),s.setPrimitive(i.default.S_PRIMITIVE_LINES),s}}],(n=null)&&a(t.prototype,n),o&&a(t,o),e}();t.default=l,u=0,(s="count")in(_=l)?Object.defineProperty(_,s,{value:u,enumerable:!0,configurable:!0,writable:!0}):_[s]=u},5247:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=d(n(7341)),i=d(n(5604)),o=d(n(1550)),a=d(n(5397)),_=(d(n(9784)),d(n(4048))),s=d(n(7141)),u=d(n(3846)),l=d(n(9468)),f=d(n(8113)),c=d(n(4008)),m=d(n(3370)),h=d(n(1759));function d(e){return e&&e.__esModule?e:{default:e}}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function S(e,t,n){return t&&g(e.prototype,t),n&&g(e,n),e}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){function e(t,n,r,o){p(this,e),this._m_Scene=t,this._m_MipMap=o,this._m_Resolute=n,this._m_CaptureCameres=[],this._m_CaptureFrames=[],this._m_CaptureResult=new _.default(t),this._m_CaptureResult.setTextureFormat(_.default.S_TEXTURE_FORMAT.S_RGBA16F,_.default.S_TEXTURE_FORMAT.S_RGBA,_.default.S_TEXTURE_FORMAT.S_FLOAT),this._m_CapturePixels=[],this._m_Position=new i.default,r&&this._m_Position.setTo(r),this._m_PrefilterSky=new l.default(t,{id:"prefitlerSky"+a.default.nextId()}),this._m_PrefilterSky.setMaterial(new c.default(t,{id:"prefilterMat"+a.default.nextId(),materialDef:f.default.parse(m.default.S_PREFILTER_DEF)})),this._m_PrefilterSky.getMaterial().setParam("roughness",(new h.default).valueOf(0)),this._m_PrefilterSky.getMaterial().setParam("resolution",(new h.default).valueOf(n)),this._m_PrefilterSky.getMaterial().setParam("envMap",this._m_CaptureResult),this._m_PrefilterMap=new _.default(t),this._m_PrefilterMap.setTextureFormat(_.default.S_TEXTURE_FORMAT.S_RGBA16F,_.default.S_TEXTURE_FORMAT.S_RGBA,_.default.S_TEXTURE_FORMAT.S_FLOAT),this._m_PrefilterMap.setFilter(t,_.default.S_FILTERS.S_LINEAR_MIPMAP_NEAREST,_.default.S_FILTERS.S_LINEAR),this._m_PrefilterMipmap=0;for(var s=n,u=n;(s>=1||u>=1)&&1!=s&&1!=u;)s/=2,u/=2,this._m_PrefilterMipmap++;this._init()}return S(e,[{key:"_init",value:function(){for(var t=new i.default,n=this._m_Scene.getCanvas().getGLContext(),_=0;_<6;_++)this._m_CaptureCameres[_]=new o.default(this._m_Scene,{id:"capture_"+_+"_"+a.default.nextId(),fovy:90,aspect:1}),e._S_CAPTURE_CONFIG[_].dir.add(this._m_Position,t),this._m_CaptureCameres[_].lookAt(this._m_Position,t,e._S_CAPTURE_CONFIG[_].up),this._m_CaptureFrames[_]=new r.default(n,"capture_frame_"+_+"_"+a.default.nextId(),this._m_Resolute,this._m_Resolute),this._m_CaptureFrames[_].addTexture(n,"capture_texture_"+_,n.RGBA16F,0,n.RGBA,n.FLOAT,n.COLOR_ATTACHMENT0,!1,this._m_MipMap),this._m_CaptureFrames[_].addBuffer(n,"capture_depth_"+_,n.DEPTH24_STENCIL8,n.DEPTH_STENCIL_ATTACHMENT),this._m_CaptureFrames[_].finish(n,this._m_Scene,!1);this._m_CaptureResult.setPreloadColor(this._m_Scene,new s.default(.5,.5,.5,1))}},{key:"setPosition",value:function(e){this._m_Position.setTo(e)}},{key:"getPosition",value:function(){return this._m_Position}},{key:"capture",value:function(){var t=this._m_Scene.getCanvas().getGLContext();this._m_Scene.getRender()._resetFrameContext(),this._m_Scene.getRender()._drawEnv(t);var n=this._m_Scene.getMainCamera(),r=this._m_Scene.getRender(),i=null;r.setViewPort(t,0,0,this._m_Resolute,this._m_Resolute);for(var o=0;o<6;o++)this._m_Scene.setMainCamera(this._m_CaptureCameres[o]),this._m_CaptureFrames[o].use(r),this._m_CaptureFrames[o].clear(t),this._m_Scene.getRender()._drawEnv(t),i=this._m_CaptureFrames[o].readPixels(t,"",t.RGBA,t.FLOAT),this._m_CapturePixels[o]=i,this._m_CaptureResult.setImage(this._m_Scene,e._S_CAPTURE_FACE[o],i,{width:this._m_Resolute,height:this._m_Resolute});this._m_CaptureResult.setWrap(this._m_Scene,_.default.S_WRAPS.S_CLAMP_TO_EDGE,_.default.S_WRAPS.S_CLAMP_TO_EDGE,_.default.S_WRAPS.S_CLAMP_TO_EDGE),this._m_Scene.setMainCamera(n),this._m_Scene.getRender().useDefaultFrame(),r.setViewPort(t,0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight())}},{key:"prefiltered",value:function(){var t=this._m_Scene.getCanvas().getGLContext(),n=this._m_Scene.getSky();this._m_Scene.setSky(this._m_PrefilterSky),this._m_Scene.getRender()._resetFrameContext(),this._m_Scene.getRender()._drawEnv(t);var r,i,o=this._m_Scene.getMainCamera(),a=this._m_Scene.getRender(),s=null;a.setViewPort(t,0,0,this._m_Resolute,this._m_Resolute);for(var u=0;u<6;u++){this._m_Scene.setMainCamera(this._m_CaptureCameres[u]),this._m_CaptureFrames[u].use(a),this._m_CaptureFrames[u].clear(t);for(var l=0;l<=this._m_PrefilterMipmap;l++)r=this._m_Resolute*Math.pow(.5,l),i=this._m_Resolute*Math.pow(.5,l),this._m_PrefilterSky.getMaterial().setParam("roughness",(new h.default).valueOf(1*l/(this._m_PrefilterMipmap-1))),this._m_CaptureFrames[u].clear(t),this._m_Scene.getRender()._drawEnv(t),s=this._m_CaptureFrames[u].readPixels(t,"",t.RGBA,t.FLOAT),this._m_PrefilterMap.setImage(this._m_Scene,e._S_CAPTURE_FACE[u],s,{width:r,height:i,mipmapLevel:l})}this._m_PrefilterMap.setWrap(this._m_Scene,_.default.S_WRAPS.S_CLAMP_TO_EDGE,_.default.S_WRAPS.S_CLAMP_TO_EDGE,_.default.S_WRAPS.S_CLAMP_TO_EDGE),this._m_Scene.setMainCamera(o),this._m_Scene.getRender().useDefaultFrame(),this._m_Scene.setSky(n),a.setViewPort(t,0,0,this._m_Scene.getCanvas().getWidth(),this._m_Scene.getCanvas().getHeight())}},{key:"getCaptureTextureCube",value:function(){return this._m_CaptureResult}},{key:"getCapturePixels",value:function(){return this._m_CapturePixels}},{key:"getPrefilterTextureCube",value:function(){return this._m_PrefilterMap}},{key:"getPrefilterMipMap",value:function(){return this._m_PrefilterMipmap}}]),e}();v(y,"_S_CAPTURE_CONFIG",[{dir:new i.default(1,0,0),up:new i.default(0,-1,0)},{dir:new i.default(-1,0,0),up:new i.default(0,-1,0)},{dir:new i.default(0,1,0),up:new i.default(0,0,1)},{dir:new i.default(0,-1,0),up:new i.default(0,0,-1)},{dir:new i.default(0,0,1),up:new i.default(0,-1,0)},{dir:new i.default(0,0,-1),up:new i.default(0,-1,0)}]),v(y,"_S_CAPTURE_FACE",{0:_.default.S_FACE.PositiveX,1:_.default.S_FACE.NegativeX,2:_.default.S_FACE.PositiveY,3:_.default.S_FACE.NegativeY,4:_.default.S_FACE.PositiveZ,5:_.default.S_FACE.NegativeZ});var C=function(){function e(){p(this,e)}return S(e,null,[{key:"captureProbe",value:function(t,n,r){t.getCanvas().getGLContext();var i=r&&null!=r.resolute?r.resolute:e._S_DEFAULT_CAPTURE_RESOLUTE,o=new y(t,i,n.getPosition(),r.mipmap);return u.default.time("capture!"),o.capture(),u.default.timeEnd("capture!"),o}},{key:"bakeGIProbe",value:function(t,n,r){(r=r||{}).mipmap=!0;var i=r&&null!=r.resolute?r.resolute:e._S_DEFAULT_CAPTURE_RESOLUTE,o=e.captureProbe(t,n,r);u.default.time("shCoeffs");var a=e.getShCoeffs(i,i,o.getCapturePixels(),e._S_FIX_SEAMS_METHOD.Wrap);return e.prepareShCoefs(a),n.setShCoeffs(a),u.default.timeEnd("shCoeffs"),u.default.time("prefiltered"),o.prefiltered(),n.setPrefilterEnvMap(o.getPrefilterTextureCube()),n.setPrefilterMipmap(o.getPrefilterMipMap()),u.default.timeEnd("prefiltered"),o}},{key:"_bakePrefilteredEnvMap",value:function(t,n,r,o){t.getCapturePixels(),o.getCapturePixels();for(var a=new i.default,_=new i.default,u=(new s.default,n),l=0;l<4;l++){e._getRFM(l,4),e._getSFM(l,4);for(var f=0;f<u;f++)for(var c=0;c<u;c++)_.setToInXYZ(0,0,0),e._getVFCFTC(c,f,u,face,a,r)}}},{key:"_prefilterEnvMapTexel",value:function(t,n,r,o,a,_,u){var l=2*Math.PI/1,f=256*Math.abs(o._m_Z+o._m_X),c=(Math.cos(.5*f%(2*Math.PI)),r*r);c*=c;var m=e._S_TEMP_UNIT_X;Math.abs(o._m_Z)<.999&&(m=e._S_TEMP_UNIT_Y);var h=new i.default,d=new i.default;h.setTo(m),h.cross(o),h.normal(),d.setTo(o),d.cross(h);for(var p=new i.default(0,0,1),g=new i.default,S=new s.default,v=new i.default,y=0;y<a;y++){S=e._getHPoint(y,a,S),(v=e._iSGGX(S,c,v)).normal();var C=v._m_Z,T=v.multLength(2*C).sub(p);T._m_Z;0!=_&&e._computeMipLevel(r,a,t,C),e._2World(T,o,h,d,g),0}}},{key:"_getHPoint",value:function(e,t,n){var r,i=e;return n._m_X=1*e/t,i=(16711935&(i=(252645135&(i=(858993459&(i=(1431655765&(i=i<<16|i>>16))<<1|(2863311530&i)>>>1))<<2|(3435973836&i)>>>2))<<4|(4042322160&i)>>>4))<<8|(4278255360&i)>>>8,i&=4294967295,n._m_Y=1*i*2.3283064365386963e-10,r=2*Math.PI*n._m_Y,n._m_Z=Math.cos(r),n._m_W=Math.sin(r),n}},{key:"_2World",value:function(e,t,n,r,o){o.setTo(n),o.multLength(e._m_X);var a=new i.default;a.set(r),a.multLength(e._m_Y),o.add(a),a.set(t),a.multLength(e._m_Z),o.add(a)}},{key:"_samplePixel",value:function(e,t,n,r,i,o){if(r<=0)return 0;var a=new s.default;return o._m_X=o._m_X+a._m_X*r,o._m_Y=o._m_Y+a._m_Y*r,o._m_Z=o._m_Z+a._m_Z*r,r}},{key:"_iSGGX",value:function(e,t,n){var r=Math.sqrt((1-e._m_X)/(1+(t-1)*e._m_X)),i=Math.sqrt(1-r*r),o=i*e._m_Z,a=i*e._m_W;return n._m_X=o,n._m_Y=a,n._m_Z=r,n}},{key:"_ggx",value:function(e,t){var n=t/(e*e*(t*t-1)+1);return n*n*(1/Math.PI)}},{key:"_computeMipLevel",value:function(t,n,r,i){var o=i+1e-5,a=1/(n*(e._ggx(o,t)*o/(4*i))),_=4*Math.PI/(6*r*r),s=Math.log(r)/Math.log(2),u=Math.log(a/_)/Math.log(2);return Math.min(Math.max(.5*u+1,0),1*s)}},{key:"_getRFM",value:function(e,t){var n=1/(t-1);return(n*=e)*n}},{key:"_getSFM",value:function(e,t){return 0==e?1:Math.min(1<<t-1+2*e,8192)}},{key:"prepareShCoefs",value:function(t){var n=e._S_SQRT_PI,r=e._S_SQRT_3PI,i=e._S_SQRT_5PI,o=e._S_SQRT_15PI,a=1/(2*n),_=-r/2,s=-_,u=_,l=o/2,f=-l,c=i/4,m=f,h=o/4;t[0].multLength(a).multLength(e._S_SH_BAND_FACTOR[0]),t[1].multLength(_).multLength(e._S_SH_BAND_FACTOR[1]),t[2].multLength(-s).multLength(e._S_SH_BAND_FACTOR[2]),t[3].multLength(-u).multLength(e._S_SH_BAND_FACTOR[3]),t[4].multLength(-l).multLength(e._S_SH_BAND_FACTOR[4]),t[5].multLength(-f).multLength(e._S_SH_BAND_FACTOR[5]),t[6].multLength(c).multLength(e._S_SH_BAND_FACTOR[6]),t[7].multLength(m).multLength(e._S_SH_BAND_FACTOR[7]),t[8].multLength(h).multLength(e._S_SH_BAND_FACTOR[8])}},{key:"getShCoeffs",value:function(t,n,r,o){for(var a=[],_=0;_<9;_++)a.push(new i.default);for(var u,l=[],f=0,c=new i.default,m=new s.default,h=0;h<6;h++)for(var d=0;d<n;d++)for(var p=0;p<t;p++){u=e.getSAAV(p,d,t,h,c,o),e.evalShBasis(c,l),e._getPixelColor(p,d,t,n,r[h],m);for(var g=0;g<9;g++)a[g].setToInXYZ(a[g]._m_X+m._m_X*l[g]*u,a[g]._m_Y+m._m_Y*l[g]*u,a[g]._m_Z+m._m_Z*l[g]*u);f+=u}for(var S=0;S<9;++S)a[S].multLength(4*Math.PI/f);return a}},{key:"_getPixelColor",value:function(e,t,n,r,i,o){e*=4,o._m_X=i[t*n*4+e],o._m_Y=i[t*n*4+e+1],o._m_Z=i[t*n*4+e+2],o._m_W=i[t*n*4+e+3]}},{key:"evalShBasis",value:function(t,n){var r=t._m_X,i=t._m_Y,o=t._m_Z,a=r*r,_=i*i,s=o*o,u=e._S_SQRT_PI,l=e._S_SQRT_3PI,f=e._S_SQRT_5PI,c=e._S_SQRT_15PI;n[0]=1/(2*u),n[1]=-l*i/2,n[2]=l*o/2,n[3]=-l*r/2,n[4]=c*r*i/2,n[5]=-c*i*o/2,n[6]=f*(3*s-1)/4,n[7]=-c*r*o/2,n[8]=c*(a-_)/4}},{key:"getSAAV",value:function(t,n,r,i,o,a){var _,s,u,l,f=2*(t+.5)/(r*=1)-1,c=2*(n+.5)/r-1;e._getVFCFTC(t,n,r,i,o,a);var m=1/r;return _=f-m,s=c-m,u=f+m,l=c+m,e._areaElement(_,s)-e._areaElement(_,l)-e._areaElement(u,s)+e._areaElement(u,l)}},{key:"_areaElement",value:function(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}},{key:"_getVFCFTC",value:function(t,n,r,i,o,a){var _,s;if(t*=1,n*=1,r*=1,a==e._S_FIX_SEAMS_METHOD.Stretch?(_=2*t/(r-1)-1,s=2*n/(r-1)-1):(_=2*(t+.5)/r-1,s=2*(n+.5)/r-1),a==e._S_FIX_SEAMS_METHOD.Wrap){var u=Math.pow(r,2)/Math.pow(r-1,3);_=u*Math.pow(_,3)+_,s=u*Math.pow(s,3)+s}switch(i){case 0:o.setToInXYZ(1,-s,-_);break;case 1:o.setToInXYZ(-1,-s,_);break;case 2:o.setToInXYZ(_,1,s);break;case 3:o.setToInXYZ(_,-1,-s);break;case 4:o.setToInXYZ(_,-s,1);break;case 5:o.setToInXYZ(-_,-s,-1)}return o.normal(),o}}]),e}();t.default=C,v(C,"_S_TEMP_UNIT_X",new i.default(1,0,0)),v(C,"_S_TEMP_UNIT_Y",new i.default(0,1,0)),v(C,"_S_TEMP_UNIT_Z",new i.default(0,0,1)),v(C,"_S_DEFAULT_CAPTURE_RESOLUTE",256),v(C,"_S_FIX_SEAMS_METHOD",{Wrap:0,Stretch:1,None:2}),v(C,"_S_SQRT_PI",Math.sqrt(Math.PI)),v(C,"_S_SQRT_3PI",Math.sqrt(3/Math.PI)),v(C,"_S_SQRT_5PI",Math.sqrt(5/Math.PI)),v(C,"_S_SQRT_15PI",Math.sqrt(15/Math.PI)),v(C,"_S_SH_BAND_FACTOR",[1,2/3,2/3,2/3,1/4,1/4,1/4,1/4,1/4])},5489:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}var t,r,i;return t=e,(r=[{key:"length",get:function(){return this._length}},{key:"shift",value:function(){if(this._index>=this._headLength){var e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}var t=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,t}},{key:"push",value:function(e){return this._length++,this._tail.push(e),this}},{key:"unshift",value:function(e){return this._head[--this._index]=e,this._length++,this}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},2475:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=_(n(5604)),i=_(n(2320)),o=_(n(1446)),a=_(n(7141));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"mallocLightData",value:function(t){e.S_LIGHT_DATA=new o.default(3*t*4)}}],(n=null)&&s(t.prototype,n),r&&s(t,r),e}();t.default=l,u(l,"S_TEMP_VEC3",new r.default),u(l,"S_TEMP_VEC3_2",new r.default),u(l,"S_TEMP_VEC3_3",new r.default),u(l,"S_TEMP_VEC3_4",new r.default),u(l,"S_TEMP_VEC4",new a.default),u(l,"S_TEMP_VEC4_2",new a.default),u(l,"S_TEMP_VEC4_3",new a.default),u(l,"S_TEMP_MAT4",new i.default),u(l,"S_TEMP_MAT4_1",new i.default),u(l,"S_TEMP_MAT4_2",new i.default),u(l,"S_TEMP_MAT4_3",new i.default),u(l,"S_LIGHT_DATA_4",new o.default(48)),u(l,"S_LIGHT_DATA",l.S_LIGHT_DATA_4),u(l,"S_LIGHT_DATA_8",new o.default(96)),u(l,"S_SH_COEFFS",new o.default(27))},6552:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(t,n,i,o,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"_m_TextureCanvas",void 0),r(this,"_m_Context",void 0),r(this,"_m_Pixelsize",void 0),r(this,"_m_Width",void 0),r(this,"_m_Height",void 0),r(this,"_m_BackgroundColor","#a0d7ff"),r(this,"_m_TextColor","black"),r(this,"_m_AlignLeftOffset",.5),r(this,"_m_AlignTopOffset",.7),r(this,"_m_CurLabel",null),this._m_Pixelsize=o||60,this._m_BackgroundColor=a||this._m_BackgroundColor,this._m_Width=t,this._m_Height=n,this._m_TextureCanvas=document.createElement("canvas"),this._m_TextureCanvas.width=t,this._m_TextureCanvas.height=n,this._m_TextureCanvas.style.width=t+"px",this._m_TextureCanvas.style.height=n+"px",this._m_TextureCanvas.style.padding="0",this._m_TextureCanvas.style.margin="0",this._m_TextureCanvas.style.top="0",this._m_TextureCanvas.style.background=this._m_BackgroundColor,this._m_TextureCanvas.style.position="absolute",this._m_TextureCanvas.style.opacity="1.0",this._m_TextureCanvas.style.visibility="hidden",this._m_TextureCanvas.style["z-index"]=1,document.getElementsByTagName("body")[0].appendChild(this._m_TextureCanvas),this._m_Context=this._m_TextureCanvas.getContext("2d"),this._m_Context.translate(this._m_Width,this._m_Height),this._m_Context.scale(-1,-1),this.setText(i)}var t,i,o;return t=e,(i=[{key:"getImage",value:function(){return this._m_TextureCanvas}},{key:"setPixelSize",value:function(e){this._m_Pixelsize=e,this.setText(this._m_CurLabel)}},{key:"setBackgroundColor",value:function(e){this._m_BackgroundColor=e,this.setText(this._m_CurLabel)}},{key:"setText",value:function(e){this._m_CurLabel=e,this._m_Context.fillStyle=this._m_BackgroundColor,this._m_Context.fillRect(0,0,this._m_Width,this._m_Height),this._m_Context.fillStyle=this._m_TextColor,this._m_Context.font=this._m_Pixelsize+"px sans-serif",this._m_Context.textAlign="center";var t=0+this._m_Width*this._m_AlignLeftOffset,n=0+this._m_Height*this._m_AlignTopOffset;this._m_Context.fillText(e,t,n,this._m_Width)}},{key:"setTextColor",value:function(e){this._m_TextColor=e,this.setText(this._m_CurLabel)}},{key:"setAlign",value:function(e,t){this._m_AlignLeftOffset=e,this._m_AlignTopOffset=t,this.setText(this._m_CurLabel)}}])&&n(t.prototype,i),o&&n(t,o),e}();t.default=i},5397:(__unused_webpack_module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _BoundingVolume=_interopRequireDefault(__webpack_require__(1322)),_Vector=_interopRequireDefault(__webpack_require__(5604)),_Vector2=_interopRequireDefault(__webpack_require__(9271)),_Log=_interopRequireDefault(__webpack_require__(3846));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o={lz:function(e,t){if("number"!=typeof t||t<=0||"number"!=typeof e&&"string"!=typeof e)return e;for(e+="";e.length<t;)e="0"+e;return e},getHashCode:function(e){for(var t=0,n="string"==typeof e?e.length:0,r=0;r<n;)t=(t<<5)-t+e.charCodeAt(r++);return t<0?-1*t+4294967295:t},uniqueId:function(e,t){if(null==e||"string"!=typeof e){o.___uqidc?++o.___uqidc:o.___uqidc=0;var n=e=(new Date).getTime()+""+o.___uqidc}else n=o.getHashCode(e);return(t?"res:":"")+n.toString(32)+"-"+o.lz((4*e.length).toString(16),3)}},BS=[[0,1,0],[1,0,0],[0,0,1]],Tools=function(){function Tools(){_classCallCheck(this,Tools)}return _createClass(Tools,null,[{key:"isPowerOfTwo",value:function(e){return 0==(e&e-1)}},{key:"nextHighestPowerOfTwo",value:function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}},{key:"ensureImageSizePowerOfTwo",value:function(e,t){Tools.isPowerOfTwo(e.width)&&Tools.isPowerOfTwo(e.height)||(t.width=Tools.nextHighestPowerOfTwo(e.width),t.height=Tools.nextHighestPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t);return e}},{key:"checkIsNull",value:function(e){return null!=e&&null!=e}},{key:"nextId",value:function(){return Tools.uniqueId(--Tools._s_Id+"R3D")}},{key:"insertLine",value:function(e,t,n){for(var r=(e=Tools.trim(e)).split("\n"),i="",o=0;o<r.length;o++)o==n&&(i+=t+"\n"),i+=r[o]+"\n";return i}},{key:"uniqueId",value:function(e){return o.uniqueId(e)}},{key:"getTagPattern",value:function getTagPattern(str){return eval("/"+str+"/g")}},{key:"getPattern",value:function getPattern(str){return eval("/"+str+"/")}},{key:"trim",value:function(e){return e.replace(/(^\s*)|(\s*$)/g,"")}},{key:"find",value:function(e,t){return-1!=e.search(t)}},{key:"find2",value:function(e,t){return e.search(t)}},{key:"repSrc",value:function(e,t,n,r){return-1!=e.search(t)?e.replace(n,r):e}},{key:"approxScreenArea",value:function(e,t,n){return e.getType()==_BoundingVolume.default.S_TYPE_AABB?(e.getXHalf()*e.getXHalf()+e.getYHalf()*e.getYHalf()+e.getZHalf()*e.getZHalf())*n*n/(t*t*4)*Math.PI:(e.getType(),_BoundingVolume.default.S_TYPE_SPHERE,0)}},{key:"generatorTangents2",value:function(e,t,n,r){for(var i=t.length/3,o=new Float32Array(4*i),a=[],_=[],s=0;s<i;s++)a[s]=new _Vector.default,_[s]=new _Vector.default;for(var u=new _Vector.default,l=new _Vector.default,f=new _Vector.default,c=new _Vector2.default,m=new _Vector2.default,h=new _Vector2.default,d=new _Vector.default,p=new _Vector.default,g=function(e,r,i){u.setToInXYZ(t[3*e],t[3*e+1],t[3*e+2]),l.setToInXYZ(t[3*r],t[3*r+1],t[3*r+2]),f.setToInXYZ(t[3*i],t[3*i+1],t[3*i+2]),c.setToInXY(n[2*e],n[2*e+1]),m.setToInXY(n[2*r],n[2*r+1]),h.setToInXY(n[2*i],n[2*i+1]),l.sub(u),f.sub(u),m.sub(c),h.sub(c);var o=1/(m._m_X*h._m_Y-h._m_X*m._m_Y);isFinite(o)&&(d.setTo(l),d.multLength(h._m_Y),d.addInXYZ(f._m_X*-m._m_Y,f._m_Y*-m._m_Y,f._m_Z*-m._m_Y),d.multLength(o),p.setTo(f),p.multLength(m._m_X),p.addInXYZ(l._m_X*-h._m_X,l._m_Y*-h._m_X,l._m_Z*-h._m_X),p.multLength(o),a[e].add(d),a[r].add(d),a[i].add(d),_[e].add(p),_[r].add(p),_[i].add(p))},S=0;S<e.length;S+=3)g(e[S+0],e[S+1],e[S+2]);for(var v,y,C,T=new _Vector.default,b=new _Vector.default,P=new _Vector.default,E=new _Vector.default,D=function(e){P.setToInXYZ(r[3*e],r[3*e+1],r[3*e+2]),E.setTo(P),y=a[e],T.setTo(y),T.sub(P.multLength(P.dot(y))).normal(),E.cross(y,b),C=b.dot(_[e]),v=C<0?-1:1,o[4*e]=T._m_X,o[4*e+1]=T._m_Y,o[4*e+2]=T._m_Z,o[4*e+3]=v},R=0;R<e.length;R+=3)D(e[R+0]),D(e[R+1]),D(e[R+2]);return o}},{key:"generatorFillTangents2",value:function(e){for(var t=4*(e.length/3),n=[],r=0;r<t;r++)n[r]=0;return n}},{key:"generatorFillTangents",value:function(e){for(var t=[],n=0;n<e.length;n++)t[n]=e[n];return t}},{key:"generatorTangents",value:function(e,t,n){for(var r=new _Vector.default,i=new _Vector.default,o=new Array(4).fill(0),a=0,_=0,s=0,u=0,l=[],f={},c=new _Vector.default,m=new _Vector.default,h=new _Vector.default,d=new _Vector2.default,p=new _Vector2.default,g=new _Vector2.default,S=new _Vector2.default,v=0,y=0,C=0,T=0,b=0;b<e.length;b+=3){c.setToInXYZ(t[3*e[b]],t[3*e[b]+1],t[3*e[b]+2]),m.setToInXYZ(t[3*e[b+1]],t[3*e[b+1]+1],t[3*e[b+1]+2]),h.setToInXYZ(t[3*e[b+2]],t[3*e[b+2]+1],t[3*e[b+2]+2]),d.setToInXY(n[2*e[b]],n[2*e[b]+1]),p.setToInXY(n[2*e[b+1]],n[2*e[b+1]+1]),g.setToInXY(n[2*e[b+2]],n[2*e[b+2]+1]),m.sub(c,r),h.sub(c,i),p.sub(d,S),v=S._m_X,y=S._m_Y,g.sub(d,S),C=S._m_X,T=S._m_Y,Tools._generatorDietaryUVMat(v,y,C,T,o);var P=(_=o[0]*r._m_X+o[1]*i._m_X)*_+(s=o[0]*r._m_Y+o[1]*i._m_Y)*s+(u=o[0]*r._m_Z+o[1]*i._m_Z)*u;_*=P=1/Math.sqrt(P),s*=P,u*=P,Tools._generatorWeightedTangent(e[b],e[b+1],e[b+2],_,s,u,f)}for(var E in Tools._normalizedTangents(f),f)l[a++]=f[E][0],l[a++]=f[E][1],l[a++]=f[E][2];return l}},{key:"_normalizedTangents",value:function(e){var t=[],n=0;for(var r in e)t[0]=e[r][0],t[1]=e[r][1],t[2]=e[r][2],(n=t[0]*t[0]+t[1]*t[1]+t[2]*t[2])>0?(n=Math.sqrt(1*n),t[0]/=n,t[1]/=n,t[2]/=n):t[0]=t[1]=t[2]=0,e[r][0]=t[0],e[r][1]=t[1],e[r][2]=t[2]}},{key:"_generatorWeightedTangent",value:function(e,t,n,r,i,o,a){Tools.checkIsNull(a[e])?a[e]=[.5*(r+a[e][0]),.5*(i+a[e][1]),.5*(o+a[e][2])]:a[e]=[r,i,o],Tools.checkIsNull(a[t])?a[t]=[.5*(r+a[t][0]),.5*(i+a[t][1]),.5*(o+a[t][2])]:a[t]=[r,i,o],Tools.checkIsNull(a[n])?a[n]=[.5*(r+a[n][0]),.5*(i+a[n][1]),.5*(o+a[n][2])]:a[n]=[r,i,o]}},{key:"_generatorDietaryUVMat",value:function(e,t,n,r,i){var o=1/(e*r-n*t);return i[0]=r*o,i[1]=-t*o,i[2]=-n*o,i[3]=e*o,i}},{key:"generatorBaryCentrics",value:function(e,t){for(var n,r,i,o={},a=[],_=null,s=0,u=0;u<t.length;u+=3)a.length=0,n=t[u],r=t[u+1],i=t[u+2],o[n]&&a.push(o[n]),o[r]&&a.push(o[r]),o[i]&&a.push(o[i]),(_=Tools._nextBarycentrics(a))&&(s=0,o[n]||(o[n]=_[s++]),o[r]||(o[r]=_[s++]),o[i]||(o[i]=_[s++]));var l=new Array(e.length).fill(0);for(var f in o)l[3*f]=o[f][0],l[3*f+1]=o[f][1],l[3*f+2]=o[f][2];return l}},{key:"_nextBarycentrics",value:function(e){if(3==e.length)return e[0][0]==e[1][0]&&e[0][1]==e[1][1]&&e[0][2]==e[1][2]?e[0]=[0,0,0]:e[1][0]==e[2][0]&&e[1][1]==e[2][1]&&e[1][2]==e[2][2]?e[1]=[0,0,0]:e[2][0]==e[0][0]&&e[2][1]==e[0][1]&&e[2][2]==e[0][2]&&(e[2]=[0,0,0]),null;if(0==e.length)return[[0,1,0],[1,0,0],[0,0,1]];var t=[!0,!0,!0],n=[];2==e.length&&(e[0][0]==e[1][0]&&e[0][1]==e[1][1]&&e[0][2]==e[1][2]?e[0]=[0,0,0]:e[1][0]==e[2][0]&&e[1][1]==e[2][1]&&e[1][2]==e[2][2]&&(e[1]=[0,0,0])),e.forEach((function(n){n[0]==e[1][0]&&n[1]==e[1][1]&&n[2]==e[1][2]?t[1]=!1:n[0]==e[2][0]&&n[1]==e[2][1]&&n[2]==e[2][2]?t[2]=!1:n[0]==e[0][0]&&n[1]==e[0][1]&&n[2]==e[0][2]&&(t[0]=!1)}));for(var r=0;r<3;r++)t[r]&&n.push(BS[r]);return n}}]),Tools}();exports.default=Tools,_defineProperty(Tools,"_s_Id",0)},6693:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,i;return t=e,i=[{key:"setBufLocal",value:function(e,t,n,r,i,o,a,_){e.bindBuffer(n,t),e.vertexAttribPointer(r,i,o,!1,a,_),e.enableVertexAttribArray(r),e.bindBuffer(n,null)}},{key:"setVertexBuf",value:function(e,t,n,r,i,o,a,_,s,u){e.bindVertexArray(t);var l=e.createBuffer();return e.bindBuffer(n,l),e.bufferData(n,r,i),e.vertexAttribPointer(o,a,_,!1,s,u),e.enableVertexAttribArray(o),e.bindBuffer(n,null),e.bindVertexArray(null),l}},{key:"setIndicesBuf",value:function(e,t,n,r,i){e.bindVertexArray(t);var o=e.createBuffer();return e.bindBuffer(n,o),e.bufferData(n,r,i),e.bindVertexArray(null),e.bindBuffer(n,null),o}}],(r=null)&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},7902:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.Buffer=void 0;var r=function(){function e(t,n,r,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Name=t,this._m_Loc=n||null,this._m_Width=r||0,this._m_Height=i||0,this._m_Format=o}var t,r,i;return t=e,(r=[{key:"setName",value:function(e){this._m_Name=e}},{key:"getName",value:function(){return this._m_Name}},{key:"setLoc",value:function(e){this._m_Loc=e}},{key:"getLoc",value:function(){return this._m_Loc}},{key:"setWidth",value:function(e){this._m_Width=e}},{key:"getWidth",value:function(){return this._m_Width}},{key:"setHeight",value:function(e){this._m_Height=e}},{key:"getHeight",value:function(){return this._m_Height}},{key:"setFormat",value:function(e){this._m_Format=e}},{key:"getFormat",value:function(){return this._m_Format}}])&&n(t.prototype,r),i&&n(t,i),e}();t.Buffer=r},7341:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=n(7902),i=_(n(2584)),o=(_(n(7280)),_(n(5776))),a=_(n(3846));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var u=function(){function e(t,n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Name=n,this._m_Framebuffer=t.createFramebuffer(),this._m_Textures=[],this._m_NameTextures={},this._m_MapTextures={},this._m_Buffers=[],this._m_MapBuffers={},this._m_DrawBuffers=[],this._m_Width=r,this._m_Height=i,this._m_RData={},this._m_FramePicture=null,this._m_FixedSize=!1}var t,n,_;return t=e,(n=[{key:"setFixedSize",value:function(e){this._m_FixedSize=e}},{key:"isFixedSize",value:function(){return this._m_FixedSize}},{key:"readPixels",value:function(e,t,n,r,i,o,a,_){i=i||0,o=o||0,a=a||this._m_Width,_=_||this._m_Height;var s=-1,u=null;switch(n){case e.RGBA16F:u=Float32Array,s=4;break;case e.RGBA8:case e.RGBA:u=r!=e.FLOAT?Uint8Array:Float32Array,s=4;break;case e.RGB16F:u=Float32Array,s=3;break;case e.RGB8:case e.RGB:u=r!=e.FLOAT?Uint8Array:Float32Array,s=3}e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT),e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE);var l=new u(a*_*s);return e.readPixels(i,o,a,_,n,r,l),l}},{key:"getFramePicture",value:function(){return this._m_FramePicture}},{key:"getFrameBuffer",value:function(){return this._m_Framebuffer}},{key:"use",value:function(e){var t=e.getFrameContext();if(t.m_LastFrameBuffer!=this._m_Framebuffer){var n=e._m_Scene.getCanvas().getGLContext();n.bindFramebuffer(n.FRAMEBUFFER,this._m_Framebuffer),t.m_LastFrameBuffer=this._m_Framebuffer}}},{key:"clear",value:function(e){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}},{key:"addBuffer",value:function(e,t,n,i){var o;e.bindFramebuffer(e.FRAMEBUFFER,this._m_Framebuffer),o=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,o);var a=new r.Buffer(t,o,this._m_Width,this._m_Height,n);e.renderbufferStorage(e.RENDERBUFFER,n,this._m_Width,this._m_Height),e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,o),this._m_MapBuffers[i]=a,this._m_Buffers.push(a),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),this._rData("buffer",{name:t,format:n,attachId:i})}},{key:"_rData",value:function(e,t){this._m_RData[e]||(this._m_RData[e]={keys:{},values:[]}),this._m_RData[e].keys[t.name]||(this._m_RData[e].keys[t.name]=!0,this._m_RData[e].values.push(t))}},{key:"getBuffers",value:function(){return this._m_Buffers}},{key:"setMipMap",value:function(e,t,n,r){e.framebufferTexture2D(e.FRAMEBUFFER,n,e.TEXTURE_2D,this._m_NameTextures[t].getLoc(),r)}},{key:"addTexture",value:function(e,t,n,r,o,a,_,s,u){e.bindFramebuffer(e.FRAMEBUFFER,this._m_Framebuffer);var l=e.createTexture(),f=new i.default(t,l,n,this._m_Width,this._m_Height,r,o,a,null);e.bindTexture(e.TEXTURE_2D,l),e.texImage2D(e.TEXTURE_2D,0,n,this._m_Width,this._m_Height,0,o,a,null),u?(e.generateMipmap(e.TEXTURE_2D),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.framebufferTexture2D(e.FRAMEBUFFER,_,e.TEXTURE_2D,l,0),this._m_MapTextures[_]=f,this._m_Textures.push(f),this._m_NameTextures[t]=f,s&&this._m_DrawBuffers.push(_),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null),this._rData("texture",{name:t,internalformat:n,border:r,format:o,type:a,attachId:_,toDrawBuffer:s,genMipmap:u})}},{key:"getTextures",value:function(){return this._m_Textures}},{key:"getTexture",value:function(e){return this._m_NameTextures[e]}},{key:"resize",value:function(e,t,n){var r=this;if(!this._m_FixedSize&&(this._m_Width!=t||this._m_Height!=n)){this._m_Width=t,this._m_Height=n,e.deleteFramebuffer(this._m_Framebuffer),this._m_Framebuffer=e.createFramebuffer(),this._m_Textures=[],this._m_NameTextures={},this._m_MapTextures={},this._m_Buffers=[],this._m_MapBuffers={},this._m_DrawBuffers=[];var i=null;for(var o in this._m_RData)i=this._m_RData[o].values,"buffer"==o?i.forEach((function(t){r.addBuffer(e,t.name,t.format,t.attachId)})):"texture"==o&&i.forEach((function(t){r.addTexture(e,t.name,t.internalformat,t.border,t.format,t.type,t.attachId,t.toDrawBuffer,t.genMipmap)}));this.finish(e)}}},{key:"finish",value:function(e,t,n){switch(e.bindFramebuffer(e.FRAMEBUFFER,this._m_Framebuffer),this._m_DrawBuffers.length>0&&e.drawBuffers(this._m_DrawBuffers),e.isFramebuffer(this._m_Framebuffer)||a.default.error("[["+this._m_Name+"]]无效frameBuffer!"),e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_COMPLETE:a.default.log("[["+this._m_Name+"]]帧缓冲区已准备好显示。");break;case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:a.default.error("[["+this._m_Name+"]]附件类型不匹配或不是所有的帧缓冲附件点都已完成。");break;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:a.default.error("[["+this._m_Name+"]]没有附件。");break;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:a.default.error("[["+this._m_Name+"]]附件的高度和宽度不同。");break;case e.FRAMEBUFFER_UNSUPPORTED:a.default.error("[["+this._m_Name+"]]不支持附件的格式，或者深度和模板附件的渲染缓冲区不同。")}e.bindFramebuffer(e.FRAMEBUFFER,null),n&&(this._m_FramePicture=new o.default(t,{id:this._m_Name+"_picture"}))}}])&&s(t.prototype,n),_&&s(t,_),e}();t.default=u},6798:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(8435))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.m_LastMaterial=null,this.m_LastIDrawable=null,this.m_LastSubShader=null,this.m_LastSubShaderId=null,this.m_LastFrameBuffer=null,this.m_SM=0,this.m_SS=0,this._m_BatchLightLastIndex=0,this._m_DefaultFrameBuffer=null,this.m_Contexts={},this.m_CalcContexts={},this.m_RenderState=new i.default(!0),this.m_FrameBuffers={},this.m_Shaders={},this._m_ContextBlocks={}}var t,n,r;return t=e,(n=[{key:"getBatchLightLastIndex",value:function(){return this._m_BatchLightLastIndex}},{key:"BatchLightLastIndex",set:function(e){this._m_BatchLightLastIndex=e}},{key:"resize",value:function(e,t,n){for(var r in this.m_FrameBuffers)this.m_FrameBuffers[r].resize(e,t,n)}},{key:"getContextBlock",value:function(e){return this._m_ContextBlocks[e]}},{key:"addContextBlock",value:function(e,t){this._m_ContextBlocks[e]=t}},{key:"getFrameBuffer",value:function(e){return this.m_FrameBuffers[e]}},{key:"addFrameBuffer",value:function(e,t){this.m_FrameBuffers[e]=t}},{key:"getRenderState",value:function(){return this.m_RenderState}},{key:"addContext",value:function(e){this.m_Contexts[e]=!0}},{key:"getContext",value:function(e){return this.m_Contexts[e]}},{key:"getCalcContexts",value:function(){return this.m_CalcContexts}},{key:"getCalcContext",value:function(e){return this.m_CalcContexts[e]}},{key:"setCalcContext",value:function(e,t){this.m_CalcContexts[e]=t}},{key:"reset",value:function(){this._m_BatchLightLastIndex=0,this.m_LastMaterial=null,this.m_LastSubShader=null,this.m_LastSubShaderId=null,this.m_LastFrameBuffer=null,this.m_SM=0,this.m_SS=0}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=a},307:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=_(n(6693)),i=_(n(9784)),o=_(n(3846)),a=_(n(2228));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Datas={},this._m_Bufs={},this._m_VAO=null,this._m_GL=null,this._m_ElementCount=0,this._m_Primitive=e.S_PRIMITIVE_TRIANGLES,this._m_DrawPrimitive=null,this._m_DrawType=null,this._m_CurrentLod=0,this._m_DrawLod=0,this._m_LodLevels={},this._m_LodLevelCount=0}var t,n,_;return t=e,(n=[{key:"setPrimitive",value:function(t){if(this._m_Primitive=t,this._m_GL)switch(this._m_Primitive){case e.S_PRIMITIVE_TRIANGLES:this._m_DrawPrimitive=this._m_GL.TRIANGLES;break;case e.S_PRIMITIVE_LINES:this._m_DrawPrimitive=this._m_GL.LINES}}},{key:"getPrimitive",value:function(){return this._m_Primitive}},{key:"_checkDataType",value:function(t){return!!e.S_DATAS[t]||(console.error("type is undefined:"+t),!1)}},{key:"setData",value:function(e,t,n){this._checkDataType(e)&&n&&null!=n.level?(this._m_Datas[e]||(this._m_Datas[e]={lod:!0,datas:[],count:0}),this._m_Datas[e].count+=t.length,this._m_Datas[e].datas.push({data:t,level:n.level,count:t.length})):this._m_Datas[e]=t}},{key:"getData",value:function(e){return this._m_Datas[e]}},{key:"_refreshBufLocal",value:function(e,t){var n=this;t.forEach((function(e){n._m_Bufs[e.name]}))}},{key:"_updateBound",value:function(t){if(this._m_GL=t,this._m_Datas){for(var n in this._m_VAO||(this._m_VAO=t.createVertexArray()),this._m_Datas)switch(n){case e.S_BARYCENTRICS:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_BARYCENTRIC,3,t.FLOAT,0,0);break;case e.S_POSITIONS:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_POSITION,3,t.FLOAT,0,0);break;case e.S_COLORS:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_COLOR,4,t.FLOAT,0,0);break;case e.S_NORMALS:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_NORMAL,3,t.FLOAT,0,0);break;case e.S_TANGENTS:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_TANGENT,4,t.FLOAT,0,0);break;case e.S_INDICES:if(this._m_DrawType=t.UNSIGNED_SHORT,this._m_Datas[n].lod){for(var o=this._m_Datas[n].datas,a=new Uint16Array(this._m_Datas[n].count),_=0,s=0,u=0,l=0;u<o.length;u++){this._m_LodLevels[o[u].level]={lod:l,count:o[u].count},this._m_LodLevelCount++;for(var f=0,c=0==s?0:s+1;f<o[u].data.length;f++)a[l++]=c+o[u].data[f],_=Math.max(o[u].data[f]+c,_);s=_,_=0}this._m_CurrentLod=-1,this.lod(0),r.default.setIndicesBuf(t,this._m_VAO,t.ELEMENT_ARRAY_BUFFER,a,t.STATIC_DRAW)}else this._m_ElementCount=this._m_Datas[n].length,r.default.setIndicesBuf(t,this._m_VAO,t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this._m_Datas[n]),t.STATIC_DRAW);break;case e.S_INDICES_32:if(this._m_DrawType=t.UNSIGNED_INT,this._m_Datas[n].lod){for(var m=this._m_Datas[n].datas,h=new Uint32Array(this._m_Datas[n].count),d=0,p=0,g=0,S=0;g<m.length;g++){this._m_LodLevels[m[g].level]={lod:S,count:m[g].count},this._m_LodLevelCount++;for(var v=0,y=0==p?0:p+1;v<m[g].data.length;v++)h[S++]=y+m[g].data[v],d=Math.max(m[g].data[v]+y,d);p=d,d=0}this._m_CurrentLod=-1,this.lod(0),r.default.setIndicesBuf(t,this._m_VAO,t.ELEMENT_ARRAY_BUFFER,h,t.STATIC_DRAW)}else this._m_ElementCount=this._m_Datas[n].length,r.default.setIndicesBuf(t,this._m_VAO,t.ELEMENT_ARRAY_BUFFER,new Uint32Array(this._m_Datas[n]),t.STATIC_DRAW);break;case e.S_UV0:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_UV0,2,t.FLOAT,0,0);break;case e.S_UV1:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_UV1,2,t.FLOAT,0,0);break;case e.S_UV2:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_UV2,2,t.FLOAT,0,0);break;case e.S_UV3:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_UV3,2,t.FLOAT,0,0);break;case e.S_JOINTS_0:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Uint16Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_JOINT_0,4,t.UNSIGNED_SHORT,0,0);break;case e.S_JOINTS_0_32:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Uint32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_JOINT_0,4,t.UNSIGNED_INT,0,0);break;case e.S_WEIGHTS_0:r.default.setVertexBuf(t,this._m_VAO,t.ARRAY_BUFFER,new Float32Array(this._m_Datas[n]),t.STATIC_DRAW,i.default.S_WEIGHT_0,4,t.FLOAT,0,0)}switch(this._m_Primitive){case e.S_PRIMITIVE_TRIANGLES:this._m_DrawPrimitive=this._m_GL.TRIANGLES;break;case e.S_PRIMITIVE_LINES:this._m_DrawPrimitive=this._m_GL.LINES}}}},{key:"draw",value:function(e){e.bindVertexArray(this._m_VAO),e.drawElements(this._m_DrawPrimitive,this._m_ElementCount,this._m_DrawType,this._m_DrawLod)}},{key:"lod",value:function(e){this._m_CurrentLod!=e&&(null!=this._m_LodLevels[e]?(this._m_CurrentLod=e,this._m_ElementCount=this._m_LodLevels[this._m_CurrentLod].count,this._m_DrawLod=this._m_LodLevels[this._m_CurrentLod].lod*a.default.sizeof(a.default.S_UNSIGNED_SHORT)):o.default.error("lod level "+e+"对于当前Mesh无效!"))}},{key:"getLodLevelCount",value:function(){return this._m_LodLevelCount}},{key:"getLodPrimitiveCount",value:function(t){if(null!=this._m_LodLevels[t]){var n=this._m_LodLevels[t].count;switch(this._m_Primitive){case e.S_PRIMITIVE_TRIANGLES:return n/3;case e.S_PRIMITIVE_LINES:return n/2}}else o.default.error("lod level "+t+"对于当前Mesh无效!");return 0}}])&&s(t.prototype,n),_&&s(t,_),e}();t.default=l,u(l,"S_BARYCENTRICS","barycentrics"),u(l,"S_POSITIONS","positions"),u(l,"S_COLORS","colors"),u(l,"S_NORMALS","normals"),u(l,"S_INDICES","indices"),u(l,"S_INDICES_32","indices32"),u(l,"S_TANGENTS","tangents"),u(l,"S_UV0","uv0"),u(l,"S_UV1","uv1"),u(l,"S_UV2","uv2"),u(l,"S_UV3","uv3"),u(l,"S_JOINTS_0","joints_0"),u(l,"S_JOINTS_0_32","joints_0"),u(l,"S_WEIGHTS_0","weights_0"),u(l,"S_DATAS",{barycentrics:"barycentrics",positions:"positions",colors:"colors",normals:"normals",indices:"indices",indices32:"indices",tangents:"tangents",uv0:"uv0",uv1:"uv1",uv2:"uv2",uv3:"uv3",joints_0:"joints_0",weights_0:"weights_0"}),u(l,"S_PRIMITIVE_TRIANGLES","triangles"),u(l,"S_PRIMITIVE_LINES","lines")},8435:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_State={},this._m_StoreState={_state:{},getState:function(){return this._state}},this._m_ResetState={_state:{},getState:function(){return this._state}},t&&this._init()}var t,r,i;return t=e,(r=[{key:"getState",value:function(){return this._m_State}},{key:"getFlag",value:function(e){return this._m_State[e]}},{key:"setFlag",value:function(e,t){this._m_State[e]=t}},{key:"store",value:function(){for(var e in this._m_State)this._m_StoreState._state[e]=this._m_State[e]}},{key:"restore",value:function(){return this._m_StoreState}},{key:"_init",value:function(){this._m_State[e.S_STATES[0]]=e.S_FACE_CULL_BACK,this._m_State[e.S_STATES[1]]="On",this._m_State[e.S_STATES[2]]="On",this._m_State[e.S_STATES[3]]="On",this._m_State[e.S_STATES[4]]="Off",this._m_State[e.S_STATES[6]]="Off",this._m_State[e.S_STATES[7]]="Off",this._m_ResetState._state[e.S_STATES[0]]=e.S_FACE_CULL_BACK,this._m_ResetState._state[e.S_STATES[1]]="On",this._m_ResetState._state[e.S_STATES[2]]="On",this._m_ResetState._state[e.S_STATES[3]]="On",this._m_ResetState._state[e.S_STATES[4]]="Off",this._m_ResetState._state[e.S_STATES[6]]="Off",this._m_ResetState._state[e.S_STATES[7]]="Off"}},{key:"reset",value:function(){return this._m_ResetState}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=i,r(i,"S_FACE_CULL_OFF","Off"),r(i,"S_FACE_CULL_BACK","Back"),r(i,"S_FACE_CULL_FRONT","Front"),r(i,"S_FACE_CULL_FRONT_AND_BACK","FrontAndBack"),r(i,"S_STATES",["FaceCull","DepthWrite","ColorWrite","DepthTest","Blend","BlendFactor","ScissorTest","PolygonOffsetFill","PolygonOffset"])},6616:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_GL=t,this._m_Shader=t.createShader(n),t.shaderSource(this._m_Shader,r),t.compileShader(this._m_Shader),this.compile=t.getShaderParameter(this._m_Shader,t.COMPILE_STATUS),this.compile||(this.error=t.getShaderInfoLog(this._m_Shader),console.log("编译["+(n==t.VERTEX_SHADER?"vertex_shader":n==t.FRAGMENT_SHADER?"fragment_shader":"unknow_shader")+"]失败!原因:\n"+this.error))}var t,r,i;return t=e,(r=[{key:"getShader",value:function(){return this._m_Shader}},{key:"deleteShader",value:function(){this._m_GL.deleteShader(this._m_Shader),this._m_Shader=null}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=i,r(i,"S_TYPE",{float:"float",mat4:"mat4"}),r(i,"S_GLOBALS_MAT","layout (std140) uniform S_GLOBALS_MAT\n{\nmat4 Globals_ViewMatrix;\nmat4 Globals_ProjectMatrix;\nmat4 Globals_ViewProjectMatrix;\n};\n"),r(i,"S_GLOBALS_PARAMS",{viewMatrix:"Globals_ViewProjectMatrix",projectMatrix:"Globals_ProjectMatrix",viewProjectMatrix:"Globals_ViewProjectMatrix"})},9836:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=a(n(9784)),i=a(n(6616)),o=a(n(5397));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=function(){function e(t,n,i,o,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_DefId=n,this._m_vs_s=i.get(r.default.VERTEX_SHADER),this._m_fs_s=i.get(r.default.FRAGMENT_SHADER),this._m_vsDefines=o?o[r.default.VERTEX_SHADER]:null,this._m_fsDefines=o?o[r.default.FRAGMENT_SHADER]:null,this._m_Hold=0,this._m_Holds={},a?this._m_needCompile=!0:this._compile(t)}var t,n,a;return t=e,(n=[{key:"canDestroy",value:function(){return this._m_Hold<=0}},{key:"destroy",value:function(e,t){this._m_Program&&(e.deleteProgram(this._m_Program),t.m_Shaders[this._m_DefId]=null,this._m_Program=null)}},{key:"addHold",value:function(e){this._m_Hold++,this._m_Holds[e._m_ObjId]=e}},{key:"deleteHold",value:function(e){this._m_Hold--,this._m_Holds[e._m_ObjId]=null}},{key:"needCompile",value:function(){return this._m_needCompile}},{key:"_compile",value:function(e){if(this._m_needCompile=!1,this._m_vs_s&&(this._m_vsDefines&&(this._m_vs_s=o.default.insertLine(this._m_vs_s,this._m_vsDefines,1)),this._m_vs=new i.default(e,e.VERTEX_SHADER,this._m_vs_s)),this._m_fs_s&&(this._m_fsDefines&&(this._m_fs_s=o.default.insertLine(this._m_fs_s,this._m_fsDefines,1)),this._m_fs=new i.default(e,e.FRAGMENT_SHADER,this._m_fs_s)),this._m_Program=null,this._m_vs&&this._m_fs)if(this._m_vs.compile&&this._m_fs.compile){if(this._m_Program=e.createProgram(),e.attachShader(this._m_Program,this._m_vs.getShader()),e.attachShader(this._m_Program,this._m_fs.getShader()),e.linkProgram(this._m_Program),!e.getProgramParameter(this._m_Program,e.LINK_STATUS)){var t=e.getProgramInfoLog(this._m_Program);console.error("[["+name+"]]链接ShaderProgram异常:"+t),console.log("vs:\n"+this._m_vs_s),console.log("fs:\n"+this._m_fs_s)}this._m_vs.deleteShader(),this._m_fs.deleteShader()}else console.error("[["+name+"]]无法创建着色器程序,vs或fs编译失败!!"),console.log("vs:\n"+this._m_vs_s),console.log("fs:\n"+this._m_fs_s)}},{key:"use",value:function(e){e.useProgram(this._m_Program)}},{key:"getProgram",value:function(){return this._m_Program}}])&&_(t.prototype,n),a&&_(t,a),e}();t.default=s},9784:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Source={}}var t,r,i;return t=e,i=[{key:"resizeBatchLightSize",value:function(t){t!=e.S_BATCH_LIGHT_SIZE&&(e.S_BATCH_LIGHT_SIZE=3*t,e.Context_Data["Context.VLightData"].modifier="["+e.S_BATCH_LIGHT_SIZE+"]",e.Context_Data["Context.WLightData"].modifier="["+e.S_BATCH_LIGHT_SIZE+"]")}}],(r=[{key:"set",value:function(t,n){e.SOURCE_ENUM[t]?this._m_Source[t]=n:console.error("未知着色器类型:"+t)}},{key:"get",value:function(t){return e.SOURCE_ENUM[t]?this._m_Source[t]:(console.error("未知着色器类型:"+t),null)}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=i,r(i,"VERTEX_SHADER","vertex_shader"),r(i,"FRAGMENT_SHADER","fragment_shader"),r(i,"SOURCE_ENUM",{vertex_shader:"vertex_shader",fragment_shader:"fragment_shader"}),r(i,"S_BARYCENTRIC",0),r(i,"S_POSITION",1),r(i,"S_COLOR",2),r(i,"S_NORMAL",3),r(i,"S_TANGENT",4),r(i,"S_UV0",5),r(i,"S_UV1",6),r(i,"S_UV2",7),r(i,"S_UV3",8),r(i,"S_JOINT_0",9),r(i,"S_WEIGHT_0",10),r(i,"S_MODEL_MATRIX",17),r(i,"S_VIEW_MATRIX",18),r(i,"S_PROJECT_MATRIX",19),r(i,"S_MVP",20),r(i,"S_MV",21),r(i,"S_VP",22),r(i,"S_NDP",23),r(i,"S_G_BUFFER0",0),r(i,"S_G_BUFFER1",1),r(i,"S_G_BUFFER2",2),r(i,"S_G_DEPTH",3),r(i,"S_BARYCENTRIC_SRC","_barycentric"),r(i,"S_POSITION_SRC","_position"),r(i,"S_COLOR_SRC","_color"),r(i,"S_NORMAL_SRC","_normal"),r(i,"S_TANGENT_SRC","_tangent"),r(i,"S_UV0_SRC","_uv0"),r(i,"S_UV1_SRC","_uv1"),r(i,"S_UV2_SRC","_uv2"),r(i,"S_UV3_SRC","_uv3"),r(i,"S_JOINT_0_SRC","_joint_0"),r(i,"S_WEIGHT_0_SRC","_weight_0"),r(i,"S_JOINTS_SRC","_joints"),r(i,"S_OUT_COLOR","_outColor"),r(i,"S_OUT_POSITION","gl_Position"),r(i,"S_MODEL_MATRIX_SRC","_model_matrix"),r(i,"S_VIEW_MATRIX_SRC","_view_matrix"),r(i,"S_PROJECT_MATRIX_SRC","_project_matrix"),r(i,"S_MVP_SRC","_model_view_project_matrix"),r(i,"S_MV_SRC","_model_view_matrix"),r(i,"S_VP_SRC","_view_project_matrix"),r(i,"S_NDP",""),r(i,"S_V_LIGHT_DATA_SRC","_vLightData"),r(i,"S_W_LIGHT_DATA_SRC","_wLightData"),r(i,"S_MULTI_ID_SRC","_multiId"),r(i,"S_BLEND_GI_PROBES","_blend_gi_probes"),r(i,"S_V_LIGHT_DATA0_SRC","_vLight_Data_0"),r(i,"S_V_LIGHT_DATA1_SRC","_vLight_Data_1"),r(i,"S_V_LIGHT_DATA2_SRC","_vLight_Data_2"),r(i,"S_W_LIGHT_DATA0_SRC","_wLight_Data_0"),r(i,"S_W_LIGHT_DATA1_SRC","_wLight_Data_1"),r(i,"S_W_LIGHT_DATA2_SRC","_wLight_Data_2"),r(i,"S_AMBIENT_LIGHT_COLOR","_ambientLightColor"),r(i,"S_CUR_LIGHT_COUNT_SRC","_curLightCount"),r(i,"S_NB_LIGHTS","_NB_LIGHTS"),r(i,"S_BATCH_LIGHT_SIZE",12),r(i,"S_CAMERA_POSITION_SRC","_cameraPosition"),r(i,"S_MAX_BONE",256),r(i,"S_SKINS_SRC","_C_SKINS"),r(i,"S_SRGB_SRC","_C_SRGB"),r(i,"S_GIPROBES_SRC","_C_GIPROBES"),r(i,"S_PSSM_SRC","_C_PSSM"),r(i,"S_POINTLIGHT_SHADOWS_SRC","_C_POINTLIGHT_SHADOWS"),r(i,"S_SPOTLIGHT_SHADOWS_SRC","_C_SPOTLIGHT_SHADOWS"),r(i,"S_FADE_SRC","_C_FADE"),r(i,"S_G_BUFFER0_SRC","_gBuffer0"),r(i,"S_G_BUFFER1_SRC","_gBuffer1"),r(i,"S_G_BUFFER2_SRC","_gBuffer2"),r(i,"S_G_DEPTH_SRC","_gDepth"),r(i,"S_G_DEPTH_RENDER_BUFFER_SRC","_gDepthRenderBuffer"),r(i,"S_SCREEN_SRC","_screen"),r(i,"S_FORWARD_COLOR_MAP_SRC","_forwardColorMap"),r(i,"S_IN_SCREEN_SRC","_inScreenMap"),r(i,"S_IN_DEPTH_SRC","_inDepthMap"),r(i,"S_LIGHT_NUM_SRC","_lightNum"),r(i,"S_TILE_LIGHT_DECODE_SRC","_tileLightDecode"),r(i,"S_TILE_LIGHT_INDEX_SRC","_tileLightIndex"),r(i,"S_TILE_LIGHT_OFFSET_SIZE","_tileLightOffsetSize"),r(i,"S_TILE_W_LIGHT_DATA_0","_tileWLightData0"),r(i,"S_TILE_V_LIGHT_DATA_0","_tileVLightData0"),r(i,"S_TILE_W_LIGHT_DATA_1","_tileWLightData1"),r(i,"S_TILE_V_LIGHT_DATA_1","_tileVLightData1"),r(i,"S_TILE_W_LIGHT_DATA_2","_tileWLightData2"),r(i,"S_TILE_V_LIGHT_DATA_2","_tileVLightData2"),r(i,"S_PREF_ENV_MAP_SRC","_prefEnvMap"),r(i,"S_WGIPROBE_SRC","_wGIProbe"),r(i,"S_SH_COEFFS_SRC","_ShCoeffs"),r(i,"S_RESOLUTION_INVERSE","_ResolutionInverse"),r(i,"S_SHADOW_MAP_ARRAY_SRC",{0:"_shadowMap0",1:"_shadowMap1",2:"_shadowMap2",3:"_shadowMap3",4:"_shadowMap4",5:"_shadowMap5",6:"_shadowMap6"}),r(i,"S_LIGHT_SHADOW_VP_ARRAY_SRC",{0:"_lightViewProjectMatrix0",1:"_lightViewProjectMatrix1",2:"_lightViewProjectMatrix2",3:"_lightViewProjectMatrix3",4:"_lightViewProjectMatrix4",5:"_lightViewProjectMatrix5",6:"_lightViewProjectMatrix6"}),r(i,"S_LIGHT_DIR","_lightDir"),r(i,"S_LIGHT_POS","_lightPos"),r(i,"S_SPLITS","_splits"),r(i,"S_FADEINFO","_fadeInfo"),r(i,"S_SHADOW_MAP_SIZE","_shadowMapSize"),r(i,"S_SHADOW_MAP_SIZE_INVERSE","_sMapSizeInverse"),r(i,"ContextBlocks",{S_VIEW_MATRIX_SRC:!0,S_PROJECT_MATRIX_SRC:!0,S_VP_SRC:!0}),r(i,"MAT","layout (std140) uniform MAT\n{\nmat4 "+i.S_VIEW_MATRIX_SRC+";\nmat4 "+i.S_PROJECT_MATRIX_SRC+";\nmat4 "+i.S_VP_SRC+";\n};\n"),r(i,"VIEW","layout (std140) uniform VIEW\n{\nvec3 "+i.S_CAMERA_POSITION_SRC+";\n};\n"),r(i,"BLOCKS",{MAT:{blockIndex:1,blockDef:i.MAT},VIEW:{blockIndex:2,blockDef:i.VIEW}}),r(i,"Context_RenderDataRefFBs",{_gBuffer0:"DefaultDeferredShadingFrameBuffer",_gBuffer1:"DefaultDeferredShadingFrameBuffer",_gBuffer2:"DefaultDeferredShadingFrameBuffer",_gDepth:"DefaultDeferredShadingFrameBuffer",_forwardColorMap:"DefaultForwardShadingFrameBuffer",_inScreenMap:"DefaultPostFilterShadingFrameBuffer",_inDepthMap:"DefaultPostFilterShadingFrameBuffer"}),r(i,"Context_Data",{"Context.InPosition":{src:i.S_POSITION_SRC,loc:i.S_POSITION,pattern:/Context.InPosition/,pattern2:/Context.InPosition[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InPosition/g,tag:i.S_POSITION_SRC,type:"vec3"},"Context.InBarycentric":{src:i.S_BARYCENTRIC_SRC,loc:i.S_BARYCENTRIC,pattern:/Context.InBarycentric/,pattern2:/Context.InBarycentric[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InBarycentric/g,tag:i.S_BARYCENTRIC_SRC,type:"vec3"},"Context.InNormal":{src:i.S_NORMAL_SRC,loc:i.S_NORMAL,pattern:/Context.InNormal/,pattern2:/Context.InNormal[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InNormal/g,tag:i.S_NORMAL_SRC,type:"vec3"},"Context.InTangent":{src:i.S_TANGENT_SRC,loc:i.S_TANGENT,pattern:/Context.InTangent/,pattern2:/Context.InTangent[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTangent/g,tag:i.S_TANGENT_SRC,type:"vec4"},"Context.InUv0":{src:i.S_UV0_SRC,loc:i.S_UV0,pattern:/Context.InUv0/,pattern2:/Context.InUv0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InUv0/g,tag:i.S_UV0_SRC,type:"vec2"},"Context.InJoint0":{src:i.S_JOINT_0_SRC,loc:i.S_JOINT_0,pattern:/Context.InJoint0/,pattern2:/Context.InJoint0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InJoint0/g,tag:i.S_JOINT_0_SRC,type:"vec4"},"Context.InWeight0":{src:i.S_WEIGHT_0_SRC,loc:i.S_WEIGHT_0,pattern:/Context.InWeight0/,pattern2:/Context.InWeight0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InWeight0/g,tag:i.S_WEIGHT_0_SRC,type:"vec4"},"Context.OutPosition":{src:i.S_OUT_POSITION,pattern:/Context.OutPosition/,pattern2:/Context.OutPosition[\s+-;.,\*\\]{1,}/,tagPattern:/Context.OutPosition/g,tag:"gl_Position"},"Context.ProjectViewModelMatrix":{src:i.S_MVP_SRC,pattern:/Context.ProjectViewModelMatrix/,pattern2:/Context.ProjectViewModelMatrix[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ProjectViewModelMatrix/g,tag:"_model_view_project_matrix",type:"mat4",utype:"uniform mat4"},"Context.ViewMatrix":{src:i.S_VIEW_MATRIX_SRC,pattern:/Context.ViewMatrix/,pattern2:/Context.ViewMatrix[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ViewMatrix/g,tag:i.S_VIEW_MATRIX_SRC,def:"MAT"},"Context.ProjectMatrix":{src:i.S_PROJECT_MATRIX_SRC,pattern:/Context.ProjectMatrix/,pattern2:/Context.ProjectMatrix[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ProjectMatrix/g,tag:i.S_PROJECT_MATRIX_SRC,def:"MAT"},"Context.ModelMatrix":{src:i.S_MODEL_MATRIX_SRC,pattern:/Context.ModelMatrix/,pattern2:/Context.ModelMatrix[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ModelMatrix/g,tag:i.S_MODEL_MATRIX_SRC,type:"mat4",utype:"uniform mat4"},"Context.ProjectViewMatrix":{src:i.S_VP_SRC,pattern:/Context.ProjectViewMatrix/,pattern2:/Context.ProjectViewMatrix[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ProjectViewMatrix/g,tag:i.S_VP_SRC,def:"MAT"},"Context.OutColor":{src:i.S_OUT_COLOR,pattern:/Context.OutColor/,pattern2:/Context.OutColor[\s+-;.,\*\\]{1,}/,tagPattern:/Context.OutColor/g,tag:"_outColor",type:"out vec4"},"Context.Joints":{src:i.S_JOINTS_SRC,pattern:/Context.Joints/,pattern2:/Context.Joints[\s+-;.,\*\\]{1,}/,tagPattern:/Context.Joints/g,tag:i.S_JOINTS_SRC,type:"vec4",utype:"uniform mat4",modifier:"["+i.S_MAX_BONE+"]"},"Context.VLightData":{src:i.S_V_LIGHT_DATA_SRC,pattern:/Context.VLightData/,pattern2:/Context.VLightData[\s+-;.,\*\\]{1,}/,tagPattern:/Context.VLightData/g,tag:i.S_V_LIGHT_DATA_SRC,type:"vec4",utype:"uniform vec4",modifier:"["+i.S_BATCH_LIGHT_SIZE+"]"},"Context.MultiId":{src:i.S_MULTI_ID_SRC,pattern:/Context.MultiId/,pattern2:/Context.MultiId[\s+-;.,\*\\]{1,}/,tagPattern:/Context.MultiId/g,tag:i.S_MULTI_ID_SRC,type:"int",utype:"uniform int"},"Context.TileLightNum":{src:i.S_LIGHT_NUM_SRC,pattern:/Context.TileLightNum/,pattern2:/Context.TileLightNum[\s+-;.,\*\\]{1,}/,tagPattern:/Context.TileLightNum/g,tag:i.S_LIGHT_NUM_SRC,type:"int",utype:"uniform int"},"Context.TileLightOffsetSize":{src:i.S_TILE_LIGHT_OFFSET_SIZE,pattern:/Context.TileLightOffsetSize/,pattern2:/Context.TileLightOffsetSize[\s+-;.,\*\\]{1,}/,tagPattern:/Context.TileLightOffsetSize/g,tag:i.S_TILE_LIGHT_OFFSET_SIZE,type:"float",utype:"uniform float"},"Context.BlendGiProbes":{src:i.S_BLEND_GI_PROBES,pattern:/Context.BlendGiProbes/,pattern2:/Context.BlendGiProbes[\s+-;.,\*\\]{1,}/,tagPattern:/Context.BlendGiProbes/g,tag:i.S_BLEND_GI_PROBES,type:"bool",utype:"uniform bool"},"Context.VLight_Data_0":{src:i.S_V_LIGHT_DATA0_SRC,pattern:/Context.VLight_Data_0/,pattern2:/Context.VLight_Data_0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.VLight_Data_0/g,tag:i.S_V_LIGHT_DATA0_SRC,type:"vec4",utype:"uniform vec4"},"Context.VLight_Data_1":{src:i.S_V_LIGHT_DATA1_SRC,pattern:/Context.VLight_Data_1/,pattern2:/Context.VLight_Data_1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.VLight_Data_1/g,tag:i.S_V_LIGHT_DATA1_SRC,type:"vec4",utype:"uniform vec4"},"Context.VLight_Data_2":{src:i.S_V_LIGHT_DATA2_SRC,pattern:/Context.VLight_Data_2/,pattern2:/Context.VLight_Data_2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.VLight_Data_2/g,tag:i.S_V_LIGHT_DATA2_SRC,type:"vec4",utype:"uniform vec4"},"Context.WLightData":{src:i.S_W_LIGHT_DATA_SRC,pattern:/Context.WLightData/,pattern2:/Context.WLightData[\s+-;.,\*\\]{1,}/,tagPattern:/Context.WLightData/g,tag:i.S_W_LIGHT_DATA_SRC,type:"vec4",utype:"uniform vec4",modifier:"["+i.S_BATCH_LIGHT_SIZE+"]"},"Context.WLight_Data_0":{src:i.S_W_LIGHT_DATA0_SRC,pattern:/Context.WLight_Data_0/,pattern2:/Context.WLight_Data_0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.WLight_Data_0/g,tag:i.S_W_LIGHT_DATA0_SRC,type:"vec4",utype:"uniform vec4"},"Context.WLight_Data_1":{src:i.S_W_LIGHT_DATA1_SRC,pattern:/Context.WLight_Data_1/,pattern2:/Context.WLight_Data_1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.WLight_Data_1/g,tag:i.S_W_LIGHT_DATA1_SRC,type:"vec4",utype:"uniform vec4"},"Context.WLight_Data_2":{src:i.S_W_LIGHT_DATA2_SRC,pattern:/Context.WLight_Data_2/,pattern2:/Context.WLight_Data_2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.WLight_Data_2/g,tag:i.S_W_LIGHT_DATA2_SRC,type:"vec4",utype:"uniform vec4"},"Context.AmbientLightColor":{src:i.S_AMBIENT_LIGHT_COLOR,pattern:/Context.AmbientLightColor/,pattern2:/Context.AmbientLightColor[\s+-;.,\*\\]{1,}/,tagPattern:/Context.AmbientLightColor/g,tag:i.S_AMBIENT_LIGHT_COLOR,type:"vec3",utype:"uniform vec3"},"Context.CurLightCount":{src:i.S_CUR_LIGHT_COUNT_SRC,pattern:/Context.CurLightCount/,pattern2:/Context.CurLightCount[\s+-;.,\*\\]{1,}/,tagPattern:/Context.CurLightCount/g,tag:i.S_CUR_LIGHT_COUNT_SRC,type:"int",utype:"uniform int"},"Context.CameraPosition":{src:i.S_CAMERA_POSITION_SRC,pattern:/Context.CameraPosition/,pattern2:/Context.CameraPosition[\s+-;.,\*\\]{1,}/,tagPattern:/Context.CameraPosition/g,tag:i.S_CAMERA_POSITION_SRC,def:"VIEW"},"Context.WGIProbe":{src:i.S_WGIPROBE_SRC,pattern:/Context.WGIProbe/,pattern2:/Context.WGIProbe[\s+-;.,\*\\]{1,}/,tagPattern:/Context.WGIProbe/g,tag:i.S_WGIPROBE_SRC,type:"vec4",utype:"uniform vec4"},"Context.ShCoeffs":{src:i.S_SH_COEFFS_SRC,pattern:/Context.ShCoeffs/,pattern2:/Context.ShCoeffs[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ShCoeffs/g,tag:i.S_SH_COEFFS_SRC,type:"vec3",utype:"uniform vec3",modifier:"[9]"},"Context.InGBuffer0":{src:i.S_G_BUFFER0_SRC,pattern:/Context.InGBuffer0/,pattern2:/Context.InGBuffer0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InGBuffer0/g,tag:i.S_G_BUFFER0_SRC,type:"sampler2D",utype:"uniform sampler2D",flag:"renderData"},"Context.InGBuffer1":{src:i.S_G_BUFFER1_SRC,pattern:/Context.InGBuffer1/,pattern2:/Context.InGBuffer1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InGBuffer1/g,tag:i.S_G_BUFFER1_SRC,type:"sampler2D",utype:"uniform sampler2D",flag:"renderData"},"Context.InGBuffer2":{src:i.S_G_BUFFER2_SRC,pattern:/Context.InGBuffer2/,pattern2:/Context.InGBuffer2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InGBuffer2/g,tag:i.S_G_BUFFER2_SRC,type:"sampler2D",utype:"uniform sampler2D",flag:"renderData"},"Context.InGDepth":{src:i.S_G_DEPTH_SRC,pattern:/Context.InGDepth/,pattern2:/Context.InGDepth[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InGDepth/g,tag:i.S_G_DEPTH_SRC,type:"sampler2D",utype:"uniform sampler2D",flag:"renderData"},"Context.InScreen":{src:i.S_IN_SCREEN_SRC,pattern:/Context.InScreen/,pattern2:/Context.InScreen[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InScreen/g,tag:i.S_IN_SCREEN_SRC,type:"sampler2D",utype:"uniform sampler2D",flag:"renderData"},"Context.InDepth":{src:i.S_IN_DEPTH_SRC,pattern:/Context.InDepth/,pattern2:/Context.InDepth[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InDepth/g,tag:i.S_IN_DEPTH_SRC,type:"sampler2D",utype:"uniform sampler2D",flag:"renderData"},"Context.InForwardColorMap":{src:i.S_FORWARD_COLOR_MAP_SRC,pattern:/Context.InForwardColorMap/,pattern2:/Context.InForwardColorMap[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InForwardColorMap/g,tag:i.S_FORWARD_COLOR_MAP_SRC,type:"sampler2D",utype:"uniform sampler2D",flag:"renderData"},"Context.InPrefEnvMap":{src:i.S_PREF_ENV_MAP_SRC,pattern:/Context.InPrefEnvMap/,pattern2:/Context.InPrefEnvMap[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InPrefEnvMap/g,tag:i.S_PREF_ENV_MAP_SRC,type:"samplerCube",utype:"uniform samplerCube"},"Context.InTileLightDecode":{src:i.S_TILE_LIGHT_DECODE_SRC,pattern:/Context.InTileLightDecode/,pattern2:/Context.InTileLightDecode[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileLightDecode/g,tag:i.S_TILE_LIGHT_DECODE_SRC,type:"sampler2D",utype:"uniform sampler2D"},"Context.InTileLightIndex":{src:i.S_TILE_LIGHT_INDEX_SRC,pattern:/Context.InTileLightIndex/,pattern2:/Context.InTileLightIndex[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileLightIndex/g,tag:i.S_TILE_LIGHT_INDEX_SRC,type:"sampler2D",utype:"uniform sampler2D"},"Context.InTileWLightData0":{src:i.S_TILE_W_LIGHT_DATA_0,pattern:/Context.InTileWLightData0/,pattern2:/Context.InTileWLightData0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileWLightData0/g,tag:i.S_TILE_W_LIGHT_DATA_0,type:"sampler2D",utype:"uniform sampler2D"},"Context.InTileVLightData0":{src:i.S_TILE_V_LIGHT_DATA_0,pattern:/Context.InTileVLightData0/,pattern2:/Context.InTileVLightData0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileVLightData0/g,tag:i.S_TILE_V_LIGHT_DATA_0,type:"sampler2D",utype:"uniform sampler2D"},"Context.InTileWLightData1":{src:i.S_TILE_W_LIGHT_DATA_1,pattern:/Context.InTileWLightData1/,pattern2:/Context.InTileWLightData1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileWLightData1/g,tag:i.S_TILE_W_LIGHT_DATA_1,type:"sampler2D",utype:"uniform sampler2D"},"Context.InTileVLightData1":{src:i.S_TILE_V_LIGHT_DATA_1,pattern:/Context.InTileVLightData1/,pattern2:/Context.InTileVLightData1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileVLightData1/g,tag:i.S_TILE_V_LIGHT_DATA_1,type:"sampler2D",utype:"uniform sampler2D"},"Context.InTileWLightData2":{src:i.S_TILE_W_LIGHT_DATA_2,pattern:/Context.InTileWLightData2/,pattern2:/Context.InTileWLightData2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileWLightData2/g,tag:i.S_TILE_W_LIGHT_DATA_2,type:"sampler2D",utype:"uniform sampler2D"},"Context.InTileVLightData2":{src:i.S_TILE_V_LIGHT_DATA_2,pattern:/Context.InTileVLightData2/,pattern2:/Context.InTileVLightData2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InTileVLightData2/g,tag:i.S_TILE_V_LIGHT_DATA_2,type:"sampler2D",utype:"uniform sampler2D"},"Context.InShadowMap0":{src:i.S_SHADOW_MAP_ARRAY_SRC[0],pattern:/Context.InShadowMap0/,pattern2:/Context.InShadowMap0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InShadowMap0/g,tag:i.S_SHADOW_MAP_ARRAY_SRC[0],type:"sampler2D",utype:"uniform sampler2D"},"Context.InShadowMap1":{src:i.S_SHADOW_MAP_ARRAY_SRC[1],pattern:/Context.InShadowMap1/,pattern2:/Context.InShadowMap1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InShadowMap1/g,tag:i.S_SHADOW_MAP_ARRAY_SRC[1],type:"sampler2D",utype:"uniform sampler2D"},"Context.InShadowMap2":{src:i.S_SHADOW_MAP_ARRAY_SRC[2],pattern:/Context.InShadowMap2/,pattern2:/Context.InShadowMap2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InShadowMap2/g,tag:i.S_SHADOW_MAP_ARRAY_SRC[2],type:"sampler2D",utype:"uniform sampler2D"},"Context.InShadowMap3":{src:i.S_SHADOW_MAP_ARRAY_SRC[3],pattern:/Context.InShadowMap3/,pattern2:/Context.InShadowMap3[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InShadowMap3/g,tag:i.S_SHADOW_MAP_ARRAY_SRC[3],type:"sampler2D",utype:"uniform sampler2D"},"Context.InShadowMap4":{src:i.S_SHADOW_MAP_ARRAY_SRC[4],pattern:/Context.InShadowMap4/,pattern2:/Context.InShadowMap4[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InShadowMap4/g,tag:i.S_SHADOW_MAP_ARRAY_SRC[4],type:"sampler2D",utype:"uniform sampler2D"},"Context.InShadowMap5":{src:i.S_SHADOW_MAP_ARRAY_SRC[5],pattern:/Context.InShadowMap5/,pattern2:/Context.InShadowMap5[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InShadowMap5/g,tag:i.S_SHADOW_MAP_ARRAY_SRC[5],type:"sampler2D",utype:"uniform sampler2D"},"Context.InShadowMap6":{src:i.S_SHADOW_MAP_ARRAY_SRC[6],pattern:/Context.InShadowMap6/,pattern2:/Context.InShadowMap6[\s+-;.,\*\\]{1,}/,tagPattern:/Context.InShadowMap6/g,tag:i.S_SHADOW_MAP_ARRAY_SRC[6],type:"sampler2D",utype:"uniform sampler2D"},"Context.LightViewProjectMatrix0":{src:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[0],pattern:/Context.LightViewProjectMatrix0/,pattern2:/Context.LightViewProjectMatrix0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightViewProjectMatrix0/g,tag:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[0],type:"mat4",utype:"uniform mat4"},"Context.LightViewProjectMatrix1":{src:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[1],pattern:/Context.LightViewProjectMatrix1/,pattern2:/Context.LightViewProjectMatrix1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightViewProjectMatrix1/g,tag:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[1],type:"mat4",utype:"uniform mat4"},"Context.LightViewProjectMatrix2":{src:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[2],pattern:/Context.LightViewProjectMatrix2/,pattern2:/Context.LightViewProjectMatrix2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightViewProjectMatrix2/g,tag:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[2],type:"mat4",utype:"uniform mat4"},"Context.LightViewProjectMatrix3":{src:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[3],pattern:/Context.LightViewProjectMatrix3/,pattern2:/Context.LightViewProjectMatrix3[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightViewProjectMatrix3/g,tag:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[3],type:"mat4",utype:"uniform mat4"},"Context.LightViewProjectMatrix4":{src:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[4],pattern:/Context.LightViewProjectMatrix4/,pattern2:/Context.LightViewProjectMatrix4[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightViewProjectMatrix4/g,tag:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[4],type:"mat4",utype:"uniform mat4"},"Context.LightViewProjectMatrix5":{src:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[5],pattern:/Context.LightViewProjectMatrix5/,pattern2:/Context.LightViewProjectMatrix5[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightViewProjectMatrix5/g,tag:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[5],type:"mat4",utype:"uniform mat4"},"Context.LightViewProjectMatrix6":{src:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[6],pattern:/Context.LightViewProjectMatrix6/,pattern2:/Context.LightViewProjectMatrix6[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightViewProjectMatrix6/g,tag:i.S_LIGHT_SHADOW_VP_ARRAY_SRC[6],type:"mat4",utype:"uniform mat4"},"Context.LightDir":{src:i.S_LIGHT_DIR,pattern:/Context.LightDir/,pattern2:/Context.LightDir[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightDir/g,tag:i.S_LIGHT_DIR,type:"vec3",utype:"uniform vec3"},"Context.LightPos":{src:i.S_LIGHT_POS,pattern:/Context.LightPos/,pattern2:/Context.LightPos[\s+-;.,\*\\]{1,}/,tagPattern:/Context.LightPos/g,tag:i.S_LIGHT_POS,type:"vec3",utype:"uniform vec3"},"Context.Splits":{src:i.S_SPLITS,pattern:/Context.Splits/,pattern2:/Context.Splits[\s+-;.,\*\\]{1,}/,tagPattern:/Context.Splits/g,tag:i.S_SPLITS,type:"vec4",utype:"uniform vec4"},"Context.Fadeinfo":{src:i.S_FADEINFO,pattern:/Context.Fadeinfo/,pattern2:/Context.Fadeinfo[\s+-;.,\*\\]{1,}/,tagPattern:/Context.Fadeinfo/g,tag:i.S_FADEINFO,type:"vec2",utype:"uniform vec2"},"Context.ResolutionInverse":{src:i.S_RESOLUTION_INVERSE,pattern:/Context.ResolutionInverse/,pattern2:/Context.ResolutionInverse[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ResolutionInverse/g,tag:i.S_RESOLUTION_INVERSE,type:"vec2",utype:"uniform vec2"},"Context.ShadowMapSize":{src:i.S_SHADOW_MAP_SIZE,pattern:/Context.ShadowMapSize/,pattern2:/Context.ShadowMapSize[\s+-;.,\*\\]{1,}/,tagPattern:/Context.ShadowMapSize/g,tag:i.S_SHADOW_MAP_SIZE,type:"float",utype:"uniform float"},"Context.SMapSizeInverse":{src:i.S_SHADOW_MAP_SIZE_INVERSE,pattern:/Context.SMapSizeInverse/,pattern2:/Context.SMapSizeInverse[\s+-;.,\*\\]{1,}/,tagPattern:/Context.SMapSizeInverse/g,tag:i.S_SHADOW_MAP_SIZE_INVERSE,type:"vec2",utype:"uniform vec2"},"Context.OutGBuffer0":{src:i.S_G_BUFFER0_SRC,loc:i.S_G_BUFFER0,pattern:/Context.OutGBuffer0/,pattern2:/Context.OutGBuffer0[\s+-;.,\*\\]{1,}/,tagPattern:/Context.OutGBuffer0/g,tag:i.S_G_BUFFER0_SRC,type:"vec4"},"Context.OutGBuffer1":{src:i.S_G_BUFFER1_SRC,loc:i.S_G_BUFFER1,pattern:/Context.OutGBuffer1/,pattern2:/Context.OutGBuffer1[\s+-;.,\*\\]{1,}/,tagPattern:/Context.OutGBuffer1/g,tag:i.S_G_BUFFER1_SRC,type:"vec4"},"Context.OutGBuffer2":{src:i.S_G_BUFFER2_SRC,loc:i.S_G_BUFFER2,pattern:/Context.OutGBuffer2/,pattern2:/Context.OutGBuffer2[\s+-;.,\*\\]{1,}/,tagPattern:/Context.OutGBuffer2/g,tag:i.S_G_BUFFER2_SRC,type:"vec4"},"Context.OutGDepth":{src:i.S_G_DEPTH_SRC,loc:i.S_G_DEPTH,pattern:/Context.OutGDepth/,pattern2:/Context.OutGDepth[\s+-;.,\*\\]{1,}/,tagPattern:/Context.OutGDepth/g,tag:i.S_G_DEPTH_SRC,type:"vec4"},"Context.Skins":{src:i.S_SKINS_SRC,pattern:/Context.Skins/,pattern2:/Context.Skins[\s+-;.,\*\\]{1,}/,tagPattern:/Context.Skins/g,tag:i.S_SKINS_SRC,isFlagVariable:!0},"Context.Srgb":{src:i.S_SRGB_SRC,pattern:/Context.Srgb/,pattern2:/Context.Srgb[\s+-;.,\*\\]{1,}/,tagPattern:/Context.Srgb/g,tag:i.S_SRGB_SRC,isFlagVariable:!0},"Context.GIProbes":{src:i.S_GIPROBES_SRC,pattern:/Context.GIProbes/,pattern2:/Context.GIProbes[\s+-;.,\*\\]{1,}/,tagPattern:/Context.GIProbes/g,tag:i.S_GIPROBES_SRC,isFlagVariable:!0},"Context.Pssm":{src:i.S_PSSM_SRC,pattern:/Context.Pssm/,pattern2:/Context.Pssm[\s+-;.,\*\\]{1,}/,tagPattern:/Context.Pssm/g,tag:i.S_PSSM_SRC,isFlagVariable:!0},"Context.PointLightShadows":{src:i.S_POINTLIGHT_SHADOWS_SRC,pattern:/Context.PointLightShadows/,pattern2:/Context.PointLightShadows[\s+-;.,\*\\]{1,}/,tagPattern:/Context.PointLightShadows/g,tag:i.S_POINTLIGHT_SHADOWS_SRC,isFlagVariable:!0},"Context.SpotLightShadows":{src:i.S_SPOTLIGHT_SHADOWS_SRC,pattern:/Context.SpotLightShadows/,pattern2:/Context.SpotLightShadows[\s+-;.,\*\\]{1,}/,tagPattern:/Context.SpotLightShadows/g,tag:i.S_SPOTLIGHT_SHADOWS_SRC,isFlagVariable:!0},"Context.Fade":{src:i.S_FADE_SRC,pattern:/Context.Fade/,pattern2:/Context.Fade[\s+-;.,\*\\]{1,}/,tagPattern:/Context.Fade/g,tag:i.S_FADE_SRC,isFlagVariable:!0},_C_SKINS:"#define "+i.S_SKINS_SRC+" "+i.S_SKINS_SRC,_C_SRGB:"#define "+i.S_SRGB_SRC+" "+i.S_SRGB_SRC,_C_GIPROBES:"#define "+i.S_GIPROBES_SRC+" "+i.S_GIPROBES_SRC,_C_PSSM:"#define "+i.S_PSSM_SRC+" "+i.S_PSSM_SRC,_C_POINTLIGHT_SHADOWS:"#define "+i.S_POINTLIGHT_SHADOWS_SRC+" "+i.S_POINTLIGHT_SHADOWS_SRC,_C_SPOTLIGHT_SHADOWS:"#define "+i.S_SPOTLIGHT_SHADOWS_SRC+" "+i.S_SPOTLIGHT_SHADOWS_SRC,_FADE:"#define "+i.S_FADE_SRC+" "+i.S_FADE_SRC})},2228:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i,o,a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,i;return t=e,i=[{key:"sizeof",value:function(t){return t===e.S_UNSIGNED_SHORT?2:-1}}],(r=null)&&n(t.prototype,r),i&&n(t,i),e}();t.default=a,o=1,(i="S_UNSIGNED_SHORT")in(r=a)?Object.defineProperty(r,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[i]=o},2584:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t,n,r,i,o,a,_,s,u){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Name=t,this._m_Loc=n,this._m_InternalFormat=r,this._m_Widht=i,this._m_Height=o,this._m_Border=a,this._m_Format=_,this._m_Type=s,this._m_Data=u}var t,r,i;return t=e,(r=[{key:"setName",value:function(e){this._m_Name=e}},{key:"getName",value:function(){return this._m_Name}},{key:"setLoc",value:function(e){this._m_Loc=e}},{key:"getLoc",value:function(){return this._m_Loc}},{key:"setInternalFormat",value:function(e){this._m_InternalFormat=e}},{key:"getInternalFormat",value:function(){return this._m_InternalFormat}},{key:"setWidth",value:function(e){this._m_Widht=e}},{key:"getWidth",value:function(){return this._m_Widht}},{key:"setHeihgt",value:function(e){this._m_Height=e}},{key:"getHeight",value:function(){return this._m_Height}},{key:"setBorder",value:function(e){this._m_Border=e}},{key:"getBorder",value:function(){return this._m_Border}},{key:"setFormat",value:function(e){this._m_Format=e}},{key:"getFormat",value:function(){return this._m_Format}},{key:"setType",value:function(e){this._m_Type=e}},{key:"getType",value:function(){return this._m_Type}},{key:"setData",value:function(e){this._m_Data=e}},{key:"getData",value:function(){return this._m_Data}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},1446:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Buffer=new Float32Array(t),this._m_Array=new Array(t).fill(0)}var t,r,i;return t=e,(r=[{key:"getArray",value:function(){return this._m_Array}},{key:"getBufferData",value:function(){return this._m_Buffer.set(this._m_Array),this._m_Buffer}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},6140:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_Buffer=new Uint8Array(t),this._m_Array=new Array(t).fill(0)}var t,r,i;return t=e,(r=[{key:"getArray",value:function(){return this._m_Array}},{key:"getBufferData",value:function(){return this._m_Buffer.set(this._m_Array),this._m_Buffer}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},1491:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(t=i.call(this,e))._m_Bool=!1,t}return t=s,(n=[{key:"valueOf",value:function(e){return this._m_Bool=e,this}},{key:"compare",value:function(e){return!1}},{key:"_upload",value:function(e,t,n){e.uniform1i(t,this._m_Bool)}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(3552))&&i.__esModule?i:{default:i}).default);t.default=l},1759:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(t=i.call(this,e))._m_Float=0,t}return t=s,(n=[{key:"valueOf",value:function(e){return this._m_Float=e,this}},{key:"compare",value:function(e){return!1}},{key:"_upload",value:function(e,t,n){e.uniform1f(t,this._m_Float)}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(3552))&&i.__esModule?i:{default:i}).default);t.default=l},1359:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n(3552)),o=(a(n(6140)),a(n(1446)));function a(e){return e&&e.__esModule?e:{default:e}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return l(this,n)}}function l(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(o,e);var t,n,r,i=u(o);function o(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),m(f(t=i.call(this,e)),"_m_Target",void 0),t._m_Scene=e;var n=e.getCanvas().getGLContext();return o.S_TEXTURE_FORMAT={S_RGB:n.RGB,S_RGBA:n.RGBA,S_RGB16F:n.RGB16F,S_RGB32F:n.RGB32F,S_RGBA16F:n.RGBA16F,S_RGBA32F:n.RGBA32F,S_RGBE5:n.RGB9_E5,S_SRGB:n.SRGB,S_SRGB8:n.SRGB8,S_SRGBA:n.SRGB8_ALPHA8,S_DEPTH_COMPONENT24:n.DEPTH_COMPONENT24,S_DEPTH_COMPONENT:n.DEPTH_COMPONENT,S_SHORT:n.SHORT,S_INT:n.INT,S_BYTE:n.BYTE,S_UNSIGNED_BYTE:n.UNSIGNED_BYTE,S_FLOAT:n.FLOAT},t._m_Texture=n.createTexture(),t._setFilter(e,n.TEXTURE_MIN_FILTER,n.NEAREST),t._setFilter(e,n.TEXTURE_MAG_FILTER,n.LINEAR),t._m_Internalformat=n.RGBA16F,t._m_Format=n.RGBA,t._m_Type=n.FLOAT,t._m_UpdateImage=!1,t._m_Image=null,t._m_Rgbe=!1,t._m_Width=t._m_Scene.getCanvas().getWidth(),t._m_Height=t._m_Scene.getCanvas().getHeight(),t._m_FlipY=!1,t._m_Alignment=4,t._m_WrapS=null,t._m_WrapT=null,t._m_MinFilter=o.S_FILTERS.S_LINEAR_MIPMAP_NEAREST,t._m_MagFilter=o.S_FILTERS.S_LINEAR,t}return t=o,(n=[{key:"target",value:function(e){this._m_Target=e}},{key:"setTextureFormat",value:function(e,t,n){this._m_Internalformat=e,this._m_Format=t,this._m_Type=n}},{key:"setAlignment",value:function(e){this._m_Alignment!=e&&(this._m_Alignment=e)}},{key:"updateTextureFilter",value:function(){var e=this._m_Scene.getCanvas().getGLContext();this._m_WrapS&&this._setWrap(this._m_Scene,e.TEXTURE_WRAP_S,this._parseWrap(e,this._m_WrapS)),this._m_WrapT&&this._setWrap(this._m_Scene,e.TEXTURE_WRAP_T,this._parseWrap(e,this._m_WrapT)),this._m_MinFilter&&this._setFilter(this._m_Scene,e.TEXTURE_MIN_FILTER,this._parseFilter(e,this._m_MinFilter)),this._m_MagFilter&&this._setFilter(this._m_Scene,e.TEXTURE_MAG_FILTER,this._parseFilter(e,this._m_MagFilter))}},{key:"uploadArrayData",value:function(e,t,n,r){var i=this._m_Scene.getCanvas().getGLContext();i.activeTexture(i.TEXTURE0+e),i.bindTexture(i.TEXTURE_2D,this._m_Texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this._m_FlipY),i.pixelStorei(i.UNPACK_ALIGNMENT,this._m_Alignment),i.texImage2D(i.TEXTURE_2D,0,this._m_Internalformat,t,n,0,this._m_Format,this._m_Type,r)}},{key:"setFlipY",value:function(e){this._m_FlipY=e}},{key:"genMipmap",value:function(e){var t=e.getCanvas().getGLContext();t.bindTexture(t.TEXTURE_2D,this._m_Texture),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)}},{key:"setFilter",value:function(e,t,n){this._m_MinFilter=t,this._m_MagFilter=n}},{key:"_parseFilter",value:function(e,t){switch(t){case o.S_FILTERS.S_LINEAR:return e.LINEAR;case o.S_FILTERS.S_NEAREST:return e.NEAREST;case o.S_FILTERS.S_LINEAR_MIPMAP_NEAREST:return e.LINEAR_MIPMAP_NEAREST;case o.S_FILTERS.S_LINEAR_MIPMAP_LINEAR:return e.LINEAR_MIPMAP_LINEAR;case o.S_FILTERS.S_NEAREST_MIPMAP_LINEAR:return e.NEAREST_MIPMAP_LINEAR;case o.S_FILTERS.S_NEAREST_MIPMAP_NEAREST:return e.NEAREST_MIPMAP_NEAREST}return null}},{key:"_setFilter",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.texParameteri(r.TEXTURE_2D,t,n),r.bindTexture(r.TEXTURE_2D,null)}},{key:"setWrap",value:function(e,t,n){this._m_WrapS=t,this._m_WrapT=n}},{key:"_parseWrap",value:function(e,t){switch(t){case o.S_WRAPS.S_CLAMP:return e.CLAMP;case o.S_WRAPS.S_REPEAT:return e.REPEAT;case o.S_WRAPS.S_CLAMP_TO_EDGE:return e.CLAMP_TO_EDGE;case o.S_WRAPS.S_CLAMP_TO_BORDER:return e.CLAMP_TO_BORDER}return null}},{key:"_setWrap",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.texParameteri(r.TEXTURE_2D,t,n),r.bindTexture(r.TEXTURE_2D,null)}},{key:"setPreloadColor",value:function(e,t){var n=o._S_TEMP_COLOR.getArray();t?(n[0]=Math.floor(255*t._m_X),n[1]=Math.floor(255*t._m_Y),n[2]=Math.floor(255*t._m_Z),n[3]=Math.floor(255*t._m_W)):(n[0]=0,n[1]=0,n[2]=0,n[3]=255);var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.texImage2D(r.TEXTURE_2D,0,this._m_Internalformat,1,1,0,this._m_Format,this._m_Type,o._S_TEMP_COLOR.getBufferData()),r.bindTexture(r.TEXTURE_2D,null)}},{key:"setImageSrc",value:function(e,t,n){var r=this,i=n&&n.rgbe?RadianceLoader.rgbeImg():new Image;i.onload=function(){for(var e in r._m_Image=n&&n.rgbe?n.linearFloat?i.dataFloat:i.dataRGBE:i,n&&n.rgbe&&(r._m_Rgbe=!0),r._m_Width=i.width,r._m_Height=i.height,r._m_UpdateImage=!0,r._m_OwnerFlags)r._m_OwnerFlags[e].owner.setParam(r._m_OwnerFlags[e].flag,r)},i.src=t}},{key:"setImage",value:function(e,t,n){for(var r in this._m_Image=n&&n.rgbe?n.linearFloat?t.dataFloat:t.dataRGBE:t,n&&n.rgbe&&(this._m_Rgbe=!0),this._m_Width=n&&null!=n.width?n.width:t.width,this._m_Height=n&&null!=n.height?n.height:t.height,this._m_UpdateImage=!0,this._m_OwnerFlags)this._m_OwnerFlags[r].owner.setParam(this._m_OwnerFlags[r].flag,this)}},{key:"_setImage",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,this._m_FlipY),this._m_Rgbe,r.texImage2D(r.TEXTURE_2D,0,this._m_Internalformat,this._m_Width,this._m_Height,0,this._m_Format,this._m_Type,t),r.bindTexture(r.TEXTURE_2D,null)}},{key:"_upload",value:function(e,t,n){if(e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,this._m_Texture),this._m_Target){var r=this._m_Scene.getRender().getFrameContext();e.bindFramebuffer(e.READ_FRAMEBUFFER,this._m_Target.getFrameBuffer()),e.copyTexImage2D(e.TEXTURE_2D,0,this._m_Internalformat,0,0,this._m_Target._m_Width,this._m_Target._m_Height,0),this._m_MinFilter!=o.S_FILTERS.S_NEAREST&&(this._m_MinFilter,o.S_FILTERS.S_LINEAR),e.bindFramebuffer(e.FRAMEBUFFER,r.m_LastFrameBuffer)}}},{key:"compare",value:function(e){return!1}}])&&_(t.prototype,n),r&&_(t,r),o}(i.default);t.default=h,m(h,"_S_TEMP_COLOR",new o.default(4)),m(h,"S_FILTERS",{S_NEAREST:1,S_LINEAR:2,S_LINEAR_MIPMAP_NEAREST:3,S_NEAREST_MIPMAP_LINEAR:4,S_LINEAR_MIPMAP_LINEAR:5,S_NEAREST_MIPMAP_NEAREST:6}),m(h,"S_WRAPS",{S_REPEAT:1,S_CLAMP:2,S_CLAMP_TO_EDGE:3,S_CLAMP_TO_BORDER:4}),m(h,"S_TEXTURE_FORMAT",{})},5141:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(3552)),o=_(n(6140)),a=(_(n(5397)),_(n(6797)));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(o,e);var t,n,r,i=l(o);function o(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=i.call(this,e))._m_Scene=e;var n=e.getCanvas().getGLContext();return o.S_TEXTURE_FORMAT={S_RGB:n.RGB,S_RGBA:n.RGBA,S_RGB16F:n.RGB16F,S_RGB32F:n.RGB32F,S_RGBA16F:n.RGBA16F,S_RGBA32F:n.RGBA32F,S_RGBE5:n.RGB9_E5,S_SRGB:n.SRGB,S_SRGB8:n.SRGB8,S_SRGBA:n.SRGB8_ALPHA8,S_SHORT:n.SHORT,S_INT:n.INT,S_BYTE:n.BYTE,S_UNSIGNED_BYTE:n.UNSIGNED_BYTE,S_FLOAT:n.FLOAT},t._m_Texture=n.createTexture(),t._setFilter(e,n.TEXTURE_MIN_FILTER,n.NEAREST),t._setFilter(e,n.TEXTURE_MAG_FILTER,n.LINEAR),t._m_Internalformat=n.RGBA,t._m_Format=n.RGBA,t._m_Type=n.UNSIGNED_BYTE,t._m_UpdateImage=!1,t._m_Image=null,t._m_Rgbe=!1,t._m_Width=-1,t._m_Height=-1,t._m_FlipY=!1,t._m_Alignment=4,t._m_WrapS=null,t._m_WrapT=null,t._m_MinFilter=o.S_FILTERS.S_LINEAR_MIPMAP_NEAREST,t._m_MagFilter=o.S_FILTERS.S_LINEAR,t}return t=o,(n=[{key:"setTextureFormat",value:function(e,t,n){this._m_Internalformat=e,this._m_Format=t,this._m_Type=n}},{key:"setAlignment",value:function(e){this._m_Alignment!=e&&(this._m_Alignment=e)}},{key:"updateTextureFilter",value:function(){var e=this._m_Scene.getCanvas().getGLContext();this._m_WrapS&&this._setWrap(this._m_Scene,e.TEXTURE_WRAP_S,this._parseWrap(e,this._m_WrapS)),this._m_WrapT&&this._setWrap(this._m_Scene,e.TEXTURE_WRAP_T,this._parseWrap(e,this._m_WrapT)),this._m_MinFilter&&this._setFilter(this._m_Scene,e.TEXTURE_MIN_FILTER,this._parseFilter(e,this._m_MinFilter)),this._m_MagFilter&&this._setFilter(this._m_Scene,e.TEXTURE_MAG_FILTER,this._parseFilter(e,this._m_MagFilter))}},{key:"uploadArrayData",value:function(e,t,n,r){var i=this._m_Scene.getCanvas().getGLContext();i.activeTexture(i.TEXTURE0+e),i.bindTexture(i.TEXTURE_2D,this._m_Texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this._m_FlipY),i.pixelStorei(i.UNPACK_ALIGNMENT,this._m_Alignment),i.texImage2D(i.TEXTURE_2D,0,this._m_Internalformat,t,n,0,this._m_Format,this._m_Type,r)}},{key:"setFlipY",value:function(e){this._m_FlipY=e}},{key:"genMipmap",value:function(e){var t=e.getCanvas().getGLContext();t.bindTexture(t.TEXTURE_2D,this._m_Texture),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)}},{key:"setFilter",value:function(e,t,n){this._m_MinFilter=t,this._m_MagFilter=n}},{key:"_parseFilter",value:function(e,t){switch(t){case o.S_FILTERS.S_LINEAR:return e.LINEAR;case o.S_FILTERS.S_NEAREST:return e.NEAREST;case o.S_FILTERS.S_LINEAR_MIPMAP_NEAREST:return e.LINEAR_MIPMAP_NEAREST;case o.S_FILTERS.S_LINEAR_MIPMAP_LINEAR:return e.LINEAR_MIPMAP_LINEAR;case o.S_FILTERS.S_NEAREST_MIPMAP_LINEAR:return e.NEAREST_MIPMAP_LINEAR;case o.S_FILTERS.S_NEAREST_MIPMAP_NEAREST:return e.NEAREST_MIPMAP_NEAREST}return null}},{key:"_setFilter",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.texParameteri(r.TEXTURE_2D,t,n),r.bindTexture(r.TEXTURE_2D,null)}},{key:"setWrap",value:function(e,t,n){this._m_WrapS=t,this._m_WrapT=n}},{key:"_parseWrap",value:function(e,t){switch(t){case o.S_WRAPS.S_CLAMP:return e.CLAMP;case o.S_WRAPS.S_REPEAT:return e.REPEAT;case o.S_WRAPS.S_CLAMP_TO_EDGE:return e.CLAMP_TO_EDGE;case o.S_WRAPS.S_CLAMP_TO_BORDER:return e.CLAMP_TO_BORDER}return null}},{key:"_setWrap",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.texParameteri(r.TEXTURE_2D,t,n),r.bindTexture(r.TEXTURE_2D,null)}},{key:"setPreloadColor",value:function(e,t){var n=o._S_TEMP_COLOR.getArray();t?(n[0]=Math.floor(255*t._m_X),n[1]=Math.floor(255*t._m_Y),n[2]=Math.floor(255*t._m_Z),n[3]=Math.floor(255*t._m_W)):(n[0]=0,n[1]=0,n[2]=0,n[3]=255);var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.texImage2D(r.TEXTURE_2D,0,this._m_Internalformat,1,1,0,this._m_Format,this._m_Type,o._S_TEMP_COLOR.getBufferData()),r.bindTexture(r.TEXTURE_2D,null)}},{key:"setImageSrc",value:function(e,t,n){var r=this,i=n&&n.rgbe?a.default.rgbeImg():new Image;i.onload=function(){for(var e in r._m_Image=n&&n.rgbe?n.linearFloat?i.dataFloat:i.dataRGBE:i,n&&n.rgbe&&(r._m_Rgbe=!0),r._m_Width=i.width,r._m_Height=i.height,r._m_UpdateImage=!0,r._m_OwnerFlags)r._m_OwnerFlags[e].owner.setParam(r._m_OwnerFlags[e].flag,r)},i.src=t}},{key:"setImage",value:function(e,t,n){for(var r in this._m_Image=n&&n.rgbe?n.linearFloat?t.dataFloat:t.dataRGBE:t,n&&n.rgbe&&(this._m_Rgbe=!0),this._m_Width=n&&null!=n.width?n.width:t.width,this._m_Height=n&&null!=n.height?n.height:t.height,this._m_UpdateImage=!0,this._m_OwnerFlags)this._m_OwnerFlags[r].owner.setParam(this._m_OwnerFlags[r].flag,this)}},{key:"_setImage",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_2D,this._m_Texture),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,this._m_FlipY),this._m_Rgbe,r.texImage2D(r.TEXTURE_2D,0,this._m_Internalformat,this._m_Width,this._m_Height,0,this._m_Format,this._m_Type,t),r.bindTexture(r.TEXTURE_2D,null)}},{key:"_upload",value:function(e,t,n){e.activeTexture(e.TEXTURE0+t),this._m_UpdateImage&&(this._setImage(this._m_Scene,this._m_Image),this._m_MinFilter!=o.S_FILTERS.S_NEAREST&&this._m_MinFilter!=o.S_FILTERS.S_LINEAR&&this.genMipmap(this._m_Scene),this.updateTextureFilter(),this._m_UpdateImage=!1,this._m_Image=null,this._m_Width=this._m_Height=-1,this._m_Rgbe=!1),e.bindTexture(e.TEXTURE_2D,this._m_Texture)}},{key:"compare",value:function(e){return!1}}])&&s(t.prototype,n),r&&s(t,r),o}(i.default);t.default=h,m(h,"_S_TEMP_COLOR",new o.default(4)),m(h,"S_FILTERS",{S_NEAREST:1,S_LINEAR:2,S_LINEAR_MIPMAP_NEAREST:3,S_NEAREST_MIPMAP_LINEAR:4,S_LINEAR_MIPMAP_LINEAR:5,S_NEAREST_MIPMAP_NEAREST:6}),m(h,"S_WRAPS",{S_REPEAT:1,S_CLAMP:2,S_CLAMP_TO_EDGE:3,S_CLAMP_TO_BORDER:4}),m(h,"S_TEXTURE_FORMAT",{})},4048:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=_(n(3552)),o=_(n(6140)),a=_(n(1446));function _(e){return e&&e.__esModule?e:{default:e}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(o,e);var t,n,r,i=l(o);function o(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=i.call(this,e))._m_Scene=e;var n=e.getCanvas().getGLContext();return o.S_TEXTURE_FORMAT={S_RGB:n.RGB,S_RGBA:n.RGBA,S_RGB16F:n.RGB16F,S_RGB32F:n.RGB32F,S_RGBA16F:n.RGBA16F,S_RGBA32F:n.RGBA32F,S_RGBE5:n.RGB9_E5,S_SHORT:n.SHORT,S_SRGB:n.SRGB,S_SRGB8:n.SRGB8,S_SRGBA:n.SRGB8_ALPHA8,S_INT:n.INT,S_BYTE:n.BYTE,S_UNSIGNED_BYTE:n.UNSIGNED_BYTE,S_FLOAT:n.FLOAT},t._m_Texture=n.createTexture(),t._setFilter(e,n.TEXTURE_MIN_FILTER,n.NEAREST),t._setFilter(e,n.TEXTURE_MAG_FILTER,n.LINEAR),t._m_Internalformat=n.RGBA,t._m_Format=n.RGBA,t._m_Type=n.UNSIGNED_BYTE,t._m_CubeMaps={},t._m_UpdateImage=!1,t._m_FlipY=!1,t._m_WrapS=null,t._m_WrapT=null,t._m_WrapR=null,t._m_MinFilter=o.S_FILTERS.S_LINEAR,t._m_MagFilter=o.S_FILTERS.S_LINEAR,t}return t=o,(n=[{key:"setTextureFormat",value:function(e,t,n){this._m_Internalformat=e,this._m_Format=t,this._m_Type=n}},{key:"setFlipY",value:function(e){this._m_FlipY=e}},{key:"genMipmap",value:function(e){var t=e.getCanvas().getGLContext();t.bindTexture(t.TEXTURE_CUBE_MAP,this._m_Texture),t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null)}},{key:"setFilter",value:function(e,t,n){this._m_MinFilter=t,this._m_MagFilter=n}},{key:"_parseFilter",value:function(e,t){switch(t){case o.S_FILTERS.S_LINEAR:return e.LINEAR;case o.S_FILTERS.S_NEAREST:return e.NEAREST;case o.S_FILTERS.S_LINEAR_MIPMAP_NEAREST:return e.LINEAR_MIPMAP_NEAREST}return null}},{key:"_setFilter",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_CUBE_MAP,this._m_Texture),r.texParameteri(r.TEXTURE_CUBE_MAP,t,n),r.bindTexture(r.TEXTURE_CUBE_MAP,null)}},{key:"setWrap",value:function(e,t,n,r){this._m_WrapS=t,this._m_WrapT=n,this._m_WrapR=r}},{key:"_parseWrap",value:function(e,t){switch(t){case o.S_WRAPS.S_CLAMP:return e.CLAMP;case o.S_WRAPS.S_REPEAT:return e.REPEAT;case o.S_WRAPS.S_CLAMP_TO_EDGE:return e.CLAMP_TO_EDGE;case o.S_WRAPS.S_CLAMP_TO_BORDER:return e.CLAMP_TO_BORDER}return null}},{key:"_setWrap",value:function(e,t,n){var r=e.getCanvas().getGLContext();r.bindTexture(r.TEXTURE_CUBE_MAP,this._m_Texture),r.texParameteri(r.TEXTURE_CUBE_MAP,t,n),r.bindTexture(r.TEXTURE_CUBE_MAP,null)}},{key:"setPreloadColor",value:function(e,t){var n=this._m_Type!=o.S_TEXTURE_FORMAT.S_FLOAT?o._S_TEMP_COLOR:o._S_TEMP_COLORF,r=n.getArray();t?(r[0]=Math.floor(255*t._m_X),r[1]=Math.floor(255*t._m_Y),r[2]=Math.floor(255*t._m_Z),r[3]=Math.floor(255*t._m_W)):(r[0]=0,r[1]=0,r[2]=0,r[3]=255);var i=e.getCanvas().getGLContext();i.bindTexture(i.TEXTURE_CUBE_MAP,this._m_Texture);for(var a=0;a<6;a++)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,this._m_Internalformat,1,1,0,this._m_Format,this._m_Type,n.getBufferData());i.bindTexture(i.TEXTURE_CUBE_MAP,null)}},{key:"setImageSrc",value:function(e,t,n,r){var i=this,o=r&&r.rgbe?RadianceLoader.rgbeImg():new Image;o.onload=function(){for(var e in i._m_UpdateImage=!0,i._m_CubeMaps[t]={imgData:r&&r.rgbe?o.dataRGBE:o},r&&r.rgbe&&(i._m_CubeMaps[t].rgbe=!0),i._m_CubeMaps[t].width=o.width,i._m_CubeMaps[t].height=o.height,i._m_CubeMaps[t].updateImage=!0,i._m_OwnerFlags)i._m_OwnerFlags[e].owner.setParam(i._m_OwnerFlags[e].flag,i)},o.src=n}},{key:"setImage",value:function(e,t,n,r){this._m_UpdateImage=!0;var i=r&&null!=r.mipmapLevel?r.mipmapLevel:null,o=null;for(var a in null!=i?(this._m_CubeMaps[t]||(this._m_CubeMaps[t]=[]),this._m_CubeMaps[t].push({imgData:r&&r.rgbe?n.dataRGBE:n,mipmapLevel:i}),o=this._m_CubeMaps[t][this._m_CubeMaps[t].length-1]):(this._m_CubeMaps[t]={imgData:r&&r.rgbe?n.dataRGBE:n},o=this._m_CubeMaps[t]),r&&r.rgbe&&(o.rgbe=!0),o.width=r&&null!=r.width?r.width:n.width,o.height=r&&null!=r.height?r.height:n.height,o.updateImage=!0,o.mipmapLevel=r&&r.mipmapLevel?r.mipmapLevel:0,this._m_OwnerFlags)this._m_OwnerFlags[a].owner.setParam(this._m_OwnerFlags[a].flag,this)}},{key:"_setImage",value:function(e,t,n,r){var i=e.getCanvas().getGLContext();if(i.bindTexture(i.TEXTURE_CUBE_MAP,this._m_Texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this._m_FlipY),n.rgbe)i.texImage2D(this._parseFace(i,t),n.mipmapLevel,this._m_Internalformat,n.width,n.height,0,this._m_Format,this._m_Type,n.imgData);else if(Array.isArray(n)){i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_BASE_LEVEL,0),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,n.length);for(var o=null,a=0;a<n.length;a++)o=n[a],i.texImage2D(this._parseFace(i,t),o.mipmapLevel,this._m_Internalformat,o.width,o.height,0,this._m_Format,this._m_Type,o.imgData)}else i.texImage2D(this._parseFace(i,t),n.mipmapLevel,this._m_Internalformat,n.width,n.height,0,this._m_Format,this._m_Type,n.imgData);i.bindTexture(i.TEXTURE_CUBE_MAP,null)}},{key:"_parseFace",value:function(e,t){switch(t){case o.S_FACE.PositiveX:return e.TEXTURE_CUBE_MAP_POSITIVE_X;case o.S_FACE.NegativeX:return e.TEXTURE_CUBE_MAP_NEGATIVE_X;case o.S_FACE.PositiveY:return e.TEXTURE_CUBE_MAP_POSITIVE_Y;case o.S_FACE.NegativeY:return e.TEXTURE_CUBE_MAP_NEGATIVE_Y;case o.S_FACE.PositiveZ:return e.TEXTURE_CUBE_MAP_POSITIVE_Z;case o.S_FACE.NegativeZ:return e.TEXTURE_CUBE_MAP_NEGATIVE_Z}}},{key:"_upload",value:function(e,t,n){if(e.activeTexture(e.TEXTURE0+t),this._m_UpdateImage){for(var r in this._m_CubeMaps)this._m_CubeMaps[r]&&(this._setImage(this._m_Scene,r,this._m_CubeMaps[r]),this._m_CubeMaps[r]=null);this._m_MinFilter!=o.S_FILTERS.S_LINEAR_MIPMAP_NEAREST&&this._m_MagFilter!=o.S_FILTERS.S_LINEAR_MIPMAP_NEAREST||this.genMipmap(this._m_Scene);var i=this._m_Scene.getCanvas().getGLContext();this._m_WrapS&&this._setWrap(this._m_Scene,i.TEXTURE_WRAP_S,this._parseWrap(i,this._m_WrapS)),this._m_WrapT&&this._setWrap(this._m_Scene,i.TEXTURE_WRAP_T,this._parseWrap(i,this._m_WrapT)),this._m_WrapR&&this._setWrap(this._m_Scene,i.TEXTURE_WRAP_R,this._parseWrap(i,this._m_WrapR)),this._m_MinFilter&&this._setFilter(this._m_Scene,i.TEXTURE_MIN_FILTER,this._parseFilter(i,this._m_MinFilter)),this._m_MagFilter&&this._setFilter(this._m_Scene,i.TEXTURE_MAG_FILTER,this._parseFilter(i,this._m_MagFilter)),this._m_UpdateImage=!1}e.bindTexture(e.TEXTURE_CUBE_MAP,this._m_Texture)}},{key:"compare",value:function(e){return!1}}])&&s(t.prototype,n),r&&s(t,r),o}(i.default);t.default=h,m(h,"_S_TEMP_COLOR",new o.default(4)),m(h,"_S_TEMP_COLORF",new a.default(4)),m(h,"S_FACE",{PositiveX:"1",NegativeX:"2",PositiveY:"3",NegativeY:"4",PositiveZ:"5",NegativeZ:"6"}),m(h,"S_FILTERS",{S_NEAREST:1,S_LINEAR:2,S_LINEAR_MIPMAP_NEAREST:3}),m(h,"S_WRAPS",{S_REPEAT:1,S_CLAMP:2,S_CLAMP_TO_EDGE:3,S_CLAMP_TO_BORDER:4}),m(h,"S_TEXTURE_FORMAT",{})},3552:(e,t)=>{function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._m_OwnerFlags={}}var t,r,i;return t=e,(r=[{key:"compare",value:function(e){return!1}},{key:"_upload",value:function(e,t,n){}},{key:"owner",value:function(e,t){this._m_OwnerFlags[e.getId()]||(this._m_OwnerFlags[e.getId()]={owner:e,flag:t})}},{key:"unowner",value:function(e){this._m_OwnerFlags[e.getId()]&&delete this._m_OwnerFlags[e.getId()]}}])&&n(t.prototype,r),i&&n(t,i),e}();t.default=r},4690:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(t=i.call(this,e))._m_X=0,t._m_Y=0,t}return t=s,(n=[{key:"valueFromXY",value:function(e,t){return this._m_X=e,this._m_Y=t,this}},{key:"compare",value:function(e){return!1}},{key:"_upload",value:function(e,t,n){e.uniform2f(t,this._m_X,this._m_Y)}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(3552))&&i.__esModule?i:{default:i}).default);t.default=l},2462:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}var i;function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var i=u(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return s(this,n)}}function s(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(s,e);var t,n,r,i=_(s);function s(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(t=i.call(this,e))._m_X=0,t._m_Y=0,t._m_Z=0,t._m_W=1,t}return t=s,(n=[{key:"valueFromXYZW",value:function(e,t,n,r){return this._m_X=e,this._m_Y=t,this._m_Z=n,this._m_W=r,this}},{key:"compare",value:function(e){return!1}},{key:"_upload",value:function(e,t,n){e.uniform4f(t,this._m_X,this._m_Y,this._m_Z,this._m_W)}}])&&o(t.prototype,n),r&&o(t,r),s}(((i=n(3552))&&i.__esModule?i:{default:i}).default);t.default=l},4620:(e,n,r)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var i=A(r(2949)),o=A(r(5397)),a=A(r(1193)),_=A(r(3846)),s=A(r(4720)),u=A(r(307)),l=A(r(8113)),f=A(r(4008)),c=A(r(9586)),m=A(r(6858)),h=A(r(479)),d=A(r(7938)),p=A(r(4755)),g=A(r(1245)),S=A(r(7868)),v=A(r(1608)),y=A(r(8649)),C=A(r(1648)),T=A(r(9784)),b=A(r(2462)),P=A(r(1759)),E=A(r(5141)),D=A(r(1491)),R=A(r(7141)),w=A(r(2320)),M=A(r(3370));function A(e){return e&&e.__esModule?e:{default:e}}function L(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),I(this,"_m_CustomMatDef","PrincipledLightingDef")}var n,r,A;return n=e,(r=[{key:"load",value:function(e,t,n,r){this._m_Scene=e,this._m_Batch=r&&r.batch,this._m_GLTFRootNode=null,this._m_PrincipledMatDef=null,this._m_DefaultMatDef=null,this._m_Joints={},this._m_Bones=[],this._m_Nodes={},this._m_Aps=[],this._m_Skeletons={},this._m_AnimationProcessors={},this._m_Mats={},this._m_MatMeshs={},this._m_BasePath=a.default.getBasePath(t),this._loadGLTF(t,n)}},{key:"reset",value:function(){this._m_GLTFRootNode=null,this._m_PrincipledMatDef=null,this._m_DefaultMatDef=null,this._m_Joints={},this._m_Bones=[],this._m_Nodes={},this._m_Aps=[],this._m_Skeletons={},this._m_AnimationProcessors={},this._m_Mats={},this._m_MatMeshs={}}},{key:"setAssetsPath",value:function(e,t){this._m_AssetsPath=e,t&&(this._m_CustomMatDef=t)}},{key:"_loadBIN",value:function(e,t,n,r,i){var o=this;r>0?a.default.loadFile(this._m_BasePath+e.buffers[n].uri,(function(a){r--,t.push({data:a,byteLength:e.buffers[n].byteLength}),o._loadBIN(e,t,++n,r,i)}),null,{inflate:!0}):i&&i()}},{key:"_loadGLTF",value:function(e,t){var n=this;a.default.loadFile(e,(function(e){if((e=JSON.parse(e))&&e.buffers&&e.buffers.length>0){var r=e.buffers.length,i=[];n._loadBIN(e,i,0,r,(function(){if(e.buffers=i,o.default.checkIsNull(e.scene)&&n._addScene(e),n._m_Batch?n._batchScene():(n._bindBone(),o.default.checkIsNull(e.animations)&&(n._parseAnimations(e),n._m_Aps.forEach((function(e){e.skeleton.finished()})))),_.default.log("当前材质:",n._m_Mats),n._m_Mats)for(var r in n._m_Mats)n._m_Mats[r].preload();t&&t(n._m_GLTFRootNode)}))}_.default.log("gltf:",e)}))}},{key:"_batchScene",value:function(){if(this._m_MatMeshs){var e=null,t=null;for(var n in this._m_MatMeshs)e=this._m_MatMeshs[n].mesh,(t=new s.default(this._m_Scene,{id:n+"_"+o.default.nextId()})).setMesh(e),t.updateBound(),t.setMaterial(this._m_Mats[n]),this._m_Mats[n].renderState&&("BLEND"!=this._m_Mats[n].renderState.alphaMode&&"MASK"!=this._m_Mats[n].renderState.alphaMode||t.setTranslucent()),this._m_GLTFRootNode.addChildren(t)}}},{key:"_bindBone",value:function(){for(var e=null,t=null,n=0;n<this._m_Aps.length;n++){e=this._m_Aps[n].skeleton.getJoints(),_.default.log("jointcount:"+e.length);for(var r=0;r<e.length;r++)(t=this._m_Nodes[e[r].getId()])instanceof c.default||t._update2||(t.getType=function(){return"Bone"},t._update2=t._updateLocalMatrix,t.bind=function(e){this._m_Bind=e},t.getBind=function(){return this._m_Bind},t._updateLocalMatrix=function(){this._update2(),this._m_Bind&&this._m_Bind.actived()}),t&&e[r].link(t)}}},{key:"_parseAnimations",value:function(e){var t=this,n=null,r=null,i=null,a=null,s=!1;e.animations.forEach((function(u){r=new h.default(t._getName(u.name)),n=new d.default,u.channels.forEach((function(l){var f=l.target.node;if(i=new p.default(l.target.path),t._m_Nodes[f]){g.default.createTrack(i,t._m_Nodes[f]);var c=u.samplers[l.sampler];t._parseSampler(e,c.input,c.output,c.interpolation,S.default.S_KEY_FRAME[l.target.path],i),n.addClip(i),s=!1;for(var m=0;m<t._m_Aps.length;m++){a=t._m_Aps[m].skeleton.getJoints();for(var h=0;h<a.length;h++)if(a[h].getId()==f){s=!0,t._m_Aps[m].animationProcessor.addAnimationAction(r);break}if(s)break}if(!s){if(_.default.log(f+"非skin动画!path:"+l.target.path),!t._m_AnimationProcessors[f]){var d=new C.default(t._m_GLTFRootNode,{id:o.default.nextId()+"_"+f+"_animationProcessor"});t._m_AnimationProcessors[f]=d}t._m_AnimationProcessors[f].addAnimationAction(r)}}else _.default.log("animation_node:"+f)})),r.setTrackMixer(n)}))}},{key:"_getAccessorData",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=e.DATA_COMPONENT[r.type];return new e.DATA[r.componentType](i[o.buffer].data,(o.byteOffset||0)+(r.byteOffset||0),r.count*a)}},{key:"_parseSampler",value:function(t,n,r,i,o,a){for(var s=this._getAccessorData(t,n),u=this._getAccessorData(t,r),l=t.accessors[n].count,f=e.DATA_COMPONENT[t.accessors[r].type],c=null,m=0,h=0;h<l;h++)m=h*f,f>3?(o||_.default.warn("未知keyframe!"),c=new o(s[h],u[m],u[m+1],u[m+2],u[m+3])):(o||_.default.warn("未知keyframe!"),c=new o(s[h],u[m],u[m+1],u[m+2])),c.setInterpolationMode(i),a.addKeyframe(c)}},{key:"_addScene",value:function(e){var t=this;if(o.default.checkIsNull(e.scene)){var n=e.scenes[e.scene],r=new i.default(this._m_Scene,{id:n.name});return this._m_Batch?(this._m_GLTFRootNode=new i.default(this._m_Scene,{id:o.default.nextId()+"_scene"}),this._m_GLTFRootNode.addChildren(r)):this._m_GLTFRootNode=r,o.default.checkIsNull(n.nodes)&&n.nodes.forEach((function(n){t._addNode(e,r,n)})),this._m_GLTFRootNode}return null}},{key:"_getName",value:function(e){return null==e||null==e||""==e?o.default.nextId():e}},{key:"_parseSkins",value:function(e,t){var n=this,r=e.skins[t],i=new v.default(this._getName(r.name)),o=null,a=this._getAccessorData(e,r.inverseBindMatrices),_=0,s=[];return r.joints.forEach((function(e){n._m_Joints[e]=!0,s.length=0;for(var t=0,r=16*_;t<16;t++)s.push(a[t+r]);(o=new y.default(e,_)).setJointSpace(s),i.addJoint(o),_++})),i}},{key:"_addNode",value:function(e,t,n){var r=this,a=e.nodes[n],s=null;if(this._m_Joints[n]?(s=new c.default(t,{id:this._getName(a.name)}),this._m_Bones.push(s)):s=new i.default(t,{id:this._getName(a.name)}),this._m_Nodes[n]=s,t.addChildren(s),o.default.checkIsNull(a.children)&&a.children.forEach((function(t){r._addNode(e,s,t)})),s&&(o.default.checkIsNull(a.scale)&&s.setLocalScaleXYZ(a.scale[0],a.scale[1],a.scale[2]),o.default.checkIsNull(a.rotation)&&s.setLocalRotationFromXYZW(a.rotation[0],a.rotation[1],a.rotation[2],a.rotation[3]),o.default.checkIsNull(a.translation)&&s.setLocalTranslationXYZ(a.translation[0],a.translation[1],a.translation[2]),o.default.checkIsNull(a.matrix)&&s.setLocalMatrixFromArray(a.matrix)),o.default.checkIsNull(a.mesh))if(this._m_Batch)this._parseMeshBatch(e,s,a.mesh);else if(this._parseMesh(e,s,a.mesh,o.default.checkIsNull(a.skin)),o.default.checkIsNull(a.skin)){var u=null;if(this._m_Skeletons[a.skin]?u=this._m_Skeletons[a.skin]:(u=this._parseSkins(e,a.skin),this._m_Skeletons[a.skin]=u,_.default.log("创建Skeleton!")),s.getChildren().forEach((function(e){e.setSkeleton(u)})),this._m_AnimationProcessors[a.skin]);else{var l=new C.default(this._m_GLTFRootNode,{id:o.default.nextId()+"_animationProcessor"});this._m_Aps.push({skeleton:u,animationProcessor:l}),this._m_AnimationProcessors[a.skin]=l}}}},{key:"_transformVertex",value:function(e,t){for(var n=new R.default,r=new R.default,i=[],o=0;o<e.length;o+=3)n.setToInXYZW(e[o],e[o+1],e[o+2],1),w.default.multiplyMV(r,n,t),i.push(r._m_X),i.push(r._m_Y),i.push(r._m_Z);return i}},{key:"_transformNormal",value:function(e,t){var n=new w.default;n.set(t),n.inert(),n.transpose();for(var r=new R.default,i=new R.default,o=[],a=0;a<e.length;a+=3)r.setToInXYZW(e[a],e[a+1],e[a+2],0),w.default.multiplyMV(i,r,t),o.push(i._m_X),o.push(i._m_Y),o.push(i._m_Z);return o}},{key:"_parseMeshBatch",value:function(e,n,r){for(var i=this,a=e.meshes[r].primitives,_=null,s=null,c=0;c<a.length;c++){_=a[c];var m=null;if(o.default.checkIsNull(_.material)){this._m_PrincipledMatDef||(this._m_AssetsPath&&this._m_CustomMatDef?this._m_PrincipledMatDef=l.default.load(this._m_AssetsPath+this._m_CustomMatDef):this._m_PrincipledMatDef=l.default.parse(M.default.S_PRINCIPLED_LIGHTING_DEF)),m=this._getName(e.materials[_.material].name);var h=null;this._m_Mats[m]?h=this._m_Mats[m]:(h=new f.default(this._m_Scene,{id:m,materialDef:this._m_PrincipledMatDef}),this._parseMaterial(e,_.material,h),this._m_Mats[m]=h)}else{this._m_DefaultMatDef||(this._m_DefaultMatDef=l.default.load(this._m_AssetsPath+"ColorDef")),m="default_gltf_mat";var d=null;this._m_Mats[m]?d=this._m_Mats[m]:(d=new f.default(this._m_Scene,{id:m,materialDef:this._m_DefaultMatDef}),this._m_Mats[m]=d)}if(this._m_MatMeshs[m]){s=this._m_MatMeshs[m].mesh;var p=0;o.default.checkIsNull(_.attributes.POSITION)&&function(){var t=i._parsePositions(e,_.attributes.POSITION);n&&(t.data=i._transformVertex(t.data,n.getWorldMatrix()));var r=s.getData(u.default.S_POSITIONS);r&&(p=r.length,t.data.forEach((function(e){r.push(e)})),s.setData(u.default.S_POSITIONS,r))}(),o.default.checkIsNull(_.attributes.NORMAL)&&function(){var t=i._parseNormals(e,_.attributes.NORMAL);n&&(t.data=i._transformNormal(t.data,n.getWorldMatrix()));var r=s.getData(u.default.S_NORMALS);r&&(t.data.forEach((function(e){r.push(e)})),s.setData(u.default.S_NORMALS,r))}(),o.default.checkIsNull(_.attributes.TEXCOORD_0)&&function(){var t=i._parseTexcoords(e,_.attributes.TEXCOORD_0),n=s.getData(u.default.S_UV0);n&&(t.data.forEach((function(e){n.push(e)})),s.setData(u.default.S_UV0,n))}(),o.default.checkIsNull(_.indices)&&function(){var t=i._parseIndices(e,_.indices),n=s.getData(u.default.S_INDICES),r=0;n?(r=p/3,t.data.forEach((function(e){n.push(e+r)})),s.setData(5125==t.bufType?u.default.S_INDICES_32:u.default.S_INDICES,n),5125!=t.bufType&&s.setData(u.default.S_INDICES,null)):(n=s.getData(u.default.S_INDICES_32))&&(r=p/3,t.data.forEach((function(e){n.push(e+r)})),s.setData(u.default.S_INDICES_32,n))}(),o.default.checkIsNull(_.attributes.TANGENT)?function(){var t=i._parseTangents(e,_.attributes.TANGENT),n=s.getData(u.default.S_TANGENTS);n&&(t.data.forEach((function(e){n.push(e)})),s.setData(u.default.S_TANGENTS,n))}():s.getData(u.default.S_UV0)?function(){var e=o.default.generatorTangents(s.getData(u.default.S_INDICES)?s.getData(u.default.S_INDICES):s.getData(u.default.S_INDICES_32),s.getData(u.default.S_POSITIONS),s.getData(u.default.S_UV0)),t=s.getData(u.default.S_TANGENTS);t&&(e.forEach((function(e){t.push(e)})),s.setData(u.default.S_TANGENTS,t))}():function(){var e=o.default.generatorFillTangents(s.getData(u.default.S_INDICES)?s.getData(u.default.S_INDICES):s.getData(u.default.S_INDICES_32),s.getData(u.default.S_POSITIONS),s.getData(u.default.S_UV0)),t=s.getData(u.default.S_TANGENTS);t&&(e.forEach((function(e){t.push(e)})),s.setData(u.default.S_TANGENTS,t))}()}else{if(s=new u.default,o.default.checkIsNull(_.attributes.POSITION)){var g=this._parsePositions(e,_.attributes.POSITION);n&&(g.data=this._transformVertex(g.data,n.getWorldMatrix())),s.setData(u.default.S_POSITIONS,g.data)}if(o.default.checkIsNull(_.attributes.NORMAL)){var S=this._parseNormals(e,_.attributes.NORMAL);n&&(S.data=this._transformNormal(S.data,n.getWorldMatrix())),s.setData(u.default.S_NORMALS,S.data)}if(o.default.checkIsNull(_.attributes.TEXCOORD_0)){for(var v=this._parseTexcoords(e,_.attributes.TEXCOORD_0),y=[],C=0;C<v.data.length;C++)y.push(v.data[C]);s.setData(u.default.S_UV0,y)}if(o.default.checkIsNull(_.indices)){for(var T=this._parseIndices(e,_.indices),b=[],P=0;P<T.data.length;P++)b.push(T.data[P]);s.setData(5125==T.bufType?u.default.S_INDICES_32:u.default.S_INDICES,b)}if(o.default.checkIsNull(_.attributes.TANGENT)){for(var E=this._parseTangents(e,_.attributes.TANGENT),D=[],R=0;R<E.data.length;R++)D.push(E.data[R]);s.setData(u.default.S_TANGENTS,D)}else if(s.getData(u.default.S_UV0)){for(var w=o.default.generatorTangents2(s.getData(u.default.S_INDICES)?s.getData(u.default.S_INDICES):s.getData(u.default.S_INDICES_32),s.getData(u.default.S_POSITIONS),s.getData(u.default.S_UV0),s.getData(u.default.S_NORMALS)),A=[],L=0;L<w.length;L++)A.push(w[L]);s.setData(u.default.S_TANGENTS,A)}else{for(var I=o.default.generatorFillTangents2(s.getData(u.default.S_INDICES)?s.getData(u.default.S_INDICES):s.getData(u.default.S_INDICES_32),s.getData(u.default.S_POSITIONS),s.getData(u.default.S_UV0)),x=0;x<I.length;x++)t.push(I[x]);s.setData(u.default.S_TANGENTS,t)}this._m_MatMeshs[m]={mesh:s}}}}},{key:"_parseMesh",value:function(e,t,n,r){for(var i=e.meshes[n],a=i.primitives,_=null,c=null,h=null,d=0;d<a.length;d++){if(_=a[d],c=r?new m.default(t,{id:this._getName(i.name)+d}):new s.default(t,{id:this._getName(i.name)+d}),t.addChildren(c),h=new u.default,o.default.checkIsNull(_.attributes.POSITION)){var p=this._parsePositions(e,_.attributes.POSITION);h.setData(u.default.S_POSITIONS,p.data)}if(o.default.checkIsNull(_.attributes.NORMAL)){var g=this._parseNormals(e,_.attributes.NORMAL);h.setData(u.default.S_NORMALS,g.data)}if(o.default.checkIsNull(_.attributes.TEXCOORD_0)){var S=this._parseTexcoords(e,_.attributes.TEXCOORD_0);h.setData(u.default.S_UV0,S.data)}if(r){if(o.default.checkIsNull(_.attributes.JOINTS_0)){var v=this._parseJoints(e,_.attributes.JOINTS_0);h.setData(5125==v.bufType?u.default.S_JOINTS_0_32:u.default.S_JOINTS_0,v.data)}if(o.default.checkIsNull(_.attributes.WEIGHTS_0)){var y=this._parseWeights(e,_.attributes.WEIGHTS_0);h.setData(u.default.S_WEIGHTS_0,y.data)}}if(o.default.checkIsNull(_.indices)){var C=this._parseIndices(e,_.indices);h.setData(5125==C.bufType?u.default.S_INDICES_32:u.default.S_INDICES,C.data)}if(o.default.checkIsNull(_.attributes.TANGENT)){var b=this._parseTangents(e,_.attributes.TANGENT);h.setData(u.default.S_TANGENTS,b.data)}else if(h.getData(u.default.S_UV0)){console.log("生成切线数据");var P=o.default.generatorTangents2(h.getData(u.default.S_INDICES)?h.getData(u.default.S_INDICES):h.getData(u.default.S_INDICES_32),h.getData(u.default.S_POSITIONS),h.getData(u.default.S_UV0),h.getData(u.default.S_NORMALS));h.setData(u.default.S_TANGENTS,P)}else console.log("-----------------------------");if(o.default.checkIsNull(_.material)){this._m_PrincipledMatDef||(this._m_PrincipledMatDef=l.default.load(this._m_AssetsPath+"PrincipledLightingDef"));var E=this._getName(e.materials[_.material].name),D=null;this._m_Mats[E]?D=this._m_Mats[E]:(D=new f.default(this._m_Scene,{id:E,materialDef:this._m_PrincipledMatDef}),this._parseMaterial(e,_.material,D),this._m_Mats[E]=D),c.setMaterial(D),D.renderState&&("BLEND"!=D.renderState.alphaMode&&"MASK"!=D.renderState.alphaMode||c.setTranslucent())}else{this._m_DefaultMatDef||(this._m_DefaultMatDef=l.default.load(this._m_AssetsPath+"ColorDef"));var R="default_gltf_mat",w=null;this._m_Mats[R]?w=this._m_Mats[R]:(w=new f.default(this._m_Scene,{id:R,materialDef:this._m_DefaultMatDef}),this._m_Mats[R]=w),c.setMaterial(w)}c.setMesh(h),c.updateBound(),r&&c.getMaterial().addDefine(T.default.S_SKINS_SRC)}}},{key:"_samplerMap",value:function(t,n,r){var i=t.textures[n],a=t.images[i.source],_=new E.default(this._m_Scene);if(r&&_.setTextureFormat(E.default.S_TEXTURE_FORMAT.S_SRGBA,E.default.S_TEXTURE_FORMAT.S_RGBA,E.default.S_TEXTURE_FORMAT.S_UNSIGNED_BYTE),_.setImageSrc(this._m_Scene,this._m_BasePath+a.uri),o.default.checkIsNull(i.sampler)){var s=t.samplers[i.sampler];if(o.default.checkIsNull(s)){var u=s.magFilter,l=s.minFilter;u&&l&&_.setFilter(this._m_Scene,e.FILTERS[l],e.FILTERS[u]);var f=s.wrapS,c=s.wrapT;f&&c&&_.setWrap(this._m_Scene,e.WRAPS[f],e.WRAPS[c])}}return _}},{key:"_parseMaterial",value:function(e,t,n){var r=e.materials[t];if(r.pbrMetallicRoughness){var i=r.pbrMetallicRoughness,a=i.baseColorFactor;o.default.checkIsNull(a)&&n.setParam("baseColor",(new b.default).valueFromXYZW(a[0],a[1],a[2],a[3]));var _=i.roughnessFactor;o.default.checkIsNull(_)&&n.setParam("roughness",(new P.default).valueOf(_));var s=i.metallicFactor;o.default.checkIsNull(s)&&n.setParam("metallic",(new P.default).valueOf(s));var u=i.baseColorTexture;o.default.checkIsNull(u)&&n.setParam("baseColorMap",this._samplerMap(e,u.index,!0));var l=i.metallicRoughnessTexture;o.default.checkIsNull(l)&&n.setParam("metallicRoughnessMap",this._samplerMap(e,l.index))}if(r.extensions&&r.extensions.KHR_materials_pbrSpecularGlossiness){var f=r.extensions.KHR_materials_pbrSpecularGlossiness;n.setParam("useSpecGloss",(new D.default).valueOf(!0));var c=f.diffuseTexture;o.default.checkIsNull(c)&&n.setParam("baseColorMap",this._samplerMap(e,c.index,!0));var m=f.specularGlossinessTexture;o.default.checkIsNull(m)&&n.setParam("specularGlossinessMap",this._samplerMap(e,m.index,!0))}var h=r.normalTexture;o.default.checkIsNull(h)&&n.setParam("normalMap",this._samplerMap(e,h.index));var d=r.occlusionTexture;if(o.default.checkIsNull(d)){var p=d.texCoord;n.setParam("lightMap",this._samplerMap(e,d.index,!0)),null!=p&&0!=p||n.setParam("aoMap",(new D.default).valueOf(!0))}var g=r.emissiveFactor;o.default.checkIsNull(g)&&n.setParam("emissive",(new b.default).valueFromXYZW(g[0],g[1],g[2],1));var S=r.emissiveTexture;o.default.checkIsNull(S)&&n.setParam("emissiveMap",this._samplerMap(e,S.index,!0));var v={};r.alphaMode&&(v.alphaMode=r.alphaMode),r.doubleSided&&(v.doubleSided=r.doubleSided),n.renderState=v}},{key:"_parsePositions",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=i[o.buffer].data;return{data:new e.DATA[r.componentType](a,(o.byteOffset||0)+(r.byteOffset||0),3*r.count),bufType:r.componentType}}},{key:"_parseTangents",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=i[o.buffer].data;return{data:new e.DATA[r.componentType](a,(o.byteOffset||0)+(r.byteOffset||0),4*r.count),bufType:r.componentType}}},{key:"_parseNormals",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=i[o.buffer].data;return{data:new e.DATA[r.componentType](a,(o.byteOffset||0)+(r.byteOffset||0),3*r.count),bufType:r.componentType}}},{key:"_parseTexcoords",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=i[o.buffer].data;return{data:new e.DATA[r.componentType](a,(o.byteOffset||0)+(r.byteOffset||0),2*r.count),bufType:r.componentType}}},{key:"_parseIndices",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=i[o.buffer].data;return{data:new e.DATA[r.componentType](a,(o.byteOffset||0)+(r.byteOffset||0),r.count),bufType:r.componentType}}},{key:"_parseJoints",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=i[o.buffer].data;return{data:new e.DATA[r.componentType](a,(o.byteOffset||0)+(r.byteOffset||0),4*r.count),bufType:r.componentType}}},{key:"_parseWeights",value:function(t,n){var r=t.accessors[n],i=t.buffers,o=t.bufferViews[r.bufferView],a=i[o.buffer].data;return{data:new e.DATA[r.componentType](a,(o.byteOffset||0)+(r.byteOffset||0),4*r.count),bufType:r.componentType}}}])&&L(n.prototype,r),A&&L(n,A),e}();n.default=x,I(x,"DATA",{5121:Uint8Array,5123:Uint16Array,5124:Uint16Array,5125:Uint32Array,5126:Float32Array}),I(x,"DATA_COMPONENT",{SCALAR:1,VEC3:3,VEC4:4,MAT4:16}),I(x,"FILTERS",{9729:E.default.S_FILTERS.S_LINEAR,9728:E.default.S_FILTERS.S_NEAREST,9987:E.default.S_FILTERS.S_LINEAR_MIPMAP_LINEAR,9986:E.default.S_FILTERS.S_NEAREST_MIPMAP_LINEAR,9985:E.default.S_FILTERS.S_LINEAR_MIPMAP_NEAREST,9984:E.default.S_FILTERS.S_NEAREST_MIPMAP_NEAREST}),I(x,"WRAPS",{10497:E.default.S_WRAPS.S_REPEAT,33071:E.default.S_WRAPS.S_CLAMP_TO_EDGE})},8236:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=d(n(2949)),i=d(n(8113)),o=d(n(4008)),a=d(n(307)),_=d(n(4720)),s=d(n(5397)),u=d(n(3846)),l=d(n(2462)),f=d(n(1759)),c=d(n(7141)),m=d(n(5141)),h=d(n(3370));function d(e){return e&&e.__esModule?e:{default:e}}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),g(this,"_m_CustomMatDef","BasicLightingDef"),g(this,"_m_AlphaMode",e.S_ALPHA_MODE_BLEND)}var t,n,d;return t=e,(n=[{key:"load",value:function(e,t,n,i){this._m_Scene=e,this._m_DefaultMatDef=null,this._m_Mats={},this._m_CurrentMat=null;var o=new r.default(e,{id:t||s.default.nextId()});this._load(o,n,i)}},{key:"config",value:function(e){this._m_AlphaMode=e.alphaMode||this._m_AlphaMode}},{key:"setAssetsPath",value:function(e,t){this._m_AssetsPath=e,t&&(this._m_CustomMatDef=t)}},{key:"_load",value:function(e,t,n){var r=this;this.loadOBJ(e,t,(function(t){r._m_DefaultMatDef||(r._m_AssetsPath&&r._m_CustomMatDef?r._m_DefaultMatDef=i.default.load(r._m_AssetsPath+r._m_CustomMatDef):r._m_DefaultMatDef=i.default.parse(h.default.S_BASIC_LIGHTING_DEF_DATA)),r.loadMTLs(e,t,(function(){r.createMeshes(e,t),n&&n(e)}))}))}},{key:"loadOBJ",value:function(e,t,n){var r=this;this.loadFile(t,(function(i){var o=r.parseOBJ(e,i,t);n(o)}),(function(e){u.default.error(e)}))}},{key:"parseOBJ",value:function(e,t,n){var r={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /},i={src:n=n||"",basePath:this.getBasePath(n),objects:[],object:{},positions:[],normals:[],uv:[],materialLibraries:{}};this.startObject(i,"",!1),-1!==t.indexOf("\r\n")&&(t=t.replace("\r\n","\n"));for(var o=t.split("\n"),a="",_="",s="",l=[],f="function"==typeof"".trimLeft,c=0,m=o.length;c<m;c++)if(a=o[c],0!==(a=f?a.trimLeft():a.trim()).length&&"#"!==(_=a.charAt(0)))if("v"===_)if(" "===(s=a.charAt(1))&&null!==(l=r.vertex_pattern.exec(a)))i.positions.push(parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3]));else if("n"===s&&null!==(l=r.normal_pattern.exec(a)))i.normals.push(parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3]));else{if("t"!==s||null===(l=r.uv_pattern.exec(a)))return void u.default.error("Unexpected vertex/normal/uv line: '"+a+"'");i.uv.push(parseFloat(l[1]),parseFloat(l[2]))}else if("f"===_)if(null!==(l=r.face_vertex_uv_normal.exec(a)))this.addFace(i,l[1],l[4],l[7],l[10],l[2],l[5],l[8],l[11],l[3],l[6],l[9],l[12]);else if(null!==(l=r.face_vertex_uv.exec(a)))this.addFace(i,l[1],l[3],l[5],l[7],l[2],l[4],l[6],l[8]);else if(null!==(l=r.face_vertex_normal.exec(a)))this.addFace(i,l[1],l[3],l[5],l[7],void 0,void 0,void 0,void 0,l[2],l[4],l[6],l[8]);else{if(null===(l=r.face_vertex.exec(a)))return void u.default.error("Unexpected face line: '"+a+"'");this.addFace(i,l[1],l[2],l[3],l[4])}else if("l"===_){var h=a.substring(1).trim().split(" "),d=[],p=[];if(-1===a.indexOf("/"))d=h;else for(var g=0,S=h.length;g<S;g++){var v=h[g].split("/");""!==v[0]&&d.push(v[0]),""!==v[1]&&p.push(v[1])}this.addLineGeometry(i,d,p)}else if(null!==(l=r.object_pattern.exec(a))){var y=l[0].substr(1).trim();this.startObject(i,y,!0)}else if(r.material_use_pattern.test(a)){var C=a.substring(7).trim();i.object.material.id=C}else if(r.material_library_pattern.test(a))i.materialLibraries[a.substring(7).trim()]=!0;else{if(null===(l=r.smoothing_pattern.exec(a))){if("\0"===a)continue;return void u.default.error("Unexpected line: '"+a+"'")}var T=l[1].trim().toLowerCase();i.object.material.smooth="1"===T||"on"===T}return i}},{key:"getBasePath",value:function(e){var t=e.lastIndexOf("/");return-1===t?e:e.substring(0,t+1)}},{key:"startObject",value:function(e,t,n){if(e.object&&!1===e.object.fromDeclaration)return e.object.id=t,void(e.object.fromDeclaration=!1!==n);e.object={id:t||"",geometry:{positions:[],normals:[],uv:[]},material:{id:"",smooth:!0},fromDeclaration:!1!==n},e.objects.push(e.object)}},{key:"parseVertexIndex",value:function(e,t){var n=parseInt(e,10);return 3*(n>=0?n-1:n+t/3)}},{key:"parseNormalIndex",value:function(e,t){var n=parseInt(e,10);return 3*(n>=0?n-1:n+t/3)}},{key:"parseUVIndex",value:function(e,t){var n=parseInt(e,10);return 2*(n>=0?n-1:n+t/2)}},{key:"addVertex",value:function(e,t,n,r){var i=e.positions,o=e.object.geometry.positions;o.push(i[t+0]),o.push(i[t+1]),o.push(i[t+2]),o.push(i[n+0]),o.push(i[n+1]),o.push(i[n+2]),o.push(i[r+0]),o.push(i[r+1]),o.push(i[r+2])}},{key:"addVertexLine",value:function(e,t){var n=e.positions,r=e.object.geometry.positions;r.push(n[t+0]),r.push(n[t+1]),r.push(n[t+2])}},{key:"addNormal",value:function(e,t,n,r){var i=e.normals,o=e.object.geometry.normals;o.push(i[t+0]),o.push(i[t+1]),o.push(i[t+2]),o.push(i[n+0]),o.push(i[n+1]),o.push(i[n+2]),o.push(i[r+0]),o.push(i[r+1]),o.push(i[r+2])}},{key:"addUV",value:function(e,t,n,r){var i=e.uv,o=e.object.geometry.uv;o.push(i[t+0]),o.push(i[t+1]),o.push(i[n+0]),o.push(i[n+1]),o.push(i[r+0]),o.push(i[r+1])}},{key:"addUVLine",value:function(e,t){var n=e.uv,r=e.object.geometry.uv;r.push(n[t+0]),r.push(n[t+1])}},{key:"addFace",value:function(e,t,n,r,i,o,a,_,s,u,l,f,c){var m,h=e.positions.length,d=this.parseVertexIndex(t,h),p=this.parseVertexIndex(n,h),g=this.parseVertexIndex(r,h);if(void 0===i?this.addVertex(e,d,p,g):(m=this.parseVertexIndex(i,h),this.addVertex(e,d,p,m),this.addVertex(e,p,g,m)),void 0!==o){var S=e.uv.length;d=this.parseUVIndex(o,S),p=this.parseUVIndex(a,S),g=this.parseUVIndex(_,S),void 0===i?this.addUV(e,d,p,g):(m=this.parseUVIndex(s,S),this.addUV(e,d,p,m),this.addUV(e,p,g,m))}if(void 0!==u){var v=e.normals.length;d=this.parseNormalIndex(u,v),p=u===l?d:this.parseNormalIndex(l,v),g=u===f?d:this.parseNormalIndex(f,v),void 0===i?this.addNormal(e,d,p,g):(m=this.parseNormalIndex(c,v),this.addNormal(e,d,p,m),this.addNormal(e,p,g,m))}}},{key:"addLineGeometry",value:function(e,t,n){e.object.geometry.type="Line";for(var r=e.positions.length,i=e.uv.length,o=0,a=t.length;o<a;o++)this.addVertexLine(e,this.parseVertexIndex(t[o],r));for(var _=0,s=n.length;_<s;_++)this.addUVLine(e,this.parseUVIndex(n[_],i))}},{key:"loadMTLs",value:function(e,t,n){for(var r=t.basePath,i=Object.keys(t.materialLibraries),o=i.length,a=0,_=o;a<_;a++)this.loadMTL(e,r,r+i[a],(function(){0==--o&&n()}))}},{key:"loadMTL",value:function(e,t,n,r){var i=this;this.loadFile(n,(function(n){i.parseMTL(e,n,t),r()}),(function(e){u.default.error(e),r()}))}},{key:"createTexture",value:function(e,t,n,r){var i={},o=n.split(/\s+/),a=o.indexOf("-bm");a>=0&&o.splice(a,2),(a=o.indexOf("-s"))>=0&&(i.scale=[parseFloat(o[a+1]),parseFloat(o[a+2])],o.splice(a,4)),(a=o.indexOf("-o"))>=0&&(i.translate=[parseFloat(o[a+1]),parseFloat(o[a+2])],o.splice(a,4)),i.src=t+o.join(" ").trim(),i.flipY=!0,i.encoding=r||"linear";var _=new m.default(this._m_Scene);return"sRGB"==i.encoding&&_.setTextureFormat(m.default.S_TEXTURE_FORMAT.S_SRGBA,m.default.S_TEXTURE_FORMAT.S_RGBA,m.default.S_TEXTURE_FORMAT.S_UNSIGNED_BYTE),_.setPreloadColor(this._m_Scene,new c.default(.2,.2,.2,1)),_.setImageSrc(this._m_Scene,i.src),_.setFlipY(!0),_}},{key:"createMaterial",value:function(e,t){if(this._m_DefaultMatDef&&!this._m_Mats[t.id]){var n=new o.default(this._m_Scene,{id:t.id,materialDef:this._m_DefaultMatDef});this._m_Mats[t.id]=n,this._m_CurrentMat=n,this._m_CurrentMat.setParam("diffuseColor",(new l.default).valueFromXYZW(.5,.5,.5,1)),this._m_CurrentMat.setParam("ambientColor",(new l.default).valueFromXYZW(.2,.2,.2,1)),this._m_CurrentMat.setParam("specularColor",(new l.default).valueFromXYZW(1,1,1,1)),this._m_CurrentMat.setParam("shininess",(new f.default).valueOf(32))}}},{key:"parseRGB",value:function(e){var t=e.split(/\s+/,3);return[parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])]}},{key:"parseMTL",value:function(t,n,r){var i,o,a,_,s,u=n.split("\n"),c={id:"Default"};r=r||"";for(var m=0;m<u.length;m++)if(0!==(i=u[m].trim()).length&&"#"!==i.charAt(0))switch(a=(a=(o=i.indexOf(" "))>=0?i.substring(0,o):i).toLowerCase(),_=(_=o>=0?i.substring(o+1):"").trim(),a.toLowerCase()){case"newmtl":c={id:_},this.createMaterial(t,c);break;case"ka":c.ambient=this.parseRGB(_),this._m_CurrentMat.setParam("ambientColor",(new l.default).valueFromXYZW(c.ambient[0],c.ambient[1],c.ambient[2],1));break;case"kd":c.diffuse=this.parseRGB(_),this._m_CurrentMat.setParam("diffuseColor",(new l.default).valueFromXYZW(c.diffuse[0],c.diffuse[1],c.diffuse[2],1));break;case"ks":c.specular=this.parseRGB(_),this._m_CurrentMat.setParam("specularColor",(new l.default).valueFromXYZW(c.specular[0],c.specular[1],c.specular[2],1));break;case"map_kd":c.diffuseMap||(c.diffuseMap=this.createTexture(t,r,_,"sRGB"),this._m_CurrentMat.setParam("diffuseMap",c.diffuseMap));break;case"map_ks":c.specularMap||(c.specularMap=this.createTexture(t,r,_,"linear"),this._m_CurrentMat.setParam("specularMap",c.specularMap));break;case"map_bump":case"bump":c.normalMap||(c.normalMap=this.createTexture(t,r,_),this._m_CurrentMat.setParam("normalMap",c.normalMap));break;case"ns":c.shininess=parseFloat(_),this._m_CurrentMat.setParam("shininess",(new f.default).valueOf(c.shininess));break;case"d":(s=parseFloat(_))<=.1&&(this._m_AlphaMode==e.S_ALPHA_MODE_BLEND?this._m_CurrentMat.alphaMode="blend":this._m_AlphaMode==e.S_ALPHA_MODE_DISCARD&&this._m_CurrentMat.setParam("alphaDiscard",(new f.default).valueOf(s))),s<1&&(c.alpha=s,this._m_AlphaMode==e.S_ALPHA_MODE_BLEND&&(c.alphaMode="blend"));break;case"tr":(s=parseFloat(_))<=.1&&(this._m_AlphaMode==e.S_ALPHA_MODE_BLEND?this._m_CurrentMat.alphaMode="blend":this._m_AlphaMode==e.S_ALPHA_MODE_DISCARD&&this._m_CurrentMat.setParam("alphaDiscard",(new f.default).valueOf(1-s))),s>0&&(c.alpha=1-s,this._m_AlphaMode==e.S_ALPHA_MODE_BLEND&&(c.alphaMode="blend"))}}},{key:"createMeshes",value:function(e,t){u.default.debug("state.objects.length:"+t.objects.length);for(var n={},r=0,i=0,l=t.objects.length;i<l;i++){var f=t.objects[i],c=f.geometry,m=(c.type,f.material.id),h=void 0,d=null;if(0!==c.positions.length)if(n[m])!function(){for(var e=n[m].mesh,t=n[m].unitType,r=e.getData(a.default.S_POSITIONS),i=new Array(c.positions.length/3),o=0,_=r.length/3;o<i.length;o++)i[o]=o+_;if(r&&c.positions.forEach((function(e){r.push(e)})),e.setData(a.default.S_POSITIONS,r),c.normals.length>0){var s=e.getData(a.default.S_NORMALS);s&&c.normals.forEach((function(e){s.push(e)})),e.setData(a.default.S_NORMALS,s)}if(c.uv.length>0){var u=e.getData(a.default.S_UV0);u&&c.uv.forEach((function(e){u.push(e)})),e.setData(a.default.S_UV0,u)}var l=e.getData(t);l&&i.forEach((function(e){l.push(e)})),e.setData(t,l)}();else{r++;var p=new Array(c.positions.length/3);d=p.length>65534?a.default.S_INDICES_32:a.default.S_INDICES;for(var g=0;g<p.length;g++)p[g]=g;var S=new a.default;if(S.setData(a.default.S_POSITIONS,c.positions),c.normals.length>0&&S.setData(a.default.S_NORMALS,c.normals),c.uv.length>0&&S.setData(a.default.S_UV0,c.uv),S.setData(d,p),m&&""!==m)(h=this._m_Mats[m])||u.default.error("Material not found: "+m);else if(this._m_DefaultMatDef){if(!this._m_Mats.Default){var v=new o.default(this._m_Scene,{id:"Default",materialDef:this._m_DefaultMatDef});this._m_Mats.Default=v}h=this._m_Mats.Default}n[m]={mesh:S,material:h,unitType:d}}}if(r)for(var y in u.default.debug("实体数量:"+r),n){var C=n[y].material,T=n[y].unitType,b=n[y].mesh;if(b.getData(a.default.S_UV0)){var P=s.default.generatorTangents2(b.getData(T),b.getData(a.default.S_POSITIONS),b.getData(a.default.S_UV0),b.getData(a.default.S_NORMALS));b.setData(a.default.S_TANGENTS,P)}else{var E=s.default.generatorFillTangents2(b.getData(a.default.S_POSITIONS));b.setData(a.default.S_TANGENTS,E)}var D=new _.default(e,{id:"Geo_"+y});D.setMesh(b),D.setMaterial(C),D.updateBound(),C.alphaMode&&D.setTranslucent(),e.addChildren(D)}}},{key:"loadFile",value:function(e,t,n){var r=new XMLHttpRequest;r.open("GET",e,!0),r.addEventListener("load",(function(e){var i=e.target.response;200===r.status?t&&t(i):0===r.status?(u.default.warn("loadFile: HTTP Status 0 received."),t&&t(i)):n&&n(e)}),!1),r.addEventListener("error",(function(e){n&&n(e)}),!1),r.send(null)}}])&&p(t.prototype,n),d&&p(t,d),e}();t.default=S,g(S,"S_ALPHA_MODE_BLEND","blend"),g(S,"S_ALPHA_MODE_DISCARD","discard")},6797:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i=(r=n(3319))&&r.__esModule?r:{default:r};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"rgbeImg",value:function(){return(new i.default).HDRImage()}}],(n=[{key:"loadHDR",value:function(t,n){var r=e.rgbeImg();r.onload=function(){n(r)},r.src=t}}])&&o(t.prototype,n),r&&o(t,r),e}();t.default=a},3319:(t,n)=>{function r(){var e,t,n=document.createElement("canvas"),r="t",u=1,l=2.2,f=null;return n.__defineGetter__("exposure",(function(){return u})),n.__defineSetter__("exposure",(function(n){u=n,f&&(s(f,u,l,t.data),e.putImageData(t,0,0))})),n.__defineGetter__("gamma",(function(){return l})),n.__defineSetter__("gamma",(function(n){l=n,f&&(s(f,u,l,t.data),e.putImageData(t,0,0))})),n.__defineGetter__("dataFloat",(function(){return _(f)})),n.__defineGetter__("dataRGBE",(function(){return f})),n.toHDRBlob=function(e,t,n){function r(e,t,n){var r=e.createShader(n);return e.shaderSource(r,t),e.compileShader(r),r}var o=t&&t.match(/rgb9_e5/i)?new Uint8Array(i(_(f)).buffer):new Uint8Array(f.buffer),a=this.width,s=this.height;if(a*s*4<o.byteLength)return console.error("not big enough.");var u=document.createElement("canvas");u.width=a,u.height=s;var l=u.getContext("webgl",{antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),c=l.createTexture();l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,c),l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,a,s,0,l.RGBA,l.UNSIGNED_BYTE,new Uint8Array(o.buffer));var m=function(e,t,n){var i,o,a=e.createProgram();return e.attachShader(a,i=r(e,t,e.VERTEX_SHADER)),e.attachShader(a,o=r(e,n,e.FRAGMENT_SHADER)),e.linkProgram(a),e.deleteShader(i),e.deleteShader(o),a}(l,"precision highp float;\nattribute vec3 position;\nvarying vec2 tex;\nvoid main() { tex = position.xy/2.0+0.5; gl_Position = vec4(position, 1.0); }","precision highp float;\nprecision highp sampler2D;\nuniform sampler2D tx;\nvarying vec2 tex;\nvoid main() { gl_FragColor = texture2D(tx,tex); }"),h=l.getUniformLocation(m,"tx"),d=new Float32Array([-1,-1,0,1,-1,0,1,1,0,1,1,0,-1,1,0,-1,-1,0]),p=l.createBuffer();return l.enableVertexAttribArray(0),l.bindBuffer(l.ARRAY_BUFFER,p),l.bufferData(l.ARRAY_BUFFER,d,l.STATIC_DRAW),l.vertexAttribPointer(0,3,l.FLOAT,!1,0,0),l.useProgram(m),l.uniform1i(h,0),l.drawArrays(l.TRIANGLES,0,6),l.deleteTexture(c),l.deleteProgram(m),e?u.toBlob(e):void 0},n.__defineGetter__("src",(function(){return r})),n.__defineSetter__("src",(function(i){if(r=i,e&&e.clearRect(0,0,this.width,this.height),i.match(/\.hdr$/i))c=i,m=function(n,r,i){f=n,this.width=this.style.width=r,this.height=this.style.height=i,e=this.getContext("2d"),t=e.getImageData(0,0,r,i),s(n,u,l,t.data),e.putImageData(t,0,0),this.onload&&this.onload()}.bind(n),h=function(e,t){for(var n in t)e[n]=t[n];return e}(new XMLHttpRequest,{responseType:"arraybuffer"}),h.onerror=m.bind(h,!1),h.onload=function(){if(this.status>=400)return this.onerror();for(var e,t="",n=0,r=new Uint8Array(this.response);!t.match(/\n\n[^\n]+\n/g);)t+=String.fromCharCode(r[n++]);if("32-bit_rle_rgbe"!=(e=t.match(/FORMAT=(.*)$/m)[1]))return console.warn("unknown format : "+e),this.onerror();for(var i=t.split(/\n/).reverse()[1].split(" "),o=1*i[3],a=1*i[1],_=new Uint8Array(o*a*4),s=0,u=0;u<a;u++){var l=r.slice(n,n+=4),f=[];if(2!=l[0]||2!=l[1]||128&l[2]){var c=o;for(n-=4;c>0;)if(_.set(r.slice(n,n+=4),s),1==_[s]&&1==_[s+1]&&1==_[s+2])for(_[s+3];h>0;h--)_.set(_.slice(s-4,s),s),s+=4,c--;else c--,s+=4}else{if((l[2]<<8)+l[3]!=o)return console.warn("HDR line mismatch .."),this.onerror();for(var h=0;h<4;h++)for(var d,p,g=h*o,S=(h+1)*o;g<S;)if((d=r.slice(n,n+=2))[0]>128)for(p=d[0]-128;p-- >0;)f[g++]=d[1];else for(p=d[0]-1,f[g++]=d[1];p-- >0;)f[g++]=r[n++];for(h=0;h<o;h++)_[s++]=f[h],_[s++]=f[h+o],_[s++]=f[h+2*o],_[s++]=f[h+3*o]}}m&&m(_,o,a)},h.open("GET",c,!0),h.send(null);else if(i.match(/\.rgb9_e5\.png$/i)){(_=new Image).src=i,_.onload=function(){var n=document.createElement("canvas"),r=this.width=this.style.width=n.width=_.width,i=this.height=this.style.height=n.height=_.height,c=n.getContext("webgl"),m=c.createTexture();c.bindTexture(c.TEXTURE_2D,m),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,_),fb=c.createFramebuffer(),c.bindFramebuffer(c.FRAMEBUFFER,fb),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,m,0);var h=new Uint8Array(r*i*4);c.readPixels(0,0,r,i,c.RGBA,c.UNSIGNED_BYTE,h),c.deleteTexture(m),c.deleteFramebuffer(fb),this.dataRAW=new Uint32Array(h.buffer),f=a(o(this.dataRAW)),e=this.getContext("2d"),t=e.getImageData(0,0,r,i),s(f,u,l,t.data),e.putImageData(t,0,0),this.onload&&this.onload()}.bind(n)}else if(i.match(/\.hdr\.png$|\.rgbe\.png/i)){var _;(_=new Image).src=i,_.onload=function(){var n=document.createElement("canvas"),r=this.width=this.style.width=n.width=_.width,i=this.height=this.style.height=n.height=_.height,o=n.getContext("webgl"),a=o.createTexture();o.bindTexture(o.TEXTURE_2D,a),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,_),fb=o.createFramebuffer(),o.bindFramebuffer(o.FRAMEBUFFER,fb),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,a,0);var c=new Uint8Array(r*i*4);o.readPixels(0,0,r,i,o.RGBA,o.UNSIGNED_BYTE,c),o.deleteTexture(a),o.deleteFramebuffer(fb),f=c,e=this.getContext("2d"),t=e.getImageData(0,0,r,i),s(f,u,l,t.data),e.putImageData(t,0,0),this.onload&&this.onload()}.bind(n)}var c,m,h})),n}function i(e,t){for(var n,r,i,o,a,_,s=e.byteLength/12|0,u=(t=t||new Uint32Array(s),0);u<s;u++)n=Math.min(32768,e[3*u]),r=Math.min(32768,e[3*u+1]),i=Math.min(32768,e[3*u+2]),o=Math.max(Math.max(n,r),i),a=Math.max(-16,Math.floor(Math.log2(o)))+16,_=Math.pow(2,a-24),511==Math.floor(o/_+.5)&&(_*=2,a+=1),t[u]=(Math.floor(n/_+.5)<<23)+(Math.floor(r/_+.5)<<14)+(Math.floor(i/_+.5)<<5)+(0|a);return t}function o(e,t){for(var n,r,i=e.byteLength>>2,o=(t=t||new Float32Array(3*i),0);o<i;o++)n=e[o],r=Math.pow(2,(31&n)-24),t[3*o]=(n>>>23)*r,t[3*o+1]=(n>>>14&511)*r,t[3*o+2]=(n>>>5&511)*r;return t}function a(t,n){for(var r,i,o,a,_,s=t.byteLength/12|0,u=(n=n||new Uint8Array(4*s),0);u<s;u++)r=t[3*u],i=t[3*u+1],o=t[3*u+2],a=Math.max(Math.max(r,i),o),e=Math.ceil(Math.log2(a)),_=Math.pow(2,e-8),n[4*u]=r/_|0,n[4*u+1]=i/_|0,n[4*u+2]=o/_|0,n[4*u+3]=e+128;return n}function _(e,t){for(var n,r=e.byteLength>>2,i=(t=t||new Float32Array(3*r),0);i<r;i++)n=Math.pow(2,e[4*i+3]-136),t[3*i]=e[4*i]*n,t[3*i+1]=e[4*i+1]*n,t[3*i+2]=e[4*i+2]*n;return t}function s(e,t,n,r){t=Math.pow(2,void 0===t?1:t)/2,void 0===n&&(n=2.2);for(var i,o=1/n,a=e.byteLength>>2,_=(r=r||new Uint8ClampedArray(4*a),0);_<a;_++)i=t*Math.pow(2,e[4*_+3]-136),r[4*_]=255*Math.pow(e[4*_]*i,o),r[4*_+1]=255*Math.pow(e[4*_+1]*i,o),r[4*_+2]=255*Math.pow(e[4*_+2]*i,o),r[4*_+3]=255;return r}Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0,r.floatToRgbe=a,r.rgbeToFloat=_,r.floatToRgb9_e5=i,r.rgb9_e5ToFloat=o,r.rgbeToLDR=s,r.floatToLDR=function(e,t,n,r){t=Math.pow(2,void 0===t?1:t)/2,void 0===n&&(n=2.2);for(var i=1/n,o=e.byteLength/12|0,a=(r=r||new Uint8ClampedArray(4*o),0);a<o;a++)r[4*a]=255*Math.pow(e[3*a]*t,i),r[4*a+1]=255*Math.pow(e[3*a+1]*t,i),r[4*a+2]=255*Math.pow(e[3*a+2]*t,i),r[4*a+3]=255;return r};n.default=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.HDRImage=r}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}var __webpack_exports__={};return(()=>{var e=__webpack_exports__;e.default=void 0;var t=ht(__webpack_require__(4939)),n=ht(__webpack_require__(9586)),r=ht(__webpack_require__(1648)),i=ht(__webpack_require__(479)),o=ht(__webpack_require__(4755)),a=ht(__webpack_require__(6858)),_=ht(__webpack_require__(1608)),s=ht(__webpack_require__(8649)),u=ht(__webpack_require__(1245)),l=ht(__webpack_require__(7938)),f=ht(__webpack_require__(6458)),c=ht(__webpack_require__(7868)),m=ht(__webpack_require__(8081)),h=ht(__webpack_require__(6454)),d=ht(__webpack_require__(2414)),p=ht(__webpack_require__(5109)),g=ht(__webpack_require__(7120)),S=ht(__webpack_require__(6984)),v=ht(__webpack_require__(8878)),y=ht(__webpack_require__(4165)),C=ht(__webpack_require__(2028)),T=ht(__webpack_require__(7539)),b=ht(__webpack_require__(2815)),P=ht(__webpack_require__(513)),E=ht(__webpack_require__(6807)),D=ht(__webpack_require__(6967)),R=ht(__webpack_require__(3330)),w=ht(__webpack_require__(9098)),M=ht(__webpack_require__(4008)),A=ht(__webpack_require__(8113)),L=ht(__webpack_require__(5449)),I=ht(__webpack_require__(2603)),x=ht(__webpack_require__(4974)),O=ht(__webpack_require__(7057)),F=ht(__webpack_require__(2768)),k=ht(__webpack_require__(8173)),B=ht(__webpack_require__(3801)),N=ht(__webpack_require__(1846)),V=ht(__webpack_require__(1322)),G=ht(__webpack_require__(2320)),U=ht(__webpack_require__(431)),H=ht(__webpack_require__(7088)),j=ht(__webpack_require__(453)),X=ht(__webpack_require__(9271)),Y=ht(__webpack_require__(5604)),W=ht(__webpack_require__(7141)),Z=ht(__webpack_require__(2949)),z=ht(__webpack_require__(5765)),q=ht(__webpack_require__(1645)),K=ht(__webpack_require__(6341)),J=ht(__webpack_require__(9468)),Q=ht(__webpack_require__(5776)),$=ht(__webpack_require__(4720)),ee=ht(__webpack_require__(7280)),te=ht(__webpack_require__(2482)),ne=ht(__webpack_require__(9011)),re=ht(__webpack_require__(9369)),ie=ht(__webpack_require__(512)),oe=ht(__webpack_require__(6528)),ae=ht(__webpack_require__(870)),_e=ht(__webpack_require__(5734)),se=ht(__webpack_require__(9526)),ue=ht(__webpack_require__(6987)),le=ht(__webpack_require__(1393)),fe=ht(__webpack_require__(8388)),ce=ht(__webpack_require__(4658)),me=ht(__webpack_require__(8546)),he=ht(__webpack_require__(6148)),de=ht(__webpack_require__(2987)),pe=ht(__webpack_require__(2390)),ge=ht(__webpack_require__(7664)),Se=ht(__webpack_require__(3370)),ve=ht(__webpack_require__(3061)),ye=ht(__webpack_require__(9510)),Ce=ht(__webpack_require__(1550)),Te=ht(__webpack_require__(5602)),be=ht(__webpack_require__(6177)),Pe=ht(__webpack_require__(4867)),Ee=ht(__webpack_require__(1266)),De=ht(__webpack_require__(8578)),Re=ht(__webpack_require__(948)),we=ht(__webpack_require__(1193)),Me=ht(__webpack_require__(66)),Ae=ht(__webpack_require__(3846)),Le=ht(__webpack_require__(8583)),Ie=ht(__webpack_require__(5247)),xe=ht(__webpack_require__(5489)),Oe=ht(__webpack_require__(2475)),Fe=ht(__webpack_require__(5397)),ke=ht(__webpack_require__(1491)),Be=ht(__webpack_require__(1759)),Ne=ht(__webpack_require__(1359)),Ve=ht(__webpack_require__(5141)),Ge=ht(__webpack_require__(4048)),Ue=ht(__webpack_require__(3552)),He=ht(__webpack_require__(4690)),je=ht(__webpack_require__(2462)),Xe=ht(__webpack_require__(6693)),Ye=__webpack_require__(7902),We=ht(__webpack_require__(7341)),Ze=ht(__webpack_require__(6798)),ze=ht(__webpack_require__(307)),qe=ht(__webpack_require__(8435)),Ke=ht(__webpack_require__(6616)),Je=ht(__webpack_require__(9836)),Qe=ht(__webpack_require__(9784)),$e=ht(__webpack_require__(2228)),et=ht(__webpack_require__(2584)),tt=ht(__webpack_require__(1446)),nt=ht(__webpack_require__(6140)),rt=ht(__webpack_require__(9650)),it=ht(__webpack_require__(8636)),ot=ht(__webpack_require__(1797)),at=ht(__webpack_require__(4620)),_t=ht(__webpack_require__(8236)),st=ht(__webpack_require__(6797)),ut=ht(__webpack_require__(3319)),lt=ht(__webpack_require__(7698)),ft=ht(__webpack_require__(6552)),ct=ht(__webpack_require__(4992)),mt=ht(__webpack_require__(8011));function ht(e){return e&&e.__esModule?e:{default:e}}var dt={Scene:t.default,Bone:n.default,AnimationProcessor:r.default,AnimationAction:i.default,ActionClip:o.default,SkinGeometry:a.default,Skeleton:_.default,Joint:s.default,TrackBinding:u.default,TrackMixer:l.default,AnimKeyframe:f.default,AnimKeyframeEnum:c.default,QuaternionKeyframe:m.default,Vector3Keyframe:h.default,Vector4Keyframe:d.default,Canvas:p.default,Filter:g.default,CameraIps:S.default,FirstPersonController:v.default,Input:y.default,SceneBrowsingController:C.default,DirectionalLight:T.default,GIProbe:b.default,Light:P.default,PointLight:E.default,Probe:D.default,RefProbe:R.default,SpotLight:w.default,Material:M.default,MaterialDef:A.default,SubPass:L.default,SubShader:I.default,SubShaderDef:x.default,SubShaderSource:O.default,Technology:F.default,TechnologyDef:k.default,AABBBoundingBox:B.default,BoundingSphere:N.default,BoundingVolume:V.default,Matrix44:G.default,MoreMath:U.default,Plane:H.default,Quaternion:j.default,Vector2:X.default,Vector3:Y.default,Vector4:W.default,Box:z.default,Cylinder:ct.default,Torus:mt.default,GroupPlane:q.default,Grid:lt.default,Sphere:K.default,SkyBox:J.default,FramePicture:Q.default,Geometry:$.default,Node:Z.default,Picture:ee.default,LodControl:te.default,OctCullingControl:ne.default,OctNode:re.default,Base:ie.default,Clustered:oe.default,Deferred:ae.default,Forward:_e.default,ForwardPlus:se.default,TileDeferred:ue.default,DefaultRenderProgram:le.default,MultiPassIBLLightingRenderProgram:fe.default,MultiPassLightingRenderProgram:ce.default,SinglePassIBLLightingRenderProgram:me.default,SinglePassLightingRenderProgram:he.default,TilePassIBLLightingRenderProgram:de.default,TilePassLightingRenderProgram:pe.default,IDrawable:ge.default,Internal:Se.default,Render:ve.default,RenderQueue:ye.default,Camera:Ce.default,BasicShadowProcess:Te.default,DirectionalLightShadowProcess:be.default,PointLightShadowProcess:Pe.default,Shadow:Ee.default,SplitOccluders:De.default,SpotLightShadowProcess:Re.default,AssetLoader:we.default,Events:Me.default,Log:Ae.default,MeshFactor:Le.default,ProbeTools:Ie.default,Queue:xe.default,TempVars:Oe.default,TextImage:ft.default,Tools:Fe.default,BoolVars:ke.default,FloatVars:Be.default,Texture2DTargetVars:Ne.default,Texture2DVars:Ve.default,TextureCubeVars:Ge.default,Vars:Ue.default,Vec2Vars:He.default,Vec4Vars:je.default,ArrayBuf:Xe.default,Buffer:Ye.Buffer,FrameBuffer:We.default,FrameContext:Ze.default,Mesh:ze.default,RenderState:qe.default,Shader:Ke.default,ShaderProgram:Je.default,ShaderSource:Qe.default,SizeOf:$e.default,Texture:et.default,UniformBuffer:tt.default,UniformBufferI:nt.default,Component:rt.default,Globals:it.default,RenderEngine:ot.default,GLTFLoader:at.default,OBJLoader:_t.default,RadianceLoader:st.default,hdrpng:ut.default};e.default=dt})(),__webpack_exports__=__webpack_exports__.default,__webpack_exports__})()}));